@using AntDesign
@inject MessageService Message
@inject PartitionInfoApiClient PartitionApi

<div class="filter-builder">
    <div style="display: flex; flex-direction: column; gap: 16px; width: 100%;">
        @* 筛选条件列表 *@
        @foreach (var (filter, index) in _filters.Select((f, i) => (f, i)))
        {
            <Card Size="@CardSize.Small" Class="filter-item">
                <ChildContent>
                    <Row Gutter="16" Align="@RowAlign.Middle">
                        <AntDesign.Col Span="6">
                            @* 字段选择 *@
                            <Select @bind-Value="filter.ColumnName"
                                    Placeholder="选择字段"
                                    AllowClear
                                    ShowSearch
                                    TItem="string"
                                    TItemValue="string"
                                    @bind-Value:after="() => OnColumnChanged(filter)"
                                    Style="width: 100%;">
                                <SelectOptions>
                                    @if (_availableColumns != null)
                                    {
                                        @foreach (var col in _availableColumns)
                                        {
                                            <SelectOption TItemValue="string" TItem="string" Value="@col.ColumnName" Label="@col.DisplayName">
                                                <Space Size="@("small")">
                                                    <SpaceItem>@col.ColumnName</SpaceItem>
                                                    <SpaceItem>
                                                        <Tag Color="@GetColumnTypeColor(col.DataType)">@col.DataType</Tag>
                                                    </SpaceItem>
                                                    @if (col.HasIndex)
                                                    {
                                                        <SpaceItem><Tag Color="@("green")">索引</Tag></SpaceItem>
                                                    }
                                                </Space>
                                            </SelectOption>
                                        }
                                    }
                                </SelectOptions>
                            </Select>
                        </AntDesign.Col>
                        <AntDesign.Col Span="5">
                            @* 操作符选择 *@
                            <Select @bind-Value="filter.Operator"
                                    Placeholder="操作符"
                                    TItem="string"
                                    TItemValue="string"
                                    @bind-Value:after="UpdateWhereClause"
                                    Style="width: 100%;">
                                <SelectOptions>
                                    @foreach (var op in GetAvailableOperators(filter.ColumnType))
                                    {
                                        <SelectOption TItemValue="string" TItem="string" Value="@op.Value" Label="@op.Label" />
                                    }
                                </SelectOptions>
                            </Select>
                        </AntDesign.Col>
                        <AntDesign.Col Span="11">
                            @* 值输入 - 根据字段类型和操作符动态渲染 *@
                            @RenderValueInput(filter)
                        </AntDesign.Col>
                        <AntDesign.Col Span="2">
                            @* 删除按钮 *@
                            <Button Type="@ButtonType.Text"
                                    Danger
                                    Icon="delete"
                                    OnClick="() => RemoveFilter(index)"
                                    Disabled="@(_filters.Count == 1)" />
                        </AntDesign.Col>
                    </Row>
                </ChildContent>
            </Card>
        }

        @* 添加条件按钮 *@
        <Button Type="@ButtonType.Dashed"
                Icon="plus"
                Block
                OnClick="AddFilter">
            添加筛选条件
        </Button>

        @* WHERE 子句预览 *@
        @if (!string.IsNullOrWhiteSpace(_whereClause))
        {
            <Card Title="WHERE 子句预览" Size="@CardSize.Small" Class="where-preview">
                <Extra>
                    <Space Size="@("small")">
                        <SpaceItem>
                            <Button Size="@ButtonSize.Small"
                                    Icon="copy"
                                    OnClick="CopyWhereClause">
                                复制
                            </Button>
                        </SpaceItem>
                        @if (_estimatedRowCount.HasValue)
                        {
                            <SpaceItem>
                                <Tag Color="@(_estimatedRowCount.Value > 1000000 ? "red" : "blue")">
                                    预估: @_estimatedRowCount.Value.ToString("N0") 行
                                </Tag>
                            </SpaceItem>
                        }
                        @if (_isEstimating)
                        {
                            <SpaceItem><Spin Size="@SpinSize.Small" /></SpaceItem>
                        }
                    </Space>
                </Extra>
                <ChildContent>
                    <pre class="where-clause-code">@_whereClause</pre>
                    @if (_estimatedRowCount.HasValue && _estimatedRowCount.Value > 1000000)
                    {
                        <Alert Type="@AlertType.Warning"
                               Message="预估行数超过 100 万,建议调整筛选条件以减少影响范围"
                               ShowIcon="true"
                               Style="margin-top: 12px;" />
            }
        </ChildContent>
            </Card>
        }
    </div>
</div>

@code {
    /// <summary>
    /// 数据源ID - 用于获取表元数据
    /// </summary>
    [Parameter]
    public Guid DataSourceId { get; set; }

    /// <summary>
    /// 源表架构名
    /// </summary>
    [Parameter]
    public string? SourceSchema { get; set; }

    /// <summary>
    /// 源表名
    /// </summary>
    [Parameter]
    public string? SourceTable { get; set; }

    /// <summary>
    /// 生成的 WHERE 子句(不含 WHERE 关键字)
    /// </summary>
    [Parameter]
    public string? WhereClause { get; set; }

    /// <summary>
    /// WHERE 子句变化事件回调
    /// </summary>
    [Parameter]
    public EventCallback<string?> WhereClauseChanged { get; set; }

    /// <summary>
    /// 筛选条件列表
    /// </summary>
    private List<FilterCondition> _filters = new();

    /// <summary>
    /// 可用的表字段列表
    /// </summary>
    private List<TableColumnInfo>? _availableColumns;

    /// <summary>
    /// 生成的 WHERE 子句
    /// </summary>
    private string? _whereClause;

    /// <summary>
    /// 预估影响的行数
    /// </summary>
    private long? _estimatedRowCount;

    /// <summary>
    /// 是否正在预估行数
    /// </summary>
    private bool _isEstimating = false;

    protected override void OnInitialized()
    {
        // 不在这里初始化空条件，等待 LoadFromDefinition 或用户添加
    }

    protected override async Task OnParametersSetAsync()
    {
        // 处理传入的 WHERE 子句初始值
        // 注意：不尝试解析 WHERE 子句来重建筛选条件列表，因为解析复杂
        // 直接显示传入的 WHERE 子句在预览区域
        if (!string.IsNullOrWhiteSpace(WhereClause) && string.IsNullOrWhiteSpace(_whereClause))
        {
            _whereClause = WhereClause;
            StateHasChanged();
        }
        
        // 当表名变化时,重新加载字段列表
        if (!string.IsNullOrWhiteSpace(SourceSchema) && !string.IsNullOrWhiteSpace(SourceTable))
        {
            await LoadColumnsAsync();
        }
        
        // 如果还没有任何条件，添加一个空条件
        if (_filters.Count == 0)
        {
            _filters.Add(new FilterCondition());
        }
    }

    /// <summary>
    /// 加载表字段元数据
    /// </summary>
    private async Task LoadColumnsAsync()
    {
        try
        {
            Console.WriteLine($"开始加载表列信息: {SourceSchema}.{SourceTable}");
            
            // 调用后端 API 获取表字段列表
            var columns = await PartitionApi.GetTableColumnsAsync(DataSourceId, SourceSchema!, SourceTable!);
            
            _availableColumns = columns.Select(c => new TableColumnInfo
            {
                ColumnName = c.ColumnName,
                DataType = c.DataType,
                HasIndex = false, // API 暂不返回索引信息
                DisplayName = c.ColumnName
            }).ToList();

            Console.WriteLine($"列信息加载完成，共 {_availableColumns.Count} 列");
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"加载列信息失败: {ex.Message}");
            Message.Error($"加载表字段失败: {ex.Message}");
            _availableColumns = new List<TableColumnInfo>();
        }
    }

    /// <summary>
    /// 添加筛选条件
    /// </summary>
    private void AddFilter()
    {
        _filters.Add(new FilterCondition());
    }

    /// <summary>
    /// 移除筛选条件
    /// </summary>
    private async Task RemoveFilter(int index)
    {
        if (_filters.Count > 1)
        {
            _filters.RemoveAt(index);
            await UpdateWhereClause();
        }
    }

    /// <summary>
    /// 字段选择变化时
    /// </summary>
    private async Task OnColumnChanged(FilterCondition filter)
    {
        Console.WriteLine($"OnColumnSelected 被调用: ColumnName={filter.ColumnName}, 当前 Operator={filter.Operator}");
        
        if (string.IsNullOrWhiteSpace(filter.ColumnName))
        {
            filter.ColumnType = null;
            filter.Operator = null;
        }
        else
        {
            var column = _availableColumns?.FirstOrDefault(c => c.ColumnName == filter.ColumnName);
            if (column != null)
            {
                filter.ColumnType = column.DataType;
                // 只有当 Operator 为空时才设置默认值，避免覆盖从 JSON 加载的值
                if (string.IsNullOrWhiteSpace(filter.Operator))
                {
                    filter.Operator = GetDefaultOperator(column.DataType);
                    Console.WriteLine($"  设置默认 Operator: {filter.Operator}");
                }
                else
                {
                    Console.WriteLine($"  保留现有 Operator: {filter.Operator}");
                }
            }
        }
        await UpdateWhereClause();
    }

    /// <summary>
    /// 获取默认操作符
    /// </summary>
    private string GetDefaultOperator(string dataType)
    {
        return dataType.ToLower() switch
        {
            "datetime" or "datetime2" or "date" => "RelativeDays",
            "int" or "bigint" or "decimal" or "numeric" or "float" => "GreaterThanOrEqual",
            "nvarchar" or "varchar" or "nchar" or "char" => "Contains",
            _ => "Equals"
        };
    }

    /// <summary>
    /// 获取可用的操作符列表
    /// </summary>
    private List<OperatorOption> GetAvailableOperators(string? columnType)
    {
        if (string.IsNullOrWhiteSpace(columnType))
            return new List<OperatorOption>();

        return columnType.ToLower() switch
        {
            "datetime" or "datetime2" or "date" => new List<OperatorOption>
            {
                new("RelativeDays", "N 天以前 (推荐)"),
                new("DateRange", "日期范围"),
                new("LessThan", "< 早于"),
                new("GreaterThan", "> 晚于")
            },
            "int" or "bigint" or "decimal" or "numeric" or "float" => new List<OperatorOption>
            {
                new("Equals", "= 等于"),
                new("NotEquals", "≠ 不等于"),
                new("GreaterThan", "> 大于"),
                new("GreaterThanOrEqual", "≥ 大于等于"),
                new("LessThan", "< 小于"),
                new("LessThanOrEqual", "≤ 小于等于"),
                new("Between", "范围")
            },
            "nvarchar" or "varchar" or "nchar" or "char" => new List<OperatorOption>
            {
                new("Equals", "= 等于"),
                new("NotEquals", "≠ 不等于"),
                new("Contains", "包含"),
                new("StartsWith", "开头是"),
                new("EndsWith", "结尾是")
            },
            _ => new List<OperatorOption>
            {
                new("Equals", "= 等于"),
                new("NotEquals", "≠ 不等于")
            }
        };
    }

    /// <summary>
    /// 渲染值输入控件 - 根据字段类型和操作符动态渲染
    /// </summary>
    private RenderFragment RenderValueInput(FilterCondition filter) => __builder =>
    {
        if (string.IsNullOrWhiteSpace(filter.ColumnType) || string.IsNullOrWhiteSpace(filter.Operator))
        {
            <span style="color: rgba(0,0,0,.25);">请先选择字段和操作符</span>
            return;
        }

        var columnType = filter.ColumnType.ToLower();
        var op = filter.Operator;

        // 日期时间类型
        if (columnType is "datetime" or "datetime2" or "date")
        {
            if (op == "RelativeDays")
            {
                <Space Size="@("small")">
                    <SpaceItem>距今</SpaceItem>
                    <SpaceItem>
                        <AntDesign.InputNumber @bind-Value="filter.RelativeDays"
                                               Min="1"
                                               Max="3650"
                                               Placeholder="天数"
                                               @bind-Value:after="UpdateWhereClause"
                                               Style="width: 100px;" />
                    </SpaceItem>
                    <SpaceItem>天以前</SpaceItem>
                </Space>
            }
            else if (op == "DateRange")
            {
                <RangePicker @bind-Value="filter.DateRange"
                             ShowTime="@true"
                             Format="yyyy-MM-dd HH:mm:ss"
                             @bind-Value:after="UpdateWhereClause"
                             Style="width: 100%;" />
            }
            else
            {
                <DatePicker @bind-Value="filter.DateValue"
                            ShowTime="@true"
                            Format="yyyy-MM-dd HH:mm:ss"
                            @bind-Value:after="UpdateWhereClause"
                            Style="width: 100%;" />
            }
        }
        // 数值类型
        else if (columnType is "int" or "bigint" or "decimal" or "numeric" or "float")
        {
            if (op == "Between")
            {
                <Space Size="@("small")">
                    <SpaceItem>
                        <AntDesign.InputNumber @bind-Value="filter.NumericMin"
                                               Placeholder="最小值"
                                               @bind-Value:after="UpdateWhereClause"
                                               Style="width: 120px;" />
                    </SpaceItem>
                    <SpaceItem>至</SpaceItem>
                    <SpaceItem>
                        <AntDesign.InputNumber @bind-Value="filter.NumericMax"
                                               Placeholder="最大值"
                                               @bind-Value:after="UpdateWhereClause"
                                               Style="width: 120px;" />
                    </SpaceItem>
                </Space>
            }
            else
            {
                <AntDesign.InputNumber @bind-Value="filter.NumericValue"
                                       Placeholder="数值"
                                       @bind-Value:after="UpdateWhereClause"
                                       Style="width: 100%;" />
            }
        }
        // 字符串类型
        else
        {
            <Input @bind-Value="filter.StringValue"
                   Placeholder="文本值"
                   AllowClear
                   @bind-Value:after="UpdateWhereClause"
                   OnPressEnter="UpdateWhereClause" />
        }
    };

    /// <summary>
    /// 获取字段类型对应的标签颜色
    /// </summary>
    private string GetColumnTypeColor(string dataType)
    {
        return dataType.ToLower() switch
        {
            "datetime" or "datetime2" or "date" => "blue",
            "int" or "bigint" => "green",
            "decimal" or "numeric" or "float" => "cyan",
            "nvarchar" or "varchar" => "orange",
            _ => "default"
        };
    }

    /// <summary>
    /// 更新 WHERE 子句
    /// </summary>
    private async Task UpdateWhereClause()
    {
        var conditions = new List<string>();

        foreach (var filter in _filters)
        {
            if (string.IsNullOrWhiteSpace(filter.ColumnName) || string.IsNullOrWhiteSpace(filter.Operator))
                continue;

            var condition = GenerateCondition(filter);
            if (!string.IsNullOrWhiteSpace(condition))
                conditions.Add(condition);
        }

        _whereClause = conditions.Any() ? string.Join(" AND ", conditions) : null;
        await WhereClauseChanged.InvokeAsync(_whereClause);

        // 触发行数预估(后台执行,不阻塞)
        if (!string.IsNullOrWhiteSpace(_whereClause))
        {
#pragma warning disable CS4014 // 此调用不等待,后台执行
            EstimateRowCountAsync();
#pragma warning restore CS4014
        }
        else
        {
            _estimatedRowCount = null;
        }

        StateHasChanged();
    }

    /// <summary>
    /// 生成单个条件的 SQL
    /// </summary>
    private string? GenerateCondition(FilterCondition filter)
    {
        if (string.IsNullOrWhiteSpace(filter.ColumnName) || string.IsNullOrWhiteSpace(filter.Operator))
            return null;

        var columnType = filter.ColumnType?.ToLower();
        var col = $"[{filter.ColumnName}]";

        // 日期时间类型
        if (columnType is "datetime" or "datetime2" or "date")
        {
            if (filter.Operator == "RelativeDays" && filter.RelativeDays.HasValue)
            {
                // 归档任务针对旧数据,使用 <= 比较符,筛选出 N 天以前的数据
                return $"{col} <= DATEADD(DAY, -{filter.RelativeDays.Value}, GETDATE())";
            }
            else if (filter.Operator == "DateRange" && filter.DateRange != null)
            {
                var start = filter.DateRange[0]?.ToString("yyyy-MM-dd HH:mm:ss");
                var end = filter.DateRange[1]?.ToString("yyyy-MM-dd HH:mm:ss");
                if (!string.IsNullOrEmpty(start) && !string.IsNullOrEmpty(end))
                    return $"{col} BETWEEN '{start}' AND '{end}'";
            }
            else if (filter.Operator == "LessThan" && filter.DateValue.HasValue)
            {
                return $"{col} < '{filter.DateValue.Value:yyyy-MM-dd HH:mm:ss}'";
            }
            else if (filter.Operator == "GreaterThan" && filter.DateValue.HasValue)
            {
                return $"{col} > '{filter.DateValue.Value:yyyy-MM-dd HH:mm:ss}'";
            }
        }
        // 数值类型
        else if (columnType is "int" or "bigint" or "decimal" or "numeric" or "float")
        {
            if (filter.Operator == "Between" && filter.NumericMin.HasValue && filter.NumericMax.HasValue)
            {
                return $"{col} BETWEEN {filter.NumericMin.Value} AND {filter.NumericMax.Value}";
            }
            else if (filter.NumericValue.HasValue)
            {
                return filter.Operator switch
                {
                    "Equals" => $"{col} = {filter.NumericValue.Value}",
                    "NotEquals" => $"{col} <> {filter.NumericValue.Value}",
                    "GreaterThan" => $"{col} > {filter.NumericValue.Value}",
                    "GreaterThanOrEqual" => $"{col} >= {filter.NumericValue.Value}",
                    "LessThan" => $"{col} < {filter.NumericValue.Value}",
                    "LessThanOrEqual" => $"{col} <= {filter.NumericValue.Value}",
                    _ => null
                };
            }
        }
        // 字符串类型
        else if (!string.IsNullOrWhiteSpace(filter.StringValue))
        {
            var escaped = filter.StringValue.Replace("'", "''");
            return filter.Operator switch
            {
                "Equals" => $"{col} = N'{escaped}'",
                "NotEquals" => $"{col} <> N'{escaped}'",
                "Contains" => $"{col} LIKE N'%{escaped}%'",
                "StartsWith" => $"{col} LIKE N'{escaped}%'",
                "EndsWith" => $"{col} LIKE N'%{escaped}'",
                _ => null
            };
        }

        return null;
    }

    /// <summary>
    /// 预估影响的行数
    /// </summary>
    private async Task EstimateRowCountAsync()
    {
        if (string.IsNullOrWhiteSpace(SourceSchema) || string.IsNullOrWhiteSpace(SourceTable) || string.IsNullOrWhiteSpace(_whereClause))
            return;

        _isEstimating = true;
        StateHasChanged();

        try
        {
            // TODO: 调用后端 API 执行 COUNT(*) 查询
            // 临时模拟
            await Task.Delay(500);
            _estimatedRowCount = new Random().Next(1000, 5000000);
        }
        catch (Exception ex)
        {
            Message.Error($"预估行数失败: {ex.Message}");
            _estimatedRowCount = null;
        }
        finally
        {
            _isEstimating = false;
            StateHasChanged();
        }
    }

    /// <summary>
    /// 复制 WHERE 子句到剪贴板
    /// </summary>
    private void CopyWhereClause()
    {
        // TODO: 调用 JS Interop 复制到剪贴板
        Message.Success("WHERE 子句已复制到剪贴板");
    }

    /// <summary>
    /// 表字段信息
    /// </summary>
    private class TableColumnInfo
    {
        public string ColumnName { get; set; } = string.Empty;
        public string DataType { get; set; } = string.Empty;
        public bool HasIndex { get; set; }
        public string DisplayName { get; set; } = string.Empty;
    }

    /// <summary>
    /// 筛选条件模型
    /// </summary>
    private class FilterCondition
    {
        /// <summary>字段名</summary>
        public string? ColumnName { get; set; }
        
        /// <summary>字段数据类型</summary>
        public string? ColumnType { get; set; }
        
        /// <summary>操作符</summary>
        public string? Operator { get; set; }

        // 日期时间值
        public int? RelativeDays { get; set; }
        public DateTime?[]? DateRange { get; set; }
        public DateTime? DateValue { get; set; }

        // 数值
        public decimal? NumericValue { get; set; }
        public decimal? NumericMin { get; set; }
        public decimal? NumericMax { get; set; }

        // 字符串
        public string? StringValue { get; set; }
    }

    /// <summary>
    /// 操作符选项
    /// </summary>
    private record OperatorOption(string Value, string Label);

    /// <summary>
    /// 获取所有筛选条件的字段名列表（用于外部组件获取）
    /// </summary>
    public List<string> GetFilterColumns()
    {
        return _filters
            .Where(f => !string.IsNullOrWhiteSpace(f.ColumnName))
            .Select(f => f.ColumnName!)
            .Distinct()
            .ToList();
    }

    /// <summary>
    /// 获取第一个筛选条件的字段名（通常用于归档任务的主筛选字段）
    /// </summary>
    public string? GetPrimaryFilterColumn()
    {
        return _filters.FirstOrDefault(f => !string.IsNullOrWhiteSpace(f.ColumnName))?.ColumnName;
    }

    /// <summary>
    /// 导出筛选条件定义为 JSON 字符串(用于保存到数据库)
    /// </summary>
    public string? ExportFilterDefinition()
    {
        try
        {
            var definition = new DbArchiveTool.Web.Models.FilterDefinition
            {
                Version = "1.0",
                Filters = _filters.Select(f => new DbArchiveTool.Web.Models.FilterConditionDto
                {
                    FieldName = f.ColumnName ?? string.Empty,
                    Operator = f.Operator ?? string.Empty,
                    Value = GetConditionValue(f),
                    ValueEnd = GetConditionValueEnd(f),
                    LogicalOperator = "AND" // 当前版本仅支持 AND
                }).ToList()
            };

            return System.Text.Json.JsonSerializer.Serialize(definition);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"导出筛选条件定义失败: {ex.Message}");
            return null;
        }
    }

    /// <summary>
    /// 从 JSON 字符串加载筛选条件定义(用于编辑时还原表单)
    /// </summary>
    public async Task LoadFromDefinition(string? json)
    {
        if (string.IsNullOrWhiteSpace(json))
        {
            Console.WriteLine("筛选条件 JSON 为空，跳过加载");
            return;
        }

        try
        {
            Console.WriteLine($"=== 开始加载筛选条件 ===");
            Console.WriteLine($"JSON: {json}");
            Console.WriteLine($"列数据状态: {(_availableColumns?.Count ?? 0)} 列");
            
            // 如果列数据还未加载，等待一下
            if (_availableColumns == null || _availableColumns.Count == 0)
            {
                Console.WriteLine("列数据未加载，等待 500ms...");
                await Task.Delay(500);
                Console.WriteLine($"等待后列数据状态: {(_availableColumns?.Count ?? 0)} 列");
            }
            
            var definition = System.Text.Json.JsonSerializer.Deserialize<DbArchiveTool.Web.Models.FilterDefinition>(json);
            if (definition == null || definition.Filters.Count == 0)
            {
                Console.WriteLine("反序列化失败或没有条件");
                return;
            }

            Console.WriteLine($"解析到 {definition.Filters.Count} 个筛选条件");
            _filters.Clear();
            
            foreach (var dto in definition.Filters)
            {
                Console.WriteLine($"\n处理条件: FieldName={dto.FieldName}, Operator={dto.Operator}, Value={dto.Value}, ValueEnd={dto.ValueEnd}");
                
                var filter = new FilterCondition
                {
                    ColumnName = dto.FieldName,
                    Operator = dto.Operator
                };
                Console.WriteLine($"  创建 FilterCondition，Operator 已设置为: {filter.Operator}");

                // 根据字段名推断类型
                var column = _availableColumns?.FirstOrDefault(c => c.ColumnName == dto.FieldName);
                if (column != null)
                {
                    filter.ColumnType = column.DataType;
                    Console.WriteLine($"  找到列信息: {column.ColumnName} ({column.DataType})");
                    Console.WriteLine($"  设置 ColumnType 后，Operator 仍为: {filter.Operator}");
                }
                else
                {
                    Console.WriteLine($"  警告: 未找到列 '{dto.FieldName}', 可用列: {string.Join(", ", _availableColumns?.Select(c => c.ColumnName) ?? new List<string>())}");
                }

                // 恢复值
                RestoreConditionValue(filter, dto.Value, dto.ValueEnd);
                Console.WriteLine($"  恢复值后: RelativeDays={filter.RelativeDays}, DateValue={filter.DateValue}, NumericValue={filter.NumericValue}, StringValue={filter.StringValue}");
                Console.WriteLine($"  恢复值后 Operator 仍为: {filter.Operator}");
                
                _filters.Add(filter);
                Console.WriteLine($"  已添加到 _filters，当前 Operator: {filter.Operator}");
            }

            Console.WriteLine($"\n筛选条件加载完成，当前 {_filters.Count} 个条件");
            UpdateWhereClause();
            await InvokeAsync(StateHasChanged);
            Console.WriteLine("=== 筛选条件加载结束 ===");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"\u274c 加载筛选条件定义失败: {ex.Message}\n{ex.StackTrace}");
        }
    }

    /// <summary>
    /// 获取条件的值(用于序列化)
    /// </summary>
    private string? GetConditionValue(FilterCondition filter)
    {
        if (filter.Operator is "IS NULL" or "IS NOT NULL")
            return null;

        if (filter.ColumnType?.Contains("date", StringComparison.OrdinalIgnoreCase) == true)
        {
            if (filter.RelativeDays.HasValue)
                return $"RELATIVE:{filter.RelativeDays}";
            if (filter.DateValue.HasValue)
                return filter.DateValue.Value.ToString("yyyy-MM-dd HH:mm:ss");
            if (filter.DateRange?.Length == 2 && filter.DateRange[0].HasValue)
                return filter.DateRange[0].Value.ToString("yyyy-MM-dd HH:mm:ss");
        }
        else if (filter.ColumnType?.Contains("int", StringComparison.OrdinalIgnoreCase) == true || 
                 filter.ColumnType?.Contains("decimal", StringComparison.OrdinalIgnoreCase) == true ||
                 filter.ColumnType?.Contains("numeric", StringComparison.OrdinalIgnoreCase) == true ||
                 filter.ColumnType?.Contains("float", StringComparison.OrdinalIgnoreCase) == true)
        {
            if (filter.NumericValue.HasValue)
                return filter.NumericValue.Value.ToString();
            if (filter.NumericMin.HasValue)
                return filter.NumericMin.Value.ToString();
        }
        else
        {
            return filter.StringValue;
        }

        return null;
    }

    /// <summary>
    /// 获取条件的结束值(用于 BETWEEN/DateRange 序列化)
    /// </summary>
    private string? GetConditionValueEnd(FilterCondition filter)
    {
        if (filter.Operator?.Equals("Between", StringComparison.OrdinalIgnoreCase) != true && 
            filter.Operator?.Equals("DateRange", StringComparison.OrdinalIgnoreCase) != true)
            return null;

        if (filter.ColumnType?.Contains("date", StringComparison.OrdinalIgnoreCase) == true)
        {
            if (filter.DateRange?.Length == 2 && filter.DateRange[1].HasValue)
                return filter.DateRange[1].Value.ToString("yyyy-MM-dd HH:mm:ss");
        }
        else if (filter.ColumnType?.Contains("int", StringComparison.OrdinalIgnoreCase) == true || 
                 filter.ColumnType?.Contains("decimal", StringComparison.OrdinalIgnoreCase) == true ||
                 filter.ColumnType?.Contains("numeric", StringComparison.OrdinalIgnoreCase) == true ||
                 filter.ColumnType?.Contains("float", StringComparison.OrdinalIgnoreCase) == true)
        {
            if (filter.NumericMax.HasValue)
                return filter.NumericMax.Value.ToString();
        }

        return null;
    }

    /// <summary>
    /// 恢复条件的值(从序列化的字符串)
    /// </summary>
    private void RestoreConditionValue(FilterCondition filter, string? value, string? valueEnd)
    {
        if (string.IsNullOrWhiteSpace(value))
            return;

        if (filter.ColumnType?.Contains("date", StringComparison.OrdinalIgnoreCase) == true)
        {
            // 相对日期
            if (value.StartsWith("RELATIVE:") && int.TryParse(value.Substring(9), out var days))
            {
                filter.RelativeDays = days;
            }
            // 日期范围 (DateRange 操作符)
            else if (filter.Operator?.Equals("DateRange", StringComparison.OrdinalIgnoreCase) == true)
            {
                if (DateTime.TryParse(value, out var start))
                {
                    DateTime? end = null;
                    if (!string.IsNullOrWhiteSpace(valueEnd) && DateTime.TryParse(valueEnd, out var endDate))
                    {
                        end = endDate;
                    }
                    filter.DateRange = new DateTime?[] { start, end };
                }
            }
            // 单个日期 (LessThan, GreaterThan)
            else if (DateTime.TryParse(value, out var date))
            {
                filter.DateValue = date;
            }
        }
        else if (filter.ColumnType?.Contains("int", StringComparison.OrdinalIgnoreCase) == true || 
                 filter.ColumnType?.Contains("decimal", StringComparison.OrdinalIgnoreCase) == true ||
                 filter.ColumnType?.Contains("numeric", StringComparison.OrdinalIgnoreCase) == true ||
                 filter.ColumnType?.Contains("float", StringComparison.OrdinalIgnoreCase) == true)
        {
            // 数值范围 (Between 操作符)
            if (filter.Operator?.Equals("Between", StringComparison.OrdinalIgnoreCase) == true)
            {
                if (decimal.TryParse(value, out var min))
                {
                    filter.NumericMin = min;
                    if (!string.IsNullOrWhiteSpace(valueEnd) && decimal.TryParse(valueEnd, out var max))
                    {
                        filter.NumericMax = max;
                    }
                }
            }
            // 单个数值
            else if (decimal.TryParse(value, out var num))
            {
                filter.NumericValue = num;
            }
        }
        else
        {
            filter.StringValue = value;
        }
    }
}
