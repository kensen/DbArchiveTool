@using AntDesign
@using Cronos
@inject MessageService Message

<div class="cron-builder">
    <div style="display: flex; flex-direction: column; gap: 16px;">
        @* 频率类型选择 *@
        <Card Title="选择调度频率" Size="@CardSize.Small">
            <ChildContent>
                <RadioGroup @bind-Value="_frequencyType" @bind-Value:after="OnConfigChanged" ButtonStyle="@RadioButtonStyle.Solid">
                    <Radio RadioButton Value="@("minute")">每分钟</Radio>
                    <Radio RadioButton Value="@("hourly")">每小时</Radio>
                    <Radio RadioButton Value="@("daily")">每天</Radio>
                    <Radio RadioButton Value="@("weekly")">每周</Radio>
                    <Radio RadioButton Value="@("monthly")">每月</Radio>
                </RadioGroup>
            </ChildContent>
        </Card>

        @* 详细配置区域 *@
        <Card Title="详细配置" Size="@CardSize.Small">
            <ChildContent>
                @if (_frequencyType == "minute")
                {
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span>每</span>
                        <AntDesign.InputNumber @bind-Value="_minuteInterval"
                                               Min="1"
                                               Max="59"
                                               @bind-Value:after="OnConfigChanged"
                                               Style="width: 100px;" />
                        <span>分钟执行一次</span>
                    </div>
                }
                else if (_frequencyType == "hourly")
                {
                    <div style="display: flex; flex-direction: column; gap: 12px;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span>每</span>
                            <AntDesign.InputNumber @bind-Value="_hourInterval"
                                                   Min="1"
                                                   Max="23"
                                                   @bind-Value:after="OnConfigChanged"
                                                   Style="width: 100px;" />
                            <span>小时执行一次</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span>在第</span>
                            <AntDesign.InputNumber @bind-Value="_atMinute"
                                                   Min="0"
                                                   Max="59"
                                                   @bind-Value:after="OnConfigChanged"
                                                   Style="width: 100px;" />
                            <span>分钟</span>
                        </div>
                    </div>
                }
                else if (_frequencyType == "daily")
                {
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span>每天</span>
                        <TimePicker @bind-Value="_dailyTime"
                                    Format="HH:mm"
                                    @bind-Value:after="OnConfigChanged"
                                    Style="width: 120px;" />
                        <span>执行</span>
                    </div>
                }
                else if (_frequencyType == "weekly")
                {
                    <div style="display: flex; flex-direction: column; gap: 12px;">
                        <div>
                            <Text Strong>选择星期几:</Text>
                            <CheckboxGroup @bind-Value="_selectedWeekdays" Options="_weekdayOptions" @bind-Value:after="OnConfigChanged" />
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span>在</span>
                            <TimePicker @bind-Value="_weeklyTime"
                                        Format="HH:mm"
                                        @bind-Value:after="OnConfigChanged"
                                        Style="width: 120px;" />
                            <span>执行</span>
                        </div>
                    </div>
                }
                else if (_frequencyType == "monthly")
                {
                    <div style="display: flex; flex-direction: column; gap: 12px;">
                        <div>
                            <Text Strong>选择日期(可多选):</Text>
                            <CheckboxGroup @bind-Value="_selectedMonthdays" Options="_monthdayOptions" @bind-Value:after="OnConfigChanged" />
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span>在</span>
                            <TimePicker @bind-Value="_monthlyTime"
                                        Format="HH:mm"
                                        @bind-Value:after="OnConfigChanged"
                                        Style="width: 120px;" />
                            <span>执行</span>
                        </div>
                    </div>
                }
            </ChildContent>
        </Card>

        @* Cron 表达式预览 *@
        <Card Title="Cron 表达式" Size="@CardSize.Small">
            <Extra>
                @if (_isValid)
                {
                    <Tag Color="@("green")">有效</Tag>
                }
                else
                {
                    <Tag Color="@("red")">无效</Tag>
                }
            </Extra>
            <ChildContent>
                <div style="display: flex; flex-direction: column; gap: 12px;">
                    <div class="cron-expression">
                        <code>@(_cronExpression ?? "未配置")</code>
                        @if (!string.IsNullOrWhiteSpace(_cronExpression))
                        {
                            <Button Size="@ButtonSize.Small"
                                    Icon="copy"
                                    OnClick="CopyCronExpression"
                                    Style="margin-left: 8px;">
                                复制
                            </Button>
                        }
                    </div>

                    @* 中文语义描述 *@
                    @if (!string.IsNullOrWhiteSpace(_description))
                    {
                        <Alert Type="@AlertType.Info"
                               Message="@_description"
                               ShowIcon="true" />
                    }

                    @* 下次执行时间预览 *@
                    @if (_nextExecution.HasValue)
                    {
                        <Descriptions Bordered Size="@DescriptionsSize.Small" Column="1">
                            <DescriptionsItem Title="下次执行时间">
                                @_nextExecution.Value.ToString("yyyy-MM-dd HH:mm:ss")
                            </DescriptionsItem>
                            <DescriptionsItem Title="距离现在">
                                @GetTimeUntilNext()
                            </DescriptionsItem>
                        </Descriptions>
                    }

                    @* 验证错误消息 *@
                    @if (!string.IsNullOrWhiteSpace(_validationError))
                    {
                        <Alert Type="@AlertType.Error"
                               Message="@_validationError"
                               ShowIcon="true" />
                    }
                </div>
            </ChildContent>
        </Card>
    </div>
</div>

@code {
    /// <summary>
    /// 生成的 Cron 表达式
    /// </summary>
    [Parameter]
    public string? CronExpression { get; set; }

    /// <summary>
    /// Cron 表达式变化事件
    /// </summary>
    [Parameter]
    public EventCallback<string?> CronExpressionChanged { get; set; }

    /// <summary>
    /// 频率类型: minute/hourly/daily/weekly/monthly
    /// </summary>
    private string _frequencyType = "daily";

    // 分钟级配置
    private int _minuteInterval = 5;

    // 小时级配置
    private int _hourInterval = 1;
    private int _atMinute = 0;

    // 每日配置
    private DateTime? _dailyTime = DateTime.Today.AddHours(2).AddMinutes(30); // 默认 02:30

    // 每周配置
    private string[] _selectedWeekdays = new[] { "1" }; // 默认周一
    private DateTime? _weeklyTime = DateTime.Today.AddHours(2).AddMinutes(30);
    private CheckboxOption<string>[] _weekdayOptions = new[]
    {
        new CheckboxOption<string> { Label = "周一", Value = "1" },
        new CheckboxOption<string> { Label = "周二", Value = "2" },
        new CheckboxOption<string> { Label = "周三", Value = "3" },
        new CheckboxOption<string> { Label = "周四", Value = "4" },
        new CheckboxOption<string> { Label = "周五", Value = "5" },
        new CheckboxOption<string> { Label = "周六", Value = "6" },
        new CheckboxOption<string> { Label = "周日", Value = "0" }
    };

    // 每月配置
    private string[] _selectedMonthdays = new[] { "1" }; // 默认每月1号
    private DateTime? _monthlyTime = DateTime.Today.AddHours(2).AddMinutes(30);
    private CheckboxOption<string>[] _monthdayOptions = Enumerable.Range(1, 31)
        .Select(d => new CheckboxOption<string> { Label = $"{d}日", Value = d.ToString() })
        .ToArray();

    // 生成的表达式和状态
    private string? _cronExpression;
    private string? _description;
    private bool _isValid;
    private string? _validationError;
    private DateTime? _nextExecution;

    private bool _restoredFromExternal;

    protected override async Task OnInitializedAsync()
    {
        // 初始化时生成表达式
        GenerateCronExpression();

        // 如果父组件未传入 CronExpression，则将默认生成的表达式回填到父表单
        // 否则用户“切到 Cron 直接保存”会因为父表单仍为空而校验失败。
        if (string.IsNullOrWhiteSpace(CronExpression) && !string.IsNullOrWhiteSpace(_cronExpression))
        {
            await CronExpressionChanged.InvokeAsync(_cronExpression);
        }
    }

    protected override void OnParametersSet()
    {
        // 如果外部传入了表达式,尝试解析
        if (!string.IsNullOrWhiteSpace(CronExpression) && CronExpression != _cronExpression)
        {
            _cronExpression = CronExpression;
            RestoreConfigFromCronExpression(_cronExpression);
            ValidateAndPreview();
        }
    }

    private void RestoreConfigFromCronExpression(string? cronExpression)
    {
        if (string.IsNullOrWhiteSpace(cronExpression))
        {
            return;
        }

        // 只反解析由本组件生成的标准 5 段 Cron：min hour dom month dow
        // 目标：编辑页回显时，UI 频率/配置与 Cron 一致。
        var parts = cronExpression.Trim().Split(' ', StringSplitOptions.RemoveEmptyEntries);
        if (parts.Length != 5)
        {
            return;
        }

        var minutePart = parts[0];
        var hourPart = parts[1];
        var dayOfMonthPart = parts[2];
        var monthPart = parts[3];
        var dayOfWeekPart = parts[4];

        // 每分钟：*/n * * * *
        if (TryParseStepValue(minutePart, out var minuteStep)
            && hourPart == "*" && dayOfMonthPart == "*" && monthPart == "*" && dayOfWeekPart == "*")
        {
            _frequencyType = "minute";
            _minuteInterval = Clamp(minuteStep, 1, 59);
            _restoredFromExternal = true;
            return;
        }

        // 每小时：m */h * * *
        if (TryParseNumber(minutePart, out var atMinute)
            && TryParseStepValue(hourPart, out var hourStep)
            && dayOfMonthPart == "*" && monthPart == "*" && dayOfWeekPart == "*")
        {
            _frequencyType = "hourly";
            _atMinute = Clamp(atMinute, 0, 59);
            _hourInterval = Clamp(hourStep, 1, 23);
            _restoredFromExternal = true;
            return;
        }

        // 每天：m H * * *
        if (TryParseNumber(minutePart, out var dailyMinute)
            && TryParseNumber(hourPart, out var dailyHour)
            && dayOfMonthPart == "*" && monthPart == "*" && dayOfWeekPart == "*")
        {
            _frequencyType = "daily";
            _dailyTime = DateTime.Today.AddHours(Clamp(dailyHour, 0, 23)).AddMinutes(Clamp(dailyMinute, 0, 59));
            _restoredFromExternal = true;
            return;
        }

        // 每周：m H * * dow1,dow2
        if (TryParseNumber(minutePart, out var weeklyMinute)
            && TryParseNumber(hourPart, out var weeklyHour)
            && dayOfMonthPart == "*" && monthPart == "*" && dayOfWeekPart != "*")
        {
            var weekdays = ParseCsvNumbers(dayOfWeekPart, 0, 6);
            if (weekdays.Count > 0)
            {
                _frequencyType = "weekly";
                _weeklyTime = DateTime.Today.AddHours(Clamp(weeklyHour, 0, 23)).AddMinutes(Clamp(weeklyMinute, 0, 59));
                _selectedWeekdays = weekdays.Select(d => d.ToString()).ToArray();
                _restoredFromExternal = true;
            }
            return;
        }

        // 每月：m H dom1,dom2 * *
        if (TryParseNumber(minutePart, out var monthlyMinute)
            && TryParseNumber(hourPart, out var monthlyHour)
            && dayOfMonthPart != "*" && monthPart == "*" && dayOfWeekPart == "*")
        {
            var monthdays = ParseCsvNumbers(dayOfMonthPart, 1, 31);
            if (monthdays.Count > 0)
            {
                _frequencyType = "monthly";
                _monthlyTime = DateTime.Today.AddHours(Clamp(monthlyHour, 0, 23)).AddMinutes(Clamp(monthlyMinute, 0, 59));
                _selectedMonthdays = monthdays.Select(d => d.ToString()).ToArray();
                _restoredFromExternal = true;
            }
            return;
        }
    }

    private static bool TryParseStepValue(string value, out int step)
    {
        step = 0;
        if (string.IsNullOrWhiteSpace(value))
        {
            return false;
        }

        // */n
        if (!value.StartsWith("*/", StringComparison.Ordinal))
        {
            return false;
        }

        return int.TryParse(value[2..], out step);
    }

    private static bool TryParseNumber(string value, out int number)
    {
        number = 0;
        if (string.IsNullOrWhiteSpace(value))
        {
            return false;
        }

        return int.TryParse(value, out number);
    }

    private static List<int> ParseCsvNumbers(string value, int min, int max)
    {
        var results = new List<int>();
        if (string.IsNullOrWhiteSpace(value))
        {
            return results;
        }

        foreach (var token in value.Split(',', StringSplitOptions.RemoveEmptyEntries))
        {
            if (!int.TryParse(token.Trim(), out var number))
            {
                continue;
            }

            if (number < min || number > max)
            {
                continue;
            }

            results.Add(number);
        }

        return results.Distinct().OrderBy(x => x).ToList();
    }

    private static int Clamp(int value, int min, int max)
    {
        if (value < min)
        {
            return min;
        }

        if (value > max)
        {
            return max;
        }

        return value;
    }

    /// <summary>
    /// 配置变化时触发
    /// </summary>
    private async Task OnConfigChanged()
    {
        GenerateCronExpression();
        await CronExpressionChanged.InvokeAsync(_cronExpression);
    }

    /// <summary>
    /// 生成 Cron 表达式
    /// </summary>
    private void GenerateCronExpression()
    {
        try
        {
            // Cron 表达式直接使用本地时间，不做时区转换
            // 后端调度器（Quartz、Hangfire等）会按服务器本地时间执行
            _cronExpression = _frequencyType switch
            {
                "minute" => $"*/{_minuteInterval} * * * *",
                "hourly" => $"{_atMinute} */{_hourInterval} * * *",
                "daily" => _dailyTime.HasValue 
                    ? $"{_dailyTime.Value.Minute} {_dailyTime.Value.Hour} * * *"
                    : null,
                "weekly" => _weeklyTime.HasValue && _selectedWeekdays.Any()
                    ? $"{_weeklyTime.Value.Minute} {_weeklyTime.Value.Hour} * * {string.Join(",", _selectedWeekdays.OrderBy(w => w))}"
                    : null,
                "monthly" => _monthlyTime.HasValue && _selectedMonthdays.Any()
                    ? $"{_monthlyTime.Value.Minute} {_monthlyTime.Value.Hour} {string.Join(",", _selectedMonthdays.Select(int.Parse).OrderBy(d => d))} * *"
                    : null,
                _ => null
            };

            ValidateAndPreview();
        }
        catch (Exception ex)
        {
            _isValid = false;
            _validationError = $"生成失败: {ex.Message}";
            _description = null;
            _nextExecution = null;
        }
    }

    /// <summary>
    /// 验证并预览表达式
    /// </summary>
    private void ValidateAndPreview()
    {
        if (string.IsNullOrWhiteSpace(_cronExpression))
        {
            _isValid = false;
            _validationError = "Cron 表达式为空";
            _description = null;
            _nextExecution = null;
            return;
        }

        try
        {
            var expression = Cronos.CronExpression.Parse(_cronExpression, CronFormat.Standard);
            _isValid = true;
            _validationError = null;

            // 生成中文描述
            _description = GenerateDescription();

            // 计算下次执行时间
            // 重要：Cron 表达式是按服务器/本机“本地时间”语义生成的，预览也必须按本地时区计算。
            // Cronos 的 GetNextOccurrence(fromUtc, timeZone) 输入必须是 UTC，并按 timeZone 的本地时间规则求下次触发点。
            // 注意：该方法返回的是“UTC 时间点”（而不是本地时间），因此需要显式转换成本地时间用于显示与差值计算。
            var nextUtc = expression.GetNextOccurrence(DateTime.UtcNow, TimeZoneInfo.Local);
            if (nextUtc.HasValue)
            {
                var nextLocal = TimeZoneInfo.ConvertTimeFromUtc(nextUtc.Value, TimeZoneInfo.Local);
                _nextExecution = DateTime.SpecifyKind(nextLocal, DateTimeKind.Local);
            }
            else
            {
                _nextExecution = null;
            }
        }
        catch (Exception ex)
        {
            _isValid = false;
            _validationError = $"无效的 Cron 表达式: {ex.Message}";
            _description = null;
            _nextExecution = null;
        }
    }

    /// <summary>
    /// 生成中文语义描述
    /// </summary>
    private string GenerateDescription()
    {
        return _frequencyType switch
        {
            "minute" => $"每 {_minuteInterval} 分钟执行一次",
            "hourly" => $"每 {_hourInterval} 小时的第 {_atMinute} 分钟执行",
            "daily" => _dailyTime.HasValue 
                ? $"每天 {_dailyTime.Value:HH:mm} 执行"
                : "未配置",
            "weekly" => _weeklyTime.HasValue && _selectedWeekdays.Any()
                ? $"每周 {string.Join("、", _selectedWeekdays.Select(GetWeekdayName))} {_weeklyTime.Value:HH:mm} 执行"
                : "未配置",
            "monthly" => _monthlyTime.HasValue && _selectedMonthdays.Any()
                ? $"每月 {string.Join("、", _selectedMonthdays.Select(d => $"{d}日"))} {_monthlyTime.Value:HH:mm} 执行"
                : "未配置",
            _ => "未知频率"
        };
    }

    /// <summary>
    /// 获取星期几的名称
    /// </summary>
    private string GetWeekdayName(string dayValue)
    {
        return dayValue switch
        {
            "0" => "周日",
            "1" => "周一",
            "2" => "周二",
            "3" => "周三",
            "4" => "周四",
            "5" => "周五",
            "6" => "周六",
            _ => dayValue
        };
    }

    /// <summary>
    /// 获取距离下次执行的时间描述
    /// </summary>
    private string GetTimeUntilNext()
    {
        if (!_nextExecution.HasValue)
            return "N/A";

        // _nextExecution 已经是本地时间，直接与 DateTime.Now 比较
        var span = _nextExecution.Value - DateTime.Now;
        
        // 如果时间已过（可能因为计算误差），显示为即将执行
        if (span.TotalSeconds < 0)
            return "即将执行";
            
        if (span.TotalDays >= 1)
            return $"{(int)span.TotalDays} 天 {span.Hours} 小时";
        if (span.TotalHours >= 1)
            return $"{(int)span.TotalHours} 小时 {span.Minutes} 分钟";
        if (span.TotalMinutes >= 1)
            return $"{(int)span.TotalMinutes} 分钟 {span.Seconds} 秒";
        return $"{(int)span.TotalSeconds} 秒";
    }

    /// <summary>
    /// 复制 Cron 表达式
    /// </summary>
    private void CopyCronExpression()
    {
        // TODO: 调用 JS Interop 复制到剪贴板
        Message.Success("Cron 表达式已复制到剪贴板");
    }
}
