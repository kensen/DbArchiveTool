@using AntDesign
@using DbArchiveTool.Application.Partitions
@using DbArchiveTool.Web.Services
@using Microsoft.AspNetCore.Components.Web

<Drawer Visible="Visible"
        Title="@(Title)"
        Width="820"
        Placement="DrawerPlacement.Right"
        Closable="true"
        MaskClosable="false"
        OnClose="CloseAsync">
    <Spin Spinning="@(_initializing || _submitting || _autoFixExecuting)">
        <div class="archive-wizard-body">
            <Descriptions Column="1" Size="@DescriptionsSize.Small" Bordered Style="margin-bottom:16px;">
                <DescriptionsItem Title="数据源">@DataSourceId</DescriptionsItem>
                <DescriptionsItem Title="归档表">@FormatTableName()</DescriptionsItem>
                <DescriptionsItem Title="分区编号">@DisplayPartitionKey()</DescriptionsItem>
            </Descriptions>

            <Steps Current="@_currentStep" Size="@StepsSize.Small" Style="margin-bottom:24px;">
                <Step Title="选择方案" Description="确认归档方式" />
                <Step Title="填写参数" Description="配置切换参数" />
                <Step Title="预检结果" Description="确认自动补齐" />
                <Step Title="执行确认" Description="提交后台任务" />
            </Steps>

            <div class="archive-step-content">
                @switch (_currentStep)
                {
                    case 0:
                        <div class="step-pane">
                            <RadioGroup Value="_selectedMode" 
                                        ValueChanged="@(async (ArchiveMode value) => await OnArchiveModeChangedAsync(value))"
                                        ButtonStyle="@RadioButtonStyle.Solid">
                                <Radio RadioButton Value="@ArchiveMode.Switch" Disabled="@IsSwitchModeDisabled()">分区切换</Radio>
                                <Radio RadioButton Value="@ArchiveMode.Bcp">BCP</Radio>
                                <Radio RadioButton Value="@ArchiveMode.BulkCopy">BulkCopy</Radio>
                            </RadioGroup>
                            
                            @if (IsSwitchModeDisabled())
                            {
                                <Alert Type="@AlertType.Warning" ShowIcon="true" Style="margin-top:12px;">
                                    <MessageTemplate>
                                        @GetSwitchDisabledReason()
                                    </MessageTemplate>
                                </Alert>
                            }
                            
                            @if (_loadingArchiveConfig)
                            {
                                <div style="margin-top:12px;">
                                    <Spin Tip="正在加载归档配置..." />
                                </div>
                            }
                            
                            @if (_selectedMode == ArchiveMode.Switch)
                            {
                                <Alert Type="@AlertType.Info" ShowIcon="true" Style="margin-top:16px;">
                                    <MessageTemplate>
                                        <p><strong>适用场景：</strong>需要将历史分区快速迁移到归档表，并保持源/目标表结构一致的场景，例如月度或季度归档。</p>
                                        <p><strong>前置条件：</strong></p>
                                        <ul>
                                            <li>源表与目标表使用同一分区方案，主键及所有索引均包含分区列。</li>
                                            <li>目标分区为空，或已通过自动补齐步骤清理残留数据。</li>
                                            <li>切换期间业务允许短暂的排他锁；建议在维护窗口执行，并提前完成备份。</li>
                                        </ul>
                                    </MessageTemplate>
                                </Alert>
                            }
                            else if (_selectedMode == ArchiveMode.Bcp)
                            {
                                <Alert Type="@AlertType.Info" ShowIcon="true" Style="margin-top:16px;">
                                    <MessageTemplate>
                                        <p><strong>适用场景：</strong>通过文件中转进行数据归档，适用于跨服务器、跨网络环境的归档场景。</p>
                                        <p><strong>优势：</strong></p>
                                        <ul>
                                            <li>支持跨服务器归档，支持原生数据格式导出导入，性能优秀。</li>
                                            <li>适合大批量数据迁移(百万级以上)，100万行数据导出/导入均在60秒内完成。</li>
                                            <li>生成中间文件，便于审计和问题排查。</li>
                                        </ul>
                                        <p><strong>前置条件：</strong></p>
                                        <ul>
                                            <li>需要 bulkadmin 或 sysadmin 服务器权限。</li>
                                            <li>系统需安装 SQL Server 客户端工具(包含 bcp.exe)。</li>
                                            <li>确保有足够的磁盘空间存放临时文件。</li>
                                        </ul>
                                    </MessageTemplate>
                                </Alert>
                            }
                            else if (_selectedMode == ArchiveMode.BulkCopy)
                            {
                                <Alert Type="@AlertType.Info" ShowIcon="true" Style="margin-top:16px;">
                                    <MessageTemplate>
                                        <p><strong>适用场景：</strong>流式数据传输，无需生成中间文件，适合局域网内高速归档。</p>
                                        <p><strong>优势：</strong></p>
                                        <ul>
                                            <li>基于 SqlBulkCopy API，性能优秀，100万行数据2分钟内完成(局域网)。</li>
                                            <li>无需中间文件，节省磁盘空间，内存占用低。</li>
                                            <li>仅需 INSERT 权限，权限要求低于 BCP。</li>
                                            <li>支持实时进度显示和断点续传(可选)。</li>
                                        </ul>
                                        <p><strong>前置条件：</strong></p>
                                        <ul>
                                            <li>源和目标数据库需要网络可达。</li>
                                            <li>需要对目标表有 INSERT 权限。</li>
                                            <li>建议在局域网环境中使用，外网传输速度会受网络带宽影响。</li>
                                        </ul>
                                    </MessageTemplate>
                                </Alert>
                            }
                        </div>
                        break;
                    case 1:
                        <div class="step-pane">
                            @if (_loadingConfigurations)
                            {
                                <Skeleton Active />
                            }
                            else
                            {
                                @* 显示目标服务器信息 *@
                                @if (_currentDataSource != null)
                                {
                                    <Alert Type="@AlertType.Info" ShowIcon="true" Style="margin-bottom:16px;">
                                        <MessageTemplate>
                                            <h4 style="margin-bottom:8px;">目标服务器连接信息</h4>
                                            <Descriptions Column="2" Size="@DescriptionsSize.Small" Bordered>
                                                <DescriptionsItem Title="源服务器">@GetSourceServerDisplay()</DescriptionsItem>
                                                <DescriptionsItem Title="源数据库">@_currentDataSource.DatabaseName</DescriptionsItem>
                                                <DescriptionsItem Title="目标服务器">@GetTargetServerDisplay()</DescriptionsItem>
                                                <DescriptionsItem Title="目标数据库">@(_form.TargetDatabase ?? _currentDataSource.DatabaseName)</DescriptionsItem>
                                            </Descriptions>
                                        </MessageTemplate>
                                    </Alert>
                                }
                                
                                <Form Model="_form" Layout="FormLayout.Vertical">
                                    @if (_configurationOptions.Any())
                                    {
                                        <FormItem Label="分区配置（可选）">
                                            <Select TItem="Guid?" TItemValue="Guid?"
                                                    @bind-Value="SelectedConfigurationId"
                                                    Placeholder="选择已保存的配置（可跳过）"
                                                    AllowClear>
                                                @foreach (var option in _configurationOptions)
                                                {
                                                    <SelectOption Value="@((Guid?)option.Id)" Label="@option.Display" />
                                                }
                                            </Select>
                                            @if (_selectedConfiguration is not null)
                                            {
                                                <div class="form-tip">目标表默认值：@_selectedConfiguration.TargetDisplay</div>
                                            }
                                            else
                                            {
                                                <div class="form-tip">未选择配置时，将直接使用源表信息进行归档</div>
                                            }
                                        </FormItem>
                                    }
                                    else
                                    {
                                        <Alert Type="@AlertType.Info" ShowIcon="true" Style="margin-bottom:16px;">
                                            <MessageTemplate>
                                                <p>未找到已保存的配置，将直接使用源表 <strong>@FormatTableName()</strong> 进行归档。</p>
                                            </MessageTemplate>
                                        </Alert>
                                    }
                                    <FormItem Label="源分区编号" Required>
                                        <Input @bind-Value="_form.SourcePartitionKey" Placeholder="输入分区号（整数）" />
                                        <div class="form-tip">来自 SQL Server 的分区编号（SELECT $PARTITION... 返回的值）。</div>
                                    </FormItem>
                                    <FormItem Label="目标数据库">
                                        <Input @bind-Value="_form.TargetDatabase" Placeholder="默认使用源数据库" />
                                    </FormItem>
                                    <FormItem Label="目标表名称" Required>
                                        <Input @bind-Value="_form.TargetTable" Placeholder="例如: dbo.ArchiveOrders" />
                                        <div class="form-tip">支持输入三段格式 [database].[schema].[table]。</div>
                                    </FormItem>
                                    @* Switch模式专用参数 *@
                                    @if (_selectedMode == ArchiveMode.Switch)
                                    {
                                        <FormItem Label="创建临时表">
                                            <Switch @bind-Checked="_form.CreateStagingTable" />
                                            <div class="form-tip">如目标表不存在或需要调换文件组，可按需创建临时表再切换。</div>
                                        </FormItem>
                                    }

                                    @* BCP模式专用参数 *@
                                    @if (_selectedMode == ArchiveMode.Bcp)
                                    {
                                        <Divider>BCP 归档参数</Divider>
                                        
                                        @if (_loadedArchiveConfig != null)
                                        {
                                            <Alert Type="@AlertType.Success" ShowIcon="true" Style="margin-bottom:16px;">
                                                <MessageTemplate>
                                                    <Text>已自动加载归档配置: <strong>@_loadedArchiveConfig.Name</strong></Text>
                                                </MessageTemplate>
                                            </Alert>
                                        }

                                        <FormItem Label="临时文件目录">
                                            <Input @bind-Value="_form.BcpTempDirectory" Placeholder="默认使用系统临时目录" />
                                            <div class="form-tip">BCP 导出文件存放位置，需确保有足够的磁盘空间。</div>
                                        </FormItem>

                                        <FormItem Label="批次大小">
                                            <AntDesign.InputNumber @bind-Value="_form.BcpBatchSize" Min="1000" Max="100000" Step="1000" Style="width:200px;" />
                                            <div class="form-tip">每批提交的行数，建议 5000-20000。</div>
                                        </FormItem>

                                        <FormItem Label="使用原生格式">
                                            <Switch @bind-Checked="_form.BcpUseNativeFormat" />
                                            <div class="form-tip">原生格式性能更优，但仅支持SQL Server间传输。</div>
                                        </FormItem>

                                        <FormItem Label="最大错误数">
                                            <AntDesign.InputNumber @bind-Value="_form.BcpMaxErrors" Min="0" Max="1000" Style="width:200px;" />
                                            <div class="form-tip">允许的最大错误数，超过后将中止归档。0表示不允许错误。</div>
                                        </FormItem>

                                        <FormItem Label="超时时间(秒)">
                                            <AntDesign.InputNumber @bind-Value="_form.BcpTimeoutSeconds" Min="60" Max="86400" Step="60" Style="width:200px;" />
                                            <div class="form-tip">BCP 命令超时时间，大表归档建议设置为 3600 秒(1小时)或更长。</div>
                                        </FormItem>
                                    }

                                    @* BulkCopy模式专用参数 *@
                                    @if (_selectedMode == ArchiveMode.BulkCopy)
                                    {
                                        <Divider>BulkCopy 归档参数</Divider>
                                        
                                        @if (_loadedArchiveConfig != null)
                                        {
                                            <Alert Type="@AlertType.Success" ShowIcon="true" Style="margin-bottom:16px;">
                                                <MessageTemplate>
                                                    <Text>已自动加载归档配置: <strong>@_loadedArchiveConfig.Name</strong></Text>
                                                </MessageTemplate>
                                            </Alert>
                                        }

                                        <FormItem Label="批次大小">
                                            <AntDesign.InputNumber @bind-Value="_form.BulkCopyBatchSize" Min="1000" Max="100000" Step="1000" Style="width:200px;" />
                                            <div class="form-tip">每批提交的行数，建议 5000-20000。</div>
                                        </FormItem>

                                        <FormItem Label="进度通知间隔(行)">
                                            <AntDesign.InputNumber @bind-Value="_form.BulkCopyNotifyAfterRows" Min="1000" Max="1000000" Step="10000" Style="width:200px;" />
                                            <div class="form-tip">每传输N行后触发进度通知，用于实时显示进度。</div>
                                        </FormItem>

                                        <FormItem Label="超时时间(秒)">
                                            <AntDesign.InputNumber @bind-Value="_form.BulkCopyTimeoutSeconds" Min="60" Max="86400" Step="60" Style="width:200px;" />
                                            <div class="form-tip">BulkCopy 超时时间，大表归档建议设置为 3600 秒(1小时)或更长。</div>
                                        </FormItem>

                                        <FormItem Label="启用流式读取">
                                            <Switch @bind-Checked="_form.BulkCopyEnableStreaming" />
                                            <div class="form-tip">流式读取可降低内存占用，推荐开启。</div>
                                        </FormItem>
                                    }
                                </Form>
                            }
                        </div>
                        break;
                    case 2:
                        <div class="step-pane">
                            @* 显示当前归档模式和目标服务器信息 *@
                            <Alert Type="@AlertType.Info" ShowIcon="true" Style="margin-bottom:16px;">
                                <MessageTemplate>
                                    <div style="display:flex; justify-content:space-between; align-items:center;">
                                        <div>
                                            <strong>当前归档模式:</strong><span style="color:#1890ff; font-weight:600; margin-left:8px;">@GetArchiveModeDisplayText()</span>
                                        </div>
                                        @if (_currentDataSource != null)
                                        {
                                            <div>
                                                <strong>目标服务器:</strong><span style="margin-left:8px;">@GetTargetServerDisplay()</span>
                                            </div>
                                        }
                                    </div>
                                </MessageTemplate>
                            </Alert>
                            
                            @* BCP/BulkCopy模式的预检结果 *@
                            @if (_selectedMode == ArchiveMode.Bcp || _selectedMode == ArchiveMode.BulkCopy)
                            {
                                var currentInspection = _selectedMode == ArchiveMode.Bcp ? _bcpInspectionResult : _bulkCopyInspectionResult;
                                
                                if (currentInspection != null)
                                {
                                    @* 总体检查结果 *@
                                    <Alert Message="@(currentInspection.CanExecute ? "预检通过，可以执行归档" : "存在阻塞问题，无法执行归档")"
                                           Type="@(currentInspection.CanExecute ? AlertType.Success : AlertType.Error)"
                                           ShowIcon="true"
                                           Style="margin-bottom:16px;" />

                                    @* 阻塞问题 *@
                                    @if (currentInspection.BlockingIssues.Any())
                                    {
                                        <div class="inspection-section">
                                            <h4>阻塞问题</h4>
                                            <Alert Type="@AlertType.Error" ShowIcon="true">
                                                <MessageTemplate>
                                                    <ul class="issue-list">
                                                        @foreach (var issue in currentInspection.BlockingIssues)
                                                        {
                                                            <li>
                                                                <strong>@issue.Code</strong> - @issue.Message
                                                                @if (!string.IsNullOrWhiteSpace(issue.Recommendation))
                                                                {
                                                                    <div class="issue-recommendation">
                                                                        <div style="margin-top: 8px; font-weight: 500;">建议：</div>
                                                                        <pre style="white-space: pre-wrap; word-wrap: break-word; font-family: inherit; margin: 4px 0 0 0;">@issue.Recommendation</pre>
                                                                    </div>
                                                                }
                                                            </li>
                                                        }
                                                    </ul>
                                                </MessageTemplate>
                                            </Alert>
                                        </div>
                                    }

                                    @* 警告信息 *@
                                    @if (currentInspection.Warnings.Any())
                                    {
                                        <div class="inspection-section">
                                            <h4>警告信息</h4>
                                            <Alert Type="@AlertType.Warning" ShowIcon="true">
                                                <MessageTemplate>
                                                    <ul class="issue-list">
                                                        @foreach (var warning in currentInspection.Warnings)
                                                        {
                                                            <li>
                                                                <strong>@warning.Code</strong> - @warning.Message
                                                                @if (!string.IsNullOrWhiteSpace(warning.Recommendation))
                                                                {
                                                                    <div class="issue-recommendation">
                                                                        <div style="margin-top: 8px; font-weight: 500;">建议：</div>
                                                                        <pre style="white-space: pre-wrap; word-wrap: break-word; font-family: inherit; margin: 4px 0 0 0;">@warning.Recommendation</pre>
                                                                    </div>
                                                                }
                                                            </li>
                                                        }
                                                    </ul>
                                                </MessageTemplate>
                                            </Alert>
                                        </div>
                                    }

                                    @* 自动修复建议 *@
                                    @if (currentInspection.AutoFixSteps.Any())
                                    {
                                        <div class="inspection-section">
                                            <h4>可自动修复</h4>
                                            <Alert Type="@AlertType.Info" ShowIcon="true">
                                                <MessageTemplate>
                                                    <p>系统可以自动执行以下修复操作:</p>
                                                    <ul class="issue-list">
                                                        @foreach (var step in currentInspection.AutoFixSteps)
                                                        {
                                                            <li>
                                                                <strong>@step.Code</strong> - @step.Description
                                                                @if (!string.IsNullOrWhiteSpace(step.Action))
                                                                {
                                                                    <div class="autofix-action">操作：@step.Action</div>
                                                                }
                                                            </li>
                                                        }
                                                    </ul>
                                                    @* 只有当修复步骤是 CREATE_TARGET_TABLE 时才显示一键修复按钮 *@
                                                    @if (currentInspection.AutoFixSteps.Any(s => s.Code == "CREATE_TARGET_TABLE"))
                                                    {
                                                        <p style="margin-top:8px;">
                                                            <Button Type="@ButtonType.Primary" Size="@ButtonSize.Small" 
                                                                    OnClick="@OnBcpAutoFixClickedAsync"
                                                                    Loading="_autoFixExecuting">
                                                                一键修复
                                                            </Button>
                                                        </p>
                                                    }
                                                </MessageTemplate>
                                            </Alert>
                                        </div>
                                    }
                                }
                                
                                @* 服务器连接信息 *@
                                @if (_currentDataSource != null)
                                {
                                    <div class="inspection-section" style="margin-bottom:16px;">
                                        <h4>目标服务器信息</h4>
                                        <Descriptions Column="2" Size="@DescriptionsSize.Small" Bordered>
                                            <DescriptionsItem Title="源服务器地址">@GetSourceServerDisplay()</DescriptionsItem>
                                            <DescriptionsItem Title="源数据库">@_currentDataSource.DatabaseName</DescriptionsItem>
                                            <DescriptionsItem Title="源服务器认证">@GetSourceAuthDisplay()</DescriptionsItem>
                                            <DescriptionsItem Title="目标服务器地址">@GetTargetServerDisplay()</DescriptionsItem>
                                            <DescriptionsItem Title="目标数据库">@(_form.TargetDatabase ?? _currentDataSource.DatabaseName)</DescriptionsItem>
                                            <DescriptionsItem Title="目标服务器认证">@GetTargetAuthDisplay()</DescriptionsItem>
                                        </Descriptions>
                                    </div>
                                }
                                
                                <div class="inspection-section">
                                    <h4>归档参数确认</h4>
                                    <Descriptions Column="2" Size="@DescriptionsSize.Small" Bordered>
                                        <DescriptionsItem Title="源表">@FormatTableName()</DescriptionsItem>
                                        <DescriptionsItem Title="目标表">@_form.TargetTable</DescriptionsItem>
                                        <DescriptionsItem Title="目标数据库">@(_form.TargetDatabase ?? "(使用源数据库)")</DescriptionsItem>
                                        <DescriptionsItem Title="批次大小">@(_selectedMode == ArchiveMode.Bcp ? _form.BcpBatchSize : _form.BulkCopyBatchSize) 行</DescriptionsItem>
                                        @if (_selectedMode == ArchiveMode.Bcp)
                                        {
                                            <DescriptionsItem Title="临时目录">@_form.BcpTempDirectory</DescriptionsItem>
                                            <DescriptionsItem Title="原生格式">@(_form.BcpUseNativeFormat ? "是" : "否")</DescriptionsItem>
                                            <DescriptionsItem Title="最大错误数">@_form.BcpMaxErrors</DescriptionsItem>
                                            <DescriptionsItem Title="超时时间">@_form.BcpTimeoutSeconds 秒</DescriptionsItem>
                                        }
                                        else
                                        {
                                            <DescriptionsItem Title="进度通知间隔">@_form.BulkCopyNotifyAfterRows 行</DescriptionsItem>
                                            <DescriptionsItem Title="超时时间">@_form.BulkCopyTimeoutSeconds 秒</DescriptionsItem>
                                            <DescriptionsItem Title="流式读取">@(_form.BulkCopyEnableStreaming ? "是" : "否")</DescriptionsItem>
                                        }
                                    </Descriptions>
                                </div>
                            }
                            else if (_inspectionLoading)
                            {
                                <Skeleton Active />
                            }
                            else if (_inspectionResult is null)
                            {
                                <Empty Description="@("尚未执行预检或预检失败")" />
                            }
                            else
                            {
                                @* Switch模式的完整预检 *@
                                <Alert Message="@( _inspectionResult.CanExecute ? "满足切换条件" : "存在阻塞项，请处理后重试")"
                                       Type="@(_inspectionResult.CanExecute ? AlertType.Success : AlertType.Error)"
                                       ShowIcon="true"
                                       Style="margin-bottom:16px;" />

                                @* 服务器连接信息 *@
                                @if (_currentDataSource != null)
                                {
                                    <div class="inspection-section" style="margin-bottom:16px;">
                                        <h4>目标服务器信息</h4>
                                        <Descriptions Column="2" Size="@DescriptionsSize.Small" Bordered>
                                            <DescriptionsItem Title="源服务器地址">@GetSourceServerDisplay()</DescriptionsItem>
                                            <DescriptionsItem Title="源数据库">@_currentDataSource.DatabaseName</DescriptionsItem>
                                            <DescriptionsItem Title="源服务器认证">@GetSourceAuthDisplay()</DescriptionsItem>
                                            <DescriptionsItem Title="目标服务器地址">@GetTargetServerDisplay()</DescriptionsItem>
                                            <DescriptionsItem Title="目标数据库">@(_form.TargetDatabase ?? _currentDataSource.DatabaseName)</DescriptionsItem>
                                            <DescriptionsItem Title="目标服务器认证">@GetTargetAuthDisplay()</DescriptionsItem>
                                        </Descriptions>
                                    </div>
                                }

                                <div class="inspection-section">
                                    <h4>源表信息</h4>
                                    <Descriptions Column="2" Size="@DescriptionsSize.Small" Bordered>
                                        <DescriptionsItem Title="表名">@FormatTableInfo(_inspectionResult.SourceTable)</DescriptionsItem>
                                        <DescriptionsItem Title="行数">@_inspectionResult.SourceTable.RowCount</DescriptionsItem>
                                    </Descriptions>
                                </div>

                                <div class="inspection-section">
                                    <h4>目标表信息</h4>
                                    <Descriptions Column="2" Size="@DescriptionsSize.Small" Bordered>
                                        <DescriptionsItem Title="表名">@FormatTableInfo(_inspectionResult.TargetTable)</DescriptionsItem>
                                        <DescriptionsItem Title="行数">@_inspectionResult.TargetTable.RowCount</DescriptionsItem>
                                    </Descriptions>
                                </div>

                                @if (_inspectionResult.BlockingIssues.Any())
                                {
                                    <div class="inspection-section">
                                        <h4>阻塞项</h4>
                                        <Alert Type="@AlertType.Error" ShowIcon="true">
                                            <MessageTemplate>
                                                <ul class="issue-list">
                                                    @foreach (var issue in _inspectionResult.BlockingIssues)
                                                    {
                                                        <li>
                                                            <strong>@issue.Code</strong> - @issue.Message
                                                            @if (!string.IsNullOrWhiteSpace(issue.Recommendation))
                                                            {
                                                                <div class="issue-recommendation">建议：@issue.Recommendation</div>
                                                            }
                                                        </li>
                                                    }
                                                </ul>
                                            </MessageTemplate>
                                        </Alert>
                                    </div>
                                }

                                <div class="inspection-section">
                                    <h4>可自动补齐</h4>
                                    @if (_inspectionResult.AutoFixSteps.Any())
                                    {
                                        <Space Direction="@SpaceDirection.Vertical" Size="@SpaceSize.Small" Style="width:100%">
                                            @foreach (var option in _autoFixOptions)
                                            {
                                                <Checkbox @bind-Checked="option.IsSelected">
                                                    <div class="autofix-item">
                                                        <div class="autofix-title">@option.Description</div>
                                                        @if (!string.IsNullOrWhiteSpace(option.Recommendation))
                                                        {
                                                            <div class="autofix-recommendation">@option.Recommendation</div>
                                                        }
                                                    </div>
                                                </Checkbox>
                                            }
                                        </Space>
                                        <div class="autofix-actions">
                                            <Space>
                                                <Button Type="@ButtonType.Primary" Disabled="@(!_autoFixOptions.Any(item => item.IsSelected))" Loading="@_autoFixExecuting" OnClick="ExecuteAutoFixAsync">执行自动补齐</Button>
                                                <Button OnClick="RunInspectionAsync" Loading="@_inspectionLoading">重新预检</Button>
                                            </Space>
                                        </div>
                                    }
                                    else
                                    {
                                        <Alert Type="@AlertType.Success" Message="无需自动补齐" ShowIcon="true" />
                                    }
                                </div>

                                @if (_autoFixResult is not null)
                                {
                                    <div class="inspection-section">
                                        <h4>自动补齐执行结果</h4>
                                        <Alert Type="@(_autoFixResult.Succeeded ? AlertType.Success : AlertType.Warning)" ShowIcon="true">
                                            <MessageTemplate>
                                                <p>@(_autoFixResult.Succeeded ? "自动补齐已经完成，可以重新预检确认状态。" : "部分自动补齐步骤执行失败，请检查日志。")</p>
                                            </MessageTemplate>
                                        </Alert>
                                        <Collapse>
                                            @foreach (var execution in _autoFixResult.Executions)
                                            {
                                                <Panel Key="@execution.Code" Header="@($"{execution.Code} - {(execution.Succeeded ? "成功" : "失败")}")">
                                                    <p>@execution.Message</p>
                                                    <pre class="sql-preview">@execution.Script</pre>
                                                </Panel>
                                            }
                                        </Collapse>
                                        <Divider />
                                        <div class="autofix-log-title">执行日志：</div>
                                        <pre class="sql-preview">@_autoFixResult.CombinedLog</pre>
                                    </div>
                                }

                                @if (_inspectionResult.Warnings.Any())
                                {
                                    <div class="inspection-section">
                                        <h4>警告提示</h4>
                                        <Alert Type="@AlertType.Warning" ShowIcon="true">
                                            <MessageTemplate>
                                                <ul class="issue-list">
                                                    @foreach (var warning in _inspectionResult.Warnings)
                                                    {
                                                        <li>
                                                            <strong>@warning.Code</strong> - @warning.Message
                                                            @if (!string.IsNullOrWhiteSpace(warning.Recommendation))
                                                            {
                                                                <div class="issue-recommendation">建议：@warning.Recommendation</div>
                                                            }
                                                        </li>
                                                    }
                                                </ul>
                                            </MessageTemplate>
                                        </Alert>
                                    </div>
                                }

                                @if (_inspectionResult.Plan is not null)
                                {
                                    <div class="inspection-section">
                                        <h4>补齐计划摘要</h4>
                                        <Collapse>
                                            <Panel Key="planAutoFix" Header="@($"自动补齐步骤 ({_inspectionResult.Plan.AutoFixes.Count})")">
                                                @if (_inspectionResult.Plan.AutoFixes.Any())
                                                {
                                                    <ul class="plan-list">
                                                        @foreach (var item in _inspectionResult.Plan.AutoFixes)
                                                        {
                                                            <li>
                                                                <div class="plan-title">@item.Title</div>
                                                                <div class="plan-meta">分类：@item.Category，影响范围：@item.ImpactScope</div>
                                                                @if (!string.IsNullOrWhiteSpace(item.Prerequisite))
                                                                {
                                                                    <div class="plan-meta">前置条件：@item.Prerequisite</div>
                                                                }
                                                                <Divider />
                                                                <pre class="sql-preview">@string.Join("\n\n", item.Commands.Select(c => $"-- {c.Description}\n{c.CommandText}"))</pre>
                                                            </li>
                                                        }
                                                    </ul>
                                                }
                                                else
                                                {
                                                    <Empty Description="@("无自动补齐步骤")" />
                                                }
                                            </Panel>
                                            <Panel Key="planWarning" Header="@($"警告项 ({_inspectionResult.Plan.Warnings.Count})")">
                                                @if (_inspectionResult.Plan.Warnings.Any())
                                                {
                                                    <ul class="plan-list">
                                                        @foreach (var item in _inspectionResult.Plan.Warnings)
                                                        {
                                                            <li>
                                                                <div class="plan-title">@item.Title</div>
                                                                <div class="plan-meta">@item.Description</div>
                                                                @if (!string.IsNullOrWhiteSpace(item.Guidance))
                                                                {
                                                                    <div class="plan-meta">指引：@item.Guidance</div>
                                                                }
                                                            </li>
                                                        }
                                                    </ul>
                                                }
                                                else
                                                {
                                                    <Empty Description="@("无警告项")" />
                                                }
                                            </Panel>
                                        </Collapse>
                                    </div>
                                }
                            }
                        </div>
                        break;
                    case 3:
                        <div class="step-pane">
                            <Descriptions Column="1" Size="@DescriptionsSize.Small" Bordered Style="margin-bottom:16px;">
                                <DescriptionsItem Title="归档方式">@GetArchiveModeDisplayName()</DescriptionsItem>
                                @if (_selectedMode == ArchiveMode.Switch)
                                {
                                    <DescriptionsItem Title="分区配置">@_selectedConfiguration?.Display</DescriptionsItem>
                                }
                                <DescriptionsItem Title="目标表">@_form.TargetTable</DescriptionsItem>
                                <DescriptionsItem Title="目标数据库">@(_form.TargetDatabase ?? "(沿用配置)")</DescriptionsItem>
                                @if (_selectedMode == ArchiveMode.Switch)
                                {
                                    <DescriptionsItem Title="临时表">@(_form.CreateStagingTable ? "是" : "否")</DescriptionsItem>
                                }
                                else if (_selectedMode == ArchiveMode.Bcp)
                                {
                                    <DescriptionsItem Title="批次大小">@_form.BcpBatchSize 行</DescriptionsItem>
                                    <DescriptionsItem Title="临时目录">@_form.BcpTempDirectory</DescriptionsItem>
                                    <DescriptionsItem Title="使用原生格式">@(_form.BcpUseNativeFormat ? "是" : "否")</DescriptionsItem>
                                }
                                else if (_selectedMode == ArchiveMode.BulkCopy)
                                {
                                    <DescriptionsItem Title="批次大小">@_form.BulkCopyBatchSize 行</DescriptionsItem>
                                    <DescriptionsItem Title="超时时间">@_form.BulkCopyTimeoutSeconds 秒</DescriptionsItem>
                                    <DescriptionsItem Title="流式读取">@(_form.BulkCopyEnableStreaming ? "是" : "否")</DescriptionsItem>
                                }
                                @if (_isBatchMode)
                                {
                                    <DescriptionsItem Title="批量模式">
                                        <Tag Color="@TagColor.Blue">共 @_partitionKeys.Count 个分区</Tag>
                                    </DescriptionsItem>
                                    <DescriptionsItem Title="分区列表">
                                        @string.Join(", ", _partitionKeys)
                                    </DescriptionsItem>
                                }
                            </Descriptions>

                            @if (_submitting && _isBatchMode)
                            {
                                <Alert Type="@AlertType.Info" ShowIcon="true" Style="margin-bottom:16px;">
                                    <MessageTemplate>
                                        <p>正在执行批量分区切换: [@(_batchCurrentIndex + 1)/@_partitionKeys.Count]</p>
                                        <Progress Percent="@((int)((_batchCurrentIndex + 1) * 100.0 / _partitionKeys.Count))" 
                                                  Status="@ProgressStatus.Active" />
                                        <p style="margin-top:8px;">
                                            成功: @_batchSuccessCount 个 | 失败: @_batchFailureCount 个
                                        </p>
                                    </MessageTemplate>
                                </Alert>
                            }
                            
                            @if (_batchResults.Any())
                            {
                                <Alert Type="@(_batchFailureCount > 0 ? AlertType.Warning : AlertType.Success)" 
                                       ShowIcon="true" 
                                       Style="margin-bottom:16px;">
                                    <MessageTemplate>
                                        <p>批量执行结果: 成功 @_batchSuccessCount 个, 失败 @_batchFailureCount 个</p>
                                    </MessageTemplate>
                                </Alert>
                                
                                <Table TItem="BatchExecutionResult" 
                                       DataSource="@_batchResults" 
                                       Size="@TableSize.Small" 
                                       Bordered 
                                       Style="margin-bottom:16px;">
                                    <Column Title="分区号" TData="string">
                                        @context.PartitionKey
                                    </Column>
                                    <Column Title="状态" TData="bool">
                                        @if (context.Success)
                                        {
                                            <Tag Color="@TagColor.Green">成功</Tag>
                                        }
                                        else
                                        {
                                            <Tag Color="@TagColor.Red">失败</Tag>
                                        }
                                    </Column>
                                    <Column Title="消息" TData="string">
                                        @context.Message
                                    </Column>
                                    <Column Title="任务ID" TData="string">
                                        @if (context.TaskId.HasValue)
                                        {
                                            <span>@context.TaskId.Value.ToString()</span>
                                        }
                                        else
                                        {
                                            <span style="color: rgba(0,0,0,0.45);">-</span>
                                        }
                                    </Column>
                                </Table>
                            }

                            <Alert Type="@AlertType.Warning" ShowIcon="true" Style="margin-bottom:16px;">
                                <MessageTemplate>
                                    <p>请确认数据库已完成最新备份，并理解分区切换会在短时间内占用排他锁。</p>
                                    @if (_isBatchMode)
                                    {
                                        <p style="margin-top:8px;">
                                            <strong>批量模式提示:</strong> 将依次执行 @_partitionKeys.Count 个分区的切换操作,每次切换间隔500毫秒。
                                        </p>
                                    }
                                </MessageTemplate>
                            </Alert>

                            @if (!string.IsNullOrWhiteSpace(_executionPreviewMarkdown))
                            {
                                <div class="markdown-preview">
                                    <MarkdownViewer Content="@_executionPreviewMarkdown" />
                                </div>
                            }
                            else
                            {
                                <Alert Type="@AlertType.Info" ShowIcon="true" Style="margin-bottom:16px;">
                                    <MessageTemplate>
                                        <p>完成预检后将在此显示执行摘要与 SQL 预览。</p>
                                    </MessageTemplate>
                                </Alert>
                            }

                            <Checkbox Checked="_form.BackupConfirmed" CheckedChanged="(bool val) => _form.BackupConfirmed = val">我已完成备份并知晓风险</Checkbox>
                        </div>
                        break;
                }
            </div>
        </div>
    </Spin>

    <div class="drawer-footer">
        <Space>
            <Button OnClick="CloseAsync">取消</Button>
            @if (_currentStep > 0)
            {
                <Button OnClick="PrevStep">上一步</Button>
            }
            @if (_currentStep < 3)
            {
                <Button Type="@ButtonType.Primary" Disabled="@(!CanProceedToNextStep())" Loading="@_inspectionLoading" OnClick="NextStepAsync">下一步</Button>
            }
            else
            {
                <Button Type="@ButtonType.Primary" Loading="@_submitting" Disabled="@(!_form.BackupConfirmed)" OnClick="SubmitAsync">提交</Button>
            }
        </Space>
    </div>
</Drawer>
