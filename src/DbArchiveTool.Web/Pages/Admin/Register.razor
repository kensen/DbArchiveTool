@page "/admin/register"
@layout AuthLayout
@using AntDesign
@using DbArchiveTool.Application.AdminUsers
@using DbArchiveTool.Web.Core
@using DbArchiveTool.Web.Services

<h3 class="auth-layout__title">注册管理员账户</h3>
<p class="auth-layout__subtitle">首次使用请创建管理员账号，用于保护归档配置与执行权限。</p>

@if (!string.IsNullOrEmpty(_errorMessage))
{
    <Alert Type="AlertType.Error" ShowIcon="true" Message="@_errorMessage" Style="margin-bottom:16px;" />
}

<Form Model="_model" OnFinish="HandleSubmitAsync">
    <FormItem Label="用户名" Name="UserName">
        <Input Size="InputSize.Large" Placeholder="请输入管理员用户名" @bind-Value="_model.UserName" />
    </FormItem>
    <FormItem Label="密码" Name="Password">
        <InputPassword Size="InputSize.Large" Placeholder="请输入密码" @bind-Value="_model.Password" />
    </FormItem>
    <FormItem Label="确认密码" Name="ConfirmPassword">
        <InputPassword Size="InputSize.Large" Placeholder="请再次输入密码" @bind-Value="_model.ConfirmPassword" />
    </FormItem>
    <FormItem>
        <Button Type="ButtonType.Primary" HtmlType="ButtonHtmlType.Submit" Size="ButtonSize.Large" Loading="_isSubmitting" Block>
            注册并登录
        </Button>
    </FormItem>
    <FormItem>
        <Button Type="ButtonType.Default" Size="ButtonSize.Large" Block OnClick="NavigateToLogin">
            已有账号？前往登录
        </Button>
    </FormItem>
</Form>

@code {
    /// <summary>根级 App 组件引用。</summary>
    [CascadingParameter] public App? RootApp { get; set; }

    /// <summary>注册表单模型。</summary>
    private readonly RegisterAdminUserRequest _model = new();

    [Inject] private NavigationManager Navigation { get; set; } = default!;
    [Inject] private AdminUserApiClient ApiClient { get; set; } = default!;
    [Inject] private AdminSessionState SessionState { get; set; } = default!;

    private bool _isSubmitting;
    private string? _errorMessage;

    private async Task HandleSubmitAsync()
    {
        _errorMessage = null;
        _isSubmitting = true;

        try
        {
            if (!ValidateInputs())
            {
                return;
            }

            var request = new RegisterAdminUserRequest
            {
                UserName = _model.UserName.Trim(),
                Password = _model.Password,
                ConfirmPassword = _model.ConfirmPassword
            };

            var result = await ApiClient.RegisterAsync(request);
            if (!result.IsSuccess || result.Value == Guid.Empty)
            {
                _errorMessage = result.Error ?? "注册失败，请检查输入";
                return;
            }

            SessionState.SignIn(result.Value, request.UserName);
            RootApp?.MarkAdminCreated();
            Navigation.NavigateTo("/");
        }
        finally
        {
            _isSubmitting = false;
        }
    }

    private void NavigateToLogin()
    {
        Navigation.NavigateTo("/login");
    }

    private bool ValidateInputs()
    {
        if (string.IsNullOrWhiteSpace(_model.UserName))
        {
            _errorMessage = "请输入用户名";
            return false;
        }

        if (_model.UserName.Trim().Length < 4)
        {
            _errorMessage = "用户名长度至少为 4 个字符";
            return false;
        }

        if (string.IsNullOrWhiteSpace(_model.Password))
        {
            _errorMessage = "请输入密码";
            return false;
        }

        if (_model.Password.Length < 6)
        {
            _errorMessage = "密码至少为 6 位";
            return false;
        }

        if (!string.Equals(_model.Password, _model.ConfirmPassword, StringComparison.Ordinal))
        {
            _errorMessage = "两次输入的密码不一致";
            return false;
        }

        return true;
    }
}
