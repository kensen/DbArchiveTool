@page "/archive-jobs"
@attribute [ReuseTabsPage(Title = "归档任务监控", Closable = true)]
@using DbArchiveTool.Web.Services
@using DbArchiveTool.Web.Models
@using DbArchiveTool.Web.Components
@inject IHangfireMonitorService HangfireMonitor
@inject ScheduledArchiveJobApiClient ScheduledJobApi

<PageContainer Title="归档任务监控">
    <Extra>
        <Space>
            <SpaceItem>
                <Button Type="@ButtonType.Primary" Icon="reload" Loading="@_loading" OnClick="RefreshAsync">刷新</Button>
            </SpaceItem>
            <SpaceItem>
                <Switch @bind-Checked="@_autoRefresh" CheckedChildren="自动刷新" UnCheckedChildren="手动刷新" />
            </SpaceItem>
        </Space>
    </Extra>
    <ChildContent>
        <GridRow Gutter="16" Style="margin-bottom: 16px;">
            <!-- 统计卡片 -->
            <GridCol Xs="24" Sm="12" Md="6" Lg="4">
                <Card>
                    <Statistic Title="已入队" Value="@_statistics.EnqueuedCount" Suffix="个" ValueStyle="color: #1890ff;" />
                </Card>
            </GridCol>
            <GridCol Xs="24" Sm="12" Md="6" Lg="4">
                <Card>
                    <Statistic Title="已调度" Value="@_statistics.ScheduledCount" Suffix="个" ValueStyle="color: #52c41a;" />
                </Card>
            </GridCol>
            <GridCol Xs="24" Sm="12" Md="6" Lg="4">
                <Card>
                    <Statistic Title="执行中" Value="@_statistics.ProcessingCount" Suffix="个" ValueStyle="color: #faad14;" />
                </Card>
            </GridCol>
            <GridCol Xs="24" Sm="12" Md="6" Lg="4">
                <Card>
                    <Statistic Title="已成功" Value="@_statistics.SucceededCount" Suffix="个" ValueStyle="color: #52c41a;" />
                </Card>
            </GridCol>
            <GridCol Xs="24" Sm="12" Md="6" Lg="4">
                <Card>
                    <Statistic Title="已失败" Value="@_statistics.FailedCount" Suffix="个" ValueStyle="color: #f5222d;" />
                </Card>
            </GridCol>
            <GridCol Xs="24" Sm="12" Md="6" Lg="4">
                <Card>
                    <Statistic Title="定时任务" Value="@_statistics.RecurringJobCount" Suffix="个" ValueStyle="color: #722ed1;" />
                </Card>
            </GridCol>
        </GridRow>

        <Tabs @bind-ActiveKey="@_activeTab" OnChange="OnTabChange">
            <!-- 任务列表 -->
            <TabPane Key="jobs" Tab="任务列表">
                <Card Size="@CardSize.Small" Style="margin-bottom: 16px;">
                    <Space>
                        <SpaceItem>
                            <Select TItem="string"
                                    TItemValue="string"
                                    @bind-Value="@_selectedStatus"
                                    Placeholder="全部状态"
                                    AllowClear
                                    Style="width: 150px;">
                                <SelectOptions>
                                    <SelectOption TItem="string" TItemValue="string" Value="@("enqueued")" Label="已入队" />
                                    <SelectOption TItem="string" TItemValue="string" Value="@("scheduled")" Label="已调度" />
                                    <SelectOption TItem="string" TItemValue="string" Value="@("processing")" Label="执行中" />
                                    <SelectOption TItem="string" TItemValue="string" Value="@("succeeded")" Label="已成功" />
                                    <SelectOption TItem="string" TItemValue="string" Value="@("failed")" Label="已失败" />
                                </SelectOptions>
                            </Select>
                        </SpaceItem>
                        <SpaceItem>
                            <Button Type="@ButtonType.Primary" OnClick="ApplyFilterAsync">查询</Button>
                        </SpaceItem>
                    </Space>
                </Card>

                <Card>
                    <Table TItem="HangfireJobModel"
                           DataSource="@_jobs.Items"
                           Loading="@_loading"
                           Size="@TableSize.Small"
                           Bordered
                           @bind-PageIndex="_pageIndex"
                           @bind-PageSize="_pageSize"
                           Total="@_totalJobs"
                           OnPageIndexChange="OnPageIndexChangeAsync"
                           OnPageSizeChange="OnPageSizeChangeAsync">
                        <PropertyColumn Property="@(j => j.JobId)" Title="任务ID" Width="200px">
                            <Template>
                                <Text Code>@context.JobId[..Math.Min(16, context.JobId.Length)]...</Text>
                            </Template>
                        </PropertyColumn>
                        <PropertyColumn Property="@(j => j.Status)" Title="状态" Width="100px">
                            <Template>
                                <Tag Color="@GetStatusColor(context.Status)">
                                    @GetStatusText(context.Status)
                                </Tag>
                            </Template>
                        </PropertyColumn>
                        <PropertyColumn Property="@(j => j.MethodName)" Title="业务任务" Width="260px">
                            <Template>
                                @GetBusinessJobTitle(context)
                            </Template>
                        </PropertyColumn>
                        <PropertyColumn Property="@(j => j.MethodName)" Title="方法名称" />
                        <PropertyColumn Property="@(j => j.QueueName)" Title="队列" Width="100px">
                            <Template>
                                @(context.QueueName ?? "-")
                            </Template>
                        </PropertyColumn>
                        <PropertyColumn Property="@(j => j.CreatedAtUtc)" Title="创建时间" Width="180px">
                            <Template>
                                @context.CreatedAtUtc.ToLocalTime().ToString("yyyy-MM-dd HH:mm:ss")
                            </Template>
                        </PropertyColumn>
                        <PropertyColumn Property="@(j => j.ScheduledAtUtc)" Title="预计执行" Width="180px">
                            <Template>
                                @(context.ScheduledAtUtc?.ToLocalTime().ToString("yyyy-MM-dd HH:mm:ss") ?? "-")
                            </Template>
                        </PropertyColumn>
                        <PropertyColumn Property="@(j => j.DurationSeconds)" Title="耗时" Width="100px">
                            <Template>
                                @(context.DurationSeconds.HasValue ? $"{context.DurationSeconds.Value:F2}s" : "-")
                            </Template>
                        </PropertyColumn>
                        <ActionColumn Title="操作" Width="200px">
                            <Space Size="@("small")">
                                <SpaceItem>
                                    <Button Type="@ButtonType.Link" Size="@ButtonSize.Small" OnClick="@(() => ShowDetailAsync(context.JobId))">详情</Button>
                                </SpaceItem>
                                @if (context.Status == "Failed")
                                {
                                    <SpaceItem>
                                        <Popconfirm Title="确定要重新执行此任务吗?"
                                                    OnConfirm="@(() => RequeueJobAsync(context.JobId))"
                                                    OkText="确定"
                                                    CancelText="取消">
                                            <Button Type="@ButtonType.Link" Size="@ButtonSize.Small">重试</Button>
                                        </Popconfirm>
                                    </SpaceItem>
                                }
                                @if (context.Status != "Processing")
                                {
                                    <SpaceItem>
                                        <Popconfirm Title="确定要删除此任务吗?"
                                                    OnConfirm="@(() => DeleteJobAsync(context.JobId))"
                                                    OkText="确定"
                                                    CancelText="取消">
                                            <Button Type="@ButtonType.Link" Size="@ButtonSize.Small" Danger>删除</Button>
                                        </Popconfirm>
                                    </SpaceItem>
                                }
                            </Space>
                        </ActionColumn>
                    </Table>
                </Card>
            </TabPane>

            <!-- 定时任务 -->
            <TabPane Key="recurring" Tab="定时任务">
                <Card>
                    <Table TItem="HangfireRecurringJobModel"
                           DataSource="@_recurringJobs"
                           Loading="@_loading"
                           Size="@TableSize.Small"
                           Bordered>
                        <PropertyColumn Property="@(j => j.Id)" Title="任务ID" />
                        <PropertyColumn Property="@(j => j.Id)" Title="任务名称" Width="220px">
                            <Template>
                                @GetRecurringBusinessName(context)
                            </Template>
                        </PropertyColumn>
                        <PropertyColumn Property="@(j => j.Id)" Title="源表" Width="180px">
                            <Template>
                                @GetRecurringBusinessSourceTable(context)
                            </Template>
                        </PropertyColumn>
                        <PropertyColumn Property="@(j => j.Id)" Title="目标表" Width="180px">
                            <Template>
                                @GetRecurringBusinessTargetTable(context)
                            </Template>
                        </PropertyColumn>
                        <PropertyColumn Property="@(j => j.MethodName)" Title="方法名称" />
                        <PropertyColumn Property="@(j => j.Cron)" Title="Cron表达式">
                            <Template>
                                <Text Code>@context.Cron</Text>
                            </Template>
                        </PropertyColumn>
                        <PropertyColumn Property="@(j => j.QueueName)" Title="队列" Width="100px">
                            <Template>
                                @(context.QueueName ?? "default")
                            </Template>
                        </PropertyColumn>
                        <PropertyColumn Property="@(j => j.NextExecutionUtc)" Title="下次执行" Width="180px">
                            <Template>
                                @(context.NextExecutionUtc?.ToLocalTime().ToString("yyyy-MM-dd HH:mm:ss") ?? "-")
                            </Template>
                        </PropertyColumn>
                        <PropertyColumn Property="@(j => j.LastExecutionUtc)" Title="最后执行" Width="180px">
                            <Template>
                                @(context.LastExecutionUtc?.ToLocalTime().ToString("yyyy-MM-dd HH:mm:ss") ?? "-")
                            </Template>
                        </PropertyColumn>
                        <ActionColumn Title="操作" Width="200px">
                            <Space Size="@("small")">
                                <SpaceItem>
                                    <Popconfirm Title="确定要立即执行此任务吗?"
                                                OnConfirm="@(() => TriggerRecurringJobAsync(context.Id))"
                                                OkText="确定"
                                                CancelText="取消">
                                        <Button Type="@ButtonType.Link" Size="@ButtonSize.Small">立即执行</Button>
                                    </Popconfirm>
                                </SpaceItem>
                                <SpaceItem>
                                    <Popconfirm Title="确定要移除此定时任务吗?"
                                                OnConfirm="@(() => RemoveRecurringJobAsync(context.Id))"
                                                OkText="确定"
                                                CancelText="取消">
                                        <Button Type="@ButtonType.Link" Size="@ButtonSize.Small" Danger>移除</Button>
                                    </Popconfirm>
                                </SpaceItem>
                            </Space>
                        </ActionColumn>
                    </Table>
                </Card>
            </TabPane>
        </Tabs>
    </ChildContent>
</PageContainer>

<!-- 任务详情抽屉 -->
<Drawer Closable
        Width="720"
        Visible="@_detailDrawerVisible"
        Title="@("任务详情")"
        OnClose="@(() => _detailDrawerVisible = false)">
    @if (_jobDetail != null)
    {
        <Descriptions Bordered Column="2" Size="@DescriptionsSize.Small">
            <DescriptionsItem Title="任务ID" Span="2">
                <Text Code>@_jobDetail.JobId</Text>
            </DescriptionsItem>
            <DescriptionsItem Title="状态">
                <Tag Color="@GetStatusColor(_jobDetail.Status)">
                    @GetStatusText(_jobDetail.Status)
                </Tag>
            </DescriptionsItem>
            <DescriptionsItem Title="方法名称">@_jobDetail.MethodName</DescriptionsItem>
            <DescriptionsItem Title="队列">@(_jobDetail.QueueName ?? "default")</DescriptionsItem>
            <DescriptionsItem Title="重试次数">@_jobDetail.RetryCount</DescriptionsItem>
            <DescriptionsItem Title="创建时间">@_jobDetail.CreatedAtUtc.ToLocalTime().ToString("yyyy-MM-dd HH:mm:ss")</DescriptionsItem>
            <DescriptionsItem Title="开始时间">@(_jobDetail.StartedAtUtc?.ToLocalTime().ToString("yyyy-MM-dd HH:mm:ss") ?? "-")</DescriptionsItem>
            <DescriptionsItem Title="结束时间">@(_jobDetail.FinishedAtUtc?.ToLocalTime().ToString("yyyy-MM-dd HH:mm:ss") ?? "-")</DescriptionsItem>
            <DescriptionsItem Title="执行耗时">@(_jobDetail.DurationSeconds.HasValue ? $"{_jobDetail.DurationSeconds.Value:F2}秒" : "-")</DescriptionsItem>
            @if (_jobDetail.ParsedArguments.Any())
            {
                <DescriptionsItem Title="任务参数" Span="2">
                    @foreach (var arg in _jobDetail.ParsedArguments)
                    {
                        <div><strong>@arg.Key:</strong> @arg.Value</div>
                    }
                </DescriptionsItem>
            }
        </Descriptions>

        @if (_jobDetail.StateHistory.Any())
        {
            <Divider>状态历史</Divider>
            <Timeline>
                @foreach (var state in _jobDetail.StateHistory)
                {
                    <TimelineItem Color="@GetStatusColor(state.StateName)">
                        <div style="margin-bottom: 8px;">
                            <Space Size="@("small")">
                                <SpaceItem>
                                    <Tag Color="@GetStatusColor(state.StateName)">@state.StateName</Tag>
                                </SpaceItem>
                                <SpaceItem>
                                    <Text Type="@TextElementType.Secondary">@state.CreatedAtUtc.ToLocalTime().ToString("yyyy-MM-dd HH:mm:ss")</Text>
                                </SpaceItem>
                            </Space>
                        </div>
                        @if (!string.IsNullOrWhiteSpace(state.Reason))
                        {
                            <div>@state.Reason</div>
                        }

                        @* 失败信息：优先展示 ExceptionMessage（已被我们构造成 Markdown，包含必要 SQL 代码块） *@
                        @if (state.Data != null && state.Data.TryGetValue("ExceptionMessage", out var exceptionMessage) && !string.IsNullOrWhiteSpace(exceptionMessage))
                        {
                            <div style="margin-top: 8px;" class="markdown-body">
                                <MarkdownViewer Content="@exceptionMessage" />
                            </div>
                        }

                        @* 成功/跳过信息：从 Result JSON 中提取 AuditMarkdown，放在状态历史里展示 *@
                        @{
                            var auditMarkdown = TryGetAuditMarkdownFromState(state);
                        }
                        @if (!string.IsNullOrWhiteSpace(auditMarkdown))
                        {
                            <div style="margin-top: 8px;" class="markdown-body">
                                <MarkdownViewer Content="@auditMarkdown" />
                            </div>
                        }

                        @if (state.Data != null && state.Data.Any())
                        {
                            <div style="margin-top: 8px;">
                                @foreach (var kv in state.Data
                                    .Where(kv => !IsLargeStateDataKey(kv.Key))
                                    .OrderBy(kv => kv.Key))
                                {
                                    <div>
                                        <Text Type="@TextElementType.Secondary">@kv.Key</Text>
                                        <Text Type="@TextElementType.Secondary">: </Text>
                                        <Text Type="@TextElementType.Secondary">@kv.Value</Text>
                                    </div>
                                }
                            </div>
                        }
                    </TimelineItem>
                }
            </Timeline>
        }
    }
    else
    {
        <div style="text-align: center; padding: 40px;">
            <Spin />
        </div>
    }
</Drawer>

@code {
    private bool _loading = false;
    private bool _autoRefresh = true;
    private System.Threading.Timer? _refreshTimer;

    private string _activeTab = "jobs";
    private string? _selectedStatus;
    
    // 任务列表
    private PagedResult<HangfireJobModel> _jobs = new();
    private int _pageIndex = 1;
    private int _pageSize = 20;
    private int _totalJobs = 0;

    // 定时任务列表
    private List<HangfireRecurringJobModel> _recurringJobs = new();

    // 定时归档任务缓存（用于把 Hangfire Job 映射成业务任务信息）
    private readonly Dictionary<Guid, ScheduledArchiveJobDto> _scheduledJobCache = new();

    // 统计信息
    private HangfireStatisticsModel _statistics = new();

    // 任务详情
    private bool _detailDrawerVisible = false;
    private HangfireJobDetailModel? _jobDetail;

    private static bool IsLargeStateDataKey(string key)
    {
        // 这些字段通常很长（Markdown/堆栈/JSON），直接逐行展示会导致排版错乱。
        return string.Equals(key, "Result", StringComparison.OrdinalIgnoreCase)
            || string.Equals(key, "ExceptionMessage", StringComparison.OrdinalIgnoreCase)
            || string.Equals(key, "ExceptionDetails", StringComparison.OrdinalIgnoreCase);
    }

    private static string? TryGetAuditMarkdownFromState(HangfireJobStateHistoryModel state)
    {
        if (state?.Data == null)
        {
            return null;
        }

        if (!state.Data.TryGetValue("Result", out var rawResult) || string.IsNullOrWhiteSpace(rawResult))
        {
            return null;
        }

        var jsonText = rawResult.Trim();
        if (string.Equals(jsonText, "null", StringComparison.OrdinalIgnoreCase))
        {
            return null;
        }

        // 1) 直接当 JSON 解析
        if (TryParseAuditMarkdownFromJson(jsonText, out var auditMarkdown))
        {
            return auditMarkdown;
        }

        // 2) 可能是被序列化成字符串："{ ... }"，先反序列化为 string 再解析
        try
        {
            var inner = System.Text.Json.JsonSerializer.Deserialize<string>(jsonText);
            if (!string.IsNullOrWhiteSpace(inner) && TryParseAuditMarkdownFromJson(inner, out auditMarkdown))
            {
                return auditMarkdown;
            }
        }
        catch
        {
            // ignore
        }

        return null;
    }

    private static bool TryParseAuditMarkdownFromJson(string jsonText, out string? auditMarkdown)
    {
        auditMarkdown = null;
        try
        {
            using var doc = System.Text.Json.JsonDocument.Parse(jsonText);
            if (doc.RootElement.ValueKind != System.Text.Json.JsonValueKind.Object)
            {
                return false;
            }

            if (doc.RootElement.TryGetProperty("AuditMarkdown", out var prop)
                && prop.ValueKind == System.Text.Json.JsonValueKind.String)
            {
                auditMarkdown = prop.GetString();
                return !string.IsNullOrWhiteSpace(auditMarkdown);
            }

            return false;
        }
        catch
        {
            return false;
        }
    }

    protected override async Task OnInitializedAsync()
    {
        await RefreshAsync();
        StartAutoRefresh();
    }

    private async Task RefreshAsync()
    {
        _loading = true;
        try
        {
            // 获取统计信息
            _statistics = await HangfireMonitor.GetStatisticsAsync();

            // 根据当前标签页加载数据
            if (_activeTab == "jobs")
            {
                await LoadJobsAsync();
            }
            else if (_activeTab == "recurring")
            {
                await LoadRecurringJobsAsync();
            }
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task LoadJobsAsync()
    {
        _jobs = await HangfireMonitor.GetJobsAsync(_selectedStatus, _pageIndex - 1, _pageSize);
        _totalJobs = (int)_jobs.TotalCount;

        await EnrichBusinessInfoAsync(_jobs.Items);
    }

    private async Task LoadRecurringJobsAsync()
    {
        _recurringJobs = await HangfireMonitor.GetRecurringJobsAsync();

        // 预加载定时归档任务详情，便于表格直接展示任务名称/源表/目标表
        var scheduledIds = _recurringJobs
            .Select(j => TryGetScheduledArchiveJobId(j.Id, out var id) ? id : Guid.Empty)
            .Where(id => id != Guid.Empty)
            .Distinct()
            .ToList();

        foreach (var id in scheduledIds)
        {
            await EnsureScheduledJobCachedAsync(id);
        }
    }

    private async Task EnrichBusinessInfoAsync(IEnumerable<HangfireJobModel> jobs)
    {
        var ids = new HashSet<Guid>();

        foreach (var job in jobs)
        {
            if (TryGetScheduledArchiveJobIdFromJob(job, out var scheduledId))
            {
                ids.Add(scheduledId);
            }
        }

        foreach (var id in ids)
        {
            await EnsureScheduledJobCachedAsync(id);
        }
    }

    private async Task EnsureScheduledJobCachedAsync(Guid scheduledJobId)
    {
        if (_scheduledJobCache.ContainsKey(scheduledJobId))
        {
            return;
        }

        var result = await ScheduledJobApi.GetByIdAsync(scheduledJobId);
        if (result.IsSuccess && result.Value != null)
        {
            _scheduledJobCache[scheduledJobId] = result.Value;
        }
    }

    private static bool TryGetScheduledArchiveJobId(string recurringJobId, out Guid jobId)
    {
        jobId = Guid.Empty;
        if (string.IsNullOrWhiteSpace(recurringJobId))
        {
            return false;
        }

        const string prefix = "scheduled-archive-job-";
        if (!recurringJobId.StartsWith(prefix, StringComparison.OrdinalIgnoreCase))
        {
            return false;
        }

        var idPart = recurringJobId.Substring(prefix.Length);
        return Guid.TryParse(idPart, out jobId);
    }

    private static bool TryGetScheduledArchiveJobIdFromJob(HangfireJobModel job, out Guid jobId)
    {
        jobId = Guid.Empty;

        // 目前定时归档执行器签名为 ExecuteAsync(Guid jobId, CancellationToken)
        // Hangfire 参数在 Arguments 中序列化为 JSON 数组字符串，优先解析第一个 GUID
        if (string.IsNullOrWhiteSpace(job.Arguments))
        {
            return false;
        }

        try
        {
            using var doc = System.Text.Json.JsonDocument.Parse(job.Arguments);
            if (doc.RootElement.ValueKind != System.Text.Json.JsonValueKind.Array)
            {
                return false;
            }

            foreach (var el in doc.RootElement.EnumerateArray())
            {
                if (el.ValueKind == System.Text.Json.JsonValueKind.String)
                {
                    var s = el.GetString();
                    if (Guid.TryParse(s, out jobId))
                    {
                        return true;
                    }
                }
            }

            return false;
        }
        catch
        {
            return false;
        }
    }

    private string GetRecurringBusinessName(HangfireRecurringJobModel recurring)
    {
        if (!TryGetScheduledArchiveJobId(recurring.Id, out var id))
        {
            return "-";
        }

        return _scheduledJobCache.TryGetValue(id, out var job)
            ? job.Name
            : id.ToString();
    }

    private string GetRecurringBusinessSourceTable(HangfireRecurringJobModel recurring)
    {
        if (!TryGetScheduledArchiveJobId(recurring.Id, out var id))
        {
            return "-";
        }

        if (!_scheduledJobCache.TryGetValue(id, out var job))
        {
            return "-";
        }

        return !string.IsNullOrWhiteSpace(job.FullSourceTable)
            ? job.FullSourceTable
            : $"{job.SourceSchemaName}.{job.SourceTableName}";
    }

    private string GetRecurringBusinessTargetTable(HangfireRecurringJobModel recurring)
    {
        if (!TryGetScheduledArchiveJobId(recurring.Id, out var id))
        {
            return "-";
        }

        if (!_scheduledJobCache.TryGetValue(id, out var job))
        {
            return "-";
        }

        return !string.IsNullOrWhiteSpace(job.FullTargetTable)
            ? job.FullTargetTable
            : $"{job.TargetSchemaName}.{job.TargetTableName}";
    }

    private string GetBusinessJobTitle(HangfireJobModel job)
    {
        if (!TryGetScheduledArchiveJobIdFromJob(job, out var id))
        {
            return "-";
        }

        if (_scheduledJobCache.TryGetValue(id, out var scheduled))
        {
            var source = !string.IsNullOrWhiteSpace(scheduled.FullSourceTable)
                ? scheduled.FullSourceTable
                : $"{scheduled.SourceSchemaName}.{scheduled.SourceTableName}";
            var target = !string.IsNullOrWhiteSpace(scheduled.FullTargetTable)
                ? scheduled.FullTargetTable
                : $"{scheduled.TargetSchemaName}.{scheduled.TargetTableName}";
            return $"{scheduled.Name} ({source} → {target})";
        }

        return id.ToString();
    }

    private async Task ApplyFilterAsync()
    {
        _pageIndex = 1;
        await LoadJobsAsync();
    }

    private async Task OnPageIndexChangeAsync()
    {
        await LoadJobsAsync();
    }

    private async Task OnPageSizeChangeAsync()
    {
        // 切换每页数量时，重置到第一页，避免页码越界导致“看起来没变化/空白页”
        _pageIndex = 1;
        await LoadJobsAsync();
    }

    private async Task OnTabChange(string activeKey)
    {
        _activeTab = activeKey;
        await RefreshAsync();
    }

    private async Task ShowDetailAsync(string jobId)
    {
        _jobDetail = await HangfireMonitor.GetJobDetailAsync(jobId);
        _detailDrawerVisible = true;
    }

    private async Task DeleteJobAsync(string jobId)
    {
        var success = await HangfireMonitor.DeleteJobAsync(jobId);
        if (success)
        {
            await RefreshAsync();
        }
    }

    private async Task RequeueJobAsync(string jobId)
    {
        var success = await HangfireMonitor.RequeueJobAsync(jobId);
        if (success)
        {
            await RefreshAsync();
        }
    }

    private async Task TriggerRecurringJobAsync(string recurringJobId)
    {
        var success = await HangfireMonitor.TriggerRecurringJobAsync(recurringJobId);
        if (success)
        {
            await Task.Delay(1000); // 等待任务创建
            await RefreshAsync();
        }
    }

    private async Task RemoveRecurringJobAsync(string recurringJobId)
    {
        var success = await HangfireMonitor.RemoveRecurringJobAsync(recurringJobId);
        if (success)
        {
            await RefreshAsync();
        }
    }

    private void StartAutoRefresh()
    {
        _refreshTimer?.Dispose();
        if (_autoRefresh)
        {
            _refreshTimer = new System.Threading.Timer(async _ =>
            {
                await InvokeAsync(async () =>
                {
                    if (_autoRefresh)
                    {
                        await RefreshAsync();
                        StateHasChanged();
                    }
                });
            }, null, TimeSpan.FromSeconds(5), TimeSpan.FromSeconds(5));
        }
    }

    private string GetStatusColor(string status)
    {
        return status?.ToLower() switch
        {
            "enqueued" => "cyan",
            "scheduled" => "blue",
            "processing" => "processing",
            "succeeded" => "success",
            "failed" => "error",
            "deleted" => "default",
            _ => "default"
        };
    }

    private string GetStatusText(string status)
    {
        return status?.ToLower() switch
        {
            "enqueued" => "已入队",
            "scheduled" => "已调度",
            "processing" => "执行中",
            "succeeded" => "已成功",
            "failed" => "已失败",
            "deleted" => "已删除",
            _ => status ?? "未知"
        };
    }

    public void Dispose()
    {
        _refreshTimer?.Dispose();
    }
}
