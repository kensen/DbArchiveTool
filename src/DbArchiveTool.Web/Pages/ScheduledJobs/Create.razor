@page "/archive-data-sources/{DataSourceId:guid}/scheduled-jobs/create"
@using AntDesign
@using Cronos
@using DbArchiveTool.Web.Services
@using DbArchiveTool.Web.Models
@using System.Text.RegularExpressions
@attribute [ReuseTabsPage(Title = "新建定时归档任务", Closable = true)]

<PageHeader Title="新建定时归档任务" SubTitle="配置基于 BulkCopy 的定时归档任务（仅支持普通表）" OnBack="NavigateBack">
    <PageHeaderExtra>
        <Space>
            <SpaceItem><Button OnClick="HandleReset">重置</Button></SpaceItem>
            <SpaceItem><Button OnClick="NavigateBack">取消</Button></SpaceItem>
            <SpaceItem><Button Type="@ButtonType.Primary" Loading="_submitting" OnClick="HandleSubmit">保存</Button></SpaceItem>
        </Space>
    </PageHeaderExtra>
</PageHeader>

<div class="scheduled-job-form-container">
    <Row Gutter="16">
        <!-- 左侧：表单区域 -->
        <Col Span="16">
            <Card Title="基本信息" Class="form-section">
                <Form Model="_formModel" LabelCol="new ColLayoutParam { Span = 6 }" WrapperCol="new ColLayoutParam { Span = 18 }">
                    <FormItem Label="任务名称" Required>
                        <Input @bind-Value="_formModel.Name" Placeholder="例如: 订单归档任务" MaxLength="100" />
                        <span class="ant-form-text">2-100 字符，不允许仅数字</span>
                    </FormItem>
                    <FormItem Label="任务描述">
                        <TextArea @bind-Value="_formModel.Description" Rows="3" Placeholder="描述任务用途、归档规则等" MaxLength="500" />
                    </FormItem>
                    <FormItem Label="数据源">
                        <div class="readonly-field">
                            <span><strong>@_dataSourceName</strong></span>
                            <span style="color: rgba(0,0,0,.45);"> (@_dataSourceInfo)</span>
                        </div>
                    </FormItem>
                </Form>
            </Card>

            <Card Title="表配置" Class="form-section">
                <TableSelector @ref="_tableSelector"
                               DataSourceId="@DataSourceId"
                               SourceSchema="@_formModel.SourceSchemaName"
                               SourceTable="@_formModel.SourceTableName"
                               SourceSchemaChanged="OnSourceSchemaChanged"
                               SourceTableChanged="OnSourceTableChanged"
                               OnTableStatisticsChanged="OnTableStatisticsChanged" />
                <Divider />
                <Form Model="_formModel" LabelCol="new ColLayoutParam { Span = 6 }" WrapperCol="new ColLayoutParam { Span = 18 }">
                    <FormItem Label="目标服务器">
                        <div class="readonly-field">
                            <span><strong>@_dataSourceName</strong></span>
                            <span style="color: rgba(0,0,0,.45);"> (@_dataSourceInfo)</span>
                        </div>
                        <span class="ant-form-text">目标表将在同一服务器上创建</span>
                    </FormItem>
                    <FormItem Label="目标表架构">
                        <Input @bind-Value="_formModel.TargetSchemaName"
                               @bind-Value:after="OnTargetSchemaChanged"
                               Placeholder="默认: dbo" />
                    </FormItem>
                    <FormItem Label="目标表名称" Required>
                        <Input @bind-Value="_formModel.TargetTableName" 
                               Placeholder="例如: Orders_Archive"
                               @bind-Value:after="OnTargetTableNameChanged" />
                        <span class="ant-form-text">自动建议: @GetSuggestedTargetTable()</span>
                    </FormItem>
                    <FormItem Label="目标表检查">
                        <Space>
                            <SpaceItem>
                                <Button OnClick="CheckTargetTable" Loading="_checkingTargetTable" Icon="search">
                                    检查目标表
                                </Button>
                            </SpaceItem>
                            @if (_targetTableExists.HasValue)
                            {
                                <SpaceItem>
                                    @if (_targetTableExists.Value)
                                    {
                                        <Tag Color="@("green")">✅ 目标表已存在</Tag>
                                    }
                                    else
                                    {
                                        <Tag Color="@("orange")">⚠️ 目标表不存在</Tag>
                                        <Button Type="@ButtonType.Primary" Size="@ButtonSize.Small" OnClick="GenerateTargetTable">
                                            自动创建目标表
                                        </Button>
                                    }
                                </SpaceItem>
                            }
                        </Space>
                        @if (!string.IsNullOrWhiteSpace(_targetTableCheckMessage))
                        {
                            <div style="margin-top: 8px;">
                                <span style="color: @(_targetTableExists == true ? "#52c41a" : "#faad14");">@_targetTableCheckMessage</span>
                            </div>
                        }
                    </FormItem>
                </Form>
            </Card>

            <Card Title="筛选条件(必填)" Class="form-section">
                <Alert Type="@AlertType.Warning" Message="定时归档任务必须配置筛选条件,防止意外归档整个表" ShowIcon="true" Closable="false" Style="margin-bottom: 16px;" />
                <FilterBuilder @ref="_filterBuilder"
                               DataSourceId="@DataSourceId"
                               SourceSchema="@_formModel.SourceSchemaName"
                               SourceTable="@_formModel.SourceTableName"
                               WhereClause="@_formModel.ArchiveFilterCondition"
                               WhereClauseChanged="OnWhereClauseChanged" />
            </Card>

            <Card Title="归档参数" Class="form-section">
                <Form Model="_formModel" LabelCol="new ColLayoutParam { Span = 6 }" WrapperCol="new ColLayoutParam { Span = 18 }">
                    <FormItem Label="归档方法">
                        <div class="readonly-field">
                            <Tag Color="@("blue")">BulkCopy</Tag>
                            <span style="color: rgba(0,0,0,.45);">固定使用 SqlBulkCopy API</span>
                        </div>
                    </FormItem>
                    <FormItem Label="批次大小" Required>
                        <RadioGroup @bind-Value="_batchSizeSelection" @bind-Value:after="OnBatchSizeSelectionChanged">
                            <Radio Value="1000">1,000 行</Radio>
                            <Radio Value="5000">5,000 行（推荐）</Radio>
                            <Radio Value="10000">10,000 行</Radio>
                            <Radio Value="@CustomBatchSizeValue">自定义</Radio>
                        </RadioGroup>
                        <AntDesign.InputNumber @bind-Value="_customBatchSize"
                                               @bind-Value:after="OnCustomBatchSizeChanged"
                                               Min="1"
                                               Max="100000"
                                               Disabled="@(_batchSizeSelection != CustomBatchSizeValue)"
                                               Style="width: 200px; margin-left: 16px;" />
                    </FormItem>
                    <FormItem Label="单次最大行数">
                        <AntDesign.InputNumber @bind-Value="_formModel.MaxRowsPerExecution" Min="1000" Max="10000000" Step="1000" Style="width: 200px;" />
                        <span class="ant-form-text">推荐 50,000，避免单次执行时间过长</span>
                    </FormItem>
                </Form>
            </Card>

            <Card Title="调度配置" Class="form-section">
                <Form Model="_formModel" LabelCol="new ColLayoutParam { Span = 6 }" WrapperCol="new ColLayoutParam { Span = 18 }">
                    <FormItem Label="调度方式">
                        <RadioGroup @bind-Value="_scheduleMode">
                            <Radio Value="@("interval")">按间隔</Radio>
                            <Radio Value="@("cron")">Cron 表达式（高级）</Radio>
                        </RadioGroup>
                    </FormItem>
                    @if (_scheduleMode == "interval")
                    {
                        <FormItem Label="间隔分钟">
                            <AntDesign.InputNumber @bind-Value="_formModel.IntervalMinutes" Min="1" Max="43200" Style="width: 200px;" />
                            <span class="ant-form-text">最小 1 分钟，最大 30 天</span>
                        </FormItem>
                    }
                    else
                    {
                        <FormItem Label="Cron 表达式">
                            <CronBuilder CronExpression="@_formModel.CronExpression"
                                         CronExpressionChanged="OnCronExpressionChanged" />
                        </FormItem>
                    }
                </Form>
            </Card>

            <Card Title="安全与限制" Class="form-section">
                <Form Model="_formModel" LabelCol="new ColLayoutParam { Span = 6 }" WrapperCol="new ColLayoutParam { Span = 18 }">
                    <FormItem Label="最大连续失败">
                        <AntDesign.InputNumber @bind-Value="_formModel.MaxConsecutiveFailures" Min="1" Max="100" Style="width: 200px;" />
                        <span class="ant-form-text">达到此次数后自动禁用任务</span>
                    </FormItem>
                    <FormItem Label="立即启用">
                        <Switch @bind-Checked="_formModel.IsEnabled" CheckedChildren="是" UnCheckedChildren="否" />
                        <span class="ant-form-text">保存后立即开始调度</span>
                    </FormItem>
                </Form>
            </Card>
        </Col>

        <!-- 右侧：预览面板 -->
        <Col Span="8">
            <div class="preview-panel">
                <Card Title="任务预览" Class="preview-card">
                    <Descriptions Bordered Size="@DescriptionsSize.Small" Column="1">
                        <DescriptionsItem Title="任务名称">@(_formModel.Name ?? "-")</DescriptionsItem>
                        <DescriptionsItem Title="源表">@GetFullSourceTable()</DescriptionsItem>
                        <DescriptionsItem Title="目标表">@GetFullTargetTable()</DescriptionsItem>
                        <DescriptionsItem Title="筛选条件">
                            @if (!string.IsNullOrWhiteSpace(_formModel.ArchiveFilterCondition))
                            {
                                <pre class="filter-preview">@_formModel.ArchiveFilterCondition</pre>
                            }
                            else
                            {
                                <span style="color: rgba(0,0,0,.45);">未配置</span>
                            }
                        </DescriptionsItem>
                        <DescriptionsItem Title="归档方法">
                            <Tag Color="@("blue")">BulkCopy</Tag>
                        </DescriptionsItem>
                        <DescriptionsItem Title="批次大小">@_formModel.BatchSize.ToString("N0") 行</DescriptionsItem>
                        <DescriptionsItem Title="单次最大">@_formModel.MaxRowsPerExecution.ToString("N0") 行</DescriptionsItem>
                        <DescriptionsItem Title="调度方式">
                            @if (_scheduleMode == "interval" && _formModel.IntervalMinutes.HasValue)
                            {
                                <span>每 @_formModel.IntervalMinutes 分钟</span>
                            }
                            else if (_scheduleMode == "cron" && !string.IsNullOrWhiteSpace(_formModel.CronExpression))
                            {
                                <span>@_formModel.CronExpression</span>
                            }
                            else
                            {
                                <span style="color: rgba(0,0,0,.45);">未配置</span>
                            }
                        </DescriptionsItem>
                        <DescriptionsItem Title="启用状态">
                            @if (_formModel.IsEnabled)
                            {
                                <Badge Status="@BadgeStatus.Success" Text="立即启用" />
                            }
                            else
                            {
                                <Badge Status="@BadgeStatus.Default" Text="保存后不启用" />
                            }
                        </DescriptionsItem>
                    </Descriptions>
                </Card>

                @if (!string.IsNullOrWhiteSpace(_validationMessage))
                {
                    <Alert Type="@AlertType.Warning" Message="@_validationMessage" ShowIcon="true" Style="margin-top: 16px;" />
                }
            </div>
        </Col>
    </Row>
</div>

@code {
    [Parameter] public Guid DataSourceId { get; set; }

    [Inject] private ScheduledArchiveJobApiClient JobApi { get; set; } = default!;
    [Inject] private ScheduledArchiveJobState JobState { get; set; } = default!;
    [Inject] private ArchiveDataSourceApiClient DataSourceApi { get; set; } = default!;
    [Inject] private MessageService Message { get; set; } = default!;
    [Inject] private NavigationManager Navigation { get; set; } = default!;

    private readonly CreateJobFormModel _formModel = new();
    private string _dataSourceName = "加载中...";
    private string _dataSourceInfo = "";
    private string? _validationMessage;
    private bool _submitting;
    private string _scheduleMode = "interval";
    private const int CustomBatchSizeValue = -1;
    private int _batchSizeSelection = 5000;
    private int _customBatchSize = 5000;
    private TableSelector? _tableSelector;
    private FilterBuilder? _filterBuilder;
    private TableWithStatisticsDto? _selectedTableStats;
    private bool _checkingTargetTable;
    private bool? _targetTableExists;
    private string? _targetTableCheckMessage;
    private int _targetTableCheckVersion;

    protected override async Task OnInitializedAsync()
    {
        await LoadDataSourceInfoAsync();
        InitializeFormDefaults();
    }

    private async Task LoadDataSourceInfoAsync()
    {
        var result = await DataSourceApi.GetAsync();
        if (result.IsSuccess && result.Value != null)
        {
            var dataSource = result.Value.FirstOrDefault(ds => ds.Id == DataSourceId);
            if (dataSource != null)
            {
                _dataSourceName = dataSource.Name;
                _dataSourceInfo = $"{dataSource.ServerAddress}:{dataSource.ServerPort} / {dataSource.DatabaseName}";
            }
        }
    }

    private void InitializeFormDefaults()
    {
        _formModel.SourceSchemaName = "dbo";
        _formModel.TargetSchemaName = "dbo";
        _formModel.BatchSize = 5000;
        _batchSizeSelection = _formModel.BatchSize;
        _customBatchSize = _formModel.BatchSize;
        _formModel.MaxRowsPerExecution = 50000;
        _formModel.MaxConsecutiveFailures = 5;
        _formModel.IsEnabled = true;
        _formModel.IntervalMinutes = 60;
    }

    private async Task OnSourceSchemaChanged(string? schema)
    {
        _formModel.SourceSchemaName = schema ?? "dbo";
        _formModel.TargetSchemaName = schema ?? "dbo";
        ResetTargetTableCheckState();
        await InvokeAsync(StateHasChanged);
    }

    private async Task OnSourceTableChanged(string? tableName)
    {
        _formModel.SourceTableName = tableName;
        
        // 自动更新目标表名（跟随源表变更）
        if (!string.IsNullOrWhiteSpace(_formModel.SourceTableName))
        {
            _formModel.TargetTableName = $"{_formModel.SourceTableName}_Archive";
            
            // 清除之前的检查结果
            ResetTargetTableCheckState();
        }
        
        await InvokeAsync(StateHasChanged);
    }

    private async Task OnTableStatisticsChanged(TableWithStatisticsDto? stats)
    {
        _selectedTableStats = stats;
        
        // 如果表超过100万行,建议调整批次大小
        if (stats != null && stats.RowCount > 1000000)
        {
            if (_formModel.BatchSize > 5000)
            {
                _formModel.BatchSize = 5000;
            }
            if (_formModel.MaxRowsPerExecution > 50000)
            {
                _formModel.MaxRowsPerExecution = 50000;
            }
        }

        SyncBatchSizeSelection();
        await InvokeAsync(StateHasChanged);
    }

    private string GetSuggestedTargetTable()
    {
        if (string.IsNullOrWhiteSpace(_formModel.SourceTableName))
        {
            return "-";
        }
        return $"{_formModel.SourceTableName}_Archive";
    }

    private string GetFullSourceTable()
    {
        if (string.IsNullOrWhiteSpace(_formModel.SourceTableName))
        {
            return "-";
        }
        return $"{_formModel.SourceSchemaName ?? "dbo"}.{_formModel.SourceTableName}";
    }

    private string GetFullTargetTable()
    {
        if (string.IsNullOrWhiteSpace(_formModel.TargetTableName))
        {
            return "-";
        }
        return $"{_formModel.TargetSchemaName ?? "dbo"}.{_formModel.TargetTableName}";
    }

    private bool ValidateForm()
    {
        var errors = new List<string>();

        if (string.IsNullOrWhiteSpace(_formModel.Name))
        {
            errors.Add("请填写任务名称");
        }
        else if (_formModel.Name.Length < 2 || _formModel.Name.Length > 100)
        {
            errors.Add("任务名称长度需在 2-100 字符之间");
        }
        else if (Regex.IsMatch(_formModel.Name, @"^\d+$"))
        {
            errors.Add("任务名称不允许仅数字");
        }

        // 使用 TableSelector 的验证
        if (_tableSelector != null)
        {
            var (isValid, errorMessage) = _tableSelector.ValidateTableForArchive();
            if (!isValid)
            {
                errors.Add(errorMessage ?? "表选择验证失败");
            }
        }
        else if (string.IsNullOrWhiteSpace(_formModel.SourceTableName))
        {
            errors.Add("请选择源表");
        }

        if (string.IsNullOrWhiteSpace(_formModel.TargetTableName))
        {
            errors.Add("请填写目标表名称");
        }
        else if (!IsValidSqlIdentifier(_formModel.TargetTableName))
        {
            errors.Add("目标表名称仅支持字母、数字、下划线，且需以字母或下划线开头");
        }

        if (!string.IsNullOrWhiteSpace(_formModel.SourceSchemaName) &&
            !IsValidSqlIdentifier(_formModel.SourceSchemaName))
        {
            errors.Add("源表架构仅支持字母、数字、下划线，且需以字母或下划线开头");
        }

        if (!string.IsNullOrWhiteSpace(_formModel.TargetSchemaName) &&
            !IsValidSqlIdentifier(_formModel.TargetSchemaName))
        {
            errors.Add("目标表架构仅支持字母、数字、下划线，且需以字母或下划线开头");
        }

        if (_formModel.BatchSize < 1 || _formModel.BatchSize > 100000)
        {
            errors.Add("批次大小需在 1 - 100,000 之间");
        }

        if (string.IsNullOrWhiteSpace(_formModel.ArchiveFilterCondition))
        {
            errors.Add("必须配置筛选条件，防止意外归档整个表");
        }

        if (_scheduleMode == "interval" && (!_formModel.IntervalMinutes.HasValue || _formModel.IntervalMinutes < 1))
        {
            errors.Add("请设置有效的间隔分钟数（最小 1 分钟）");
        }

        if (_scheduleMode == "cron" && string.IsNullOrWhiteSpace(_formModel.CronExpression))
        {
            errors.Add("请填写 Cron 表达式");
        }
        else if (_scheduleMode == "cron")
        {
            var cronExpression = _formModel.CronExpression?.Trim();
            if (!string.IsNullOrWhiteSpace(cronExpression))
            {
                try
                {
                    CronExpression.Parse(cronExpression, CronFormat.Standard);
                }
                catch (Exception ex)
                {
                    errors.Add($"Cron 表达式无效: {ex.Message}");
                }
            }
        }

        if (errors.Any())
        {
            _validationMessage = string.Join("；", errors);
            return false;
        }

        _validationMessage = null;
        return true;
    }

    private async Task HandleSubmit()
    {
        if (!ValidateForm())
        {
            Message.Warning(_validationMessage ?? "请完善表单信息");
            return;
        }

        _submitting = true;
        try
        {
            // 从 FilterBuilder 获取主筛选字段
            var primaryFilterColumn = _filterBuilder?.GetPrimaryFilterColumn();
            if (string.IsNullOrWhiteSpace(primaryFilterColumn))
            {
                Message.Warning("无法获取筛选字段，请检查筛选条件配置");
                return;
            }

            // 导出筛选条件定义为 JSON
            var filterDefinition = _filterBuilder?.ExportFilterDefinition();

            var request = new CreateScheduledArchiveJobRequest
            {
                Name = _formModel.Name!.Trim(),
                Description = string.IsNullOrWhiteSpace(_formModel.Description) ? null : _formModel.Description.Trim(),
                DataSourceId = DataSourceId,
                SourceSchemaName = _formModel.SourceSchemaName ?? "dbo",
                SourceTableName = _formModel.SourceTableName!.Trim(),
                TargetSchemaName = _formModel.TargetSchemaName ?? "dbo",
                TargetTableName = _formModel.TargetTableName!.Trim(),
                ArchiveFilterColumn = primaryFilterColumn,
                ArchiveFilterCondition = _formModel.ArchiveFilterCondition!.Trim(),
                ArchiveFilterDefinition = filterDefinition,
                BatchSize = _formModel.BatchSize,
                MaxRowsPerExecution = _formModel.MaxRowsPerExecution,
                IntervalMinutes = _scheduleMode == "interval" ? _formModel.IntervalMinutes : null,
                CronExpression = _scheduleMode == "cron" ? _formModel.CronExpression?.Trim() : null,
                IsEnabled = _formModel.IsEnabled,
                MaxConsecutiveFailures = _formModel.MaxConsecutiveFailures
            };

            var result = await JobApi.CreateAsync(request);
            
            if (result.IsSuccess)
            {
                var targetUrl = $"/archive-data-sources/{DataSourceId}/scheduled-jobs";
                
                // 显示成功消息
                Message.Success("任务创建成功");
                
                // 跳转到列表页面
                Navigation.NavigateTo(targetUrl, forceLoad: true);
                return; // 立即返回，避免后续代码执行
            }
            else
            {
                Message.Error(result.Error ?? "创建任务失败");
                _submitting = false;
            }
        }
        catch (Exception ex)
        {
            Message.Error($"保存失败: {ex.Message}");
            _submitting = false;
        }
    }

    private void HandleReset()
    {
        _formModel.Reset();
        InitializeFormDefaults();
        _scheduleMode = "interval";
        _validationMessage = null;
        _selectedTableStats = null;
        ResetTargetTableCheckState();
    }

    private async Task OnWhereClauseChanged(string? whereClause)
    {
        _formModel.ArchiveFilterCondition = whereClause;
        await Task.CompletedTask;
    }

    private async Task OnCronExpressionChanged(string? cronExpression)
    {
        _formModel.CronExpression = cronExpression;
        await Task.CompletedTask;
    }

    private void NavigateBack()
    {
        Navigation.NavigateTo($"/archive-data-sources/{DataSourceId}/scheduled-jobs");
    }

    private async Task OnTargetTableNameChanged()
    {
        // 目标表名变化时，清除之前的检查结果
        ResetTargetTableCheckState();
        await Task.CompletedTask;
    }

    private async Task OnTargetSchemaChanged()
    {
        ResetTargetTableCheckState();
        await Task.CompletedTask;
    }

    private async Task CheckTargetTable()
    {
        if (string.IsNullOrWhiteSpace(_formModel.SourceTableName) || string.IsNullOrWhiteSpace(_formModel.TargetTableName))
        {
            Message.Warning("请先选择源表和填写目标表名称");
            return;
        }

        _checkingTargetTable = true;
        _targetTableExists = null;
        _targetTableCheckMessage = null;
        var requestVersion = ++_targetTableCheckVersion;
        var requestSnapshot = BuildTargetTableSnapshot();
        try
        {
            var result = await JobApi.ValidateTargetTableAsync(
                DataSourceId,
                _formModel.SourceSchemaName ?? "dbo",
                _formModel.SourceTableName,
                _formModel.TargetSchemaName ?? "dbo",
                _formModel.TargetTableName);

            if (IsTargetTableCheckStale(requestVersion, requestSnapshot))
            {
                return;
            }

            if (result.IsSuccess && result.Value != null)
            {
                _targetTableExists = result.Value.TargetTableExists;
                _targetTableCheckMessage = result.Value.Message;
                
                if (result.Value.TargetTableExists)
                {
                    if (result.Value.IsCompatible)
                    {
                        // 目标表存在且结构一致
                        Message.Success($"? 目标表结构验证通过：{result.Value.Message}");
                    }
                    else
                    {
                        // 目标表存在但结构不一致
                        Message.Warning($"?? {result.Value.Message}");
                        
                        // 显示详细差异信息
                        if (result.Value.MissingColumns.Any())
                        {
                            Message.Warning($"缺失列: {string.Join(", ", result.Value.MissingColumns)}");
                        }
                        if (result.Value.TypeMismatchColumns.Any())
                        {
                            Message.Warning($"类型不匹配: {string.Join(", ", result.Value.TypeMismatchColumns)}");
                        }
                        if (result.Value.LengthInsufficientColumns.Any())
                        {
                            Message.Warning($"长度不足: {string.Join(", ", result.Value.LengthInsufficientColumns)}");
                        }
                        if (result.Value.PrecisionInsufficientColumns.Any())
                        {
                            Message.Warning($"精度不足: {string.Join(", ", result.Value.PrecisionInsufficientColumns)}");
                        }
                    }
                }
                else
                {
                    // 目标表不存在
                    Message.Warning("目标表不存在，请先创建目标表");
                }
            }
            else
            {
                if (IsTargetTableCheckStale(requestVersion, requestSnapshot))
                {
                    return;
                }

                Message.Error(result.Error ?? "验证目标表失败");
            }
        }
        catch (Exception ex)
        {
            if (IsTargetTableCheckStale(requestVersion, requestSnapshot))
            {
                return;
            }

            Message.Error($"验证目标表失败: {ex.Message}");
        }
        finally
        {
            if (!IsTargetTableCheckStale(requestVersion, requestSnapshot))
            {
                _checkingTargetTable = false;
            }
        }
    }

    private async Task GenerateTargetTable()
    {
        if (string.IsNullOrWhiteSpace(_formModel.SourceTableName) || string.IsNullOrWhiteSpace(_formModel.TargetTableName))
        {
            Message.Warning("请先选择源表和填写目标表名称");
            return;
        }

        var requestVersion = ++_targetTableCheckVersion;
        var requestSnapshot = BuildTargetTableSnapshot();
        try
        {
            var result = await JobApi.CreateTargetTableAsync(
                DataSourceId,
                _formModel.SourceSchemaName ?? "dbo",
                _formModel.SourceTableName,
                _formModel.TargetSchemaName ?? "dbo",
                _formModel.TargetTableName);

            if (IsTargetTableCheckStale(requestVersion, requestSnapshot))
            {
                return;
            }

            if (result.IsSuccess && result.Value != null)
            {
                _targetTableExists = true;
                _targetTableCheckMessage = result.Value.Message;
                Message.Success($"? 目标表创建成功，共 {result.Value.ColumnCount} 列");
                
                // 创建成功后自动验证表结构
                await CheckTargetTable();
            }
            else
            {
                if (IsTargetTableCheckStale(requestVersion, requestSnapshot))
                {
                    return;
                }

                Message.Error(result.Error ?? "创建目标表失败");
            }
        }
        catch (Exception ex)
        {
            if (IsTargetTableCheckStale(requestVersion, requestSnapshot))
            {
                return;
            }

            Message.Error($"创建目标表失败: {ex.Message}");
        }
    }

    private static bool IsValidSqlIdentifier(string name)
    {
        if (string.IsNullOrWhiteSpace(name))
        {
            return false;
        }

        return Regex.IsMatch(name, "^[A-Za-z_][A-Za-z0-9_]*$");
    }

    private void ResetTargetTableCheckState()
    {
        _targetTableCheckVersion++;
        _checkingTargetTable = false;
        _targetTableExists = null;
        _targetTableCheckMessage = null;
    }

    private string BuildTargetTableSnapshot()
    {
        var sourceSchema = _formModel.SourceSchemaName ?? "dbo";
        var targetSchema = _formModel.TargetSchemaName ?? "dbo";
        return $"{DataSourceId}|{sourceSchema}|{_formModel.SourceTableName}|{targetSchema}|{_formModel.TargetTableName}";
    }

    private bool IsTargetTableCheckStale(int version, string snapshot)
    {
        return version != _targetTableCheckVersion || snapshot != BuildTargetTableSnapshot();
    }

    private void SyncBatchSizeSelection()
    {
        _batchSizeSelection = _formModel.BatchSize switch
        {
            1000 => 1000,
            5000 => 5000,
            10000 => 10000,
            _ => CustomBatchSizeValue
        };
        _customBatchSize = _formModel.BatchSize;
    }

    private void OnBatchSizeSelectionChanged()
    {
        if (_batchSizeSelection == CustomBatchSizeValue)
        {
            _formModel.BatchSize = _customBatchSize;
        }
        else
        {
            _formModel.BatchSize = _batchSizeSelection;
            _customBatchSize = _batchSizeSelection;
        }
    }

    private void OnCustomBatchSizeChanged()
    {
        if (_batchSizeSelection == CustomBatchSizeValue)
        {
            _formModel.BatchSize = _customBatchSize;
        }
    }
    private sealed class CreateJobFormModel
    {
        public string? Name { get; set; }
        public string? Description { get; set; }
        public string? SourceSchemaName { get; set; }
        public string? SourceTableName { get; set; }
        public string? TargetSchemaName { get; set; }
        public string? TargetTableName { get; set; }
        public string? ArchiveFilterColumn { get; set; }
        public string? ArchiveFilterCondition { get; set; }
        public string? ArchiveFilterDefinition { get; set; }
        public int BatchSize { get; set; } = 5000;
        public int MaxRowsPerExecution { get; set; } = 50000;
        public int? IntervalMinutes { get; set; }
        public string? CronExpression { get; set; }
        public bool IsEnabled { get; set; } = true;
        public int MaxConsecutiveFailures { get; set; } = 5;

        public void Reset()
        {
            Name = null;
            Description = null;
            SourceSchemaName = "dbo";
            SourceTableName = null;
            TargetSchemaName = "dbo";
            TargetTableName = null;
            ArchiveFilterColumn = null;
            ArchiveFilterCondition = null;
            BatchSize = 5000;
            MaxRowsPerExecution = 50000;
            IntervalMinutes = 60;
            CronExpression = null;
            IsEnabled = true;
            MaxConsecutiveFailures = 5;
        }
    }
}






















