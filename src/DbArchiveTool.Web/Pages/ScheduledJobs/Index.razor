@page "/archive-data-sources/{DataSourceId:guid}/scheduled-jobs"
@using AntDesign
@using DbArchiveTool.Web.Services
@using DbArchiveTool.Web.Models
@implements IDisposable
@attribute [ReuseTabsPage(Title = "定时归档任务", Closable = true)]

<PageHeader Title="定时归档任务" OnBack="NavigateBack">
    <PageHeaderExtra>
        <Space>
            <SpaceItem><Button Type="ButtonType.Primary" Icon="plus" OnClick="ShowCreateModal">新建任务</Button></SpaceItem>
            <SpaceItem><Button Type="ButtonType.Default" Icon="reload" Loading="_loading" OnClick="RefreshAsync">刷新</Button></SpaceItem>
        </Space>
    </PageHeaderExtra>
    <PageHeaderContent>
        <div class="scheduled-jobs-header">
            <div class="header-info">
                <Text Strong>数据源：</Text>
                <Text>@_dataSourceName</Text>
            </div>
            <div class="header-stats">
                <Statistic Title="任务总数" Value="@((object?)_statistics?.TotalJobCount ?? "-")" Suffix="个" />
                <Statistic Title="启用任务" Value="@((object?)_statistics?.EnabledJobCount ?? "-")" Suffix="个" />
                <Statistic Title="今日有执行" Value="@((object?)_statistics?.TodayExecutionCount ?? "-")" Suffix="个" />
                <Statistic Title="今日成功率" Value="@((object?)_statistics?.TodaySuccessRate.ToString("F1") ?? "-")" Suffix="%" />
            </div>
        </div>
    </PageHeaderContent>
</PageHeader>

<Card>
    <div class="scheduled-jobs-filters">
        <Space>
            <SpaceItem>
                <RadioGroup @bind-Value="_filterEnabled" ButtonStyle="RadioButtonStyle.Solid">
                    <Radio Value="@((bool?)null)">全部</Radio>
                    <Radio Value="@((bool?)true)">已启用</Radio>
                    <Radio Value="@((bool?)false)">已禁用</Radio>
                </RadioGroup>
            </SpaceItem>
            <SpaceItem>
                <Search Placeholder="搜索任务名称或表名" @bind-Value="_searchKeyword" OnSearch="OnFilterChanged" EnterButton="true" Style="width: 300px;" />
            </SpaceItem>
        </Space>
    </div>

    <Table TItem="ScheduledArchiveJobDto"
           DataSource="_filteredJobs"
           Loading="_loading"
           Size="TableSize.Small"
           Bordered
           @bind-PageIndex="_pageIndex"
           @bind-PageSize="_pageSize"
           Total="_filteredJobs.Count">
        <PropertyColumn Property="c => c.Name" Title="任务名称" Width="200">
            <a href="javascript:void(0)" @onclick="() => NavigateToDetails(context.Id)">@context.Name</a>
        </PropertyColumn>
        <PropertyColumn Property="c => c.FullSourceTable" Title="源表" Width="180" />
        <PropertyColumn Property="c => c.FullTargetTable" Title="目标表" Width="180" />
        <PropertyColumn Property="c => c.CronDescription" Title="执行频率" Width="150">
            <span>@GetScheduleDisplay(context)</span>
        </PropertyColumn>
        <PropertyColumn Property="c => c.NextExecutionDisplay" Title="下次执行" Width="140">
            @if (!context.IsEnabled)
            {
                <span style="color: rgba(0,0,0,.45);">已禁用</span>
            }
            else if (context.NextExecutionAtUtc.HasValue)
            {
                <span>@context.NextExecutionAtUtc.Value.ToLocalTime().ToString("yyyy-MM-dd HH:mm:ss")</span>
            }
            else
            {
                <span style="color: #faad14;">未调度</span>
            }
        </PropertyColumn>
        <PropertyColumn Property="c => c.LastExecutionStatusDisplay" Title="最近状态" Width="100">
            @switch (context.LastExecutionStatus)
            {
                case JobExecutionStatus.Success:
                    <Tag Color="@("green")">@GetLastExecutionStatusText(context)</Tag>
                    break;
                case JobExecutionStatus.Running:
                    <Tag Color="@("blue")">@GetLastExecutionStatusText(context)</Tag>
                    break;
                case JobExecutionStatus.Failed:
                    <Tooltip Title="@GetFailureTooltip(context)">
                        <Tag Color="@("red")">@GetLastExecutionStatusText(context)</Tag>
                    </Tooltip>
                    break;
                case JobExecutionStatus.Skipped:
                    <Tag Color="@("default")">@GetLastExecutionStatusText(context)</Tag>
                    break;
                default:
                    <span style="color: rgba(0,0,0,.45);">@GetLastExecutionStatusText(context)</span>
                    break;
            }
        </PropertyColumn>
        <PropertyColumn Property="c => c.LastArchivedRowCount" Title="最近归档行数" Width="120" Align="ColumnAlign.Right">
            @if (context.LastArchivedRowCount.HasValue)
            {
                <span>@context.LastArchivedRowCount.Value.ToString("N0")</span>
            }
            else
            {
                <span style="color: rgba(0,0,0,.45);">-</span>
            }
        </PropertyColumn>
        <PropertyColumn Property="c => c.IsEnabled" Title="状态" Width="80">
            @if (context.IsEnabled)
            {
                <Badge Status="@BadgeStatus.Success" Text="启用" />
            }
            else
            {
                <Badge Status="@BadgeStatus.Default" Text="禁用" />
            }
        </PropertyColumn>
        <ActionColumn Title="操作" Width="220">
            <Space Size="@("small")">
                @if (context.IsEnabled && !context.NextExecutionAtUtc.HasValue)
                {
                    <SpaceItem><Button Type="ButtonType.Link" Size="@ButtonSize.Small" OnClick="() => RescheduleJobAsync(context.Id)">同步调度</Button></SpaceItem>
                }
                @if (context.IsEnabled)
                {
                    <SpaceItem><Button Type="ButtonType.Link" Size="@ButtonSize.Small" OnClick="() => DisableJobAsync(context.Id)">禁用</Button></SpaceItem>
                }
                else
                {
                    <SpaceItem><Button Type="ButtonType.Link" Size="@ButtonSize.Small" OnClick="() => EnableJobAsync(context.Id)">启用</Button></SpaceItem>
                }
                <SpaceItem><Button Type="ButtonType.Link" Size="@ButtonSize.Small" OnClick="() => ExecuteJobAsync(context.Id)">立即执行</Button></SpaceItem>
                <SpaceItem><Button Type="ButtonType.Link" Size="@ButtonSize.Small" OnClick="() => ShowEditModal(context)">编辑</Button></SpaceItem>
                <SpaceItem>
                    <Popconfirm Title="确定删除此任务吗？" OnConfirm="() => DeleteJobAsync(context.Id)" OkText="删除" CancelText="取消">
                        <Button Type="ButtonType.Link" Size="@ButtonSize.Small" Danger>删除</Button>
                    </Popconfirm>
                </SpaceItem>
            </Space>
        </ActionColumn>
    </Table>
</Card>

@code {
    [Parameter] public Guid DataSourceId { get; set; }

    [Inject] private ScheduledArchiveJobApiClient JobApi { get; set; } = default!;
    [Inject] private ScheduledArchiveJobState JobState { get; set; } = default!;
    [Inject] private ArchiveDataSourceApiClient DataSourceApi { get; set; } = default!;
    [Inject] private MessageService Message { get; set; } = default!;
    [Inject] private NavigationManager Navigation { get; set; } = default!;

    private List<ScheduledArchiveJobDto> _jobs = new();
    private List<ScheduledArchiveJobDto> _filteredJobs = new();
    private ScheduledArchiveJobStatisticsDto? _statistics;
    private string _dataSourceName = "加载中...";

    private bool _loading;
    private string? _searchKeyword;
    private int _pageIndex = 1;
    private int _pageSize = 20;
    private bool _disposed;

    private bool? _filterEnabled
    {
        get => _filterEnabledValue;
        set
        {
            if (_filterEnabledValue != value)
            {
                _filterEnabledValue = value;
                ApplyFilters();
                StateHasChanged();
            }
        }
    }
    private bool? _filterEnabledValue;

    private string GetScheduleDisplay(ScheduledArchiveJobDto job)
    {
        // CronExpression 优先：列表展示应与 CronBuilder 预览/后端调度一致
        if (!string.IsNullOrWhiteSpace(job.CronExpression))
        {
            return DescribeCron(job.CronExpression);
        }

        if (job.IntervalMinutes.HasValue)
        {
            return $"每 {job.IntervalMinutes} 分钟";
        }

        return "未配置";
    }

    private static string DescribeCron(string cronExpression)
    {
        // 仅处理本项目 CronBuilder 生成的标准 5 段 Cron：min hour dom month dow
        // 其他格式直接回显表达式，避免误导。
        var parts = cronExpression.Trim().Split(' ', StringSplitOptions.RemoveEmptyEntries);
        if (parts.Length != 5)
        {
            return cronExpression;
        }

        var minute = parts[0];
        var hour = parts[1];
        var dayOfMonth = parts[2];
        var month = parts[3];
        var dayOfWeek = parts[4];

        if (hour == "*" && dayOfMonth == "*" && month == "*" && dayOfWeek == "*")
        {
            // */N * * * *
            if (minute == "*")
            {
                return "每 1 分钟执行一次";
            }

            if (minute.StartsWith("*/", StringComparison.Ordinal) && int.TryParse(minute[2..], out var n) && n > 0)
            {
                return $"每 {n} 分钟执行一次";
            }
        }

        if (dayOfMonth == "*" && month == "*" && dayOfWeek == "*")
        {
            // M */H * * *
            if (hour.StartsWith("*/", StringComparison.Ordinal) && int.TryParse(hour[2..], out var h) && h > 0 && int.TryParse(minute, out var m1))
            {
                return $"每 {h} 小时的第 {m1} 分钟执行";
            }

            // M H * * *
            if (int.TryParse(hour, out var h1) && int.TryParse(minute, out var m2))
            {
                return $"每天 {h1:D2}:{m2:D2} 执行";
            }
        }

        // M H * * DOW
        if (dayOfMonth == "*" && month == "*" && dayOfWeek != "*" && int.TryParse(hour, out var wh) && int.TryParse(minute, out var wm))
        {
            var days = dayOfWeek.Split(',', StringSplitOptions.RemoveEmptyEntries)
                .Select(GetWeekdayName)
                .Where(n => !string.IsNullOrWhiteSpace(n))
                .ToArray();

            if (days.Length > 0)
            {
                return $"每周 {string.Join("、", days)} {wh:D2}:{wm:D2} 执行";
            }
        }

        // M H DOM * *
        if (month == "*" && dayOfWeek == "*" && dayOfMonth != "*" && int.TryParse(hour, out var mh) && int.TryParse(minute, out var mm))
        {
            var doms = dayOfMonth.Split(',', StringSplitOptions.RemoveEmptyEntries)
                .Select(s => int.TryParse(s, out var d) ? d : (int?)null)
                .Where(d => d.HasValue)
                .Select(d => $"{d}日")
                .ToArray();

            if (doms.Length > 0)
            {
                return $"每月 {string.Join("、", doms)} {mh:D2}:{mm:D2} 执行";
            }
        }

        return cronExpression;
    }

    private static string GetWeekdayName(string dayValue)
    {
        return dayValue switch
        {
            "0" => "周日",
            "1" => "周一",
            "2" => "周二",
            "3" => "周三",
            "4" => "周四",
            "5" => "周五",
            "6" => "周六",
            _ => string.Empty
        };
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadDataSourceInfoAsync();
        await LoadJobsAsync();
        ComputeStatisticsFromJobs();

        // 订阅状态变更事件（仅在其他地方主动触发缓存更新时刷新UI）
        JobState.OnStateChanged += OnStateChanged;
    }

    private async Task LoadDataSourceInfoAsync()
    {
        var result = await DataSourceApi.GetAsync();
        if (result.IsSuccess && result.Value != null)
        {
            var dataSource = result.Value.FirstOrDefault(ds => ds.Id == DataSourceId);
            _dataSourceName = dataSource?.Name ?? "未知数据源";
        }
        else
        {
            _dataSourceName = "未知数据源";
        }
    }

    private async Task LoadJobsAsync()
    {
        _loading = true;
        try
        {
            // 使用缓存优先策略，避免频繁刷新
            var result = await JobState.GetJobsAsync(DataSourceId, forceRefresh: false);
            if (result.IsSuccess && result.Value != null)
            {
                _jobs = result.Value;
                ApplyFilters();
                ComputeStatisticsFromJobs();
            }
            else
            {
                Message.Error(result.Error ?? "加载任务列表失败");
            }
        }
        finally
        {
            _loading = false;
            StateHasChanged();
        }
    }

    private async Task RefreshAsync()
    {
        // 手动刷新时强制从API加载
        _loading = true;
        try
        {
            var jobsResult = await JobState.GetJobsAsync(DataSourceId, forceRefresh: true);
            if (jobsResult.IsSuccess && jobsResult.Value != null)
            {
                _jobs = jobsResult.Value;
                ApplyFilters();
                ComputeStatisticsFromJobs();
            }
        }
        finally
        {
            _loading = false;
            StateHasChanged();
        }
    }

    private void ComputeStatisticsFromJobs()
    {
        var nowLocal = DateTime.Now.Date;
        var executedToday = _jobs.Where(j => j.LastExecutionAtUtc.HasValue && j.LastExecutionAtUtc.Value.ToLocalTime().Date == nowLocal).ToList();

        var todaySuccess = executedToday.Count(j => j.LastExecutionStatus == JobExecutionStatus.Success);
        var todayFailure = executedToday.Count(j => j.LastExecutionStatus == JobExecutionStatus.Failed);
        var todayTotal = executedToday.Count;

        _statistics = new ScheduledArchiveJobStatisticsDto
        {
            TotalJobCount = _jobs.Count,
            EnabledJobCount = _jobs.Count(j => j.IsEnabled),
            RunningJobCount = _jobs.Count(j => j.LastExecutionStatus == JobExecutionStatus.Running),
            TodayExecutionCount = todayTotal,
            TodaySuccessCount = todaySuccess,
            TodayFailureCount = todayFailure,
            TodaySuccessRate = todayTotal > 0 ? (double)todaySuccess / todayTotal * 100 : 0,
            TotalArchivedRowCount = _jobs.Sum(j => j.TotalArchivedRowCount),
            AverageArchivedRowCount = _jobs.Count > 0 ? (long)_jobs.Average(j => (double)j.TotalArchivedRowCount) : 0
        };
    }

    private string GetFailureTooltip(ScheduledArchiveJobDto job)
    {
        var error = string.IsNullOrWhiteSpace(job.LastExecutionError) ? "(无错误详情)" : job.LastExecutionError.Trim();
        var max = job.MaxConsecutiveFailures > 0 ? job.MaxConsecutiveFailures : 0;
        return $"连续失败次数: {job.ConsecutiveFailureCount}/{max}\n错误: {error}";
    }

    private string GetLastExecutionStatusText(ScheduledArchiveJobDto job)
    {
        return job.LastExecutionStatus switch
        {
            JobExecutionStatus.Success => "成功",
            JobExecutionStatus.Running => "运行中",
            JobExecutionStatus.Failed => "失败",
            JobExecutionStatus.Skipped => "跳过",
            _ => "未开始"
        };
    }

    private void OnFilterChanged()
    {
        ApplyFilters();
        StateHasChanged();
    }

    private void ApplyFilters()
    {
        _filteredJobs = _jobs.Where(job =>
        {
            // 启用状态过滤
            if (_filterEnabled.HasValue && job.IsEnabled != _filterEnabled.Value)
            {
                return false;
            }

            // 关键字搜索
            if (!string.IsNullOrWhiteSpace(_searchKeyword))
            {
                var keyword = _searchKeyword.Trim().ToLowerInvariant();
                return job.Name.ToLowerInvariant().Contains(keyword) ||
                       job.FullSourceTable.ToLowerInvariant().Contains(keyword) ||
                       job.FullTargetTable.ToLowerInvariant().Contains(keyword);
            }

            return true;
        }).ToList();
    }

    private async Task EnableJobAsync(Guid jobId)
    {
        var result = await JobApi.EnableAsync(jobId);
        if (result.IsSuccess)
        {
            Message.Success("任务已启用");
            JobState.UpdateJobEnabledState(DataSourceId, jobId, true);
            await RefreshAsync(); // 刷新以获取下次执行时间
        }
        else
        {
            Message.Error(result.Error ?? "启用任务失败");
        }
    }

    private async Task DisableJobAsync(Guid jobId)
    {
        var result = await JobApi.DisableAsync(jobId);
        if (result.IsSuccess)
        {
            Message.Success("任务已禁用");
            JobState.UpdateJobEnabledState(DataSourceId, jobId, false);
            await RefreshAsync();
        }
        else
        {
            Message.Error(result.Error ?? "禁用任务失败");
        }
    }

    private async Task ExecuteJobAsync(Guid jobId)
    {
        var result = await JobApi.ExecuteAsync(jobId);
        if (result.IsSuccess)
        {
            Message.Success("任务已触发执行，请稍后查看执行结果");
            await Task.Delay(2000); // 等待2秒后刷新
            await RefreshAsync();
        }
        else
        {
            Message.Error(result.Error ?? "触发执行失败");
        }
    }

    private async Task DeleteJobAsync(Guid jobId)
    {
        var result = await JobApi.DeleteAsync(jobId);
        if (result.IsSuccess)
        {
            Message.Success("任务已删除");
            JobState.RemoveJobFromCache(DataSourceId, jobId);
            await RefreshAsync();
        }
        else
        {
            Message.Error(result.Error ?? "删除任务失败");
        }
    }

    private async Task RescheduleJobAsync(Guid jobId)
    {
        var result = await JobApi.RescheduleAsync(jobId);
        if (result.IsSuccess)
        {
            Message.Success("已同步调度");
            await RefreshAsync();
        }
        else
        {
            Message.Error(result.Error ?? "同步调度失败");
        }
    }

    private void ShowCreateModal()
    {
        // TODO: 导航到创建页面（Stage 4 实现）
        Navigation.NavigateTo($"/archive-data-sources/{DataSourceId}/scheduled-jobs/create");
    }

    private void ShowEditModal(ScheduledArchiveJobDto job)
    {
        // TODO: 导航到编辑页面（Stage 4 实现）
        Navigation.NavigateTo($"/archive-data-sources/{DataSourceId}/scheduled-jobs/{job.Id}/edit");
    }

    private void NavigateToDetails(Guid jobId)
    {
        // TODO: 导航到详情页面（Stage 5 实现）
        Navigation.NavigateTo($"/archive-data-sources/{DataSourceId}/scheduled-jobs/{jobId}");
    }

    private void NavigateBack()
    {
        Navigation.NavigateTo("/");
    }

    private void OnStateChanged()
    {
        if (_disposed) return;
        
        // 仅刷新UI，不重新加载数据（数据已由 JobState 更新缓存）
        InvokeAsync(() =>
        {
            if (_disposed) return;
            
            // 从缓存中获取最新数据
            var cachedJobs = JobState.GetJobsAsync(DataSourceId, forceRefresh: false).Result;
            if (cachedJobs.IsSuccess && cachedJobs.Value != null)
            {
                _jobs = cachedJobs.Value;
                ApplyFilters();
            }
            
            StateHasChanged();
        });
    }

    public void Dispose()
    {
        _disposed = true;
        JobState.OnStateChanged -= OnStateChanged;
    }
}
