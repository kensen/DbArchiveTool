@page "/archive-data-sources/{DataSourceId:guid}/partitions"
@attribute [ReuseTabsPage(Title = "分区管理", Closable = true)]
@implements IDisposable
@using AntDesign
@using AntDesign.TableModels
@using System.Globalization
@using System.Linq
@using DbArchiveTool.Application.Partitions
@using DbArchiveTool.Web.Components
@using DbArchiveTool.Web.Core
@using DbArchiveTool.Web.Services
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.AspNetCore.Components
@inject PartitionInfoApiClient PartitionInfoApi
@inject PartitionConfigurationApiClient PartitionConfigApi
@inject MessageService Message
@inject NavigationManager Navigation
@inject PartitionPageState PartitionPageState

<PageTitle>分区管理</PageTitle>

<PageHeader Title="分区表管理" OnBack="NavigateBack">
    <PageHeaderExtra>
        <div class="header-actions">
            <Button Type="@ButtonType.Default" Icon="database" OnClick="ShowSourceServerInfo">源服务器信息</Button>
            <Button Type="@ButtonType.Default" Icon="setting" OnClick="ShowTargetServerConfig">目标服务器配置</Button>
            <Button Type="@ButtonType.Primary" Icon="reload" Loading="_loading" OnClick="ReloadAsync">刷新</Button>
        </div>
    </PageHeaderExtra>
    <PageHeaderContent>
        <div class="server-info">
            <Descriptions Size="@DescriptionsSize.Small" Column="3">
                <DescriptionsItem Title="数据源">@_dataSourceName</DescriptionsItem>
                <DescriptionsItem Title="服务器">@_serverAddress</DescriptionsItem>
                <DescriptionsItem Title="数据库">@_databaseName</DescriptionsItem>
            </Descriptions>
        </div>
    </PageHeaderContent>
</PageHeader>

<div class="partition-container">
    <div class="partition-tables-section">
        <div class="section-header">
            <h3>分区表配置</h3>
            <Space>
                <SpaceItem>
                    <Button Type="@ButtonType.Primary" Icon="plus" Size="@ButtonSize.Small" OnClick="ShowAddPartitionConfig">添加分区配置</Button>
                </SpaceItem>
                <SpaceItem>
                    <Button Type="@ButtonType.Default"
                            Icon="edit"
                            Size="@ButtonSize.Small"
                            Disabled="@(!CanEditDraft)"
                            OnClick="EditSelectedDraftAsync">修改分区配置</Button>
                </SpaceItem>
            </Space>
        </div>

        <Tabs @bind-ActiveKey="_activeTab" OnChange="OnTabChanged">
            <TabPane Key="partitioned" Tab="已分区表">
                <Table TItem="PartitionTableInfo"
                       DataSource="_partitionTables"
                       Loading="_loading"
                       Size="@TableSize.Small"
                       Bordered
                       @bind-SelectedRows="_selectedTableRows"
                       OnRowClick="OnTableRowClick"
                       RowClassName="@GetPartitionRowClass">
                    <Selection Key="@(context.TableName)" Type="@SelectionType.Radio" />
                    <PropertyColumn Property="c => c.SchemaName" Title="架构名" Sortable />
                    <PropertyColumn Property="c => c.TableName" Title="表名" Sortable />
                    <PropertyColumn Property="c => c.PartitionFunction" Title="分区函数" />
                    <PropertyColumn Property="c => c.PartitionScheme" Title="分区方案" />
                    <PropertyColumn Property="c => c.PartitionColumn" Title="分区列" />
                    <PropertyColumn Property="c => c.DataType" Title="数据类型" />
                    <PropertyColumn Property="c => c.TotalPartitions" Title="分区数" Sortable />
                    <PropertyColumn Property="c => c.IsRangeRight" Title="分区类型">
                        <Template>
                            <Tag Color="@(context.IsRangeRight ? TagColor.GeekBlue : TagColor.Orange)">@(context.IsRangeRight ? "RIGHT" : "LEFT")</Tag>
                        </Template>
                    </PropertyColumn>
                    <ActionColumn Title="操作">
                        <Space Size="@("small")">
                            <SpaceItem>
                                <Button Type="@ButtonType.Link" Size="@ButtonSize.Small" OnClick="() => ViewTableDetails(context)">详情</Button>
                            </SpaceItem>
                        </Space>
                    </ActionColumn>
                </Table>
            </TabPane>

            <TabPane Key="drafts" Tab="配置草稿">
                <Table TItem="ConfigurationDraftInfo"
                       DataSource="_configurationDrafts"
                       Loading="_loadingDrafts"
                       Size="@TableSize.Small"
                       Bordered
                       @bind-SelectedRows="_selectedDraftRows"
                       OnRowClick="OnDraftRowClick"
                       RowClassName="@GetDraftRowClass">
                    <Selection Key="@(context.Id.ToString())" Type="@SelectionType.Radio" />
                    <PropertyColumn Property="c => c.SchemaName" Title="架构名" Sortable />
                    <PropertyColumn Property="c => c.TableName" Title="表名" Sortable />
                    <PropertyColumn Property="c => c.PartitionColumnName" Title="分区列" />
                    <PropertyColumn Property="c => c.PartitionFunctionName" Title="分区函数" />
                    <PropertyColumn Property="c => c.PartitionSchemeName" Title="分区方案" />
                    <PropertyColumn Property="c => c.BoundaryCount" Title="边界值数" Sortable />
                    <PropertyColumn Property="c => c.StorageMode" Title="存储模式">
                        <Template>
                            <Tag Color="@(context.StorageMode == "DedicatedFilegroupSingleFile" ? TagColor.Blue : TagColor.Green)">
                                @(context.StorageMode == "DedicatedFilegroupSingleFile" ? "专用文件组" : "使用PRIMARY")
                            </Tag>
                        </Template>
                    </PropertyColumn>
                    <PropertyColumn Property="c => c.ExecutionStage" Title="执行状态">
                        <Template>
                            @{
                                var statusDisplay = GetExecutionStageDisplay(context.ExecutionStage);
                            }
                            <Tag Color="@statusDisplay.Color">@statusDisplay.Text</Tag>
                        </Template>
                    </PropertyColumn>
                    <PropertyColumn Property="c => c.CreatedAtUtc" Title="创建时间" Format="yyyy-MM-dd HH:mm" />
                    <PropertyColumn Property="c => c.CreatedBy" Title="创建人" />
                    <ActionColumn Title="操作">
                        <Space Size="@("small")">
                            <SpaceItem>
                                <Button Type="@ButtonType.Link"
                                        Size="@ButtonSize.Small"
                                        Disabled="@(context.IsCommitted || context.IsPartitioned)"
                                        OnClick="() => EditConfigurationDraftAsync(context)">编辑</Button>
                            </SpaceItem>
                            <SpaceItem>
                                <Button Type="@ButtonType.Link"
                                        Size="@ButtonSize.Small"
                                        Disabled="@(context.IsCommitted || context.IsPartitioned || context.ExecutionStage == "Running" || context.ExecutionStage == "Queued")"
                                        OnClick="() => NavigateToExecutionWizard(context.Id)">
                                    @(string.IsNullOrWhiteSpace(context.ExecutionStage) ? "执行分区" : "重新执行")
                                </Button>
                            </SpaceItem>
                            @if (!string.IsNullOrWhiteSpace(context.ExecutionStage) && context.LastExecutionTaskId.HasValue)
                            {
                                <SpaceItem>
                                    <Button Type="@ButtonType.Link"
                                            Size="@ButtonSize.Small"
                                            OnClick="() => NavigateToTaskMonitor(context.LastExecutionTaskId.Value)">查看日志</Button>
                                </SpaceItem>
                            }
                            <SpaceItem>
                                <Popconfirm Title="确定要删除此配置草稿吗？"
                                            OnConfirm="() => DeleteConfigurationDraftAsync(context.Id)"
                                            OkText="删除"
                                            CancelText="取消"
                                            Disabled="@CannotDeleteDraft(context)">
                                    <Button Type="@ButtonType.Link" 
                                            Size="@ButtonSize.Small" 
                                            Danger
                                            Disabled="@CannotDeleteDraft(context)">删除</Button>
                                </Popconfirm>
                            </SpaceItem>
                        </Space>
                    </ActionColumn>
                </Table>
            </TabPane>
        </Tabs>
    </div>

    <div class="partition-details-section">
        <div class="section-header">
            <h3>分区边界值明细 @(_selectedTable != null ? $"- {_selectedTable.SchemaName}.{_selectedTable.TableName}" : "")</h3>
            <Space>
                <SpaceItem>
                    <Button Type="@ButtonType.Primary" Icon="plus" Size="@ButtonSize.Small" Disabled="@(_selectedTable == null)" OnClick="ShowAddPartitionValue">添加分区值</Button>
                </SpaceItem>
                <SpaceItem>
                    <Button Type="@ButtonType.Default" Icon="scissor" Size="@ButtonSize.Small" Disabled="@(_selectedTable == null || _selectedPartitionRows.Count() == 0)" OnClick="ShowSplitPartition">拆分分区</Button>
                </SpaceItem>
                <SpaceItem>
                    <Button Type="@ButtonType.Default" Icon="merge-cells" Size="@ButtonSize.Small" Disabled="@(_selectedTable == null || _selectedPartitionRows.Count() == 0)" OnClick="ShowMergePartition">合并分区</Button>
                </SpaceItem>
                <SpaceItem>
                    <Button Type="@ButtonType.Default" Icon="swap" Size="@ButtonSize.Small" Disabled="@(_selectedTable == null || _selectedPartitionRows.Count() == 0)" OnClick="ShowSwitchPartition">切换分区</Button>
                </SpaceItem>
            </Space>
        </div>

        @if (_selectedTable == null)
        {
            <Empty Description="@("请先选择一个分区表")" />
        }
        else
        {
            <Table @key="_partitionDetailsTableRenderKey"
                   TItem="PartitionDetailInfo"
                   DataSource="_partitionDetails"
                   Loading="_loadingDetails"
                   Size="@TableSize.Small"
                   Bordered
                   @bind-SelectedRows="_selectedPartitionRows">
                <Selection Key="@(context.PartitionNumber.ToString())" />
                <PropertyColumn Property="c => c.PartitionNumber" Title="分区号" Sortable DefaultSortOrder="@SortDirection.Ascending" />
                <PropertyColumn Property="c => c.BoundaryValue" Title="边界值" />
                <PropertyColumn Property="c => c.RangeType" Title="范围类型">
                    <Template>
                        <Tag Color="@(context.RangeType == "RIGHT" ? TagColor.GeekBlue : TagColor.Orange)">@context.RangeType</Tag>
                    </Template>
                </PropertyColumn>
                <PropertyColumn Property="c => c.FilegroupName" Title="文件组" />
                <PropertyColumn Property="c => c.RowCount" Title="行数" Sortable />
                <PropertyColumn Property="c => c.TotalSpaceMB" Title="空间(MB)" Sortable />
                <PropertyColumn Property="c => c.DataCompression" Title="压缩">
                    <Template>
                        <Tag Color="@(context.DataCompression == "NONE" ? TagColor.Default : TagColor.Cyan)">@context.DataCompression</Tag>
                    </Template>
                </PropertyColumn>
                <PropertyColumn Property="c => c.CreatedDate" Title="创建时间" Format="yyyy-MM-dd HH:mm" />
            </Table>
        }
    </div>
</div>

<Modal Title="源服务器信息" @bind-Visible="_sourceServerModalVisible" Footer="null" Width="600">
    <Descriptions Bordered Column="1" Size="@DescriptionsSize.Small">
        <DescriptionsItem Title="服务器地址">@_serverAddress</DescriptionsItem>
        <DescriptionsItem Title="端口">@_serverPort</DescriptionsItem>
        <DescriptionsItem Title="数据库">@_databaseName</DescriptionsItem>
        <DescriptionsItem Title="认证方式">@(_useIntegratedSecurity ? "Windows 集成" : $"SQL 登录 ({_userName})")</DescriptionsItem>
        <DescriptionsItem Title="连接状态">
            <Tag Color="@(_isConnected ? TagColor.Success : TagColor.Default)">@(_isConnected ? "已连接" : "未连接")</Tag>
        </DescriptionsItem>
    </Descriptions>
</Modal>

<Modal Title="目标服务器配置" @bind-Visible="_targetServerModalVisible" Width="720" OnOk="SaveTargetServerConfig" OnCancel="() => _targetServerModalVisible = false">
    <Form Model="_targetServerModel" LabelColSpan="6" WrapperColSpan="18">
        <FormItem Label="目标服务器">
            <Switch CheckedChildren="使用源服务器" UnCheckedChildren="自定义配置" @bind-Checked="_targetServerModel.UseSourceAsTarget" />
            <span style="margin-left: 12px; color: #8c8c8c; font-size: 13px;">
                @(_targetServerModel.UseSourceAsTarget ? "归档数据将保存在源服务器" : "归档数据将保存在自定义目标服务器")
            </span>
        </FormItem>

        @if (!_targetServerModel.UseSourceAsTarget)
        {
            <Divider>目标服务器信息</Divider>

            <FormItem Label="服务器地址" Required>
                <Input @bind-Value="_targetServerModel.ServerAddress" Placeholder="例如: localhost 或 192.168.1.100" />
            </FormItem>

            <FormItem Label="端口">
                <AntDesign.InputNumber @bind-Value="_targetServerModel.Port" Min="1" Max="65535" DefaultValue="1433" Style="width: 100%;" />
            </FormItem>

            <FormItem Label="数据库名称" Required>
                <Input @bind-Value="_targetServerModel.DatabaseName" Placeholder="目标数据库名称" />
            </FormItem>

            <FormItem Label="认证方式">
                <Switch CheckedChildren="Windows" UnCheckedChildren="SQL 登录" @bind-Checked="_targetServerModel.UseIntegratedSecurity" />
            </FormItem>

            <FormItem Label="登录账号" Required="@(!_targetServerModel.UseIntegratedSecurity)">
                <Input @bind-Value="_targetServerModel.UserName" Disabled="_targetServerModel.UseIntegratedSecurity" Placeholder="SQL 登录账号" />
            </FormItem>

            <FormItem Label="登录密码">
                <InputPassword @bind-Value="_targetServerModel.Password" Disabled="_targetServerModel.UseIntegratedSecurity" Placeholder="留空表示不修改原密码" VisibilityToggle="true" />
            </FormItem>

            <FormItem Label="连接测试">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <Button Type="ButtonType.Default" Icon="api" Loading="_testingTargetConnection" OnClick="TestTargetServerConnection">测试连接</Button>
                    @if (!string.IsNullOrEmpty(_targetConnectionTestResult))
                    {
                        <span style="color: @(_targetConnectionTestSuccess ? "#52c41a" : "#ff4d4f"); font-weight: 500;">
                            @(_targetConnectionTestSuccess ? "✓" : "✗") @_targetConnectionTestResult
                        </span>
                    }
                </div>
            </FormItem>
        }
    </Form>
</Modal>

<PartitionConfigWizard Visible="_partitionConfigModalVisible"
                       VisibleChanged="HandlePartitionWizardVisibleChanged"
                       Title="@PartitionConfigModalTitle"
                       DataSourceId="DataSourceId"
                       DatabaseName="_databaseName"
                       SelectedTable="_selectedTable"
                       IsEditMode="_partitionConfigWizardIsEdit"
                       EditingConfigurationId="_editingConfigurationId"
                       EditingConfiguration="_editingConfigurationDetail"
                       OnCompleted="OnPartitionConfigCompletedAsync" />

<PartitionBoundaryAddDrawer DataSourceId="DataSourceId"
                            SchemaName="@_boundaryTargetSchema"
                            TableName="@_boundaryTargetTable"
                            Visible="@_partitionBoundaryDrawerVisible"
                            OnClose="@OnBoundaryDrawerClosedAsync"
                            OnSuccess="@OnBoundaryOperationCompletedAsync" />

<PartitionSplitWizard DataSourceId="DataSourceId"
                      SchemaName="@_boundaryTargetSchema"
                      TableName="@_boundaryTargetTable"
                      PreSelectedBoundaryKey="@_preSelectedBoundaryKey"
                      Visible="@_splitModalVisible"
                      OnClose="@OnSplitWizardClosedAsync"
                      OnSuccess="@OnSplitOperationCompletedAsync" />

<PartitionMergeWizard DataSourceId="DataSourceId"
                      SchemaName="@_boundaryTargetSchema"
                      TableName="@_boundaryTargetTable"
                      PreSelectedBoundaryKey="@_preSelectedBoundaryKey"
                      Visible="@_mergeModalVisible"
                      OnClose="@OnMergeWizardClosedAsync"
                      OnSuccess="@OnMergeOperationCompletedAsync" />

<PartitionArchiveWizard DataSourceId="DataSourceId"
                        SchemaName="@_archiveTargetSchema"
                        TableName="@_archiveTargetTable"
                        PreSelectedPartitionKey="@_archiveTargetPartitionKey"
                        Visible="@_archiveWizardVisible"
                        VisibleChanged="OnArchiveWizardVisibleChanged"
                        OnSuccess="OnArchiveWizardSuccessAsync"
                        Title="@_archiveWizardTitle" />

<style>
    .partition-container { display: flex; flex-direction: column; gap: 16px; padding: 16px; height: calc(100vh - 200px); }
    .partition-tables-section { flex: 0 0 auto; max-height: 40%; overflow: auto; background: white; padding: 16px; border-radius: 4px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
    .partition-details-section { flex: 1 1 auto; overflow: auto; background: white; padding: 16px; border-radius: 4px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
    .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid #f0f0f0; }
    .partition-wizard-body { margin-top: 16px; }
    .wizard-step { padding-top: 16px; }
    .wizard-step .form-tip { color: #8c8c8c; font-size: 12px; }
    .boundary-actions { margin-top: 12px; display: flex; gap: 12px; align-items: center; }
    .partition-wizard-footer { margin-top: 24px; text-align: right; }
    .wizard-summary { list-style: none; padding-left: 0; margin: 16px 0 0; }
    .wizard-summary li { margin-bottom: 6px; }
    .section-header h3 { margin: 0; font-size: 16px; font-weight: 600; color: #262626; }
    .header-actions { display: flex; gap: 8px; }
    .server-info { margin-top: 12px; }
    .table-row-selected { background-color: #e6f7ff !important; }
    ::deep .ant-table-tbody > tr:hover > td { cursor: pointer; }
</style>

@code {
    [Parameter] public Guid DataSourceId { get; set; }
    private string _dataSourceName = "加载中...";
    private string _serverAddress = "";
    private int _serverPort = 1433;
    private string _databaseName = "";
    private bool _useIntegratedSecurity = true;
    private string _userName = "";
    private bool _isConnected = false;
    private bool _loading = false;
    private List<PartitionTableInfo> _partitionTables = new();
    private IEnumerable<PartitionTableInfo> _selectedTableRows = Array.Empty<PartitionTableInfo>();
    private PartitionTableInfo? _selectedTable = null;
    private bool _loadingDetails = false;
    private List<PartitionDetailInfo> _partitionDetails = new();
    private IEnumerable<PartitionDetailInfo> _selectedPartitionRows = Array.Empty<PartitionDetailInfo>();
    private int _partitionDetailsTableRenderKey;
    private bool _sourceServerModalVisible = false;
    private bool _targetServerModalVisible = false;
    private TargetServerConfigModel _targetServerModel = new();
    private bool _testingTargetConnection = false;
    private string _targetConnectionTestResult = "";
    private bool _targetConnectionTestSuccess = false;
    private bool _partitionConfigModalVisible = false;
    private string PartitionConfigModalTitle { get; set; } = "分区配置向导";
    private bool _partitionBoundaryDrawerVisible = false;
    private string _boundaryTargetSchema = string.Empty;
    private string _boundaryTargetTable = string.Empty;
    private string _preSelectedBoundaryKey = string.Empty;
    private bool _splitModalVisible = false;
    private bool _mergeModalVisible = false;
    private bool _archiveWizardVisible = false;
    private string _archiveTargetSchema = string.Empty;
    private string _archiveTargetTable = string.Empty;
    private string _archiveTargetPartitionKey = string.Empty;
    private string _archiveWizardTitle = "分区归档向导";

    // Tabs and configuration drafts
    private string _activeTab = "partitioned";
    private List<ConfigurationDraftInfo> _configurationDrafts = new();
    private IEnumerable<ConfigurationDraftInfo> _selectedDraftRows = Array.Empty<ConfigurationDraftInfo>();
    private ConfigurationDraftInfo? _selectedDraft;
    private Guid? _editingConfigurationId;
    private PartitionConfigurationDetailModel? _editingConfigurationDetail;
    private bool _partitionConfigWizardIsEdit;
    private bool CanEditDraft =>
        _activeTab == "drafts" &&
        _selectedDraft is not null &&
        !_selectedDraft.IsCommitted &&
        !_selectedDraft.IsPartitioned;

    private bool _loadingDrafts = false;
    private CancellationTokenSource? _draftRefreshCts;

    protected override async Task OnInitializedAsync()
    {
        PartitionPageState.DraftsRefreshRequested += OnDraftsRefreshRequested;
        await LoadDataSourceInfoAsync();
        await LoadPartitionTablesAsync();
        await LoadConfigurationDraftsAsync();
    }

    public void Dispose()
    {
        PartitionPageState.DraftsRefreshRequested -= OnDraftsRefreshRequested;
        _draftRefreshCts?.Cancel();
    }

    private void OnDraftsRefreshRequested(Guid dataSourceId, Guid configurationId)
    {
        if (dataSourceId != DataSourceId)
        {
            return;
        }

        _draftRefreshCts?.Cancel();
        var cts = new CancellationTokenSource();
        _draftRefreshCts = cts;
        _ = AutoRefreshDraftsAsync(configurationId, cts.Token);
    }

    private async Task AutoRefreshDraftsAsync(Guid configurationId, CancellationToken cancellationToken)
    {
        try
        {
            for (var attempt = 0; attempt < 12 && !cancellationToken.IsCancellationRequested; attempt++)
            {
                await InvokeAsync(async () =>
                {
                    try
                    {
                        await LoadPartitionTablesAsync();
                        await LoadConfigurationDraftsAsync();
                        if (_selectedTable is not null)
                        {
                            // 自动刷新时静默处理错误,避免弹出提示
                            await LoadPartitionDetailsAsync(_selectedTable, suppressErrorMessage: true);
                        }
                        StateHasChanged();
                    }
                    catch (Exception)
                    {
                        // 静默处理刷新时的错误,避免在表转换过程中弹出错误提示
                        // 下次刷新会重试
                    }
                });

                var draft = _configurationDrafts.FirstOrDefault(d => d.Id == configurationId);
                if (draft is null || draft.IsCommitted || string.Equals(draft.ExecutionStage, "Completed", StringComparison.OrdinalIgnoreCase))
                {
                    break;
                }

                await Task.Delay(TimeSpan.FromSeconds(5), cancellationToken);
            }
        }
        catch (TaskCanceledException)
        {
            // ignore
        }
    }

    private async Task OnTabChanged(string key)
    {
        _activeTab = key;
        if (key == "drafts")
        {
            await LoadConfigurationDraftsAsync();
        }
        else
        {
            _selectedDraft = null;
            _selectedDraftRows = Array.Empty<ConfigurationDraftInfo>();
        }
    }

    private async Task LoadConfigurationDraftsAsync()
    {
        _loadingDrafts = true;
        try
        {
            var previousSelectedId = _selectedDraft?.Id;
            var result = await PartitionConfigApi.GetByDataSourceAsync(DataSourceId);
            if (result.IsSuccess && result.Value != null)
            {
                var partitionedLookup = new HashSet<string>(
                    _partitionTables.Select(t => $"{t.SchemaName}.{t.TableName}".ToLowerInvariant()));

                _configurationDrafts = result.Value.Select(d => new ConfigurationDraftInfo
                {
                    Id = d.Id,
                    SchemaName = d.SchemaName,
                    TableName = d.TableName,
                    PartitionColumnName = d.PartitionColumnName,
                    PartitionFunctionName = d.PartitionFunctionName,
                    PartitionSchemeName = d.PartitionSchemeName,
                    BoundaryCount = d.BoundaryCount,
                    StorageMode = d.StorageMode,
                    TargetTableName = d.TargetTableName,
                    CreatedAtUtc = d.CreatedAtUtc,
                    CreatedBy = d.CreatedBy,
                    Remarks = d.Remarks,
                    IsCommitted = d.IsCommitted,
                    IsPartitioned = partitionedLookup.Contains($"{d.SchemaName}.{d.TableName}".ToLowerInvariant()),
                    ExecutionStage = d.ExecutionStage,
                    LastExecutionTaskId = d.LastExecutionTaskId
                }).ToList();

                if (previousSelectedId.HasValue)
                {
                    _selectedDraft = _configurationDrafts.FirstOrDefault(d => d.Id == previousSelectedId.Value);
                }
                else
                {
                    _selectedDraft = null;
                }

                _selectedDraftRows = _selectedDraft is null
                    ? Array.Empty<ConfigurationDraftInfo>()
                    : new[] { _selectedDraft };
            }
            else
            {
                _configurationDrafts = new List<ConfigurationDraftInfo>();
                if (!result.IsSuccess)
                {
                    Message.Warning($"加载配置草稿失败: {result.Error}");
                }

                _selectedDraft = null;
                _selectedDraftRows = Array.Empty<ConfigurationDraftInfo>();
            }
        }
        catch (Exception ex)
        {
            Message.Error($"加载配置草稿失败: {ex.Message}");
            _configurationDrafts = new List<ConfigurationDraftInfo>();
            _selectedDraft = null;
            _selectedDraftRows = Array.Empty<ConfigurationDraftInfo>();
        }
        finally
        {
            _loadingDrafts = false;
        }
    }

    private async Task DeleteConfigurationDraftAsync(Guid configurationId)
    {
        try
        {
            var result = await PartitionConfigApi.DeleteAsync(configurationId);
            if (result.IsSuccess)
            {
                Message.Success("配置草稿已删除");
                if (_selectedDraft?.Id == configurationId)
                {
                    _selectedDraft = null;
                    _selectedDraftRows = Array.Empty<ConfigurationDraftInfo>();
                }
                await LoadConfigurationDraftsAsync();
            }
            else
            {
                Message.Error($"删除失败: {result.Error}");
            }
        }
        catch (Exception ex)
        {
            Message.Error($"删除失败: {ex.Message}");
        }
    }

    private async Task EditConfigurationDraftAsync(ConfigurationDraftInfo draft)
    {
        _selectedDraft = draft;
        _selectedDraftRows = new[] { draft };

        if (draft.IsCommitted)
        {
            Message.Warning("该配置已执行，无法修改。");
            return;
        }

        if (draft.IsPartitioned)
        {
            Message.Warning("目标表已是分区表，只能通过分区操作调整边界。");
            return;
        }

        try
        {
            var detailResult = await PartitionConfigApi.GetAsync(draft.Id);
            if (!detailResult.IsSuccess || detailResult.Value is null)
            {
                Message.Error($"加载配置详情失败: {detailResult.Error ?? "未知错误"}");
                return;
            }

            var detail = detailResult.Value;
            if (detail.IsCommitted)
            {
                Message.Warning("该配置已执行，无法修改。");
                await LoadConfigurationDraftsAsync();
                return;
            }

            if (detail.SourceTableIsPartitioned)
            {
                Message.Warning("目标表已是分区表，只能通过分区操作调整边界。");
                return;
            }

            _editingConfigurationId = draft.Id;
            _editingConfigurationDetail = detail;
            PartitionConfigModalTitle = "编辑分区配置";
            _partitionConfigWizardIsEdit = true;
            _partitionConfigModalVisible = true;
        }
        catch (Exception ex)
        {
            Message.Error($"加载配置详情失败: {ex.Message}");
        }
    }

    /// <summary>
    /// 导航到执行向导页面
    /// </summary>
    private void NavigateToExecutionWizard(Guid configId)
    {
        Navigation.NavigateTo($"/background-tasks/wizard/{configId}");
    }

    /// <summary>
    /// 导航到任务监控页面
    /// </summary>
    private void NavigateToTaskMonitor(Guid taskId)
    {
        Navigation.NavigateTo($"/background-tasks/monitor?taskId={taskId}");
    }

    /// <summary>
    /// 执行分区(已废弃,保留用于兼容)
    /// </summary>
    private void ExecutePartitionAsync(ConfigurationDraftInfo draft)
    {
        // 现在统一使用向导模式
        NavigateToExecutionWizard(draft.Id);
    }

    private async Task LoadDataSourceInfoAsync()
    {
        try
        {
            // 从API加载数据源信息
            var response = await PartitionInfoApi.GetDataSourceAsync(DataSourceId);
            if (response != null)
            {
                _dataSourceName = response.Name ?? "未命名数据源";
                _serverAddress = response.ServerAddress ?? "";
                _serverPort = response.ServerPort;
                _databaseName = response.DatabaseName ?? "";
                _useIntegratedSecurity = response.UseIntegratedSecurity;
                _userName = response.UserName ?? "";
                _isConnected = true;
            }
        }
        catch (Exception ex)
        {
            Message.Error($"加载数据源信息失败: {ex.Message}");
        }
    }

    private async Task LoadPartitionTablesAsync()
    {
        _loading = true;
        try
        {
            // 从API加载真实分区表数据
            var tables = await PartitionInfoApi.GetPartitionTablesAsync(DataSourceId);
            _partitionTables = tables.Select(t => new PartitionTableInfo
            {
                SchemaName = t.SchemaName,
                TableName = t.TableName,
                PartitionFunction = t.PartitionFunction,
                PartitionScheme = t.PartitionScheme,
                PartitionColumn = t.PartitionColumn,
                DataType = t.DataType,
                TotalPartitions = t.TotalPartitions,
                IsRangeRight = t.IsRangeRight
            }).ToList();
        }
        catch (Exception ex)
        {
            Message.Error($"加载分区表失败: {ex.Message}");
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task LoadPartitionDetailsAsync(PartitionTableInfo table, bool suppressErrorMessage = false)
    {
        _loadingDetails = true;
        _partitionDetails = new List<PartitionDetailInfo>();
        await InvokeAsync(StateHasChanged);
        try
        {
            // 从API加载真实分区明细数据
            var details = await PartitionInfoApi.GetPartitionDetailsAsync(DataSourceId, table.SchemaName, table.TableName);
            _partitionDetails = details.Select(d => new PartitionDetailInfo
            {
                PartitionNumber = d.PartitionNumber,
                BoundaryValue = FormatBoundaryValue(d.BoundaryValue, table.DataType),
                RangeType = d.RangeType,
                FilegroupName = d.FilegroupName,
                RowCount = d.RowCount,
                TotalSpaceMB = d.TotalSpaceMB,
                DataCompression = d.DataCompression,
                CreatedDate = DateTime.Now // API未返回,使用当前时间占位
            }).ToList();
        }
        catch (Exception ex)
        {
            if (!suppressErrorMessage)
            {
                Message.Error($"加载分区明细失败: {ex.Message}");
            }
            // 静默失败时仍然清空列表,下次刷新会重试
        }
        finally
        {
            _loadingDetails = false;
        }

        await InvokeAsync(StateHasChanged);
    }

    private void OnTableRowClick(RowData<PartitionTableInfo> row)
    {
        _selectedTable = row.Data;
        _selectedTableRows = new[] { row.Data };
        _selectedPartitionRows = Array.Empty<PartitionDetailInfo>();
        _partitionDetailsTableRenderKey++;

        _ = InvokeAsync(async () =>
        {
            StateHasChanged();
            await LoadPartitionDetailsAsync(row.Data);
        });
    }

    private void OnDraftRowClick(RowData<ConfigurationDraftInfo> row)
    {
        if (row?.Data is null)
        {
            return;
        }

        _selectedDraft = row.Data;
        _selectedDraftRows = new[] { row.Data };
        _ = InvokeAsync(StateHasChanged);
    }

    private string GetPartitionRowClass(RowData<PartitionTableInfo> row) =>
        row.Data == _selectedTable ? "table-row-selected" : string.Empty;

    private string GetDraftRowClass(RowData<ConfigurationDraftInfo> row) =>
        _selectedDraft is not null && row.Data.Id == _selectedDraft.Id ? "table-row-selected" : string.Empty;

    /// <summary>
    /// 获取执行状态的显示信息
    /// </summary>
    private (string Text, string Color) GetExecutionStageDisplay(string? executionStage)
    {
        if (string.IsNullOrWhiteSpace(executionStage))
        {
            return ("草稿", "default");
        }

        return executionStage switch
        {
            "PendingValidation" => ("待校验", "default"),
            "Validating" => ("校验中", "processing"),
            "Queued" => ("已排队", "processing"),
            "Running" => ("执行中", "processing"),
            "Succeeded" or "Completed" => ("已完成", "success"),
            "Failed" => ("失败", "error"),
            "Cancelled" => ("已取消", "warning"),
            _ => (executionStage, "default")
        };
    }

    /// <summary>
    /// 判断是否可以删除配置草稿
    /// </summary>
    private bool CannotDeleteDraft(ConfigurationDraftInfo draft)
    {
        // 如果没有执行阶段，说明是纯草稿，可以删除
        if (string.IsNullOrWhiteSpace(draft.ExecutionStage))
        {
            return false;
        }

        // 已完成的配置不允许删除
        if (draft.ExecutionStage is "Completed" or "Succeeded")
        {
            return true;
        }

        // 正在执行的任务不允许删除
        if (draft.ExecutionStage is "Running" or "Queued" or "Validating" or "PendingValidation")
        {
            return true;
        }

        // 失败或已取消的任务允许删除
        return false;
    }

    private async Task ReloadAsync()
    {
        await LoadPartitionTablesAsync();
        if (_selectedTable != null) await LoadPartitionDetailsAsync(_selectedTable);
    }

    private void NavigateBack() => Navigation.NavigateTo("/");
    private void ShowSourceServerInfo() => _sourceServerModalVisible = true;
    
    private async Task ShowTargetServerConfig()
    {
        // 从API加载当前目标服务器配置
        try
        {
            var dataSource = await PartitionInfoApi.GetDataSourceAsync(DataSourceId);
            if (dataSource != null)
            {
                _targetServerModel = new TargetServerConfigModel
                {
                    UseSourceAsTarget = dataSource.UseSourceAsTarget,
                    ServerAddress = dataSource.TargetServerAddress ?? "",
                    Port = dataSource.TargetServerPort,
                    DatabaseName = dataSource.TargetDatabaseName ?? "",
                    UseIntegratedSecurity = dataSource.TargetUseIntegratedSecurity,
                    UserName = dataSource.TargetUserName ?? "",
                    Password = "" // 安全起见不回显密码
                };
            }
            _targetServerModalVisible = true;
        }
        catch (Exception ex)
        {
            Message.Error($"加载目标服务器配置失败: {ex.Message}");
        }
    }
    private Task ShowAddPartitionConfig()
    {
        PartitionConfigModalTitle = "分区配置向导";
        _partitionConfigWizardIsEdit = false;
        _editingConfigurationId = null;
        _editingConfigurationDetail = null;
        _partitionConfigModalVisible = true;
        return Task.CompletedTask;
    }

    private async Task EditSelectedDraftAsync()
    {
        if (!CanEditDraft || _selectedDraft is null)
        {
            return;
        }

        await EditConfigurationDraftAsync(_selectedDraft);
    }

    private Task HandlePartitionWizardVisibleChanged(bool value)
    {
        _partitionConfigModalVisible = value;
        if (!value)
        {
            _partitionConfigWizardIsEdit = false;
            _editingConfigurationId = null;
            _editingConfigurationDetail = null;
        }
        return Task.CompletedTask;
    }

    private async Task OnPartitionConfigCompletedAsync()
    {
        var previousSelection = _selectedTable;
        await LoadPartitionTablesAsync();

        if (previousSelection is not null)
        {
            var refreshed = _partitionTables.FirstOrDefault(t =>
                string.Equals(t.SchemaName, previousSelection.SchemaName, StringComparison.OrdinalIgnoreCase) &&
                string.Equals(t.TableName, previousSelection.TableName, StringComparison.OrdinalIgnoreCase));

            if (refreshed is not null)
            {
                _selectedTable = refreshed;
                _selectedTableRows = new[] { refreshed };
                await LoadPartitionDetailsAsync(refreshed);
            }
        }

        await LoadConfigurationDraftsAsync();
        _partitionConfigWizardIsEdit = false;
        _editingConfigurationId = null;
        _editingConfigurationDetail = null;
    }
    
    private Task ShowAddPartitionValue()
    {
        if (_selectedTable is null)
        {
            Message.Warning("请选择分区表后再添加边界值。");
            return Task.CompletedTask;
        }

        _boundaryTargetSchema = _selectedTable.SchemaName;
        _boundaryTargetTable = _selectedTable.TableName;
        _partitionBoundaryDrawerVisible = true;

        return Task.CompletedTask;
    }
    
    private void ShowSplitPartition()
    {
        if (_selectedTable is null || !_selectedPartitionRows.Any())
        {
            Message.Warning("请先选择一个分区");
            return;
        }

        // 验证只能选择一个分区
        if (_selectedPartitionRows.Count() > 1)
        {
            Message.Warning("只能选择一个分区进行拆分操作");
            return;
        }

        _boundaryTargetSchema = _selectedTable.SchemaName;
        _boundaryTargetTable = _selectedTable.TableName;
        // 获取第一个选中的分区边界值
        var firstSelected = _selectedPartitionRows.First();
        _preSelectedBoundaryKey = firstSelected.BoundaryValue ?? string.Empty;
        _splitModalVisible = true;
    }

    private void ShowMergePartition()
    {
        if (_selectedTable is null)
        {
            Message.Warning("请先选择一个分区表");
            return;
        }

        if (!_selectedPartitionRows.Any())
        {
            Message.Warning("请先选择要合并的分区");
            return;
        }

        // 当前版本:一次合并一个边界值
        // TODO: 未来可支持批量合并多个连续边界
        if (_selectedPartitionRows.Count() > 1)
        {
            Message.Warning("当前仅支持一次合并一个分区边界。如需合并多个边界,请分多次操作。");
            return;
        }

        _boundaryTargetSchema = _selectedTable.SchemaName;
        _boundaryTargetTable = _selectedTable.TableName;
        // 获取第一个选中的分区边界值
        var firstSelected = _selectedPartitionRows.First();
        _preSelectedBoundaryKey = firstSelected.BoundaryValue ?? string.Empty;
        _mergeModalVisible = true;
    }

    private void ShowSwitchPartition()
    {
        if (_selectedTable is null)
        {
            Message.Warning("请先选择目标分区表。");
            return;
        }

        if (!_selectedPartitionRows.Any())
        {
            Message.Warning("请先在下方表格中选择需要归档的分区。");
            return;
        }

        _archiveTargetSchema = _selectedTable.SchemaName;
        _archiveTargetTable = _selectedTable.TableName;
        // 将所有选中的分区号以逗号分隔传递
        _archiveTargetPartitionKey = string.Join(",", _selectedPartitionRows.Select(p => p.PartitionNumber.ToString(CultureInfo.InvariantCulture)));
        
        var count = _selectedPartitionRows.Count();
        _archiveWizardTitle = count == 1 
            ? $"分区归档 - {_selectedTable.SchemaName}.{_selectedTable.TableName} #{_selectedPartitionRows.First().PartitionNumber}"
            : $"批量分区归档 - {_selectedTable.SchemaName}.{_selectedTable.TableName} ({count}个分区)";
        _archiveWizardVisible = true;
    }

    private Task OnArchiveWizardVisibleChanged(bool visible)
    {
        _archiveWizardVisible = visible;
        if (!visible)
        {
            _archiveTargetPartitionKey = string.Empty;
        }

        return InvokeAsync(StateHasChanged);
    }

    private async Task OnArchiveWizardSuccessAsync(Guid taskId)
    {
        _archiveWizardVisible = false;
        await ReloadAsync();
        NavigateToTaskMonitor(taskId);
    }
    private void ViewTableDetails(PartitionTableInfo table) { }
    
    private async Task OnBoundaryOperationCompletedAsync()
    {
        // 刷新分区详情
        if (_selectedTable != null)
        {
            await LoadPartitionDetailsAsync(_selectedTable);
        }
    }

    private Task OnBoundaryDrawerClosedAsync()
    {
        _partitionBoundaryDrawerVisible = false;
        _boundaryTargetSchema = string.Empty;
        _boundaryTargetTable = string.Empty;
        return Task.CompletedTask;
    }

    private Task OnSplitWizardClosedAsync()
    {
        _splitModalVisible = false;
        _boundaryTargetSchema = string.Empty;
        _boundaryTargetTable = string.Empty;
        _preSelectedBoundaryKey = string.Empty;
        return Task.CompletedTask;
    }

    private async Task OnSplitOperationCompletedAsync()
    {
        _splitModalVisible = false;
        _boundaryTargetSchema = string.Empty;
        _boundaryTargetTable = string.Empty;
        _preSelectedBoundaryKey = string.Empty;
        
        // 刷新分区详情
        if (_selectedTable is not null)
        {
            await LoadPartitionDetailsAsync(_selectedTable);
        }
    }

    private Task OnMergeWizardClosedAsync()
    {
        _mergeModalVisible = false;
        _boundaryTargetSchema = string.Empty;
        _boundaryTargetTable = string.Empty;
        _preSelectedBoundaryKey = string.Empty;
        return Task.CompletedTask;
    }

    private async Task OnMergeOperationCompletedAsync()
    {
        _mergeModalVisible = false;
        _boundaryTargetSchema = string.Empty;
        _boundaryTargetTable = string.Empty;
        _preSelectedBoundaryKey = string.Empty;
        
        // 刷新分区详情
        if (_selectedTable is not null)
        {
            await LoadPartitionDetailsAsync(_selectedTable);
        }
    }
    
    private async Task TestTargetServerConnection()
    {
        _testingTargetConnection = true;
        _targetConnectionTestResult = "";
        _targetConnectionTestSuccess = false;

        try
        {
            // 验证必填字段
            if (string.IsNullOrWhiteSpace(_targetServerModel.ServerAddress))
            {
                _targetConnectionTestResult = "请输入服务器地址";
                _targetConnectionTestSuccess = false;
                return;
            }
            if (string.IsNullOrWhiteSpace(_targetServerModel.DatabaseName))
            {
                _targetConnectionTestResult = "请输入数据库名称";
                _targetConnectionTestSuccess = false;
                return;
            }
            if (!_targetServerModel.UseIntegratedSecurity && string.IsNullOrWhiteSpace(_targetServerModel.UserName))
            {
                _targetConnectionTestResult = "使用SQL身份验证时必须输入用户名";
                _targetConnectionTestSuccess = false;
                return;
            }

            // 调用 API 测试连接
            var testRequest = new TestConnectionRequest
            {
                ServerAddress = _targetServerModel.ServerAddress,
                ServerPort = _targetServerModel.Port,
                DatabaseName = _targetServerModel.DatabaseName,
                UseIntegratedSecurity = _targetServerModel.UseIntegratedSecurity,
                UserName = _targetServerModel.UserName,
                Password = _targetServerModel.Password
            };

            var result = await PartitionInfoApi.TestConnectionAsync(testRequest);
            _targetConnectionTestSuccess = result;
            _targetConnectionTestResult = result ? "连接成功！" : "连接失败，请检查配置";
        }
        catch (Exception ex)
        {
            _targetConnectionTestSuccess = false;
            _targetConnectionTestResult = $"连接失败: {ex.Message}";
        }
        finally
        {
            _testingTargetConnection = false;
        }
    }
    
    private async Task SaveTargetServerConfig()
    {
        try
        {
            // 验证表单
            if (!_targetServerModel.UseSourceAsTarget)
            {
                if (string.IsNullOrWhiteSpace(_targetServerModel.ServerAddress))
                {
                    Message.Warning("请输入目标服务器地址");
                    return;
                }
                if (string.IsNullOrWhiteSpace(_targetServerModel.DatabaseName))
                {
                    Message.Warning("请输入目标数据库名称");
                    return;
                }
                if (!_targetServerModel.UseIntegratedSecurity && string.IsNullOrWhiteSpace(_targetServerModel.UserName))
                {
                    Message.Warning("使用SQL Server身份验证时必须输入用户名");
                    return;
                }
            }

            // 调用API保存配置
            var request = new UpdateTargetServerConfigRequest
            {
                UseSourceAsTarget = _targetServerModel.UseSourceAsTarget,
                TargetServerAddress = _targetServerModel.ServerAddress,
                TargetServerPort = _targetServerModel.Port,
                TargetDatabaseName = _targetServerModel.DatabaseName,
                TargetUseIntegratedSecurity = _targetServerModel.UseIntegratedSecurity,
                TargetUserName = _targetServerModel.UserName,
                TargetPassword = _targetServerModel.Password
            };

            await PartitionInfoApi.UpdateTargetServerConfigAsync(DataSourceId, request);
            Message.Success("目标服务器配置已保存");
            _targetServerModalVisible = false;
        }
        catch (Exception ex)
        {
            Message.Error($"保存目标服务器配置失败: {ex.Message}");
        }
    }

    /// <summary>
    /// 分区配置草稿信息（用于列表显示）
    /// </summary>
    private class ConfigurationDraftInfo
    {
        public Guid Id { get; set; }
        public string SchemaName { get; set; } = string.Empty;
        public string TableName { get; set; } = string.Empty;
        public string PartitionColumnName { get; set; } = string.Empty;
        public string PartitionFunctionName { get; set; } = string.Empty;
        public string PartitionSchemeName { get; set; } = string.Empty;
        public int BoundaryCount { get; set; }
        public string StorageMode { get; set; } = string.Empty;
        public string TargetTableName { get; set; } = string.Empty;
        public DateTime CreatedAtUtc { get; set; }
        public string CreatedBy { get; set; } = string.Empty;
        public string? Remarks { get; set; }
        public bool IsCommitted { get; set; }
        public bool IsPartitioned { get; set; }
        
        /// <summary>
        /// 执行阶段(Queued/Running/Completed/Failed等)
        /// </summary>
        public string? ExecutionStage { get; set; }
        
        /// <summary>
        /// 最后一次执行任务ID
        /// </summary>
        public Guid? LastExecutionTaskId { get; set; }
    }

    private class PartitionDetailInfo
    {
        public int PartitionNumber { get; set; }
        public string BoundaryValue { get; set; } = "";
        public string RangeType { get; set; } = "";
        public string FilegroupName { get; set; } = "";
        public long RowCount { get; set; }
        public decimal TotalSpaceMB { get; set; }
        public string DataCompression { get; set; } = "NONE";
        public DateTime CreatedDate { get; set; }
    }

    private static string FormatBoundaryValue(string value, string? dataType)
    {
        if (string.IsNullOrWhiteSpace(value) || string.Equals(value, "N/A", StringComparison.OrdinalIgnoreCase))
        {
            return value;
        }

        if (string.IsNullOrWhiteSpace(dataType))
        {
            return value;
        }

        var normalizedType = dataType.ToLowerInvariant();
        if (normalizedType is "date" or "datetime" or "datetime2" or "smalldatetime" or "datetimeoffset")
        {
            var trimmed = value.Trim();
            if (DateTime.TryParse(trimmed, CultureInfo.InvariantCulture, DateTimeStyles.AllowWhiteSpaces | DateTimeStyles.AssumeLocal, out var parsed) ||
                DateTime.TryParse(trimmed, CultureInfo.CurrentCulture, DateTimeStyles.AllowWhiteSpaces, out parsed))
            {
                return parsed.ToString("yyyy-MM-dd", CultureInfo.InvariantCulture);
            }
        }

        return value;
    }

    /// <summary>
    /// 目标服务器配置表单模型
    /// </summary>
    private class TargetServerConfigModel
    {
        /// <summary>
        /// 是否使用源服务器作为目标服务器
        /// </summary>
        public bool UseSourceAsTarget { get; set; } = true;

        /// <summary>
        /// 目标服务器地址
        /// </summary>
        public string ServerAddress { get; set; } = "";

        /// <summary>
        /// 目标服务器端口
        /// </summary>
        public int Port { get; set; } = 1433;

        /// <summary>
        /// 目标数据库名称
        /// </summary>
        public string DatabaseName { get; set; } = "";

        /// <summary>
        /// 是否使用集成认证
        /// </summary>
        public bool UseIntegratedSecurity { get; set; } = true;

        /// <summary>
        /// 用户名
        /// </summary>
        public string UserName { get; set; } = "";

        /// <summary>
        /// 密码
        /// </summary>
        public string Password { get; set; } = "";
    }
}




