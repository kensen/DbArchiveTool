@page "/archive-data-sources/{DataSourceId:guid}/partitions"
@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.Components.Forms
@using DbArchiveTool.Application.Partitions
@using DbArchiveTool.Web.Services
@inject PartitionManagementApiClient PartitionApi

<PageTitle>分区管理</PageTitle>

<section class="partition-actions">
	<button class="btn btn-primary" @onclick="OpenSplitDrawer">拆分分区</button>
</section>

@if (!string.IsNullOrEmpty(alertMessage))
{
	<div class="alert @($"alert-{alertLevel}")">@alertMessage</div>
}

@if (showSplitDrawer)
{
	<div class="split-drawer">
		<EditForm Model="@splitModel">
			<DataAnnotationsValidator />
			<ValidationSummary />

			<div class="form-group">
				<label for="schema">架构名</label>
				<InputText id="schema" class="form-control" @bind-Value="splitModel.SchemaName" />
			</div>

			<div class="form-group">
				<label for="table">表名</label>
				<InputText id="table" class="form-control" @bind-Value="splitModel.TableName" />
			</div>

			<div class="form-group">
				<label for="boundary">新分区边界值</label>
				<InputText id="boundary" class="form-control" @bind-Value="splitModel.BoundaryValue" />
			</div>

			<div class="form-group">
				<label for="requestedBy">申请人</label>
				<InputText id="requestedBy" class="form-control" @bind-Value="splitModel.RequestedBy" />
			</div>

			<div class="form-check">
				<InputCheckbox id="backup" class="form-check-input" @bind-Value="splitModel.BackupConfirmed" />
				<label class="form-check-label" for="backup">已确认最近备份</label>
			</div>

			<div class="action-buttons">
				<button type="button" class="btn btn-secondary" disabled="@submittingSplit" @onclick="PreviewSplitAsync">预览脚本</button>
				<button type="button" class="btn btn-success" disabled="@submittingSplit || preview is null" @onclick="SubmitSplitAsync">提交命令</button>
				<button type="button" class="btn btn-link" @onclick="CloseSplitDrawer">关闭</button>
			</div>
		</EditForm>

		@if (preview is not null)
		{
			<section class="preview-section">
				<h4>脚本预览</h4>
				<pre>@preview.Script</pre>

				@if (preview.Warnings.Count > 0)
				{
					<ul class="warning-list">
						@foreach (var warning in preview.Warnings)
						{
							<li>@warning</li>
						}
					</ul>
				}
			</section>
		}
	</div>
}
