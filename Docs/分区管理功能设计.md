# 分区管理功能设计

## 1. 背景与目标
- 在归档数据源列表中点击服务器卡片后进入分区管理界面，提供表分区的可视化管理能力。
- 支持读取 SQL Server 已有的分区函数、分区方案、目标表及分区边界信息，并可执行新增/移除等标准操作。
- 在任何分区维护流程中确保数据库安全，要求先校验前置条件、提供预览脚本与操作提示，避免数据丢失。

## 2. 领域模型规划
- 新增 PartitionConfiguration 聚合根：关联归档数据源 Id、架构名、目标表、分区函数/方案名称、分区列（类型、排序规则）、是否 Range Right、默认文件组策略、保留策略（按时间或数量）。
- 值对象：
  - PartitionBoundary：包含边界序号、边界值（支持日期、整数、自增 Id、GUID 等），负责维持边界顺序及唯一性。
  - PartitionFilegroupMapping：描述边界到文件组的映射策略，允许默认文件组或自定义文件组列表。
  - PartitionSafetyRule：封装操作前置条件（分区是否为空、锁类型、推荐执行时段等），供应用层决策。
- 仓储契约：IPartitionMetadataRepository 负责查询 SQL Server 元数据信息（函数、方案、边界、分区文件组、行数等），提供只读/预览结果，实际 DDL 执行由应用层协调。

## 3. 应用层用例
- PartitionManagementAppService 负责组合元数据查询、安全校验与执行脚本，主要方法：
  - ListPartitionsAsync：读取目标表当前分区概览，返回分区数、边界值、文件组、行数。
  - GetPartitionDetailsAsync：查看单个分区详情及安全状态提示。
  - PreviewAddPartitionAsync / AddPartitionAsync：校验并执行新增边界，支持 Range Left/Right、指定文件组、生成可执行脚本。
  - PreviewRemovePartitionAsync / RemovePartitionAsync：校验分区数据行数，必要时提供 SWITCH 至临时表选项。
  - SwitchPartitionAsync：在安全确认后执行 SWITCH 至指定归档表。
- 所有执行操作默认先走预览接口返回脚本列表和安全提示，前端需二次确认后再调用执行接口。

## 4. 基础设施实现
- 通过 Dapper 新增 SQL Server 元数据访问组件：
  - 查询 sys.tables、sys.indexes、sys.partitions、sys.partition_schemes/functions、sys.allocation_units 等视图获取结构信息。
  - 统一封装连接字符串构造（复用 ArchiveDataSource 凭据），设置 ApplicationIntent=ReadOnly 用于元数据查询。
- 创建脚本模板存放于 Sql/Partitioning/：包含分区新增 (ALTER PARTITION FUNCTION ... SPLIT RANGE)、文件组配置 (ALTER PARTITION SCHEME ... NEXT USED)、分区移除 (MERGE RANGE)、ALTER TABLE ... SWITCH 等操作，模板内包含 SET XACT_ABORT ON、SET NOCOUNT ON、TRY/CATCH 结构。
- 实际执行时开启显式事务，设置 lock_timeout，若失败回滚并记录失败原因。

## 5. API 设计
- 新增控制器 ArchiveDataSourcePartitionsController：路由 pi/v1/archive-data-sources/{id}/partitions。
- 主要端点：
  - GET /：列出目标表的分区概览。
  - GET /{schema}/{table}：查看指定表的配置与边界详情。
  - POST /{schema}/{table}/preview-add 与 POST /{schema}/{table}/add。
  - POST /{schema}/{table}/preview-remove 与 POST /{schema}/{table}/remove。
  - POST /{schema}/{table}/switch：执行 SWITCH 操作。
- 所有写操作需要管理员身份 + 幂等令牌，并返回 ProblemDetails 提供安全提示或失败原因。

## 6. 前端界面
- 新增 Blazor 页面 /archive-data-sources/{id}/partitions：加载数据源详情及默认选中的表分区情况。
- 页面结构：
  - 概览区：展示分区数量、最大/最小边界、Range 类型、默认文件组、最近操作时间。
  - 分区列表：表格显示每个边界值、行数、所在文件组、安全状态（空/有数据/警告）。
  - 操作面板：
    - “新增分区” 向导：输入边界值、选择文件组、预览脚本、安全提示。
    - “移除分区” 面板：选择目标边界，显示行数警告，并可选择 SWITCH 目标表。
    - “脚本预览” Tab：只读展示将要执行的 SQL，要求确认复选框后才能提交。
- 交互要求：所有危险操作需二次确认并展示安全提示；操作完成后刷新分区信息。

## 7. 安全与审计
- 应用层在执行前后记录审计日志（包含操作人、数据源、表名、DDL 摘要、结果）。
- 若启用 SWITCH，验证目标表结构（列顺序、索引、约束一致性）；如不符合则阻止执行。
- 引入 DryRun 选项，默认前端先调用预览接口获取脚本与提示后再决定是否执行。
- 失败时捕获 SQL 错误并转换为用户友好的提示，同时保留技术细节供日志审计。

## 8. 实施步骤
1. 领域层：创建 Partitions 目录下的聚合、值对象、仓储契约及对应单元测试，确保边界排序、文件组策略等规则正确。
2. 基础设施层：实现 SQL Server 元数据仓储和脚本执行器，引入参数化脚本模板，补充集成测试（可使用本地 SQL 容器）。
3. 应用层：编写 PartitionManagementAppService、DTO 和安全校验逻辑，整合审计记录。
4. API 层：新增控制器、请求/响应模型、DI 注册、Swagger 文档更新。
5. Web 层：实现新的分区管理页面和服务调用，完成 UI 交互和状态管理。
6. 测试与文档：扩展单元/集成/UI 测试，更新 Docs/ 相关说明和 SQL 脚本示例。

