# 分区管理功能设计

## 1. 背景与目标
- 在归档数据源列表中点击服务器卡片后进入分区管理界面，提供表分区的可视化管理能力。
- 支持读取 SQL Server 已有的分区函数、分区方案、目标表及分区边界信息，并可执行新增/移除/切换等标准操作。
- 在任何分区维护流程中确保数据库安全，要求先校验前置条件、提供预览脚本与操作提示，避免数据丢失。

## 2. 领域模型规划
- 新增 PartitionConfiguration 聚合根：关联归档数据源 Id、架构名、目标表、分区函数/方案名称、分区列（类型、排序规则）、是否 Range Right、默认文件组策略、保留策略（按时间或数量）。
- 值对象：
  - PartitionBoundary：包含边界序号、边界值（支持日期、整数、自增 Id、GUID 等），负责维护边界顺序及唯一性。
  - PartitionFilegroupMapping：描述边界到文件组的映射策略，允许默认文件组或自定义文件组列表，提供 `PartitionConfiguration.TryAssignFilegroup` 支持动态调整映射。
  - PartitionSafetyRule：封装操作前置条件（分区是否为空、锁类型、推荐执行时段、额外风险提示），供应用层决策及前端风险展示。
  - PartitionCommand：表示一次分区操作（Split/Merge/Switch），包含目标对象、脚本、脚本摘要（Hash）、风险提示、状态、审计信息、执行日志；通过 `CreateSplit` / `CreateMerge` / `CreateSwitch` 工厂方法构建。
- PartitionConfiguration 新增集合 `FilegroupMappings` 与 `SafetyRule`，并提供 `ResolveFilegroup`、`UpdateSafetyRule`、`ClearSafetyRule` 等领域行为，移除边界时需同步清理对应文件组映射。
- PartitionCommand 状态机扩展：PendingApproval → Approved → Queued → Executing → Succeeded/Failed，过程中保留 `ExecutedAt`、`CompletedAt`、`FailureReason`、`RiskNotes`、`ExecutionLog`。
- 仓储契约：
  - IPartitionMetadataRepository 查询分区配置、文件组映射、安全规则、安全快照。
  - IPartitionCommandRepository 负责命令新增、更新、列表查询、入队状态维护。

## 3. 应用层用途
- PartitionManagementAppService：提供概览、边界安全快照等只读能力。
- PartitionCommandAppService：处理分区命令的预览、执行、审批、状态查询，由后台任务执行核心 DDL。
  - PreviewSplitAsync / ExecuteSplitAsync：校验 Range 规则、文件组策略、生成 SPLIT 脚本与风险提示（如备份未确认、一次处理多个边界）。
  - PreviewMergeAsync / ExecuteMergeAsync：校验分区存在、范围合法性和安全规则，生成 MERGE 脚本。
  - PreviewSwitchAsync / ExecuteSwitchAsync：校验源分区是否为空或提供目标表，必要时生成临时表脚本，支持“只生成脚本”模式。
  - GetStatusAsync：根据命令 Id 返回状态、失败原因、执行日志摘要，供前端轮询。
- DTO 扩充：新增 Merge/Switch 请求模型、`PartitionCommandPreviewDto.RiskWarnings`、`PartitionCommandStatusDto`。

## 4. 后端执行策略
- 通过后台任务执行（Queue + HostedService），避免页面关闭导致执行中断，可支持任务重试：
  - IPartitionCommandQueue：负责命令入队/出队，确保 FIFO；
  - PartitionCommandHostedService：循环拉取命令，调用执行器并更新状态。
- 执行前检查：
  - 调用 `sys.fn_my_permissions` 校验 ALTER、CONTROL、VIEW DEFINITION 等权限，缺失则拒绝执行；
  - 若 `PartitionSafetyRule.RequiresEmptyPartition`，执行前查询目标分区行数；
  - 审计中记录“是否确认已备份”，未勾选时执行接口返回失败，引导用户仅下载脚本。
- 执行时：
  - SqlPartitionCommandExecutor 渲染 SQL 模板，统一启用 `SET XACT_ABORT ON`、显式事务；
  - 所有变量采用参数化/模板替换，生成脚本与执行脚本一致并写入命令记录。
- 执行后：更新 PartitionCommand 状态、记录耗时与执行日志（截断或摘要），失败时填充 `FailureReason` 并保留异常堆栈。

## 5. SQL 模板与命名约束
- 模板目录：`src/DbArchiveTool.Infrastructure/SqlTemplates/Partitioning/Commands/`
  - SplitRange.sql：执行 ALTER PARTITION FUNCTION ... SPLIT。
  - MergeRange.sql：执行 MERGE RANGE。
  - SwitchOut.sql：SWITCH 源分区到目标表。
  - SwitchIn.sql：可选，用于恢复分区到主表。
  - SwitchPrepareStaging.sql：根据命名规则自动创建临时表。
  - PermissionCheck.sql：执行权限检测。
- 命名约束：
  - 自动创建文件组：`{TableName}_FG_{yyyyMMdd}`；
  - 临时 staging 表：`{TableName}_Stage_{yyyyMMddHHmm}`；
  - 审计编号：`Partition-{CommandType}-{yyyyMMddHHmmss}`；
  - 模板文件统一使用 UTF-8 编码和 CRLF 换行，通过 `ISqlTemplateProvider` 渲染，新增模板需在文档中同步说明。

## 6. API 设计
- 保留现有只读控制器，并新增 PartitionCommandsController：
  - POST `/api/v1/archive-data-sources/{id}/partitions/{schema}/{table}/split/preview`
  - POST `/api/v1/archive-data-sources/{id}/partitions/{schema}/{table}/split/execute`
  - POST `/api/v1/archive-data-sources/{id}/partitions/{schema}/{table}/merge/preview`
  - POST `/api/v1/archive-data-sources/{id}/partitions/{schema}/{table}/merge/execute`
  - POST `/api/v1/archive-data-sources/{id}/partitions/{schema}/{table}/switch/preview`
  - POST `/api/v1/archive-data-sources/{id}/partitions/{schema}/{table}/switch/execute`
  - GET `/api/v1/partition-commands/{commandId}` 查询状态与日志摘要；
  - POST `/api/v1/partition-commands/{commandId}/approve`、`/reject` 处理审批。
- 请求模型位于 Api.Models：Split/Merge/Switch/Approve/Reject。
- 响应模型：预览返回 `PartitionCommandPreviewDto`（含脚本、风险、脚本 Hash），执行返回 `CommandId`，状态返回 `PartitionCommandStatusDto`。
- 控制器需提供中文 XML 注释并声明 `ProducesResponseType`，方便 Swagger 展示。

## 7. 前端界面
- 概览页：
  - Tab1：分区概览（已实现）。
- 分区操作向导：
  - Tab2：新增分区（Split）向导：选择架构、表、边界列表、文件组策略、勾选备份确认；预览脚本后才能提交。
  - Tab3：移除/合并分区（Merge + Switch）：展示当前分区列表、行数、风险提示；支持选择目标表和是否自动创建临时表。
  - Tab4：任务日志：展示命令列表、状态、执行时间、脚本下载、审批按钮。
- 交互流程：预览按钮 → 显示脚本与风险提示 → 用户确认并勾选备份 → 调用执行接口 → 显示 CommandId 并跳转任务日志。
- 操作增强：
  - 未勾选“已备份”或未确认风险时禁用执行按钮；
  中奖    - 风险提示列表展示来   源 `PartitionSafetyRule`、批量操作等信息；
  - 脚本可复制/下载。

## 8. 安全与审计
- 强制记录每条命令：操作人、数据源、对象、脚本摘要、风险提示、确认备份标记。
- 执行失败：捕捉 SQL 异常，记录错误码/消息，并在 UI 提示通过日志查看详情。
- 提供“只生成脚本”模式，运维可手动执行并上传执行结果。
- 审计记录需包含权限校验结果、风险提示、脚本 Hash 与执行日志，保证可追踪性及合规。

## 9. 实施步骤
1. 领域层：扩展 PartitionConfiguration、PartitionCommand、值对象，编写验证规则与单元测试。
2. 应用层：实现 PartitionCommandAppService 扩展，串联安全校验与后台队列，补齐 DTO 与 Result。
3. 基础设施：
   - SqlPartitionCommandExecutor 渲染模板并执行事务；
   - PartitionCommandQueue + HostedService + 依赖注入；
   - 新增 SQL 模板与 TemplateProvider，实现权限校验、日志写入。
4. API 层：新增 PartitionCommandsController，完成预览/执行/审批/状态查询；补充集成测试。
5. Web 层：构建分区向导页面、任务日志与 API 客户端；提供脚本展示、风险提示、审批操作。（UI 自动化测试由人工验证替代。）
6. 测试：
   - 单元测试覆盖领域与应用逻辑；
   - 集成测试验证模板执行与 API 行为；
   - HostedService 通过模拟队列/执行器的集成测试验证可靠性。
7. 文档更新：保持本文件同步，补充 README/操作指南，说明权限与操作步骤。

## 10. 操作流程
1. 用户在 UI 选择目标表和分区操作类型（Split/Merge/Switch）。
2. 填写参数（边界、文件组、目标表等）并勾选“已备份/知悉风险”。
3. 系统调用预览接口，返回脚本与风险提示，用户确认后方可执行；亦可选择仅保存脚本。
4. 执行请求写入 PartitionCommand 并入队后台任务，立即返回 CommandId。
5. HostedService 读取命令执行 DDL，更新状态，前端可通过状态接口轮询或查看任务日志。

## 11. 权限与安全校验
- 执行账户需具备 ALTER、CONTROL、VIEW DEFINITION、CREATE TABLE（Switch 自动建表）等权限。
- 若 SafetyRule 要求分区为空，执行前需查询 `sys.partitions` 验证；不符合则禁止执行并提示风险。
- 未勾选“已备份”时执行接口返回失败，仅允许下载脚本；审批流程也需校验备份确认。
- 审计记录需包含权限校验结果、风险提示、脚本 Hash，确保可追踪性与不可篡改性。

## 12. 后台任务说明
- PartitionCommandQueue 采用 Channel<Guid> 实现，保证 FIFO 与并发控制，可根据配置限制并发度。
- PartitionCommandHostedService 使用依赖注入作用域加载命令、执行、持久化状态；失败任务支持配置重试策略（如指数退避 + 最大重试次数）。
- 执行日志以 JSON 或文本形式存入 `ExecutionLog`，包含耗时、受影响对象、异常堆栈。
- HostedService 健康状况可在后续版本暴露为监控指标（如 Prometheus）。

## 13. SQL 模板命名规则
- 模板文件统一命名 `{Operation}{Verb}.sql`，Operation 取 Split/Merge/Switch，Verb 取 Range/Out/In/Prepare 等，便于检索。
- 模板使用 PascalCase 参数名，通过 `ISqlTemplateProvider` 渲染；新增模板时需在文档中同步说明用途、输入参数。
- 模板中需描述风险提示与脚本 Hash 的生成方式，确保脚本与审计保持一致。
