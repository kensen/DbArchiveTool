# 数据归档工具 - 生产环境部署指南

## 📋 目录
- [部署前准备](#部署前准备)
- [服务器环境配置](#服务器环境配置)
- [数据库初始化](#数据库初始化)
- [应用程序部署](#应用程序部署)
- [配置文件设置](#配置文件设置)
- [Docker 容器化部署](#docker-容器化部署)
- [Windows 服务部署](#windows-服务部署)
- [IIS 部署方案](#iis-部署方案)
- [健康检查与监控](#健康检查与监控)
- [安全加固](#安全加固)
- [故障排查](#故障排查)
- [回滚方案](#回滚方案)

---

## 部署前准备

### 1. 硬件要求

| 组件 | 最低配置 | 推荐配置 | 备注 |
|------|---------|---------|------|
| **CPU** | 4 核 | 8 核+ | Always On 环境建议 8 核+ |
| **内存** | 8 GB | 16 GB+ | 大数据量归档建议 32GB+ |
| **磁盘** | 100 GB SSD | 500 GB+ SSD | 需考虑日志和临时文件空间 |
| **网络** | 100 Mbps | 1 Gbps+ | 跨服务器归档需高速网络 |

### 2. 软件依赖清单

| 软件 | 版本要求 | 用途 | 下载地址 |
|------|---------|------|---------|
| **Windows Server** | 2016+ / 2019+ / 2022 | 操作系统 | [Microsoft](https://www.microsoft.com/windows-server) |
| **.NET 8 Runtime** | 8.0.0+ | 应用程序运行时 | [dotnet.microsoft.com](https://dotnet.microsoft.com/download/dotnet/8.0) |
| **ASP.NET Core Runtime** | 8.0.0+ | Web 应用运行时 | 同上 |
| **SQL Server** | 2016+ / 2019+ / 2022 | 元数据库 | [Microsoft SQL Server](https://www.microsoft.com/sql-server) |
| **IIS** | 10.0+ (可选) | Web 托管 | Windows 功能 |
| **BCP 工具** | 与 SQL Server 版本匹配 | 数据导出导入 | SQL Server 安装自带 |

### 3. 网络与端口规划

| 服务 | 默认端口 | 说明 | 建议 |
|------|---------|------|------|
| **DbArchiveTool.Api** | 5001 (HTTPS) | REST API 服务 | 生产环境使用 443 |
| **DbArchiveTool.Web** | 5000 (HTTP) | Blazor UI | 生产环境使用 80/443 |
| **SQL Server** | 1433 | 元数据库 | 防火墙允许应用服务器访问 |
| **Hangfire Dashboard** | /hangfire | 任务监控面板 | 需配置授权 |

### 4. 数据库访问权限

应用程序需要以下 SQL Server 权限：

```sql
-- 1. 元数据库权限（DbArchiveTool 数据库）
USE [DbArchiveTool];
GO

-- 创建专用数据库用户
CREATE LOGIN [DbArchiveToolApp] WITH PASSWORD = 'Strong@Password123!';
CREATE USER [DbArchiveToolApp] FOR LOGIN [DbArchiveToolApp];

-- 授予必要权限
ALTER ROLE [db_owner] ADD MEMBER [DbArchiveToolApp];  -- 需要 DDL 权限（迁移表结构）
-- 或者使用更细粒度的权限：
-- ALTER ROLE [db_datareader] ADD MEMBER [DbArchiveToolApp];
-- ALTER ROLE [db_datawriter] ADD MEMBER [DbArchiveToolApp];
-- GRANT CREATE TABLE TO [DbArchiveToolApp];
-- GRANT CREATE PROCEDURE TO [DbArchiveToolApp];

-- 2. Hangfire 数据库权限（使用同一数据库）
-- 已包含在上面的 db_owner 角色中

-- 3. 归档源数据库权限（业务数据库）
USE [YourBusinessDatabase];
GO

CREATE USER [DbArchiveToolApp] FOR LOGIN [DbArchiveToolApp];
-- 授予读取权限和必要的 DDL 权限
ALTER ROLE [db_datareader] ADD MEMBER [DbArchiveToolApp];
GRANT SELECT, INSERT, DELETE ON SCHEMA::dbo TO [DbArchiveToolApp];
GRANT CREATE TABLE TO [DbArchiveToolApp];  -- 创建临时表
GRANT ALTER ON SCHEMA::dbo TO [DbArchiveToolApp];  -- 分区 SWITCH 操作
GRANT VIEW DATABASE STATE TO [DbArchiveToolApp];  -- 查询分区元数据

-- 4. 归档目标数据库权限
USE [YourArchiveDatabase];
GO

CREATE USER [DbArchiveToolApp] FOR LOGIN [DbArchiveToolApp];
ALTER ROLE [db_datawriter] ADD MEMBER [DbArchiveToolApp];
GRANT SELECT, INSERT, CREATE TABLE ON SCHEMA::dbo TO [DbArchiveToolApp];
```

### 5. 部署前检查清单

```powershell
# 检查 .NET 运行时
dotnet --list-runtimes

# 检查 SQL Server 连接
sqlcmd -S YourServer -d master -Q "SELECT @@VERSION"

# 检查 BCP 工具
bcp -v

# 检查防火墙规则
Get-NetFirewallRule -DisplayName "*5001*"

# 检查磁盘空间（至少 20GB 可用空间）
Get-PSDrive -PSProvider FileSystem

# 检查 IIS 安装（如果使用 IIS）
Get-WindowsFeature -Name Web-Server
```

---

## 服务器环境配置

### 1. 安装 .NET 8 Runtime

```powershell
# 下载 .NET 8 Hosting Bundle（包含 Runtime 和 ASP.NET Core）
# 访问：https://dotnet.microsoft.com/download/dotnet/8.0
# 选择：ASP.NET Core Runtime 8.0.x - Windows Hosting Bundle

# 安装后重启 IIS（如果使用）
iisreset

# 验证安装
dotnet --info
```

### 2. 配置应用程序目录

```powershell
# 创建部署目录
$deployPath = "C:\Applications\DbArchiveTool"
New-Item -Path $deployPath -ItemType Directory -Force

# 创建子目录
New-Item -Path "$deployPath\Api" -ItemType Directory -Force
New-Item -Path "$deployPath\Web" -ItemType Directory -Force
New-Item -Path "$deployPath\Logs" -ItemType Directory -Force
New-Item -Path "$deployPath\Temp" -ItemType Directory -Force
New-Item -Path "$deployPath\Backups" -ItemType Directory -Force

# 设置目录权限
$acl = Get-Acl $deployPath
$rule = New-Object System.Security.AccessControl.FileSystemAccessRule(
    "IIS_IUSRS", "FullControl", "ContainerInherit,ObjectInherit", "None", "Allow")
$acl.SetAccessRule($rule)
Set-Acl $deployPath $acl
```

### 3. 配置防火墙规则

```powershell
# 允许 API 端口（5001）
New-NetFirewallRule -DisplayName "DbArchiveTool API" `
    -Direction Inbound `
    -Protocol TCP `
    -LocalPort 5001 `
    -Action Allow

# 允许 Web 端口（5000）
New-NetFirewallRule -DisplayName "DbArchiveTool Web" `
    -Direction Inbound `
    -Protocol TCP `
    -LocalPort 5000 `
    -Action Allow

# 如果使用 IIS，允许 80/443
New-NetFirewallRule -DisplayName "HTTP" -Direction Inbound -Protocol TCP -LocalPort 80 -Action Allow
New-NetFirewallRule -DisplayName "HTTPS" -Direction Inbound -Protocol TCP -LocalPort 443 -Action Allow
```

---

## 数据库初始化

### 1. 创建元数据库

```sql
-- 在 SQL Server 上执行
USE master;
GO

-- 创建数据库
CREATE DATABASE [DbArchiveTool]
ON PRIMARY 
(
    NAME = N'DbArchiveTool',
    FILENAME = N'D:\SQLData\DbArchiveTool.mdf',
    SIZE = 1024MB,
    FILEGROWTH = 256MB
)
LOG ON 
(
    NAME = N'DbArchiveTool_log',
    FILENAME = N'D:\SQLData\DbArchiveTool_log.ldf',
    SIZE = 512MB,
    FILEGROWTH = 128MB
);
GO

-- 设置恢复模式（生产环境建议 FULL）
ALTER DATABASE [DbArchiveTool] SET RECOVERY FULL;
GO

-- 优化配置
ALTER DATABASE [DbArchiveTool] SET AUTO_CREATE_STATISTICS ON;
ALTER DATABASE [DbArchiveTool] SET AUTO_UPDATE_STATISTICS ON;
ALTER DATABASE [DbArchiveTool] SET PAGE_VERIFY CHECKSUM;
GO
```

### 2. 执行 EF Core 迁移

**方法 A：使用开发机器远程迁移**

```powershell
# 在开发机器上执行（需要连接生产数据库）
cd F:\tmp\数据归档工具\DBManageTool

# 设置生产数据库连接字符串
$prodConnectionString = "Server=PROD_SERVER;Database=DbArchiveTool;User Id=DbArchiveToolApp;Password=Strong@Password123!;TrustServerCertificate=True"

# 执行迁移
dotnet ef database update `
    --project src/DbArchiveTool.Infrastructure `
    --startup-project src/DbArchiveTool.Api `
    --connection $prodConnectionString

# 验证表结构
sqlcmd -S PROD_SERVER -d DbArchiveTool -U DbArchiveToolApp -P "Strong@Password123!" -Q "SELECT TABLE_NAME FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_TYPE='BASE TABLE' ORDER BY TABLE_NAME"
```

**方法 B：应用程序自动迁移（推荐）**

应用程序在启动时会自动执行数据库迁移（已在 `Program.cs` 中配置）：

```csharp
// Program.cs 已包含以下代码
using (var tempScope = builder.Services.BuildServiceProvider().CreateScope())
{
    var dbContext = tempScope.ServiceProvider.GetRequiredService<ArchiveDbContext>();
    await dbContext.Database.MigrateAsync();
}
```

### 3. 初始化管理员账户

```powershell
# 使用 API 注册管理员（应用程序启动后执行）
$apiUrl = "https://your-server:5001"

$adminData = @{
    username = "admin"
    password = "Admin@123456"
    email = "admin@company.com"
} | ConvertTo-Json

Invoke-RestMethod -Uri "$apiUrl/api/v1/auth/register" `
    -Method Post `
    -Body $adminData `
    -ContentType "application/json"
```

### 4. 加密历史密码（如有数据迁移）

```powershell
cd C:\Applications\DbArchiveTool\Tools

# 运行密码加密工具
dotnet EncryptPasswords.dll `
    --connection "Server=PROD_SERVER;Database=DbArchiveTool;Trusted_Connection=True;TrustServerCertificate=True"
```

---

## 应用程序部署

### 1. 发布应用程序

**在开发机器上执行：**

```powershell
cd F:\tmp\数据归档工具\DBManageTool

# 发布 API 项目
dotnet publish src/DbArchiveTool.Api/DbArchiveTool.Api.csproj `
    -c Release `
    -o publish/Api `
    --self-contained false `
    -p:PublishSingleFile=false

# 发布 Web 项目
dotnet publish src/DbArchiveTool.Web/DbArchiveTool.Web.csproj `
    -c Release `
    -o publish/Web `
    --self-contained false `
    -p:PublishSingleFile=false

# 压缩发布包
Compress-Archive -Path publish/Api/* -DestinationPath DbArchiveTool.Api.zip -Force
Compress-Archive -Path publish/Web/* -DestinationPath DbArchiveTool.Web.zip -Force
```

### 2. 上传到生产服务器

```powershell
# 方法 A：使用远程桌面手动复制

# 方法 B：使用 PowerShell Remoting
$session = New-PSSession -ComputerName PROD_SERVER -Credential (Get-Credential)

Copy-Item -Path ".\DbArchiveTool.Api.zip" -Destination "C:\Temp\" -ToSession $session
Copy-Item -Path ".\DbArchiveTool.Web.zip" -Destination "C:\Temp\" -ToSession $session

Remove-PSSession $session
```

### 3. 解压到部署目录

**在生产服务器上执行：**

```powershell
# 停止现有服务（如果已部署）
Stop-Service -Name "DbArchiveTool.Api" -ErrorAction SilentlyContinue
Stop-Service -Name "DbArchiveTool.Web" -ErrorAction SilentlyContinue

# 备份当前版本
$timestamp = Get-Date -Format "yyyyMMdd_HHmmss"
if (Test-Path "C:\Applications\DbArchiveTool\Api") {
    Compress-Archive -Path "C:\Applications\DbArchiveTool\Api" `
        -DestinationPath "C:\Applications\DbArchiveTool\Backups\Api_$timestamp.zip"
}

# 解压新版本
Expand-Archive -Path "C:\Temp\DbArchiveTool.Api.zip" `
    -DestinationPath "C:\Applications\DbArchiveTool\Api" -Force

Expand-Archive -Path "C:\Temp\DbArchiveTool.Web.zip" `
    -DestinationPath "C:\Applications\DbArchiveTool\Web" -Force

# 清理临时文件
Remove-Item "C:\Temp\DbArchiveTool.*.zip"
```

---

## 配置文件设置

### 1. API 配置文件（appsettings.Production.json）

```powershell
# 创建生产配置文件
$apiConfig = @"
{
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning",
      "Microsoft.EntityFrameworkCore": "Warning",
      "Hangfire": "Information"
    },
    "File": {
      "Path": "C:\\Applications\\DbArchiveTool\\Logs\\api-.log",
      "RollingInterval": "Day",
      "RetainedFileCountLimit": 30,
      "FileSizeLimitBytes": 104857600
    }
  },
  "ConnectionStrings": {
    "ArchiveDatabase": "Server=PROD_SQL_SERVER;Database=DbArchiveTool;User Id=DbArchiveToolApp;Password=Strong@Password123!;TrustServerCertificate=True;Encrypt=True;Connection Timeout=30;Max Pool Size=200"
  },
  "AllowedHosts": "*",
  "Kestrel": {
    "Endpoints": {
      "Https": {
        "Url": "https://*:5001",
        "Certificate": {
          "Path": "C:\\Certificates\\archive-api.pfx",
          "Password": "CertPassword"
        }
      }
    },
    "Limits": {
      "MaxRequestBodySize": 524288000,
      "RequestHeadersTimeout": "00:02:00"
    }
  },
  "Hangfire": {
    "WorkerCount": 8,
    "Queues": ["archive", "default"],
    "ServerName": "PROD-ARCHIVE-01"
  },
  "Archive": {
    "TempDirectory": "C:\\Applications\\DbArchiveTool\\Temp",
    "MaxConcurrentTasks": 4,
    "TaskTimeout": "02:00:00",
    "BcpTimeout": 7200,
    "BulkCopyBatchSize": 10000,
    "AlwaysOn": {
      "Enabled": true,
      "MaxLogGenerationMBPerMin": 500,
      "MonitorSecondaryLag": true,
      "PauseIfLagExceeds": 10
    }
  }
}
"@

$apiConfig | Out-File -FilePath "C:\Applications\DbArchiveTool\Api\appsettings.Production.json" -Encoding UTF8
```

### 2. Web 配置文件（appsettings.Production.json）

```powershell
$webConfig = @"
{
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning"
    },
    "File": {
      "Path": "C:\\Applications\\DbArchiveTool\\Logs\\web-.log",
      "RollingInterval": "Day",
      "RetainedFileCountLimit": 30
    }
  },
  "ArchiveApi": {
    "BaseUrl": "https://localhost:5001"
  },
  "ConnectionStrings": {
    "HangfireDatabase": "Server=PROD_SQL_SERVER;Database=DbArchiveTool;User Id=DbArchiveToolApp;Password=Strong@Password123!;TrustServerCertificate=True;Encrypt=True"
  },
  "AllowedHosts": "*",
  "Kestrel": {
    "Endpoints": {
      "Http": {
        "Url": "http://*:5000"
      }
    }
  }
}
"@

$webConfig | Out-File -FilePath "C:\Applications\DbArchiveTool\Web\appsettings.Production.json" -Encoding UTF8
```

### 3. 配置环境变量

```powershell
# 设置系统环境变量
[System.Environment]::SetEnvironmentVariable(
    "ASPNETCORE_ENVIRONMENT", 
    "Production", 
    [System.EnvironmentVariableTarget]::Machine)

[System.Environment]::SetEnvironmentVariable(
    "SQLSERVER_ALWAYSON_MODE", 
    "true", 
    [System.EnvironmentVariableTarget]::Machine)

# 设置临时目录
[System.Environment]::SetEnvironmentVariable(
    "ARCHIVE_TEMP_DIR", 
    "C:\Applications\DbArchiveTool\Temp", 
    [System.EnvironmentVariableTarget]::Machine)
```

---

## Docker 容器化部署

### 🐳 部署方案概述

Docker 部署方案提供了最简单快速的部署方式，适用于：
- **快速体验和测试**：一键启动完整环境
- **开发环境**：本地开发和调试
- **容器化生产环境**：Kubernetes、Docker Swarm
- **跨平台部署**：Windows、Linux、macOS

**架构组件**：
- SQL Server 2022（容器化数据库）
- DbArchiveTool.Api（REST API 服务）
- DbArchiveTool.Web（Blazor Web 界面）

---

### 1. 环境准备

#### 安装 Docker Desktop

**Windows 环境：**
```powershell
# 下载 Docker Desktop for Windows
# https://www.docker.com/products/docker-desktop/

# 启用 WSL 2（推荐）
wsl --install
wsl --set-default-version 2

# 验证安装
docker --version
docker-compose --version
```

**Linux 环境：**
```bash
# Ubuntu/Debian
sudo apt-get update
sudo apt-get install -y docker.io docker-compose

# 启动 Docker 服务
sudo systemctl start docker
sudo systemctl enable docker

# 添加当前用户到 docker 组
sudo usermod -aG docker $USER

# 验证安装
docker --version
docker-compose --version
```

#### 系统要求

| 资源 | 最低配置 | 推荐配置 |
|------|---------|---------|
| **CPU** | 2 核 | 4 核+ |
| **内存** | 4 GB | 8 GB+ |
| **磁盘** | 20 GB | 50 GB+ |
| **Docker** | 20.10.0+ | 最新版本 |

---

### 2. 快速启动（开箱即用）

#### 一键启动所有服务

```powershell
# 进入项目根目录
cd F:\tmp\数据归档工具\DBManageTool

# 启动所有服务（SQL Server + API + Web）
docker-compose up -d

# 查看服务状态
docker-compose ps

# 查看日志
docker-compose logs -f

# 等待服务就绪（约 1-2 分钟）
# SQL Server 初始化需要 30-60 秒
```

**输出示例**：
```
[+] Running 4/4
 ✔ Network dbarchive-network           Created
 ✔ Container dbarchive-sqlserver       Started
 ✔ Container dbarchive-api             Started
 ✔ Container dbarchive-web             Started
```

#### 访问服务

- **Web 界面**：http://localhost:5000
- **API 服务**：http://localhost:5001
- **Swagger 文档**：http://localhost:5001/swagger
- **Hangfire 监控**：http://localhost:5001/hangfire
- **SQL Server**：localhost:1433（用户名: sa，密码: Archive@Pass123!）

#### 初始化管理员账户

```powershell
# 等待 API 服务就绪
Start-Sleep -Seconds 60

# 注册管理员账户
$adminData = @{
    username = "admin"
    password = "Admin@123456"
    email = "admin@company.com"
} | ConvertTo-Json

Invoke-RestMethod -Uri "http://localhost:5001/api/v1/auth/register" `
    -Method Post `
    -Body $adminData `
    -ContentType "application/json"
```

---

### 3. Docker 镜像构建

#### 手动构建镜像

```powershell
cd F:\tmp\数据归档工具\DBManageTool

# 构建 API 镜像
docker build -t dbarchive-api:latest -f src/DbArchiveTool.Api/Dockerfile .

# 构建 Web 镜像
docker build -t dbarchive-web:latest -f src/DbArchiveTool.Web/Dockerfile .

# 查看镜像
docker images | Select-String "dbarchive"
```

#### 优化镜像构建

```powershell
# 使用 BuildKit 加速构建
$env:DOCKER_BUILDKIT=1

# 多阶段构建（已在 Dockerfile 中配置）
# - build 阶段：使用 SDK 镜像编译
# - runtime 阶段：使用轻量级 ASP.NET 镜像运行

# 构建并标记版本
docker build -t dbarchive-api:1.0.0 -t dbarchive-api:latest `
    -f src/DbArchiveTool.Api/Dockerfile .

# 查看镜像大小
docker images dbarchive-api
# REPOSITORY       TAG       SIZE
# dbarchive-api    latest    ~350MB（优化后）
```

---

### 4. 生产环境配置

#### 自定义 docker-compose.prod.yml

```yaml
version: '3.8'

services:
  sqlserver:
    image: mcr.microsoft.com/mssql/server:2022-latest
    container_name: dbarchive-sqlserver-prod
    environment:
      - SA_PASSWORD=${SQL_SA_PASSWORD:-StrongPass@2024!}
      - ACCEPT_EULA=Y
      - MSSQL_PID=Standard  # 生产版本
    volumes:
      - /data/sqlserver:/var/opt/mssql  # 持久化到宿主机
    ports:
      - "1433:1433"
    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 8G
        reservations:
          cpus: '2'
          memory: 4G
    restart: always

  api:
    image: dbarchive-api:1.0.0
    container_name: dbarchive-api-prod
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ConnectionStrings__ArchiveDatabase=Server=sqlserver;Database=DbArchiveTool;User Id=sa;Password=${SQL_SA_PASSWORD:-StrongPass@2024!};TrustServerCertificate=True
      - SQLSERVER_ALWAYSON_MODE=false
      - Archive__MaxConcurrentTasks=8
      - Hangfire__WorkerCount=8
    volumes:
      - /data/archive/logs:/app/logs
      - /data/archive/temp:/app/temp
    ports:
      - "5001:5001"
    depends_on:
      - sqlserver
    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 4G
    restart: always

  web:
    image: dbarchive-web:1.0.0
    container_name: dbarchive-web-prod
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ArchiveApi__BaseUrl=http://api:5001
    ports:
      - "80:5000"  # 映射到标准 HTTP 端口
    depends_on:
      - api
    restart: always
```

#### 使用环境变量文件

创建 `.env` 文件：
```bash
# .env - Docker Compose 环境变量
SQL_SA_PASSWORD=YourStrongPassword@2024!
ARCHIVE_MAX_TASKS=8
HANGFIRE_WORKER_COUNT=8
```

启动生产环境：
```powershell
# 使用生产配置启动
docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d

# 或直接使用环境变量
$env:SQL_SA_PASSWORD="YourStrongPassword@2024!"
docker-compose up -d
```

---

### 5. 数据持久化

#### 使用命名卷（推荐）

```powershell
# 查看 Docker 卷
docker volume ls | Select-String "dbarchive"

# 检查卷详情
docker volume inspect dbarchive-sqlserver-data

# 备份数据卷
docker run --rm `
    -v dbarchive-sqlserver-data:/source `
    -v C:\Backups:/backup `
    alpine tar czf /backup/sqlserver-backup-$(Get-Date -Format 'yyyyMMdd').tar.gz -C /source .

# 恢复数据卷
docker run --rm `
    -v dbarchive-sqlserver-data:/target `
    -v C:\Backups:/backup `
    alpine tar xzf /backup/sqlserver-backup-20251114.tar.gz -C /target
```

#### 使用宿主机目录

修改 `docker-compose.yml`：
```yaml
volumes:
  # 替换命名卷为宿主机路径
  - /data/sqlserver:/var/opt/mssql
  - /data/logs:/app/logs
  - /data/temp:/app/temp
```

**Windows 路径示例**：
```yaml
volumes:
  - C:\Docker\DbArchive\sqlserver:/var/opt/mssql
  - C:\Docker\DbArchive\logs:/app/logs
```

---

### 6. 容器管理

#### 常用命令

```powershell
# ========== 服务管理 ==========
# 启动所有服务
docker-compose up -d

# 停止所有服务
docker-compose down

# 重启服务
docker-compose restart

# 停止并删除容器、网络、卷
docker-compose down -v

# ========== 查看状态 ==========
# 查看运行中的容器
docker-compose ps

# 查看服务日志
docker-compose logs -f api
docker-compose logs -f web
docker-compose logs -f sqlserver

# 实时查看资源使用
docker stats

# ========== 容器操作 ==========
# 进入容器 Shell
docker exec -it dbarchive-api bash
docker exec -it dbarchive-sqlserver /bin/bash

# 在容器中执行命令
docker exec dbarchive-api dotnet --info

# 从容器复制文件
docker cp dbarchive-api:/app/logs/api-20251114.log ./

# 复制文件到容器
docker cp ./appsettings.json dbarchive-api:/app/

# ========== 清理 ==========
# 清理未使用的镜像
docker image prune -a

# 清理未使用的卷
docker volume prune

# 完整清理（谨慎使用）
docker system prune -a --volumes
```

#### 服务伸缩

```powershell
# 扩展 API 服务到 3 个实例（需配置负载均衡）
docker-compose up -d --scale api=3

# 查看多个实例
docker-compose ps
```

---

### 7. 健康检查与监控

#### 内置健康检查

```powershell
# 查看容器健康状态
docker inspect --format='{{.State.Health.Status}}' dbarchive-api
# healthy / unhealthy / starting

# 查看健康检查日志
docker inspect --format='{{range .State.Health.Log}}{{.Output}}{{end}}' dbarchive-api
```

#### 使用 Docker Compose 监控

```yaml
# 在 docker-compose.yml 中已配置健康检查
healthcheck:
  test: ["CMD-SHELL", "curl -f http://localhost:5001/api/v1/health || exit 1"]
  interval: 30s
  timeout: 5s
  retries: 3
  start_period: 60s
```

#### 集成 Portainer（可选）

```powershell
# 部署 Portainer 容器管理界面
docker run -d `
    -p 9000:9000 `
    -v /var/run/docker.sock:/var/run/docker.sock `
    -v portainer_data:/data `
    --name portainer `
    portainer/portainer-ce:latest

# 访问 Portainer: http://localhost:9000
```

---

### 8. 开发环境配置

#### 使用开发配置启动

```powershell
# 使用开发环境配置（支持热重载）
docker-compose -f docker-compose.yml -f docker-compose.dev.yml up

# 特点：
# - 挂载源代码目录（实时同步）
# - 启用 dotnet watch（自动重启）
# - 调试日志级别
# - 暴露调试端口
```

#### 本地开发 + Docker 数据库

```powershell
# 仅启动数据库容器
docker-compose up -d sqlserver

# 本地运行 API 和 Web（连接容器数据库）
cd src/DbArchiveTool.Api
dotnet run

cd src/DbArchiveTool.Web
dotnet run
```

---

### 9. 网络配置

#### 容器间通信

```powershell
# 查看 Docker 网络
docker network ls | Select-String "dbarchive"

# 检查网络详情
docker network inspect dbarchive-network

# 测试容器间连接
docker exec dbarchive-web curl http://api:5001/api/v1/health
```

#### 暴露到外网

```yaml
# 修改端口映射（docker-compose.yml）
services:
  web:
    ports:
      - "80:5000"      # HTTP
      - "443:5001"     # HTTPS（需配置证书）
```

#### 反向代理配置（Nginx）

```nginx
# nginx.conf
upstream dbarchive-api {
    server localhost:5001;
}

upstream dbarchive-web {
    server localhost:5000;
}

server {
    listen 80;
    server_name archive.company.com;

    location / {
        proxy_pass http://dbarchive-web;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
    }

    location /api/ {
        proxy_pass http://dbarchive-api;
        proxy_set_header Host $host;
    }
}
```

---

### 10. 故障排查

#### 常见问题

| 问题 | 原因 | 解决方案 |
|------|------|---------|
| **SQL Server 容器启动失败** | 密码不符合复杂度要求 | 修改 `SA_PASSWORD` 为强密码 |
| **API 无法连接数据库** | 容器未就绪 | 等待 SQL Server 健康检查通过 |
| **端口冲突** | 宿主机端口被占用 | 修改端口映射或停止占用进程 |
| **容器磁盘空间不足** | Docker 数据目录满 | 清理未使用镜像/卷 |
| **BCP 工具找不到** | Dockerfile 未安装 | 已在 API Dockerfile 中配置 |

#### 诊断命令

```powershell
# 查看容器日志（最后 100 行）
docker-compose logs --tail=100 api

# 查看特定时间范围日志
docker-compose logs --since="2025-11-14T10:00:00" api

# 实时跟踪日志
docker-compose logs -f --tail=50 api

# 检查容器资源使用
docker stats --no-stream

# 进入容器调试
docker exec -it dbarchive-api bash

# 容器内测试网络
docker exec dbarchive-api curl http://sqlserver:1433
docker exec dbarchive-api ping sqlserver

# 检查环境变量
docker exec dbarchive-api env | Select-String "ASPNETCORE"

# 验证 BCP 工具
docker exec dbarchive-api bcp -v
```

---

### 11. 生产部署最佳实践

#### ✅ 安全建议

1. **修改默认密码**
   ```yaml
   environment:
     - SA_PASSWORD=${SQL_SA_PASSWORD}  # 从环境变量读取
   ```

2. **使用 Docker Secrets（Swarm 模式）**
   ```yaml
   secrets:
     - db_password
   environment:
     - SA_PASSWORD_FILE=/run/secrets/db_password
   ```

3. **限制容器权限**
   ```yaml
   security_opt:
     - no-new-privileges:true
   read_only: true  # 只读文件系统
   ```

4. **网络隔离**
   ```yaml
   networks:
     frontend:
     backend:
   ```

#### ✅ 性能优化

1. **资源限制**
   ```yaml
   deploy:
     resources:
       limits:
         cpus: '4'
         memory: 4G
       reservations:
         cpus: '2'
         memory: 2G
   ```

2. **日志轮转**
   ```yaml
   logging:
     driver: "json-file"
     options:
       max-size: "10m"
       max-file: "3"
   ```

3. **使用本地卷**
   ```yaml
   volumes:
     - type: volume
       source: sqlserver-data
       target: /var/opt/mssql
       volume:
         nocopy: true
   ```

#### ✅ 备份策略

```powershell
# 自动化备份脚本
$backupScript = @"
`$timestamp = Get-Date -Format 'yyyyMMdd_HHmmss'

# 备份数据库
docker exec dbarchive-sqlserver /opt/mssql-tools/bin/sqlcmd ``
    -S localhost -U sa -P 'Archive@Pass123!' ``
    -Q "BACKUP DATABASE [DbArchiveTool] TO DISK = '/var/opt/mssql/backup/DbArchiveTool_`$timestamp.bak'"

# 备份数据卷
docker run --rm ``
    -v dbarchive-sqlserver-data:/source ``
    -v C:\Backups:/backup ``
    alpine tar czf /backup/volumes_`$timestamp.tar.gz -C /source .

Write-Host "备份完成: `$timestamp"
"@

# 配置定时任务（每天 2:00）
$action = New-ScheduledTaskAction -Execute "PowerShell.exe" -Argument "-File C:\Scripts\docker-backup.ps1"
$trigger = New-ScheduledTaskTrigger -Daily -At 2am
Register-ScheduledTask -TaskName "DbArchive-Docker-Backup" -Action $action -Trigger $trigger
```

---

### 12. Kubernetes 部署（高级）

#### 生成 Kubernetes 清单

```powershell
# 使用 Kompose 将 docker-compose.yml 转换为 Kubernetes
# 安装: choco install kubernetes-kompose

kompose convert -f docker-compose.yml -o k8s/

# 生成文件：
# - api-deployment.yaml
# - web-deployment.yaml
# - sqlserver-deployment.yaml
# - services.yaml
# - persistent-volume-claims.yaml
```

#### 部署到 Kubernetes

```bash
# 创建命名空间
kubectl create namespace dbarchive

# 部署应用
kubectl apply -f k8s/ -n dbarchive

# 查看部署状态
kubectl get all -n dbarchive

# 暴露服务
kubectl expose deployment dbarchive-web --type=LoadBalancer --port=80 -n dbarchive
```

---

### 13. Docker 部署总结

#### 🎯 优势

| 特性 | 说明 |
|------|------|
| **快速部署** | 一键启动完整环境 |
| **环境一致性** | 开发、测试、生产环境完全一致 |
| **易于扩展** | 横向扩展 API 服务实例 |
| **版本管理** | 镜像标签管理版本 |
| **资源隔离** | 容器间资源隔离，互不影响 |
| **跨平台** | Windows、Linux、macOS 通用 |

#### 📊 性能对比

| 部署方式 | 启动时间 | 资源占用 | 维护复杂度 |
|---------|---------|---------|-----------|
| **Docker** | 1-2 分钟 | 中等（容器开销） | 低 |
| **Windows 服务** | 10-30 秒 | 低 | 中 |
| **IIS** | 5-15 秒 | 低 | 高 |

#### 🚀 推荐场景

- ✅ **开发环境**：本地快速搭建
- ✅ **测试环境**：CI/CD 集成
- ✅ **演示环境**：快速部署展示
- ✅ **容器化生产**：Kubernetes、Docker Swarm
- ⚠️ **传统生产**：推荐 Windows 服务或 IIS

---

## Windows 服务部署

### 1. 安装 Windows Service 工具

```powershell
# 使用 NSSM (Non-Sucking Service Manager) - 推荐
# 下载：https://nssm.cc/download

# 或使用内置 sc 命令
```

### 2. 配置 API 服务

```powershell
# 使用 NSSM 安装服务
$nssmPath = "C:\Tools\nssm\win64\nssm.exe"

# 安装 API 服务
& $nssmPath install DbArchiveTool.Api `
    "C:\Program Files\dotnet\dotnet.exe" `
    "C:\Applications\DbArchiveTool\Api\DbArchiveTool.Api.dll"

# 配置服务参数
& $nssmPath set DbArchiveTool.Api AppDirectory "C:\Applications\DbArchiveTool\Api"
& $nssmPath set DbArchiveTool.Api AppEnvironmentExtra "ASPNETCORE_ENVIRONMENT=Production"
& $nssmPath set DbArchiveTool.Api DisplayName "数据归档工具 - API 服务"
& $nssmPath set DbArchiveTool.Api Description "数据归档工具 REST API 服务，提供归档管理和任务调度功能"
& $nssmPath set DbArchiveTool.Api Start SERVICE_AUTO_START
& $nssmm set DbArchiveTool.Api ObjectName "LocalSystem"

# 配置日志
& $nssmPath set DbArchiveTool.Api AppStdout "C:\Applications\DbArchiveTool\Logs\api-stdout.log"
& $nssmPath set DbArchiveTool.Api AppStderr "C:\Applications\DbArchiveTool\Logs\api-stderr.log"
& $nssmPath set DbArchiveTool.Api AppRotateFiles 1
& $nssmPath set DbArchiveTool.Api AppRotateBytes 10485760

# 配置故障恢复
& $nssmPath set DbArchiveTool.Api AppExit Default Restart
& $nssmPath set DbArchiveTool.Api AppRestartDelay 5000

# 启动服务
Start-Service -Name "DbArchiveTool.Api"

# 验证服务状态
Get-Service -Name "DbArchiveTool.Api"
```

### 3. 配置 Web 服务

```powershell
# 安装 Web 服务
& $nssmPath install DbArchiveTool.Web `
    "C:\Program Files\dotnet\dotnet.exe" `
    "C:\Applications\DbArchiveTool\Web\DbArchiveTool.Web.dll"

# 配置服务参数
& $nssmPath set DbArchiveTool.Web AppDirectory "C:\Applications\DbArchiveTool\Web"
& $nssmPath set DbArchiveTool.Web AppEnvironmentExtra "ASPNETCORE_ENVIRONMENT=Production"
& $nssmPath set DbArchiveTool.Web DisplayName "数据归档工具 - Web 界面"
& $nssmPath set DbArchiveTool.Web Description "数据归档工具 Blazor Web 界面"
& $nssmPath set DbArchiveTool.Web Start SERVICE_AUTO_START
& $nssmPath set DbArchiveTool.Web ObjectName "LocalSystem"

# 配置日志
& $nssmPath set DbArchiveTool.Web AppStdout "C:\Applications\DbArchiveTool\Logs\web-stdout.log"
& $nssmPath set DbArchiveTool.Web AppStderr "C:\Applications\DbArchiveTool\Logs\web-stderr.log"
& $nssmPath set DbArchiveTool.Web AppRotateFiles 1
& $nssmPath set DbArchiveTool.Web AppRotateBytes 10485760

# 启动服务
Start-Service -Name "DbArchiveTool.Web"

# 验证服务状态
Get-Service -Name "DbArchiveTool.Web"
```

### 4. 服务管理命令

```powershell
# 查看服务状态
Get-Service -Name "DbArchiveTool.*"

# 启动服务
Start-Service -Name "DbArchiveTool.Api"
Start-Service -Name "DbArchiveTool.Web"

# 停止服务
Stop-Service -Name "DbArchiveTool.Api"
Stop-Service -Name "DbArchiveTool.Web"

# 重启服务
Restart-Service -Name "DbArchiveTool.Api"
Restart-Service -Name "DbArchiveTool.Web"

# 查看服务日志
Get-Content "C:\Applications\DbArchiveTool\Logs\api-*.log" -Tail 50
Get-Content "C:\Applications\DbArchiveTool\Logs\web-*.log" -Tail 50

# 卸载服务（如需要）
& $nssmPath remove DbArchiveTool.Api confirm
& $nssmPath remove DbArchiveTool.Web confirm
```

---

## IIS 部署方案

### 1. 启用 IIS 功能

```powershell
# 安装 IIS 和必要组件
Install-WindowsFeature -Name Web-Server -IncludeManagementTools
Install-WindowsFeature -Name Web-WebSockets
Install-WindowsFeature -Name Web-Asp-Net45

# 安装 ASP.NET Core Hosting Bundle（如未安装）
# 下载：https://dotnet.microsoft.com/download/dotnet/8.0
# 安装后执行：
iisreset
```

### 2. 创建应用程序池

```powershell
# 导入 IIS 模块
Import-Module WebAdministration

# 创建 API 应用程序池
New-WebAppPool -Name "DbArchiveTool.Api"
Set-ItemProperty "IIS:\AppPools\DbArchiveTool.Api" -Name managedRuntimeVersion -Value ""
Set-ItemProperty "IIS:\AppPools\DbArchiveTool.Api" -Name startMode -Value "AlwaysRunning"
Set-ItemProperty "IIS:\AppPools\DbArchiveTool.Api" -Name processModel.idleTimeout -Value "00:00:00"

# 创建 Web 应用程序池
New-WebAppPool -Name "DbArchiveTool.Web"
Set-ItemProperty "IIS:\AppPools\DbArchiveTool.Web" -Name managedRuntimeVersion -Value ""
Set-ItemProperty "IIS:\AppPools\DbArchiveTool.Web" -Name startMode -Value "AlwaysRunning"
```

### 3. 创建 IIS 站点

```powershell
# 创建 API 站点
New-Website -Name "DbArchiveTool.Api" `
    -ApplicationPool "DbArchiveTool.Api" `
    -PhysicalPath "C:\Applications\DbArchiveTool\Api" `
    -Port 5001 `
    -Ssl

# 创建 Web 站点
New-Website -Name "DbArchiveTool.Web" `
    -ApplicationPool "DbArchiveTool.Web" `
    -PhysicalPath "C:\Applications\DbArchiveTool\Web" `
    -Port 5000

# 配置 HTTPS 绑定（需要证书）
# 导入证书到 LocalMachine\My
$cert = Import-PfxCertificate -FilePath "C:\Certificates\archive-api.pfx" `
    -CertStoreLocation Cert:\LocalMachine\My `
    -Password (ConvertTo-SecureString "CertPassword" -AsPlainText -Force)

# 绑定证书到站点
New-WebBinding -Name "DbArchiveTool.Api" -Protocol https -Port 5001
Get-ChildItem -Path "IIS:\SslBindings\0.0.0.0!5001" | Remove-Item
New-Item -Path "IIS:\SslBindings\0.0.0.0!5001" -Value $cert
```

### 4. 配置 web.config

**API 站点 web.config：**

```xml
<?xml version="1.0" encoding="utf-8"?>
<configuration>
  <location path="." inheritInChildApplications="false">
    <system.webServer>
      <handlers>
        <add name="aspNetCore" path="*" verb="*" modules="AspNetCoreModuleV2" resourceType="Unspecified" />
      </handlers>
      <aspNetCore processPath="dotnet" 
                  arguments=".\DbArchiveTool.Api.dll" 
                  stdoutLogEnabled="true" 
                  stdoutLogFile=".\logs\stdout" 
                  hostingModel="inprocess">
        <environmentVariables>
          <environmentVariable name="ASPNETCORE_ENVIRONMENT" value="Production" />
          <environmentVariable name="SQLSERVER_ALWAYSON_MODE" value="true" />
        </environmentVariables>
      </aspNetCore>
      <security>
        <requestFiltering>
          <requestLimits maxAllowedContentLength="524288000" />
        </requestFiltering>
      </security>
    </system.webServer>
  </location>
</configuration>
```

### 5. 重启 IIS

```powershell
iisreset
```

---

## 健康检查与监控

### 1. API 健康检查端点

```powershell
# 测试 API 是否运行
Invoke-RestMethod -Uri "https://localhost:5001/api/v1/health" -Method Get

# 测试数据库连接
Invoke-RestMethod -Uri "https://localhost:5001/api/v1/health/database" -Method Get

# 查看 Swagger 文档
Start-Process "https://localhost:5001/swagger"
```

### 2. Hangfire Dashboard 监控

```powershell
# 访问 Hangfire 监控面板
Start-Process "https://localhost:5001/hangfire"

# 监控任务状态
# - Succeeded: 成功任务数
# - Failed: 失败任务数
# - Processing: 正在执行的任务
# - Scheduled: 计划中的任务
```

### 3. 配置性能计数器

```powershell
# 创建性能监控脚本
$monitorScript = @"
`$apiProcess = Get-Process -Name "dotnet" | Where-Object { `$_.Path -like "*DbArchiveTool.Api*" }
`$webProcess = Get-Process -Name "dotnet" | Where-Object { `$_.Path -like "*DbArchiveTool.Web*" }

Write-Host "API 进程:"
Write-Host "  CPU: `$(`$apiProcess.CPU) 秒"
Write-Host "  内存: `$([math]::Round(`$apiProcess.WorkingSet64 / 1MB, 2)) MB"
Write-Host "  线程: `$(`$apiProcess.Threads.Count)"

Write-Host "`nWeb 进程:"
Write-Host "  CPU: `$(`$webProcess.CPU) 秒"
Write-Host "  内存: `$([math]::Round(`$webProcess.WorkingSet64 / 1MB, 2)) MB"
Write-Host "  线程: `$(`$webProcess.Threads.Count)"
"@

$monitorScript | Out-File -FilePath "C:\Applications\DbArchiveTool\Scripts\Monitor.ps1"

# 运行监控
& "C:\Applications\DbArchiveTool\Scripts\Monitor.ps1"
```

### 4. 日志监控

```powershell
# 实时查看 API 日志
Get-Content "C:\Applications\DbArchiveTool\Logs\api-*.log" -Wait -Tail 20

# 查找错误日志
Select-String -Path "C:\Applications\DbArchiveTool\Logs\*.log" -Pattern "Error|Exception" -Context 2,5

# 统计错误数量
(Select-String -Path "C:\Applications\DbArchiveTool\Logs\api-*.log" -Pattern "Error").Count
```

---

## 安全加固

### 1. SSL/TLS 证书配置

```powershell
# 生成自签名证书（测试环境）
$cert = New-SelfSignedCertificate `
    -DnsName "archive.company.com" `
    -CertStoreLocation "Cert:\LocalMachine\My" `
    -KeyExportPolicy Exportable `
    -KeySpec Signature `
    -KeyLength 2048 `
    -KeyAlgorithm RSA `
    -HashAlgorithm SHA256 `
    -NotAfter (Get-Date).AddYears(2)

# 导出为 PFX（用于 Kestrel）
$password = ConvertTo-SecureString "CertPassword" -AsPlainText -Force
Export-PfxCertificate -Cert $cert -FilePath "C:\Certificates\archive-api.pfx" -Password $password

# 生产环境：使用受信任的证书颁发机构（CA）颁发的证书
# - Let's Encrypt（免费）
# - DigiCert、GlobalSign 等商业 CA
```

### 2. 防火墙规则

```powershell
# 仅允许内网访问（如果不对外开放）
New-NetFirewallRule -DisplayName "DbArchiveTool API - Internal" `
    -Direction Inbound `
    -Protocol TCP `
    -LocalPort 5001 `
    -RemoteAddress 10.0.0.0/8,172.16.0.0/12,192.168.0.0/16 `
    -Action Allow

# 阻止外网直接访问
New-NetFirewallRule -DisplayName "DbArchiveTool API - Block External" `
    -Direction Inbound `
    -Protocol TCP `
    -LocalPort 5001 `
    -Action Block `
    -Priority 100
```

### 3. 敏感信息保护

```powershell
# 使用 Windows DPAPI 加密配置文件
# 修改 appsettings.Production.json，使用加密的连接字符串

# 或使用 Azure Key Vault / AWS Secrets Manager
```

### 4. Hangfire Dashboard 授权

编辑 `HangfireAuthorizationFilter.cs`：

```csharp
public class HangfireAuthorizationFilter : IDashboardAuthorizationFilter
{
    public bool Authorize(DashboardContext context)
    {
        var httpContext = context.GetHttpContext();
        
        // 生产环境：集成 Windows 身份验证或 Token 验证
        // return httpContext.User.Identity?.IsAuthenticated ?? false;
        
        // 或限制 IP 地址
        var remoteIp = httpContext.Connection.RemoteIpAddress?.ToString();
        var allowedIps = new[] { "10.0.0.10", "192.168.1.100" };
        return allowedIps.Contains(remoteIp);
    }
}
```

---

## 故障排查

### 1. 常见问题

| 问题 | 原因 | 解决方案 |
|------|------|---------|
| **服务无法启动** | 端口被占用 | `netstat -ano \| findstr 5001`，结束占用进程 |
| **数据库连接失败** | 连接字符串错误 / 权限不足 | 检查连接字符串，验证数据库用户权限 |
| **Hangfire 初始化失败** | 数据库迁移未完成 | 手动执行 `dotnet ef database update` |
| **归档任务卡住** | Always On 延迟 / 锁冲突 | 检查辅助副本延迟，查看 `sys.dm_tran_locks` |
| **内存溢出** | BulkCopy 批次太大 | 调整 `BulkCopyBatchSize` 参数 |
| **临时表未清理** | 任务异常中断 | 手动运行 `快速清理临时表.sql` |

### 2. 诊断命令

```powershell
# 检查服务状态
Get-Service -Name "DbArchiveTool.*"

# 检查进程
Get-Process -Name "dotnet" | Where-Object { $_.Path -like "*DbArchiveTool*" }

# 检查端口监听
netstat -ano | findstr "5000 5001"

# 检查事件日志
Get-EventLog -LogName Application -Source ".NET Runtime" -Newest 20

# 测试数据库连接
Test-NetConnection -ComputerName PROD_SQL_SERVER -Port 1433

# 查看最近的错误日志
Get-ChildItem "C:\Applications\DbArchiveTool\Logs\*.log" | 
    ForEach-Object { Select-String -Path $_.FullName -Pattern "Error|Exception" } | 
    Select-Object -Last 10
```

### 3. 性能分析

```powershell
# 使用 dotnet-trace 工具
dotnet tool install --global dotnet-trace

# 收集性能跟踪（30秒）
$apiPid = (Get-Process -Name "dotnet" | Where-Object { $_.Path -like "*DbArchiveTool.Api*" }).Id
dotnet-trace collect --process-id $apiPid --duration 00:00:30 --output api-trace.nettrace

# 使用 PerfView 分析（Windows）
# 下载：https://github.com/microsoft/perfview
```

---

## 回滚方案

### 1. 快速回滚步骤

```powershell
# 停止服务
Stop-Service -Name "DbArchiveTool.Api"
Stop-Service -Name "DbArchiveTool.Web"

# 查找最近的备份
$latestBackup = Get-ChildItem "C:\Applications\DbArchiveTool\Backups\Api_*.zip" | 
    Sort-Object LastWriteTime -Descending | 
    Select-Object -First 1

Write-Host "回滚到版本: $($latestBackup.Name)"

# 删除当前版本
Remove-Item "C:\Applications\DbArchiveTool\Api\*" -Recurse -Force

# 还原备份
Expand-Archive -Path $latestBackup.FullName -DestinationPath "C:\Applications\DbArchiveTool\Api"

# 重启服务
Start-Service -Name "DbArchiveTool.Api"
Start-Service -Name "DbArchiveTool.Web"

# 验证
Invoke-RestMethod -Uri "https://localhost:5001/api/v1/health"
```

### 2. 数据库回滚

```sql
-- 如果数据库迁移导致问题，回滚到上一个迁移
-- 在开发机器上执行：
-- dotnet ef migrations list --project src/DbArchiveTool.Infrastructure --startup-project src/DbArchiveTool.Api

-- 回滚到指定迁移
-- dotnet ef database update <PreviousMigrationName> --project src/DbArchiveTool.Infrastructure --startup-project src/DbArchiveTool.Api

-- 或使用数据库备份还原
RESTORE DATABASE [DbArchiveTool]
FROM DISK = 'D:\Backups\DbArchiveTool_BeforeDeployment.bak'
WITH REPLACE;
```

---

## 部署后验证清单

### ✅ 功能验证

- [ ] API 服务启动成功（`https://localhost:5001/swagger`）
- [ ] Web 界面可访问（`http://localhost:5000`）
- [ ] 管理员登录成功
- [ ] 数据源连接测试通过
- [ ] Hangfire Dashboard 可访问（`https://localhost:5001/hangfire`）
- [ ] 创建测试归档任务成功
- [ ] 任务日志正常记录
- [ ] BCP/BulkCopy 归档功能正常

### ✅ 性能验证

- [ ] API 响应时间 < 200ms（空载）
- [ ] 内存占用 < 2GB（空载）
- [ ] CPU 占用 < 20%（空载）
- [ ] 归档任务吞吐量 > 10,000 行/秒

### ✅ 安全验证

- [ ] HTTPS 证书有效
- [ ] 数据库连接加密
- [ ] 敏感配置已加密
- [ ] Hangfire Dashboard 需授权访问
- [ ] 防火墙规则生效

### ✅ 监控验证

- [ ] 服务日志正常输出
- [ ] Windows 事件日志无错误
- [ ] Hangfire 任务统计正常
- [ ] 性能计数器可用

---

## 维护计划

### 日常维护

```powershell
# 每日健康检查脚本
$healthCheck = @"
# 检查服务状态
`$services = Get-Service -Name "DbArchiveTool.*"
`$services | ForEach-Object {
    if (`$_.Status -ne 'Running') {
        Write-Warning "`$(`$_.Name) 服务未运行!"
        Start-Service `$_.Name
    }
}

# 检查磁盘空间
`$drive = Get-PSDrive -Name C
if (`$drive.Free -lt 20GB) {
    Write-Warning "磁盘空间不足: `$([math]::Round(`$drive.Free / 1GB, 2)) GB"
}

# 检查日志大小
`$logSize = (Get-ChildItem "C:\Applications\DbArchiveTool\Logs" -Recurse | Measure-Object -Property Length -Sum).Sum / 1MB
if (`$logSize -gt 1024) {
    Write-Warning "日志文件过大: `$([math]::Round(`$logSize, 2)) MB，建议清理"
}

# 检查临时表
# ... (查询数据库是否有孤儿临时表)

Write-Host "健康检查完成: `$(Get-Date)"
"@

$healthCheck | Out-File "C:\Applications\DbArchiveTool\Scripts\DailyHealthCheck.ps1"

# 配置计划任务（每天 8:00 执行）
$action = New-ScheduledTaskAction -Execute "PowerShell.exe" `
    -Argument "-File C:\Applications\DbArchiveTool\Scripts\DailyHealthCheck.ps1"
$trigger = New-ScheduledTaskTrigger -Daily -At 8am
Register-ScheduledTask -TaskName "DbArchiveTool-HealthCheck" -Action $action -Trigger $trigger
```

### 定期维护

- **每周**：检查归档任务成功率，清理旧日志文件
- **每月**：数据库备份，索引重建，统计信息更新
- **每季度**：性能评估，容量规划，安全审计

---

## 联系与支持

- **技术文档**：`DBManageTool/Docs/`
- **问题报告**：GitHub Issues
- **紧急联系**：[系统管理员联系方式]

---

**部署指南版本**：v1.0  
**最后更新**：2025-11-14  
**适用版本**：DbArchiveTool 1.0+
