# 数据归档工具已知问题与限制汇总

> **更新日期**：2025-11-04  
> **版本**：v1.0  
> **状态**：已测试并识别

---

## 📌 问题概览

| 问题ID | 问题描述 | 严重程度 | 影响范围 | 状态 | 解决方案 |
|--------|----------|----------|----------|------|----------|
| ISSUE-001 | 已有分区方案名称不一致 | 🟡 中 | 非工具创建的分区 | 已识别 | 见下文详细说明 |
| ISSUE-002 | 索引未对齐到分区方案 | 🟡 中 | 非工具创建的分区 | 已识别 | 见下文详细说明 |
| ISSUE-003 | 约束定义不匹配 | 🟢 低 | 非工具创建的分区 | 已识别 | 见下文详细说明 |
| ISSUE-004 | 目标表残留数据处理 | 🟡 中 | 所有归档操作 | 已解决 | 已改为阻断模式 |

---

## 🔴 ISSUE-001：已有分区方案名称不一致

### 问题描述
非工具创建的分区表，其分区方案名称可能与工具预期不一致，导致预检失败。

### 问题原因
- 工具创建分区时使用规范化命名：`PS_{TableName}` 或用户自定义
- 已有分区可能使用其他命名规则，如：`ps_archive_*`、`PartitionScheme1` 等

### 影响范围
- 预检阶段识别为 **Blocker**
- 阻止归档执行
- 需手动调整后才能继续

### 重现步骤
1. 已有分区表使用非工具创建的分区方案
2. 尝试使用工具进行归档
3. 预检失败，提示"分区方案不一致"

### 解决方案

#### 方案1：重建分区方案（推荐）
```sql
-- 1. 备份数据
-- 2. 删除旧分区方案和函数
-- 3. 使用工具重新创建分区配置
-- 4. 重新导入数据
```

#### 方案2：修改工具配置（灵活）
- 在分区配置中指定实际的分区方案名称
- 工具读取实际方案进行对齐检查
- **注意**：需确保其他对象（索引、约束）也对齐

#### 方案3：手动对齐（临时）
```sql
-- 查询现有分区方案
SELECT 
    ps.name AS PartitionSchemeName,
    pf.name AS PartitionFunctionName,
    t.name AS TableName
FROM sys.partition_schemes ps
INNER JOIN sys.partition_functions pf ON ps.function_id = pf.function_id
INNER JOIN sys.indexes i ON ps.data_space_id = i.data_space_id
INNER JOIN sys.tables t ON i.object_id = t.object_id
WHERE t.name = 'YourTableName';

-- 根据查询结果，在工具中手动指定正确的方案名称
```

### 预防措施
- 建议使用工具创建所有新分区
- 已有分区逐步迁移到工具管理

### 相关文档
- 用户操作手册 > 已有分区对齐指南
- FAQ > Q12: 分区方案名称不一致如何处理？

---

## 🟡 ISSUE-002：索引未对齐到分区方案

### 问题描述
分区表的某些索引未对齐到分区方案，导致分区切换失败。

### 问题原因
SQL Server 分区切换要求：
- **所有索引必须对齐到分区方案**
- 索引键列必须包含分区列
- 源表和目标表索引定义必须一致

已有分区可能存在：
- 索引创建在文件组上而非分区方案上
- 索引键列不包含分区列
- 非聚集索引未对齐

### 影响范围
- 预检阶段识别为 **Blocker** 或 **AutoFix**
- 如能自动修复，工具会重建索引
- 如无法自动修复，需手动处理

### 重现步骤
1. 已有分区表存在未对齐的索引
2. 尝试使用工具进行归档
3. 预检失败或提示自动补齐

### 解决方案

#### 方案1：使用工具自动补齐（推荐）
- 预检结果中勾选"同步索引"选项
- 工具自动删除并重建未对齐的索引
- **注意**：需确认索引重建对业务影响

#### 方案2：手动重建索引
```sql
-- 1. 查询未对齐的索引
SELECT 
    i.name AS IndexName,
    t.name AS TableName,
    ds.name AS DataSpaceName,
    ds.type_desc AS DataSpaceType
FROM sys.indexes i
INNER JOIN sys.tables t ON i.object_id = t.object_id
INNER JOIN sys.data_spaces ds ON i.data_space_id = ds.data_space_id
WHERE t.name = 'YourTableName'
  AND i.type > 0  -- 排除堆
  AND ds.type_desc <> 'PARTITION_SCHEME';  -- 未对齐到分区方案

-- 2. 删除未对齐的索引
DROP INDEX [IndexName] ON [Schema].[TableName];

-- 3. 重建索引（包含分区列）
CREATE NONCLUSTERED INDEX [IndexName]
ON [Schema].[TableName] ([Column1], [Column2], [PartitionColumn])  -- 必须包含分区列
ON [PartitionSchemeName]([PartitionColumn]);
```

#### 诊断脚本
```sql
-- 检查索引对齐状态
EXEC sp_helpindex 'Schema.TableName';

-- 查询分区列
SELECT 
    c.name AS PartitionColumn,
    pf.name AS PartitionFunction,
    ps.name AS PartitionScheme
FROM sys.indexes i
INNER JOIN sys.partition_schemes ps ON i.data_space_id = ps.data_space_id
INNER JOIN sys.partition_functions pf ON ps.function_id = pf.function_id
INNER JOIN sys.index_columns ic ON i.object_id = ic.object_id AND i.index_id = ic.index_id
INNER JOIN sys.columns c ON ic.object_id = c.object_id AND ic.column_id = c.column_id
WHERE i.object_id = OBJECT_ID('Schema.TableName')
  AND ic.partition_ordinal = 1;
```

### 预防措施
- 创建索引时始终使用分区方案
- 确保索引键列包含分区列
- 定期检查索引对齐状态

### 相关文档
- 用户操作手册 > 索引对齐问题处理
- FAQ > Q15: 索引未对齐如何重建？

---

## 🟢 ISSUE-003：约束定义不匹配

### 问题描述
源表和目标表的约束定义不一致，导致分区切换失败。

### 问题原因
SQL Server 分区切换要求：
- CHECK 约束定义必须完全一致
- DEFAULT 约束可以不同（但建议一致）
- FOREIGN KEY 约束不能存在于目标表上

### 影响范围
- 预检阶段识别为 **Blocker** 或 **AutoFix**
- CHECK 约束不一致通常为 Blocker
- 如能自动修复，工具会同步约束

### 重现步骤
1. 源表和目标表 CHECK 约束不一致
2. 尝试使用工具进行归档
3. 预检失败或提示自动补齐

### 解决方案

#### 方案1：使用工具自动补齐（推荐）
- 预检结果中勾选"同步约束"选项
- 工具自动创建缺失的约束

#### 方案2：手动同步约束
```sql
-- 1. 查询源表约束
SELECT 
    cc.name AS ConstraintName,
    cc.definition AS ConstraintDefinition,
    c.name AS ColumnName
FROM sys.check_constraints cc
LEFT JOIN sys.columns c ON cc.parent_object_id = c.object_id AND cc.parent_column_id = c.column_id
WHERE cc.parent_object_id = OBJECT_ID('Schema.SourceTable');

-- 2. 在目标表创建相同约束
ALTER TABLE [Schema].[TargetTable]
ADD CONSTRAINT [CK_TargetTable_ColumnName]
CHECK ([ColumnName] >= 0);

-- 3. 查询 DEFAULT 约束
SELECT 
    dc.name AS ConstraintName,
    dc.definition AS DefaultDefinition,
    c.name AS ColumnName
FROM sys.default_constraints dc
INNER JOIN sys.columns c ON dc.parent_object_id = c.object_id AND dc.parent_column_id = c.column_id
WHERE dc.parent_object_id = OBJECT_ID('Schema.SourceTable');

-- 4. 在目标表创建相同 DEFAULT 约束
ALTER TABLE [Schema].[TargetTable]
ADD CONSTRAINT [DF_TargetTable_ColumnName]
DEFAULT (0) FOR [ColumnName];
```

### 预防措施
- 使用工具创建目标表（自动同步约束）
- 定期检查约束一致性

### 相关文档
- 用户操作手册 > 约束不匹配问题处理
- FAQ > Q18: CHECK 约束不一致如何处理？

---

## 🟢 ISSUE-004：目标表残留数据处理（已解决）

### 问题描述
目标分区存在残留数据，导致分区切换失败。

### 问题原因
SQL Server 分区切换要求：
- 目标分区必须为空
- 不能有任何数据行

### 影响范围
- 预检阶段识别为 **AutoFix**
- **已改为阻断模式**：检测到数据时不自动清空，而是阻止执行

### 解决方案

#### 当前处理（2025-11-04 增强）
1. 预检检测到残留数据
2. 自动补齐步骤返回失败（`Succeeded=false`）
3. 提供手动清空脚本：
```sql
-- 手动清空目标表分区的残留数据
SET XACT_ABORT ON;
BEGIN TRANSACTION;
    TRUNCATE TABLE [Schema].[TargetTable]
    WITH (PARTITIONS (<partition_number>));
COMMIT TRANSACTION;
```
4. 用户确认并手动执行脚本
5. 重新执行归档

#### 手动处理步骤
1. 查询残留数据
```sql
-- 查询目标分区行数
SELECT 
    p.partition_number,
    p.rows
FROM sys.partitions p
INNER JOIN sys.tables t ON p.object_id = t.object_id
INNER JOIN sys.schemas s ON t.schema_id = s.schema_id
WHERE s.name = 'Schema'
  AND t.name = 'TargetTable'
  AND p.index_id IN (0, 1)
  AND p.partition_number = <partition_number>;
```

2. 确认数据可以删除（重要！）
3. 执行清空脚本
4. 重新执行归档

### 设计理由
- **安全优先**：防止误删除业务数据
- **用户确认**：强制用户检查残留数据来源
- **可追溯**：手动脚本留下审计记录

### 相关文档
- 用户操作手册 > 目标表残留数据处理流程
- FAQ > Q20: 检测到残留数据如何处理？

---

## 📋 测试状态汇总

### ✅ 已测试场景
1. **工具创建分区 → 归档**：✅ 测试通过
2. **批量归档**：✅ 测试通过
3. **目标表为空**：✅ 测试通过
4. **自动补齐（索引）**：✅ 测试通过
5. **残留数据检测**：✅ 测试通过（阻断模式）

### ⏳ 待测试场景
1. **已有分区 + 方案不一致**：⏳ 待补充测试
2. **已有分区 + 索引未对齐**：⏳ 待补充测试
3. **已有分区 + 约束不匹配**：⏳ 待补充测试
4. **大数据量归档（> 100万行）**：⏳ 待性能测试
5. **并发归档**：⏳ 待压力测试

---

## 🔧 诊断工具规划

### 即将开发的诊断脚本
1. **分区方案对齐检查脚本**
   - 输入：表名
   - 输出：分区方案差异报告

2. **索引对齐状态检查脚本**
   - 输入：表名
   - 输出：未对齐索引列表 + 修复建议

3. **约束一致性检查脚本**
   - 输入：源表名、目标表名
   - 输出：约束差异报告

4. **综合诊断脚本**
   - 输入：表名
   - 输出：完整的对齐问题报告

---

## 📚 相关资源

### 官方文档
- [SQL Server 分区表和索引](https://learn.microsoft.com/zh-cn/sql/relational-databases/partitions/partitioned-tables-and-indexes)
- [ALTER TABLE...SWITCH](https://learn.microsoft.com/zh-cn/sql/t-sql/statements/alter-table-transact-sql)

### 内部文档
- 用户操作手册（待编写）
- FAQ 与故障处理指南（待编写）
- 诊断脚本使用说明（待编写）

---

## 📝 反馈与建议

如发现新问题或有改进建议，请：
1. 提交 Issue 到项目仓库
2. 联系开发团队
3. 参考下阶段实施计划提供反馈

---

**维护人**：开发团队  
**最后更新**：2025-11-04
