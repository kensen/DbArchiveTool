# 开发规范与项目结构

> 版本: 1.0  
> 日期: 2025-09-29  
> 范围: 新数据库归档工具（服务端、前端、数据访问、部署）

---

## 1. 目标
提供统一、精简、可执行的开发规范，保障代码质量、可维护性与快速迭代能力。

---

## 2. 解决方案总体目录结构
```
DbArchiveTool.sln
├── src/
│   ├── DbArchiveTool.Web/              # Blazor Server + Ant Design UI + API Gateway
│   ├── DbArchiveTool.Api/              # （可选）独立REST API（必要时拆分）
│   ├── DbArchiveTool.Application/      # 应用服务层（编排、DTO、命令、查询）
│   ├── DbArchiveTool.Domain/           # 领域模型（实体、值对象、领域服务、规约）
│   ├── DbArchiveTool.Infrastructure/   # 基础设施（EF、Dapper、仓储实现、外部服务）
│   └── DbArchiveTool.Shared/           # 通用工具、基础类型、Result模型
├── tests/
│   ├── DbArchiveTool.UnitTests/
│   ├── DbArchiveTool.IntegrationTests/
│   └── DbArchiveTool.E2ETests/
├── docs/
├── scripts/
├── docker/
└── build/
```

---

## 3. 命名规范
| 类型 | 规则 | 示例 |
|------|------|------|
| 解决方案 | PascalCase | DbArchiveTool.sln |
| 项目 | PascalCase | DbArchiveTool.Domain |
| 目录 | PascalCase | Services |
| 类 | PascalCase | ArchiveEngine |
| 接口 | I + PascalCase | IArchiveEngine |
| 方法 | PascalCase | ExecuteArchiveAsync |
| 变量 | camelCase | taskResult |
| 参数 | camelCase | connectionString |
| 常量 | PascalCase | DefaultTimeout |
| 枚举 | PascalCase | ArchiveStatus |
| 枚举值 | PascalCase | Pending |
| 配置节 | PascalCase | ArchiveSettings |
| 数据库表 | PascalCase / 语义化 | ArchiveTask |
| 数据库列 | PascalCase | CreatedAt |

---

## 4. 分层职责与依赖原则
| 层 | 只依赖 | 禁止依赖 | 职责核心 |
|----|--------|----------|----------|
| Web (Presentation) | Application, Shared | Domain, Infrastructure（除DTO映射） | UI交互、API、实时推送 |
| Application | Domain, Infrastructure(接口), Shared | 具体实现类 | 业务编排、事务边界、输入输出模型 |
| Domain | Shared | 任何上层 | 领域模型与规则（纯净） |
| Infrastructure | Domain, Shared | Web, Application | 外部技术实现（EF、Dapper、文件、缓存） |
| Tests | 所有 | - | 自动化质量保障 |

原则：
- Domain 不感知数据库实现。
- Application 不写原生SQL（除委派到 Dapper 执行服务接口）。
- Infrastructure 不做业务决策，只实现接口。
- DTO 和 Entity 分离，不泄漏内部结构。

---

## 5. 代码组织与模式
### 5.1 仓储模式
```csharp
public interface IRepository<T> where T : BaseEntity
{
    Task<T?> GetByIdAsync(Guid id);
    Task AddAsync(T entity);
    Task UpdateAsync(T entity);
    Task RemoveAsync(T entity);
    Task<IReadOnlyList<T>> ListAsync(ISpecification<T> spec);
}
```

### 5.2 规约（Specification）模式
```csharp
public interface ISpecification<T>
{
    Expression<Func<T, bool>> Criteria { get; }
    List<Expression<Func<T, object>>> Includes { get; }
}
```

### 5.3 Dapper 执行器模式
```csharp
public interface ISqlExecutor
{
    Task<int> ExecuteAsync(string connection, string sql, object? param = null, int? timeoutSeconds = null);
    Task<IEnumerable<T>> QueryAsync<T>(string connection, string sql, object? param = null, int? timeoutSeconds = null);
    Task<T?> QuerySingleAsync<T>(string connection, string sql, object? param = null);
}
```

### 5.4 结果返回模式（Result Pattern）
```csharp
public record Result(bool IsSuccess, string? Error)
{
    public static Result Success() => new(true, null);
    public static Result Failure(string error) => new(false, error);
}

public record Result<T>(bool IsSuccess, T? Value, string? Error)
{
    public static Result<T> Success(T value) => new(true, value, null);
    public static Result<T> Failure(string error) => new(false, default, error);
}
```

### 5.5 异常处理策略
| 场景 | 策略 |
|------|------|
| 业务可预期错误 | 使用 Result 返回 |
| 不可预期系统异常 | 捕获记录日志后抛出或统一中间件处理 |
| 数据一致性失败 | 事务回滚 + 记录差异 + 返回失败 |
| 重试类操作 | Polly 重试（指数退避） |

---

## 6. 数据库设计规范（工具自身元数据）
### 6.1 表命名
| 功能域 | 前缀 | 示例 | 说明 |
|--------|------|------|------|
| 数据源 | DataSource | DataSourceConnection | 数据源配置管理 |
| 归档配置 | ArchiveConfig | ArchiveConfiguration | 归档策略配置 |
| 归档任务 | ArchiveTask | ArchiveTask | 归档任务执行 |
| 分区明细 | ArchivePartition | ArchivePartitionDetail | 分区归档明细 |
| 执行日志 | ExecLog | ExecutionLog | 通用执行日志 |
| 调度任务 | Schedule | SchedulePlan | 自动调度配置 |
| 系统配置 | SystemConfig | SystemConfiguration | 系统级配置 |

### 6.2 公共字段
| 字段 | 类型 | 说明 | 必需 |
|------|------|------|------|
| Id | UNIQUEIDENTIFIER | 主键，使用 GUID | ✓ |
| CreatedAt | DATETIME2 | 创建时间 | ✓ |
| CreatedBy | NVARCHAR(64) | 创建人 | ✓ |
| UpdatedAt | DATETIME2 | 更新时间 | ✓ |
| UpdatedBy | NVARCHAR(64) | 更新人 | ✓ |
| IsDeleted | BIT | 软删除标记 | ✓ |
| Version | ROWVERSION | 并发控制 | 可选 |

### 6.3 旧工具兼容性字段设计
**原则**: 新表结构包含兼容性字段，支持数据迁移和双向同步

| 新表 | 兼容字段 | 对应旧表字段 | 用途 |
|------|----------|--------------|------|
| DataSource | LegacySourceConfigId | SourceConfigurationId | 标识来源配置 |
| ArchiveTask | LegacyOperationRecordId | ArchiveOperationRecordId | 关联旧操作记录 |
| ArchivePartitionDetail | LegacyDetailId | ArchivePartitionDetailId | 关联旧分区明细 |
| SystemConfiguration | LegacyMigrated | - | 标记已迁移配置 |

### 6.4 核心实体表结构示例

#### DataSource (数据源表)
```sql
CREATE TABLE [dbo].[DataSource](
    [Id] [uniqueidentifier] NOT NULL DEFAULT NEWID(),
    [Name] [nvarchar](100) NOT NULL,
    [Description] [nvarchar](500) NULL,
    [DatabaseType] [int] NOT NULL DEFAULT 1, -- 1:SqlServer, 2:MySQL, 3:Oracle
    [SourceConnectionJson] [nvarchar](max) NOT NULL, -- JSON格式连接配置
    [TargetConnectionJson] [nvarchar](max) NOT NULL,
    [IsActive] [bit] NOT NULL DEFAULT 1,
    [LastValidatedAt] [datetime2] NULL,
    
    -- 兼容性字段
    [LegacySourceConfigId] [char](12) NULL, -- 对应旧工具ID
    [LegacyOperationStatus] [int] NULL,     -- 保留旧工具状态
    
    -- 公共字段
    [CreatedAt] [datetime2] NOT NULL DEFAULT GETUTCDATE(),
    [CreatedBy] [nvarchar](64) NOT NULL DEFAULT SYSTEM_USER,
    [UpdatedAt] [datetime2] NOT NULL DEFAULT GETUTCDATE(),
    [UpdatedBy] [nvarchar](64) NOT NULL DEFAULT SYSTEM_USER,
    [IsDeleted] [bit] NOT NULL DEFAULT 0,
    [Version] [rowversion],
    
    CONSTRAINT [PK_DataSource] PRIMARY KEY ([Id]),
    CONSTRAINT [UK_DataSource_Name] UNIQUE ([Name]),
    CONSTRAINT [UK_DataSource_LegacyId] UNIQUE ([LegacySourceConfigId])
);
```

#### ArchiveConfiguration (归档配置表)
```sql
CREATE TABLE [dbo].[ArchiveConfiguration](
    [Id] [uniqueidentifier] NOT NULL DEFAULT NEWID(),
    [DataSourceId] [uniqueidentifier] NOT NULL,
    [SourceTableName] [nvarchar](128) NOT NULL,
    [TargetTableName] [nvarchar](128) NOT NULL,
    [PartitionColumnName] [nvarchar](128) NULL,
    [PartitionValues] [nvarchar](max) NULL, -- JSON格式
    [FileGroupMode] [int] NOT NULL DEFAULT 1,
    [FileSize] [int] NOT NULL DEFAULT 100, -- MB
    [FileGrowth] [int] NOT NULL DEFAULT 50, -- MB
    
    -- 自动归档配置
    [EnableAutoArchive] [bit] NOT NULL DEFAULT 0,
    [ArchiveDataType] [int] NULL, -- 1:指定分区, 2:相对时间  
    [AutoArchivePartitionValues] [nvarchar](2000) NULL,
    [RelativeDays] [int] NULL,
    [AutoArchiveTimeType] [int] NULL, -- 1:间隔, 2:天数
    [AutoArchiveTimeValue] [nvarchar](2000) NULL,
    
    [Remark] [nvarchar](max) NULL,
    
    -- 公共字段  
    [CreatedAt] [datetime2] NOT NULL DEFAULT GETUTCDATE(),
    [CreatedBy] [nvarchar](64) NOT NULL DEFAULT SYSTEM_USER,
    [UpdatedAt] [datetime2] NOT NULL DEFAULT GETUTCDATE(), 
    [UpdatedBy] [nvarchar](64) NOT NULL DEFAULT SYSTEM_USER,
    [IsDeleted] [bit] NOT NULL DEFAULT 0,
    [Version] [rowversion],
    
    CONSTRAINT [PK_ArchiveConfiguration] PRIMARY KEY ([Id]),
    CONSTRAINT [FK_ArchiveConfiguration_DataSource] FOREIGN KEY ([DataSourceId]) 
        REFERENCES [DataSource] ([Id]),
    CONSTRAINT [UK_ArchiveConfiguration_Table] UNIQUE ([DataSourceId], [SourceTableName])
);
```

#### ArchiveTask (归档任务表)
```sql
CREATE TABLE [dbo].[ArchiveTask](
    [Id] [uniqueidentifier] NOT NULL DEFAULT NEWID(),
    [DataSourceId] [uniqueidentifier] NOT NULL,
    [SourceTableName] [nvarchar](128) NOT NULL,
    [TargetTableName] [nvarchar](128) NOT NULL,
    [TaskType] [int] NOT NULL, -- 1:归档, 2:创建分区, 3:添加分区, 4:删除分区, 5:维护分区
    [Status] [int] NOT NULL DEFAULT 1, -- 1:待处理, 2:运行中, 3:成功, 4:失败, 5:取消
    [IsAutoArchive] [bit] NOT NULL DEFAULT 0,
    
    -- 执行时间
    [StartedAt] [datetime2] NULL,
    [CompletedAt] [datetime2] NULL,
    
    -- 数据统计
    [SourceRowCount] [bigint] NULL,
    [TargetRowCount] [bigint] NULL, 
    [SuccessfulRows] [bigint] NULL,
    
    -- 执行环境 (兼容旧工具字段)
    [MachineName] [nvarchar](50) NULL,
    [InternalIP] [nvarchar](50) NULL,
    [ExternalIP] [nvarchar](50) NULL,
    [ExecutorUser] [nvarchar](100) NOT NULL,
    
    -- 错误和备注
    [ErrorMessage] [nvarchar](max) NULL,
    [WhereSql] [nvarchar](2000) NULL,
    [Remark] [nvarchar](max) NULL,
    [RichTextContent] [nvarchar](max) NULL,
    
    -- 兼容性字段
    [LegacyOperationRecordId] [char](12) NULL,
    
    -- 公共字段
    [CreatedAt] [datetime2] NOT NULL DEFAULT GETUTCDATE(),
    [CreatedBy] [nvarchar](64) NOT NULL DEFAULT SYSTEM_USER,
    [UpdatedAt] [datetime2] NOT NULL DEFAULT GETUTCDATE(),
    [UpdatedBy] [nvarchar](64) NOT NULL DEFAULT SYSTEM_USER,  
    [IsDeleted] [bit] NOT NULL DEFAULT 0,
    [Version] [rowversion],
    
    CONSTRAINT [PK_ArchiveTask] PRIMARY KEY ([Id]),
    CONSTRAINT [FK_ArchiveTask_DataSource] FOREIGN KEY ([DataSourceId]) 
        REFERENCES [DataSource] ([Id])
);
```

#### SystemConfiguration (系统配置表)
```sql
CREATE TABLE [dbo].[SystemConfiguration](
    [Id] [uniqueidentifier] NOT NULL DEFAULT NEWID(),
    [ConfigKey] [nvarchar](100) NOT NULL,
    [ConfigValue] [nvarchar](max) NULL,
    [Description] [nvarchar](500) NULL,
    [IsEncrypted] [bit] NOT NULL DEFAULT 0,
    [Scope] [int] NOT NULL DEFAULT 1, -- 1:Global, 2:DataSource, 3:User
    [IsActive] [bit] NOT NULL DEFAULT 1,
    
    -- 公共字段
    [CreatedAt] [datetime2] NOT NULL DEFAULT GETUTCDATE(),
    [CreatedBy] [nvarchar](64) NOT NULL DEFAULT SYSTEM_USER,
    [UpdatedAt] [datetime2] NOT NULL DEFAULT GETUTCDATE(),
    [UpdatedBy] [nvarchar](64) NOT NULL DEFAULT SYSTEM_USER,
    [IsDeleted] [bit] NOT NULL DEFAULT 0,
    [Version] [rowversion],
    
    CONSTRAINT [PK_SystemConfiguration] PRIMARY KEY ([Id]),
    CONSTRAINT [UK_SystemConfiguration_Key] UNIQUE ([ConfigKey], [Scope])
);
```

### 6.5 索引策略
| 表 | 索引类型 | 字段 | 用途 |
|----|----------|------|------|
| DataSource | 唯一索引 | Name | 业务主键查找 |
| DataSource | 普通索引 | IsActive, CreatedAt | 列表查询优化 |
| ArchiveTask | 普通索引 | DataSourceId, Status | 任务状态查询 |
| ArchiveTask | 普通索引 | StartedAt, CompletedAt | 时间范围查询 |
| ArchivePartitionDetail | 普通索引 | ArchiveTaskId | 关联查询优化 |
| SystemConfiguration | 唯一索引 | ConfigKey, Scope | 配置键查找 |

### 6.6 数据迁移策略

#### 迁移阶段划分
1. **阶段1**: 结构迁移 - 创建新表结构，建立兼容字段
2. **阶段2**: 数据迁移 - 批量迁移历史数据，保持关联关系
3. **阶段3**: 增量同步 - 支持新旧工具并行运行期间的数据同步
4. **阶段4**: 切换完成 - 停止旧工具，完全使用新工具

#### 迁移脚本示例
```sql
-- 数据迁移存储过程
CREATE PROCEDURE [dbo].[sp_MigrateLegacyData]
    @LegacyConnectionString NVARCHAR(500),
    @BatchSize INT = 1000
AS
BEGIN
    -- 迁移数据源配置
    INSERT INTO [DataSource] (Name, Description, SourceConnectionJson, TargetConnectionJson, 
                             IsActive, LegacySourceConfigId, CreatedAt, CreatedBy)
    SELECT TOP(@BatchSize)
        ISNULL(SourceTableName, 'Unknown') + '_' + SourceConfigurationId,
        ISNULL(Remark, ''),
        -- 构建连接JSON（需要单独处理）
        '{"Server":"' + @LegacyConnectionString + '"}',
        '{"Server":"' + ISNULL(TargetServerIP, 'localhost') + '","Database":"' + ISNULL(TargetDatabase, '') + '"}',
        CASE WHEN OperationStatus = 1 THEN 1 ELSE 0 END,
        SourceConfigurationId,
        ISNULL(CreateDate, GETUTCDATE()),
        'MIGRATION'
    FROM OPENQUERY([LegacyServer], 
        'SELECT * FROM PartitionArchive_SourceConfiguration WHERE OperationStatus IS NOT NULL')
    WHERE NOT EXISTS (
        SELECT 1 FROM [DataSource] d 
        WHERE d.LegacySourceConfigId = SourceConfigurationId
    );
END
```

### 6.5 迁移管理
```bash
# 添加迁移
 dotnet ef migrations add Init --project DbArchiveTool.Infrastructure --startup-project DbArchiveTool.Web
# 更新数据库
 dotnet ef database update --project DbArchiveTool.Infrastructure --startup-project DbArchiveTool.Web
```

---

## 7. 配置与环境管理
| 环境 | 配置文件 | 特性 |
|------|----------|------|
| 开发 | appsettings.Development.json | Debug日志、详细错误 |
| 测试 | appsettings.Test.json | 模拟外部依赖 |
| 生产 | appsettings.Production.json | 最小日志、性能优化 |

环境变量优先级 > 用户机密 > appsettings.* > 默认值。

---

## 8. 日志规范
| 级别 | 使用场景 | 示例 |
|------|----------|------|
| Trace | 深度调试 | SQL原始语句（受配置控制） |
| Debug | 开发调试 | 配置加载、分支判断 |
| Information | 业务里程碑 | 归档任务开始/结束 |
| Warning | 可恢复异常 | 重试警告 |
| Error | 功能失败 | SQL执行失败 |
| Critical | 系统不可用 | 无法连接数据库 |

日志上下文字段：TraceId、TaskId、DataSource、User、ElapsedMs。

---

## 9. API 设计规范
| 规则 | 说明 | 示例 |
|------|------|------|
| 路由风格 | 资源 + 版本 | /api/v1/datasources |
| 资源命名 | 复数形式 | /archive-tasks |
| 分页参数 | page / pageSize | /archive-tasks?page=1&pageSize=20 |
| 过滤参数 | 简短、语义清晰 | status=Pending |
| 排序参数 | sort=字段:asc|desc | sort=CreatedAt:desc |
| 返回包装 | 统一Result或分页模型 | { items, total } |
| 幂等性 | POST幂等需传Client Token | X-Idempotency-Key |

### 响应示例
```json
{
  "isSuccess": true,
  "value": {
    "id": "d9f7...",
    "name": "CoreBusinessDB",
    "databaseType": "SqlServer",
    "isActive": true,
    "createdAt": "2025-09-29T05:23:11Z"
  },
  "error": null
}
```

---

## 10. 认证与授权（后续阶段）
- 身份认证：JWT + Refresh Token
- 授权模型：Role + Policy（可扩展到资源级）
- 审计：所有敏感操作记录操作者、时间、参数摘要

---

## 11. 测试策略
| 类型 | 工具 | 覆盖重点 |
|------|------|----------|
| 单元测试 | xUnit / FluentAssertions | 领域服务、应用服务逻辑 |
| 集成测试 | WebApplicationFactory | API 端点、数据库交互 |
| 端到端 | Playwright (可选) | 关键用户路径 |
| 性能测试 | BenchmarkDotNet / k6 | 归档执行关键路径 |
| 回归测试 | 测试集脚本 | 版本升级后关键功能 |

---

## 12. 性能与优化建议
- Dapper：用于高频、批量、导出导入场景
- EF：开启无跟踪查询 `AsNoTracking()` 降低内存
- 批处理：分批分页读取避免大事务
- 连接池：设置最小/最大池并监控阻塞
- 缓存：元数据/配置读多写少可加内存缓存或Redis
- 指标监控：归档耗时、吞吐量、失败率

---

## 13. 异步与后台任务
- 使用 `IHostedService` / `BackgroundService` 实现调度轮询
- 使用 `Channel<T>` 或 `System.Threading.Channels` 实现任务队列
- 任务状态表持久化 + 内存字典加速查询
- 失败重试策略：指数退避 + 最大次数

---

## 14. 部署与交付
| 阶段 | 工具 | 内容 |
|------|------|------|
| 构建 | dotnet CLI | 恰当分层构建 Docker 镜像 |
| CI | GitHub Actions / Azure DevOps | 编译 + 测试 + 扫描 |
| CD | 容器平台（k8s） | 蓝绿或滚动发布 |
| 配置 | 环境变量 / Secret | 连接串、密钥、目录路径 |
| 追踪 | OpenTelemetry (可选) | Trace + Metrics + Logs |

---

## 15. 质量检查清单（提交前）
- [ ] 新增代码已覆盖单元测试
- [ ] 没有无用/调试代码 (Console.WriteLine)
- [ ] 所有公共方法具备注释
- [ ] EF迁移是否同步（如有模型变更）
- [ ] 配置项是否集中管理
- [ ] 日志级别合理
- [ ] SQL语句已参数化
- [ ] 异常没有被吞掉

---

## 16. 渐进式增强建议（后续）
| 优先级 | 功能 | 价值 |
|--------|------|------|
| 中 | API 限流 | 防止恶意调用 |
| 高 | 任务进度实时推送 | 提升体验 |
| 中 | 指标监控仪表盘 | 可观测性增强 |
| 低 | 多数据库类型插件 | 可扩展市场 |
| 中 | 规则脚本化（Lua/表达式） | 灵活配置 |

---

*本规范为第一版，可随迭代进行版本演进。所有新增约定需在 PR 中说明并更新本文档。*