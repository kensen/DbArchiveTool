# å¼€å‘è§„èŒƒä¸é¡¹ç›®ç»“æ„

> ç‰ˆæœ¬: 1.0  
> æ—¥æœŸ: 2025-09-29  
> èŒƒå›´: æ–°æ•°æ®åº“å½’æ¡£å·¥å…·ï¼ˆæœåŠ¡ç«¯ã€å‰ç«¯ã€æ•°æ®è®¿é—®ã€éƒ¨ç½²ï¼‰

---

## 1. ç›®æ ‡
æä¾›ç»Ÿä¸€ã€ç²¾ç®€ã€å¯æ‰§è¡Œçš„å¼€å‘è§„èŒƒï¼Œä¿éšœä»£ç è´¨é‡ã€å¯ç»´æŠ¤æ€§ä¸å¿«é€Ÿè¿­ä»£èƒ½åŠ›ã€‚

---

## 2. è§£å†³æ–¹æ¡ˆæ€»ä½“ç›®å½•ç»“æ„
```
DbArchiveTool.sln
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ DbArchiveTool.Web/              # Blazor Server + Ant Design UI + API Gateway
â”‚   â”œâ”€â”€ DbArchiveTool.Api/              # ï¼ˆå¯é€‰ï¼‰ç‹¬ç«‹REST APIï¼ˆå¿…è¦æ—¶æ‹†åˆ†ï¼‰
â”‚   â”œâ”€â”€ DbArchiveTool.Application/      # åº”ç”¨æœåŠ¡å±‚ï¼ˆç¼–æ’ã€DTOã€å‘½ä»¤ã€æŸ¥è¯¢ï¼‰
â”‚   â”œâ”€â”€ DbArchiveTool.Domain/           # é¢†åŸŸæ¨¡å‹ï¼ˆå®ä½“ã€å€¼å¯¹è±¡ã€é¢†åŸŸæœåŠ¡ã€è§„çº¦ï¼‰
â”‚   â”œâ”€â”€ DbArchiveTool.Infrastructure/   # åŸºç¡€è®¾æ–½ï¼ˆEFã€Dapperã€ä»“å‚¨å®ç°ã€å¤–éƒ¨æœåŠ¡ï¼‰
â”‚   â””â”€â”€ DbArchiveTool.Shared/           # é€šç”¨å·¥å…·ã€åŸºç¡€ç±»å‹ã€Resultæ¨¡å‹
â”œâ”€â”€ tests/
â”‚   â”œâ”€â”€ DbArchiveTool.UnitTests/
â”‚   â”œâ”€â”€ DbArchiveTool.IntegrationTests/
â”‚   â””â”€â”€ DbArchiveTool.E2ETests/
â”œâ”€â”€ docs/
â”œâ”€â”€ scripts/
â”œâ”€â”€ docker/
â””â”€â”€ build/
```

---

## 3. å‘½åè§„èŒƒ
| ç±»å‹ | è§„åˆ™ | ç¤ºä¾‹ |
|------|------|------|
| è§£å†³æ–¹æ¡ˆ | PascalCase | DbArchiveTool.sln |
| é¡¹ç›® | PascalCase | DbArchiveTool.Domain |
| ç›®å½• | PascalCase | Services |
| ç±» | PascalCase | ArchiveEngine |
| æ¥å£ | I + PascalCase | IArchiveEngine |
| æ–¹æ³• | PascalCase | ExecuteArchiveAsync |
| å˜é‡ | camelCase | taskResult |
| å‚æ•° | camelCase | connectionString |
| å¸¸é‡ | PascalCase | DefaultTimeout |
| æšä¸¾ | PascalCase | ArchiveStatus |
| æšä¸¾å€¼ | PascalCase | Pending |
| é…ç½®èŠ‚ | PascalCase | ArchiveSettings |
| æ•°æ®åº“è¡¨ | PascalCase / è¯­ä¹‰åŒ– | ArchiveTask |
| æ•°æ®åº“åˆ— | PascalCase | CreatedAt |

---

## 4. åˆ†å±‚èŒè´£ä¸ä¾èµ–åŸåˆ™
| å±‚ | åªä¾èµ– | ç¦æ­¢ä¾èµ– | èŒè´£æ ¸å¿ƒ |
|----|--------|----------|----------|
| Web (Presentation) | Application, Shared | Domain, Infrastructureï¼ˆé™¤DTOæ˜ å°„ï¼‰ | UIäº¤äº’ã€APIã€å®æ—¶æ¨é€ |
| Application | Domain, Infrastructure(æ¥å£), Shared | å…·ä½“å®ç°ç±» | ä¸šåŠ¡ç¼–æ’ã€äº‹åŠ¡è¾¹ç•Œã€è¾“å…¥è¾“å‡ºæ¨¡å‹ |
| Domain | Shared | ä»»ä½•ä¸Šå±‚ | é¢†åŸŸæ¨¡å‹ä¸è§„åˆ™ï¼ˆçº¯å‡€ï¼‰ |
| Infrastructure | Domain, Shared | Web, Application | å¤–éƒ¨æŠ€æœ¯å®ç°ï¼ˆEFã€Dapperã€æ–‡ä»¶ã€ç¼“å­˜ï¼‰ |
| Tests | æ‰€æœ‰ | - | è‡ªåŠ¨åŒ–è´¨é‡ä¿éšœ |

åŸåˆ™ï¼š
- Domain ä¸æ„ŸçŸ¥æ•°æ®åº“å®ç°ã€‚
- Application ä¸å†™åŸç”ŸSQLï¼ˆé™¤å§”æ´¾åˆ° Dapper æ‰§è¡ŒæœåŠ¡æ¥å£ï¼‰ã€‚
- Infrastructure ä¸åšä¸šåŠ¡å†³ç­–ï¼Œåªå®ç°æ¥å£ã€‚
- DTO å’Œ Entity åˆ†ç¦»ï¼Œä¸æ³„æ¼å†…éƒ¨ç»“æ„ã€‚

---

## 5. ä»£ç ç»„ç»‡ä¸æ¨¡å¼
### 5.1 ä»“å‚¨æ¨¡å¼
```csharp
public interface IRepository<T> where T : BaseEntity
{
    Task<T?> GetByIdAsync(Guid id);
    Task AddAsync(T entity);
    Task UpdateAsync(T entity);
    Task RemoveAsync(T entity);
    Task<IReadOnlyList<T>> ListAsync(ISpecification<T> spec);
}
```

### 5.2 è§„çº¦ï¼ˆSpecificationï¼‰æ¨¡å¼
```csharp
public interface ISpecification<T>
{
    Expression<Func<T, bool>> Criteria { get; }
    List<Expression<Func<T, object>>> Includes { get; }
}
```

### 5.3 Dapper æ‰§è¡Œå™¨æ¨¡å¼
```csharp
public interface ISqlExecutor
{
    Task<int> ExecuteAsync(string connection, string sql, object? param = null, int? timeoutSeconds = null);
    Task<IEnumerable<T>> QueryAsync<T>(string connection, string sql, object? param = null, int? timeoutSeconds = null);
    Task<T?> QuerySingleAsync<T>(string connection, string sql, object? param = null);
}
```

### 5.4 ç»“æœè¿”å›æ¨¡å¼ï¼ˆResult Patternï¼‰
```csharp
public record Result(bool IsSuccess, string? Error)
{
    public static Result Success() => new(true, null);
    public static Result Failure(string error) => new(false, error);
}

public record Result<T>(bool IsSuccess, T? Value, string? Error)
{
    public static Result<T> Success(T value) => new(true, value, null);
    public static Result<T> Failure(string error) => new(false, default, error);
}
```

### 5.5 å¼‚å¸¸å¤„ç†ç­–ç•¥
| åœºæ™¯ | ç­–ç•¥ |
|------|------|
| ä¸šåŠ¡å¯é¢„æœŸé”™è¯¯ | ä½¿ç”¨ Result è¿”å› |
| ä¸å¯é¢„æœŸç³»ç»Ÿå¼‚å¸¸ | æ•è·è®°å½•æ—¥å¿—åæŠ›å‡ºæˆ–ç»Ÿä¸€ä¸­é—´ä»¶å¤„ç† |
| æ•°æ®ä¸€è‡´æ€§å¤±è´¥ | äº‹åŠ¡å›æ»š + è®°å½•å·®å¼‚ + è¿”å›å¤±è´¥ |
| é‡è¯•ç±»æ“ä½œ | Polly é‡è¯•ï¼ˆæŒ‡æ•°é€€é¿ï¼‰ |

### 5.6 æ³¨é‡Šè§„èŒƒ
- **ç±»ä¸æ¥å£**ï¼šåœ¨å£°æ˜ä¸Šæ–¹ä½¿ç”¨ `///` æ–‡æ¡£æ³¨é‡Šï¼Œè¯´æ˜èŒè´£ã€è¾“å…¥è¾“å‡ºçº¦æŸï¼Œéœ€ä½¿ç”¨ä¸­æ–‡æè¿°ï¼Œå¿…è¦æ—¶è¡¥å……ç¤ºä¾‹ã€‚
- **å…¬å…±æ–¹æ³•**ï¼šå¿…é¡»åŒ…å«ä¸­æ–‡ `///` æ³¨é‡Šï¼Œæ¶µç›–ç”¨é€”ã€å‚æ•°å«ä¹‰ã€è¿”å›å€¼ã€å¼‚å¸¸æƒ…å†µï¼›é‡å†™æ–¹æ³•éœ€è¯´æ˜ä¸åŸºç±»å·®å¼‚ã€‚
- **å®ä½“ä¸DTOå­—æ®µ**ï¼šåœ¨å±æ€§æˆ–å­—æ®µä¸Šä¸€å¾‹æ·»åŠ ä¸­æ–‡æ³¨é‡Šï¼Œæ ‡æ³¨ä¸šåŠ¡å«ä¹‰ã€å•ä½ã€ä¸æ—§å·¥å…·å­—æ®µçš„æ˜ å°„å…³ç³»ã€‚
- **å…³é”®ä¸šåŠ¡å®ç°**ï¼šåœ¨å¤æ‚ç®—æ³•ã€SQL æ„é€ ã€äº‹åŠ¡æ§åˆ¶ç­‰ä»£ç å—å‰æ·»åŠ ä¸­æ–‡è¡Œå†…æ³¨é‡Šï¼Œè¯´æ˜ä¸šåŠ¡æ„å›¾ã€å‰ç½®æ¡ä»¶ã€è¾¹ç•Œå¤„ç†ã€‚
- **ç¦æ­¢**ï¼šå‡ºç°æ— æ„ä¹‰æ³¨é‡Šï¼ˆå¦‚â€œTODOâ€å ä½ä¸è§£é‡Šï¼‰æˆ–ä¸ä»£ç é€»è¾‘ä¸ç¬¦çš„è¿‡æœŸæ³¨é‡Šï¼›è‹¥é€»è¾‘æ›´æ–°éœ€åŒæ­¥è°ƒæ•´è¯´æ˜ã€‚

---

## 6. æ•°æ®åº“è®¾è®¡è§„èŒƒï¼ˆå·¥å…·è‡ªèº«å…ƒæ•°æ®ï¼‰
### 6.1 è¡¨å‘½å
| åŠŸèƒ½åŸŸ | å‰ç¼€ | ç¤ºä¾‹ | è¯´æ˜ |
|--------|------|------|------|
| æ•°æ®æº | DataSource | DataSourceConnection | æ•°æ®æºé…ç½®ç®¡ç† |
| å½’æ¡£é…ç½® | ArchiveConfig | ArchiveConfiguration | å½’æ¡£ç­–ç•¥é…ç½® |
| å½’æ¡£ä»»åŠ¡ | ArchiveTask | ArchiveTask | å½’æ¡£ä»»åŠ¡æ‰§è¡Œ |
| åˆ†åŒºæ˜ç»† | ArchivePartition | ArchivePartitionDetail | åˆ†åŒºå½’æ¡£æ˜ç»† |
| æ‰§è¡Œæ—¥å¿— | ExecLog | ExecutionLog | é€šç”¨æ‰§è¡Œæ—¥å¿— |
| è°ƒåº¦ä»»åŠ¡ | Schedule | SchedulePlan | è‡ªåŠ¨è°ƒåº¦é…ç½® |
| ç³»ç»Ÿé…ç½® | SystemConfig | SystemConfiguration | ç³»ç»Ÿçº§é…ç½® |

### 6.2 å…¬å…±å­—æ®µ
| å­—æ®µ | ç±»å‹ | è¯´æ˜ | å¿…éœ€ |
|------|------|------|------|
| Id | UNIQUEIDENTIFIER | ä¸»é”®ï¼Œä½¿ç”¨ GUID | âœ“ |
| CreatedAt | DATETIME2 | åˆ›å»ºæ—¶é—´ | âœ“ |
| CreatedBy | NVARCHAR(64) | åˆ›å»ºäºº | âœ“ |
| UpdatedAt | DATETIME2 | æ›´æ–°æ—¶é—´ | âœ“ |
| UpdatedBy | NVARCHAR(64) | æ›´æ–°äºº | âœ“ |
| IsDeleted | BIT | è½¯åˆ é™¤æ ‡è®° | âœ“ |
| Version | ROWVERSION | å¹¶å‘æ§åˆ¶ | å¯é€‰ |

### 6.3 æ—§å·¥å…·å…¼å®¹æ€§å­—æ®µè®¾è®¡
**åŸåˆ™**: æ–°è¡¨ç»“æ„åŒ…å«å…¼å®¹æ€§å­—æ®µï¼Œæ”¯æŒæ•°æ®è¿ç§»å’ŒåŒå‘åŒæ­¥

| æ–°è¡¨ | å…¼å®¹å­—æ®µ | å¯¹åº”æ—§è¡¨å­—æ®µ | ç”¨é€” |
|------|----------|--------------|------|
| DataSource | LegacySourceConfigId | SourceConfigurationId | æ ‡è¯†æ¥æºé…ç½® |
| ArchiveTask | LegacyOperationRecordId | ArchiveOperationRecordId | å…³è”æ—§æ“ä½œè®°å½• |
| ArchivePartitionDetail | LegacyDetailId | ArchivePartitionDetailId | å…³è”æ—§åˆ†åŒºæ˜ç»† |
| SystemConfiguration | LegacyMigrated | - | æ ‡è®°å·²è¿ç§»é…ç½® |

### 6.4 æ ¸å¿ƒå®ä½“è¡¨ç»“æ„ç¤ºä¾‹

#### DataSource (æ•°æ®æºè¡¨)
```sql
CREATE TABLE [dbo].[DataSource](
    [Id] [uniqueidentifier] NOT NULL DEFAULT NEWID(),
    [Name] [nvarchar](100) NOT NULL,
    [Description] [nvarchar](500) NULL,
    [DatabaseType] [int] NOT NULL DEFAULT 1, -- 1:SqlServer, 2:MySQL, 3:Oracle
    [SourceConnectionJson] [nvarchar](max) NOT NULL, -- JSONæ ¼å¼è¿æ¥é…ç½®
    [TargetConnectionJson] [nvarchar](max) NOT NULL,
    [IsActive] [bit] NOT NULL DEFAULT 1,
    [LastValidatedAt] [datetime2] NULL,
    
    -- å…¼å®¹æ€§å­—æ®µ
    [LegacySourceConfigId] [char](12) NULL, -- å¯¹åº”æ—§å·¥å…·ID
    [LegacyOperationStatus] [int] NULL,     -- ä¿ç•™æ—§å·¥å…·çŠ¶æ€
    
    -- å…¬å…±å­—æ®µ
    [CreatedAt] [datetime2] NOT NULL DEFAULT GETUTCDATE(),
    [CreatedBy] [nvarchar](64) NOT NULL DEFAULT SYSTEM_USER,
    [UpdatedAt] [datetime2] NOT NULL DEFAULT GETUTCDATE(),
    [UpdatedBy] [nvarchar](64) NOT NULL DEFAULT SYSTEM_USER,
    [IsDeleted] [bit] NOT NULL DEFAULT 0,
    [Version] [rowversion],
    
    CONSTRAINT [PK_DataSource] PRIMARY KEY ([Id]),
    CONSTRAINT [UK_DataSource_Name] UNIQUE ([Name]),
    CONSTRAINT [UK_DataSource_LegacyId] UNIQUE ([LegacySourceConfigId])
);
```

#### ArchiveConfiguration (å½’æ¡£é…ç½®è¡¨)
```sql
CREATE TABLE [dbo].[ArchiveConfiguration](
    [Id] [uniqueidentifier] NOT NULL DEFAULT NEWID(),
    [DataSourceId] [uniqueidentifier] NOT NULL,
    [SourceTableName] [nvarchar](128) NOT NULL,
    [TargetTableName] [nvarchar](128) NOT NULL,
    [PartitionColumnName] [nvarchar](128) NULL,
    [PartitionValues] [nvarchar](max) NULL, -- JSONæ ¼å¼
    [FileGroupMode] [int] NOT NULL DEFAULT 1,
    [FileSize] [int] NOT NULL DEFAULT 100, -- MB
    [FileGrowth] [int] NOT NULL DEFAULT 50, -- MB
    
    -- è‡ªåŠ¨å½’æ¡£é…ç½®
    [EnableAutoArchive] [bit] NOT NULL DEFAULT 0,
    [ArchiveDataType] [int] NULL, -- 1:æŒ‡å®šåˆ†åŒº, 2:ç›¸å¯¹æ—¶é—´  
    [AutoArchivePartitionValues] [nvarchar](2000) NULL,
    [RelativeDays] [int] NULL,
    [AutoArchiveTimeType] [int] NULL, -- 1:é—´éš”, 2:å¤©æ•°
    [AutoArchiveTimeValue] [nvarchar](2000) NULL,
    
    [Remark] [nvarchar](max) NULL,
    
    -- å…¬å…±å­—æ®µ  
    [CreatedAt] [datetime2] NOT NULL DEFAULT GETUTCDATE(),
    [CreatedBy] [nvarchar](64) NOT NULL DEFAULT SYSTEM_USER,
    [UpdatedAt] [datetime2] NOT NULL DEFAULT GETUTCDATE(), 
    [UpdatedBy] [nvarchar](64) NOT NULL DEFAULT SYSTEM_USER,
    [IsDeleted] [bit] NOT NULL DEFAULT 0,
    [Version] [rowversion],
    
    CONSTRAINT [PK_ArchiveConfiguration] PRIMARY KEY ([Id]),
    CONSTRAINT [FK_ArchiveConfiguration_DataSource] FOREIGN KEY ([DataSourceId]) 
        REFERENCES [DataSource] ([Id]),
    CONSTRAINT [UK_ArchiveConfiguration_Table] UNIQUE ([DataSourceId], [SourceTableName])
);
```

#### ArchiveTask (å½’æ¡£ä»»åŠ¡è¡¨)
```sql
CREATE TABLE [dbo].[ArchiveTask](
    [Id] [uniqueidentifier] NOT NULL DEFAULT NEWID(),
    [DataSourceId] [uniqueidentifier] NOT NULL,
    [SourceTableName] [nvarchar](128) NOT NULL,
    [TargetTableName] [nvarchar](128) NOT NULL,
    [TaskType] [int] NOT NULL, -- 1:å½’æ¡£, 2:åˆ›å»ºåˆ†åŒº, 3:æ·»åŠ åˆ†åŒº, 4:åˆ é™¤åˆ†åŒº, 5:ç»´æŠ¤åˆ†åŒº
    [Status] [int] NOT NULL DEFAULT 1, -- 1:å¾…å¤„ç†, 2:è¿è¡Œä¸­, 3:æˆåŠŸ, 4:å¤±è´¥, 5:å–æ¶ˆ
    [IsAutoArchive] [bit] NOT NULL DEFAULT 0,
    
    -- æ‰§è¡Œæ—¶é—´
    [StartedAt] [datetime2] NULL,
    [CompletedAt] [datetime2] NULL,
    
    -- æ•°æ®ç»Ÿè®¡
    [SourceRowCount] [bigint] NULL,
    [TargetRowCount] [bigint] NULL, 
    [SuccessfulRows] [bigint] NULL,
    
    -- æ‰§è¡Œç¯å¢ƒ (å…¼å®¹æ—§å·¥å…·å­—æ®µ)
    [MachineName] [nvarchar](50) NULL,
    [InternalIP] [nvarchar](50) NULL,
    [ExternalIP] [nvarchar](50) NULL,
    [ExecutorUser] [nvarchar](100) NOT NULL,
    
    -- é”™è¯¯å’Œå¤‡æ³¨
    [ErrorMessage] [nvarchar](max) NULL,
    [WhereSql] [nvarchar](2000) NULL,
    [Remark] [nvarchar](max) NULL,
    [RichTextContent] [nvarchar](max) NULL,
    
    -- å…¼å®¹æ€§å­—æ®µ
    [LegacyOperationRecordId] [char](12) NULL,
    
    -- å…¬å…±å­—æ®µ
    [CreatedAt] [datetime2] NOT NULL DEFAULT GETUTCDATE(),
    [CreatedBy] [nvarchar](64) NOT NULL DEFAULT SYSTEM_USER,
    [UpdatedAt] [datetime2] NOT NULL DEFAULT GETUTCDATE(),
    [UpdatedBy] [nvarchar](64) NOT NULL DEFAULT SYSTEM_USER,  
    [IsDeleted] [bit] NOT NULL DEFAULT 0,
    [Version] [rowversion],
    
    CONSTRAINT [PK_ArchiveTask] PRIMARY KEY ([Id]),
    CONSTRAINT [FK_ArchiveTask_DataSource] FOREIGN KEY ([DataSourceId]) 
        REFERENCES [DataSource] ([Id])
);
```

#### SystemConfiguration (ç³»ç»Ÿé…ç½®è¡¨)
```sql
CREATE TABLE [dbo].[SystemConfiguration](
    [Id] [uniqueidentifier] NOT NULL DEFAULT NEWID(),
    [ConfigKey] [nvarchar](100) NOT NULL,
    [ConfigValue] [nvarchar](max) NULL,
    [Description] [nvarchar](500) NULL,
    [IsEncrypted] [bit] NOT NULL DEFAULT 0,
    [Scope] [int] NOT NULL DEFAULT 1, -- 1:Global, 2:DataSource, 3:User
    [IsActive] [bit] NOT NULL DEFAULT 1,
    
    -- å…¬å…±å­—æ®µ
    [CreatedAt] [datetime2] NOT NULL DEFAULT GETUTCDATE(),
    [CreatedBy] [nvarchar](64) NOT NULL DEFAULT SYSTEM_USER,
    [UpdatedAt] [datetime2] NOT NULL DEFAULT GETUTCDATE(),
    [UpdatedBy] [nvarchar](64) NOT NULL DEFAULT SYSTEM_USER,
    [IsDeleted] [bit] NOT NULL DEFAULT 0,
    [Version] [rowversion],
    
    CONSTRAINT [PK_SystemConfiguration] PRIMARY KEY ([Id]),
    CONSTRAINT [UK_SystemConfiguration_Key] UNIQUE ([ConfigKey], [Scope])
);
```

### 6.5 ç´¢å¼•ç­–ç•¥
| è¡¨ | ç´¢å¼•ç±»å‹ | å­—æ®µ | ç”¨é€” |
|----|----------|------|------|
| DataSource | å”¯ä¸€ç´¢å¼• | Name | ä¸šåŠ¡ä¸»é”®æŸ¥æ‰¾ |
| DataSource | æ™®é€šç´¢å¼• | IsActive, CreatedAt | åˆ—è¡¨æŸ¥è¯¢ä¼˜åŒ– |
| ArchiveTask | æ™®é€šç´¢å¼• | DataSourceId, Status | ä»»åŠ¡çŠ¶æ€æŸ¥è¯¢ |
| ArchiveTask | æ™®é€šç´¢å¼• | StartedAt, CompletedAt | æ—¶é—´èŒƒå›´æŸ¥è¯¢ |
| ArchivePartitionDetail | æ™®é€šç´¢å¼• | ArchiveTaskId | å…³è”æŸ¥è¯¢ä¼˜åŒ– |
| SystemConfiguration | å”¯ä¸€ç´¢å¼• | ConfigKey, Scope | é…ç½®é”®æŸ¥æ‰¾ |

### 6.6 æ•°æ®è¿ç§»ç­–ç•¥

#### è¿ç§»é˜¶æ®µåˆ’åˆ†
1. **é˜¶æ®µ1**: ç»“æ„è¿ç§» - åˆ›å»ºæ–°è¡¨ç»“æ„ï¼Œå»ºç«‹å…¼å®¹å­—æ®µ
2. **é˜¶æ®µ2**: æ•°æ®è¿ç§» - æ‰¹é‡è¿ç§»å†å²æ•°æ®ï¼Œä¿æŒå…³è”å…³ç³»
3. **é˜¶æ®µ3**: å¢é‡åŒæ­¥ - æ”¯æŒæ–°æ—§å·¥å…·å¹¶è¡Œè¿è¡ŒæœŸé—´çš„æ•°æ®åŒæ­¥
4. **é˜¶æ®µ4**: åˆ‡æ¢å®Œæˆ - åœæ­¢æ—§å·¥å…·ï¼Œå®Œå…¨ä½¿ç”¨æ–°å·¥å…·

#### è¿ç§»è„šæœ¬ç¤ºä¾‹
```sql
-- æ•°æ®è¿ç§»å­˜å‚¨è¿‡ç¨‹
CREATE PROCEDURE [dbo].[sp_MigrateLegacyData]
    @LegacyConnectionString NVARCHAR(500),
    @BatchSize INT = 1000
AS
BEGIN
    -- è¿ç§»æ•°æ®æºé…ç½®
    INSERT INTO [DataSource] (Name, Description, SourceConnectionJson, TargetConnectionJson, 
                             IsActive, LegacySourceConfigId, CreatedAt, CreatedBy)
    SELECT TOP(@BatchSize)
        ISNULL(SourceTableName, 'Unknown') + '_' + SourceConfigurationId,
        ISNULL(Remark, ''),
        -- æ„å»ºè¿æ¥JSONï¼ˆéœ€è¦å•ç‹¬å¤„ç†ï¼‰
        '{"Server":"' + @LegacyConnectionString + '"}',
        '{"Server":"' + ISNULL(TargetServerIP, 'localhost') + '","Database":"' + ISNULL(TargetDatabase, '') + '"}',
        CASE WHEN OperationStatus = 1 THEN 1 ELSE 0 END,
        SourceConfigurationId,
        ISNULL(CreateDate, GETUTCDATE()),
        'MIGRATION'
    FROM OPENQUERY([LegacyServer], 
        'SELECT * FROM PartitionArchive_SourceConfiguration WHERE OperationStatus IS NOT NULL')
    WHERE NOT EXISTS (
        SELECT 1 FROM [DataSource] d 
        WHERE d.LegacySourceConfigId = SourceConfigurationId
    );
END
```

### 6.5 è¿ç§»ç®¡ç†
```bash
# æ·»åŠ è¿ç§»
 dotnet ef migrations add Init --project DbArchiveTool.Infrastructure --startup-project DbArchiveTool.Web
# æ›´æ–°æ•°æ®åº“
 dotnet ef database update --project DbArchiveTool.Infrastructure --startup-project DbArchiveTool.Web
```

---

## 7. é…ç½®ä¸ç¯å¢ƒç®¡ç†
| ç¯å¢ƒ | é…ç½®æ–‡ä»¶ | ç‰¹æ€§ |
|------|----------|------|
| å¼€å‘ | appsettings.Development.json | Debugæ—¥å¿—ã€è¯¦ç»†é”™è¯¯ |
| æµ‹è¯• | appsettings.Test.json | æ¨¡æ‹Ÿå¤–éƒ¨ä¾èµ– |
| ç”Ÿäº§ | appsettings.Production.json | æœ€å°æ—¥å¿—ã€æ€§èƒ½ä¼˜åŒ– |

ç¯å¢ƒå˜é‡ä¼˜å…ˆçº§ > ç”¨æˆ·æœºå¯† > appsettings.* > é»˜è®¤å€¼ã€‚

---

## 8. æ—¥å¿—è§„èŒƒ
| çº§åˆ« | ä½¿ç”¨åœºæ™¯ | ç¤ºä¾‹ |
|------|----------|------|
| Trace | æ·±åº¦è°ƒè¯• | SQLåŸå§‹è¯­å¥ï¼ˆå—é…ç½®æ§åˆ¶ï¼‰ |
| Debug | å¼€å‘è°ƒè¯• | é…ç½®åŠ è½½ã€åˆ†æ”¯åˆ¤æ–­ |
| Information | ä¸šåŠ¡é‡Œç¨‹ç¢‘ | å½’æ¡£ä»»åŠ¡å¼€å§‹/ç»“æŸ |
| Warning | å¯æ¢å¤å¼‚å¸¸ | é‡è¯•è­¦å‘Š |
| Error | åŠŸèƒ½å¤±è´¥ | SQLæ‰§è¡Œå¤±è´¥ |
| Critical | ç³»ç»Ÿä¸å¯ç”¨ | æ— æ³•è¿æ¥æ•°æ®åº“ |

æ—¥å¿—ä¸Šä¸‹æ–‡å­—æ®µï¼šTraceIdã€TaskIdã€DataSourceã€Userã€ElapsedMsã€‚

### 8.1 æ‰§è¡Œæ—¥å¿— Markdown æ ¼å¼è§„èŒƒ

ä¸ºæå‡æ—¥å¿—å¯è¯»æ€§,åå°ä»»åŠ¡æ‰§è¡Œæ—¥å¿—åº”ä½¿ç”¨ Markdown æ ¼å¼,å‰ç«¯ä½¿ç”¨ `Markdig` åº“æ¸²æŸ“:

**æ ¼å¼è¦ç‚¹**:
- ä½¿ç”¨ `\n` ä½œä¸ºæ¢è¡Œç¬¦(ä¸æ˜¯ `\r\n`)
- ä½¿ç”¨ `\n\n` åŒæ¢è¡Œåˆ†æ®µ
- è¡¨å/ç´¢å¼•å/åˆ—åç”¨åå¼•å·åŒ…è£¹: `` `TableName` ``
- æ ‡é¢˜ä½¿ç”¨ `**åŠ ç²—**` çªå‡ºæ˜¾ç¤º
- åˆ—è¡¨ä½¿ç”¨ `- é¡¹ç›®` æ ¼å¼,æ¯é¡¹ç‹¬å ä¸€è¡Œ
- SQL ä»£ç å—ä½¿ç”¨: `` ```sql\nä»£ç \n``` ``
- æ³¨æ„äº‹é¡¹ä½¿ç”¨å¼•ç”¨å—: `> ğŸ“Œ **æ³¨æ„:** å†…å®¹`

**ç¤ºä¾‹**:
```csharp
var detailMessage =
    $"æˆåŠŸå°†è¡¨ `{schema}.{table}` è½¬æ¢ä¸ºåˆ†åŒºè¡¨ã€‚\n\n" +
    $"**è¡¨æ€»è¡Œæ•°:** {rows:N0} è¡Œ\n\n" +
    $"**å·²åˆ é™¤ç´¢å¼•:**\n- `IX_001`\n- `IX_002`\n\n" +
    $"**å·²é‡å»ºç´¢å¼•:**\n- `PK_Table`\n- `IX_001`\n\n" +
    $"> ğŸ“Œ **æ³¨æ„:** åˆ†åŒºåˆ—å·²è‡ªåŠ¨è½¬æ¢ä¸º NOT NULLã€‚";

// SQL è„šæœ¬ç¤ºä¾‹
var sqlLog = 
    $"æ­£åœ¨æ‰§è¡Œåˆ†åŒºæ‹†åˆ†DDLè„šæœ¬,å°†æ‹†åˆ† {count} ä¸ªè¾¹ç•Œå€¼...\n```sql\n{ddlScript}\n```";
```

**å‰ç«¯æ¸²æŸ“é…ç½®**:
- å®‰è£… `Markdig` NuGet åŒ…
- åˆ›å»º `MarkdownViewer.razor` ç»„ä»¶ä½¿ç”¨ `Markdown.ToHtml()`
- æ·»åŠ  `markdown.css` æ ·å¼ç¾åŒ–ä»£ç å—å’Œåˆ—è¡¨
- åœ¨æ—¥å¿—å±•ç¤ºç»„ä»¶ä¸­ä½¿ç”¨ `<MarkdownViewer Content="@log.Message" />`

---

## 9. API è®¾è®¡è§„èŒƒ
| è§„åˆ™ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| è·¯ç”±é£æ ¼ | èµ„æº + ç‰ˆæœ¬ | /api/v1/datasources |
| èµ„æºå‘½å | å¤æ•°å½¢å¼ | /archive-tasks |
| åˆ†é¡µå‚æ•° | page / pageSize | /archive-tasks?page=1&pageSize=20 |
| è¿‡æ»¤å‚æ•° | ç®€çŸ­ã€è¯­ä¹‰æ¸…æ™° | status=Pending |
| æ’åºå‚æ•° | sort=å­—æ®µ:asc|desc | sort=CreatedAt:desc |
| è¿”å›åŒ…è£… | ç»Ÿä¸€Resultæˆ–åˆ†é¡µæ¨¡å‹ | { items, total } |
| å¹‚ç­‰æ€§ | POSTå¹‚ç­‰éœ€ä¼ Client Token | X-Idempotency-Key |

### å“åº”ç¤ºä¾‹
```json
{
  "isSuccess": true,
  "value": {
    "id": "d9f7...",
    "name": "CoreBusinessDB",
    "databaseType": "SqlServer",
    "isActive": true,
    "createdAt": "2025-09-29T05:23:11Z"
  },
  "error": null
}
```

---

## 10. è®¤è¯ä¸æˆæƒï¼ˆåç»­é˜¶æ®µï¼‰
- èº«ä»½è®¤è¯ï¼šJWT + Refresh Token
- æˆæƒæ¨¡å‹ï¼šRole + Policyï¼ˆå¯æ‰©å±•åˆ°èµ„æºçº§ï¼‰
- å®¡è®¡ï¼šæ‰€æœ‰æ•æ„Ÿæ“ä½œè®°å½•æ“ä½œè€…ã€æ—¶é—´ã€å‚æ•°æ‘˜è¦

---

## 11. æµ‹è¯•ç­–ç•¥
| ç±»å‹ | å·¥å…· | è¦†ç›–é‡ç‚¹ |
|------|------|----------|
| å•å…ƒæµ‹è¯• | xUnit / FluentAssertions | é¢†åŸŸæœåŠ¡ã€åº”ç”¨æœåŠ¡é€»è¾‘ |
| é›†æˆæµ‹è¯• | WebApplicationFactory | API ç«¯ç‚¹ã€æ•°æ®åº“äº¤äº’ |
| ç«¯åˆ°ç«¯ | Playwright (å¯é€‰) | å…³é”®ç”¨æˆ·è·¯å¾„ |
| æ€§èƒ½æµ‹è¯• | BenchmarkDotNet / k6 | å½’æ¡£æ‰§è¡Œå…³é”®è·¯å¾„ |
| å›å½’æµ‹è¯• | æµ‹è¯•é›†è„šæœ¬ | ç‰ˆæœ¬å‡çº§åå…³é”®åŠŸèƒ½ |

---

## 12. æ€§èƒ½ä¸ä¼˜åŒ–å»ºè®®
- Dapperï¼šç”¨äºé«˜é¢‘ã€æ‰¹é‡ã€å¯¼å‡ºå¯¼å…¥åœºæ™¯
- EFï¼šå¼€å¯æ— è·Ÿè¸ªæŸ¥è¯¢ `AsNoTracking()` é™ä½å†…å­˜
- æ‰¹å¤„ç†ï¼šåˆ†æ‰¹åˆ†é¡µè¯»å–é¿å…å¤§äº‹åŠ¡
- è¿æ¥æ± ï¼šè®¾ç½®æœ€å°/æœ€å¤§æ± å¹¶ç›‘æ§é˜»å¡
- ç¼“å­˜ï¼šå…ƒæ•°æ®/é…ç½®è¯»å¤šå†™å°‘å¯åŠ å†…å­˜ç¼“å­˜æˆ–Redis
- æŒ‡æ ‡ç›‘æ§ï¼šå½’æ¡£è€—æ—¶ã€ååé‡ã€å¤±è´¥ç‡

---

## 13. å¼‚æ­¥ä¸åå°ä»»åŠ¡
- ä½¿ç”¨ `IHostedService` / `BackgroundService` å®ç°è°ƒåº¦è½®è¯¢
- ä½¿ç”¨ `Channel<T>` æˆ– `System.Threading.Channels` å®ç°ä»»åŠ¡é˜Ÿåˆ—
- ä»»åŠ¡çŠ¶æ€è¡¨æŒä¹…åŒ– + å†…å­˜å­—å…¸åŠ é€ŸæŸ¥è¯¢
- å¤±è´¥é‡è¯•ç­–ç•¥ï¼šæŒ‡æ•°é€€é¿ + æœ€å¤§æ¬¡æ•°

---

## 14. éƒ¨ç½²ä¸äº¤ä»˜
| é˜¶æ®µ | å·¥å…· | å†…å®¹ |
|------|------|------|
| æ„å»º | dotnet CLI | æ°å½“åˆ†å±‚æ„å»º Docker é•œåƒ |
| CI | GitHub Actions / Azure DevOps | ç¼–è¯‘ + æµ‹è¯• + æ‰«æ |
| CD | å®¹å™¨å¹³å°ï¼ˆk8sï¼‰ | è“ç»¿æˆ–æ»šåŠ¨å‘å¸ƒ |
| é…ç½® | ç¯å¢ƒå˜é‡ / Secret | è¿æ¥ä¸²ã€å¯†é’¥ã€ç›®å½•è·¯å¾„ |
| è¿½è¸ª | OpenTelemetry (å¯é€‰) | Trace + Metrics + Logs |

---

## 15. è´¨é‡æ£€æŸ¥æ¸…å•ï¼ˆæäº¤å‰ï¼‰
- [ ] æ–°å¢ä»£ç å·²è¦†ç›–å•å…ƒæµ‹è¯•
- [ ] æ²¡æœ‰æ— ç”¨/è°ƒè¯•ä»£ç  (Console.WriteLine)
- [ ] æ‰€æœ‰å…¬å…±æ–¹æ³•å…·å¤‡æ³¨é‡Š
- [ ] EFè¿ç§»æ˜¯å¦åŒæ­¥ï¼ˆå¦‚æœ‰æ¨¡å‹å˜æ›´ï¼‰
- [ ] é…ç½®é¡¹æ˜¯å¦é›†ä¸­ç®¡ç†
- [ ] æ—¥å¿—çº§åˆ«åˆç†
- [ ] SQLè¯­å¥å·²å‚æ•°åŒ–
- [ ] å¼‚å¸¸æ²¡æœ‰è¢«åæ‰

---

## 16. æ¸è¿›å¼å¢å¼ºå»ºè®®ï¼ˆåç»­ï¼‰
| ä¼˜å…ˆçº§ | åŠŸèƒ½ | ä»·å€¼ |
|--------|------|------|
| ä¸­ | API é™æµ | é˜²æ­¢æ¶æ„è°ƒç”¨ |
| é«˜ | ä»»åŠ¡è¿›åº¦å®æ—¶æ¨é€ | æå‡ä½“éªŒ |
| ä¸­ | æŒ‡æ ‡ç›‘æ§ä»ªè¡¨ç›˜ | å¯è§‚æµ‹æ€§å¢å¼º |
| ä½ | å¤šæ•°æ®åº“ç±»å‹æ’ä»¶ | å¯æ‰©å±•å¸‚åœº |
| ä¸­ | è§„åˆ™è„šæœ¬åŒ–ï¼ˆLua/è¡¨è¾¾å¼ï¼‰ | çµæ´»é…ç½® |

---

*æœ¬è§„èŒƒä¸ºç¬¬ä¸€ç‰ˆï¼Œå¯éšè¿­ä»£è¿›è¡Œç‰ˆæœ¬æ¼”è¿›ã€‚æ‰€æœ‰æ–°å¢çº¦å®šéœ€åœ¨ PR ä¸­è¯´æ˜å¹¶æ›´æ–°æœ¬æ–‡æ¡£ã€‚*
