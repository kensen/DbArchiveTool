# 分区边界值明细管理功能规划设计

## 1. 背景及目标

分区管理界面「分区边界值明细」目前仅提供数据展示能力，缺乏对分区边界的增删改及分区切换等操作。为了统一交互体验、提升数据库操作安全性，并复用现有的执行监控体系，本次规划覆盖以下四项功能：

- 添加分区值
- 拆分分区
- 合并分区
- 切换分区（重点，需与旧工具的归档能力对齐但兼顾安全控制）

所有功能均以子控件的方式封装，实现与主表格的低耦合交互，并符合 SQL Server 分区最佳实践。

## 2. 总体设计原则

1. **组件化封装**：每个操作对应一个 Blazor 子组件，置于 `Pages/Partitions/Components/Boundaries/` 目录，主界面通过参数与事件回调进行交互。
2. **向导式体验**：执行流程超过两步或存在复杂校验时，使用步骤式向导（Ant Design `Steps`+`Modal`/`Drawer` 组件），提供清晰的操作指导。
3. **安全优先**：所有操作在执行前进行完整预检（边界合法性、文件组、索引、约束、锁定状态等），并在可行时提供“导出脚本”而非直接执行。
4. **审计与监控**：最终执行通过后台服务入队 `PartitionExecutionTask`，使得执行进度、日志、失败恢复与现有平台保持一致。
5. **一致性体验**：UI 风格延续现有分区管理页面，包括表单、提示、成功/失败反馈以及导航联动。

## 3. 子控件规划

### 3.1 添加分区值（`PartitionBoundaryAddDialog`）

- **触发形式**：主界面按钮 → 弹出小型对话框。
- **核心表单**：
  - 新边界值（类型根据分区列自动适配）
  - 目标文件组（下拉选择，可选“自动选择”）
  - 是否预热数据（布尔选项，为后续扩展预留）
- **前端校验**：
  - 边界顺序合法性（结合 Range Left/Right）
  - 格式、重复值检查
  - 文件组存在性（读取配置）
- **后端流程**：
  - `POST /api/v1/partition-configurations/{id}/boundaries`
  - 应用层校验：验证新边界位置、文件组有效、配置未锁定
  - 基础架构层执行 `ALTER PARTITION FUNCTION … SPLIT RANGE` 并登记日志
- **执行反馈**：成功后显示提示信息并触发 `OnCompleted` 回调刷新主表。

### 3.2 拆分分区（`PartitionSplitWizard`）

- **交互形式**：三步向导（Drawer 或 Modal）。

| 步骤 | 内容 | 说明 |
| --- | --- | --- |
| Step 1 | 选择待拆分分区 | 表格展示现有分区边界、行数、文件组、数据量；支持搜索 |
| Step 2 | 设置新边界 | 输入新边界值，实时显示拆分后左右分区范围与预计行数 |
| Step 3 | 预览执行计划 | 展示 SQL 脚本、索引重建计划、风险提示、备份提醒 |

- **后端接口**：`POST /partition-configurations/{id}/boundaries/split`
- **关键校验**：
  - 新边界需位于目标分区内部
  - 对齐检查：索引、文件组映射、统计信息
  - 执行前要求确认最近一次备份时间，必要时阻止执行
- **执行策略**：
  - 所有 SQL 置于事务内；失败立即回滚
  - 记录执行快照及日志，自动发起统计更新任务

### 3.3 合并分区（`PartitionMergeWizard`）

- **交互**：与拆分类似的三步向导。

| 步骤 | 内容 | 说明 |
| --- | --- | --- |
| Step 1 | 选择起始分区 | 仅允许选择有相邻下一分区的记录 |
| Step 2 | 确认合并结果 | 展示合并后范围、目标文件组、数据量、统计差异 |
| Step 3 | 预览执行计划 | `ALTER PARTITION FUNCTION … MERGE RANGE`、索引重建、风险提示 |

- **后端接口**：`POST /partition-configurations/{id}/boundaries/merge`
- **校验重点**：
  - 两个分区必须相邻且无待执行任务
  - 数据量过大时提前警告并建议离峰执行
  - 确保没有活跃的分区切换/拆分任务持有锁
- **安全措施**：执行前自动暂停相关调度任务、执行后更新统计并恢复。

### 3.4 数据归档（原“切换分区”）——重点

- **功能定位**：统一归档入口，提供三种方案占位：
  1. **按分区切换归档**（立即支持）：在主表与辅助表之间执行 `SWITCH PARTITION`，适用于归档库与业务库位于同一实例的场景。
  2. **按 BCP 执行归档**（预留）：利用 `bcp` 工具导出分区数据并导入目标实例。
  3. **按 BulkCopy 执行归档**（预留）：基于 `SqlBulkCopy` 或自研批量写入逻辑，实现跨实例高速归档。
- **交互**：四步向导，首步新增方案选择。

| 步骤 | 内容 | 说明 |
| --- | --- | --- |
| Step 1 | 选择归档方案 | 用户在三种方案中择一；若选择 BCP/BulkCopy，展示“即将支持/敬请期待”提示并提供占位表单，后续迭代填充执行逻辑 |
| Step 2 | 方案配置 | 对于分区切换，选择源分区与目标表；对于 BCP/BulkCopy，录入目标实例连接与映射信息（先占位） |
| Step 3 | 预检 | 分区切换执行严密校验；BCP/BulkCopy 当前展示必备条件与预备清单（例如网络带宽、磁盘空间、权限等） |
| Step 4 | 执行确认 | 分区切换展示最终 SQL；其他方案提供操作指南及“生成脚本/命令”占位，后续版本启用真实执行 |

- **分区切换方案**（即时实现）
  - 与旧方案一致但入口改为归档操作，详见上一版本描述。
  - 重点应用于同实例场景，依赖结构一致性、索引对齐、文件组可写等前提。

- **BCP 方案预研**
  - **适用场景**：归档库位于不同实例或跨机房。
  - **流程设想**：
    1. 预检分区行数、目标实例连接可用性、网络带宽。
    2. 生成 `bcp` 导出命令（指定查询分区数据、使用临时文件存储）。
    3. 远端导入（可选执行或输出命令交由运维执行）。
    4. 清空源分区（未来可复用分区切换或 DELETE+压缩方式）。
  - **注意事项**：
    - 临时文件存储空间、路径权限、加密传输。
    - 大文件传输失败的恢复机制。
    - 导出/导入生成的一致性校验（行数、校验和）。
    - 需预留任务编排，控制长时间运行任务对资源的占用。

- **BulkCopy 方案预研**
  - **适用场景**：跨实例但在受控网络环境，可以直接连接目标实例。
  - **流程设想**：
    1. 使用 `SqlBulkCopy` 读取分区内数据流式写入目标表。
    2. 支持事务控制与批次提交，提高失败可恢复性。
    3. 导入完成后再清理源分区或执行 SWITCH 至空表。
  - **注意事项**：
    - 内存与批次大小控制，避免长事务。
    - 目标实例的表结构同步与索引管理。
    - 网络失败重试、超时处理、并发限制。

- **预留占位实现**：
  - UI：在向导 Step1 中展示三种选项，后两者标记为“规划中”，并在 Step2 提供只读提示和需求收集字段（如目标连接字符串、目标表）。
  - 服务层：定义接口 `ArchiveUsingBcpAsync`、`ArchiveUsingBulkCopyAsync`，当前返回“功能规划中”，并记录用户选择以便后续调研。

- **与旧工具差异**：
  - 旧工具仅支持分区切换方式，且直接执行。
  - 新设计针对跨实例归档需求预留扩展方案，提供统一入口与审计记录。
  - 后续实现 BCP/BulkCopy 时可复用向导框架、预检机制与执行监控。

## 4. 后端服务扩展

1. **应用层接口调整**
   - `IPartitionConfigurationAppService`：增加 `AddBoundaryAsync`、`SplitBoundaryAsync`、`MergeBoundariesAsync`
   - 新增 `IPartitionSwitchAppService`：提供 `InspectAsync`、`SwitchAsync`
2. **API 层**
   - `PartitionManagementController` 创建新路由 `/boundaries/add|split|merge`
   - `PartitionSwitchController` 负责预检与执行
3. **执行层**
   - 复用 `SqlPartitionCommandExecutor`，新增命令封装类 `SplitPartitionCommand`、`MergePartitionCommand`、`SwitchPartitionCommand`
   - 执行任务统一写入 `PartitionExecutionTask`，方便监控及重试
4. **日志与审计**
   - 每次操作记录到 `PartitionAuditLog`：执行人、时间、对象、预检结果、SQL 脚本
   - 执行失败提供完整堆栈追踪，便于排查
5. **任务调度平台对接**
   - 所有操作默认写入任务调度平台的统一任务表（扩展 `PartitionExecutionTask` 增加 `OperationType` 字段，区分 Add/Split/Merge/Archive）
   - 归档相关任务追加 `ArchiveTargetInfo`（目标实例、目标表、方案类型）
   - 日志统一写入调度平台日志表，新增 `ArchiveExecutionLog` 仅作为冗余视图，UI 侧通过 `OperationType` 聚合展示

## 5. 安全控制与最佳实践

- **事务与回滚**：所有 DDL 操作在 `TRY/CATCH` 中执行，开启 `XACT_ABORT ON`，确保失败即回滚。
- **最小锁定**：执行前提醒关闭长事务，必要时提供“离峰执行”提示。
- **备份策略**：向导中要求用户勾选“已完成备份”，并记录到执行日志。
- **索引/统计维护**：拆分、合并、切换后自动触发索引重建或统计更新任务。
- **权限校验**：后端在执行前验证当前用户是否具备 ALTER、CONTROL 权限；缺失时直接阻止。
- **资源保护**：检测文件组剩余空间、数据库可写状态、磁盘压力；不满足条件时提示阻断。
- **脚本导出**：提供导出功能，便于 DBA 审核；导出的 SQL 附注执行顺序与回滚方案。

## 6. 测试与验证计划

1. **单元测试**
   - 边界校验逻辑：重复、顺序、范围合法性
   - 切换预检：结构不匹配、索引缺失、约束不合规时返回阻塞
2. **集成测试**
   - 基于本地 SQL Server 搭建分区样例库，验证成功/失败路径
   - 模拟大数据量拆分与合并，确保性能及超时控制
3. **UI 自动化**
   - 编写 Playwright 脚本覆盖四个向导关键流程
   - 验证导出脚本、执行后刷新、错误提示
4. **安全演练**
   - 注入权限不足、文件组只读、统计过期、活跃事务等异常，确认提示准确
   - 验证执行失败时无残留半成脚本或锁

## 7. 参考资料

- Microsoft Docs：《Partitioned Tables and Indexes》、`ALTER PARTITION FUNCTION`、`ALTER TABLE … SWITCH`
- SQL Server 官方最佳实践：备份策略、索引对齐、CHECK 约束匹配、统计更新
- 现有旧版归档工具执行流程与脚本模板，用于归档方案差异对比与复用

## 8. 任务调度平台兼容性与 UI 调整

1. **任务模型调整**
   - `PartitionExecutionTask` 增加 `OperationType`（枚举：AddBoundary、SplitBoundary、MergeBoundary、ArchiveSwitch、ArchiveBcp、ArchiveBulkCopy 等），并新增 `ArchiveScheme`、`TargetConnection`、`TargetTable` 字段用于归档方案记录。
   - 对归档占位方案（BCP/BulkCopy）当用户选择后也创建任务条目，状态设为 `Planned`，便于后续统计。

2. **日志模型**
   - 继续复用 `PartitionExecutionLog`，新增 `Category` 枚举值（如 `Archive`, `BcpExport`, `BulkCopy`），保证新旧任务日志可在同一列表展示。
   - 预期新增归档日志表可作为视图或物化表提供给报表系统使用，但调度平台 UI 读取统一视图，避免双重维护。

3. **UI 变更点**
   - 任务列表新增列“操作类型”“归档方案”“目标实例/库”，以区分不同任务。
   - 详情页根据 `OperationType` 决定展示的核心信息：例如归档任务展示目标库连接、BCP/BulkCopy 命令脚本，分区操作则展示边界变化。
   - 日志面板新增过滤器，可按操作类型或归档方案筛选。
   - 针对占位方案，UI 显示“规划中”状态及提示文案，避免用户误判为执行失败。

4. **兼容策略**
   - 历史分区执行任务默认将 `OperationType` 标记为 `Unknown`（迁移脚本补全），日志默认归为 `Partition`.
   - 任务调度平台 API 增加版本号，前端按新字段进行兼容渲染；旧版前端若未更新仍可获取必需字段。

5. **后续扩展**
   - 当 BCP/BulkCopy 真正落地时，可在任务详情中嵌入执行进度（文件生成、传输、导入三个阶段），同时在日志中细化步骤记录。
   - 提供导出执行摘要到审计中心的接口，实现审计统一归档。

---

本规划作为后续开发的实施蓝图，可在需求评审后细化任务分工并进入开发阶段。任何新增规范或约束会在文档中持续更新。
