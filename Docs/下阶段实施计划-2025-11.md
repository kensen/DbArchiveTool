# 数据归档工具下阶段实施计划（2025年11月）

> **制定日期**：2025-11-04  
> **状态**：待启动  
> **负责人**：开发团队

---

## 📊 当前项目状态总结

### ✅ 已完成功能（Milestone A-C）

1. **分区边界值管理**（Milestone A & B）
   - ✅ 添加分区值（单值/批量生成）
   - ✅ 分区拆分（2步向导）
   - ✅ 分区合并（2步向导）
   - ✅ 后台任务执行与日志记录

2. **数据归档功能**（Milestone C）
   - ✅ 4步向导（方案选择 → 参数配置 → 预检 → 执行）
   - ✅ 预检服务（结构/索引/约束/权限/锁检查）
   - ✅ 自动补齐执行器（6种修复步骤）
   - ✅ 后台任务执行（8阶段流程）
   - ✅ 批量归档支持
   - ✅ 安全增强（残留数据检测改为阻断模式）

### ⚠️ 已知问题与限制

1. **已有分区对齐问题**
   - **现象**：非工具创建的分区可能无法直接归档
   - **原因**：分区方案、索引、约束定义与工具规范不一致
   - **影响**：预检阶段识别为 Blocker 并阻止执行
   - **当前处理**：提示用户手动调整

2. **文档缺失**
   - 无用户操作手册，用户学习成本高
   - 缺少常见问题处理指南
   - 已有分区对齐问题无文档支持

3. **测试覆盖不足**
   - 已有分区归档场景未充分测试
   - 缺少复杂对齐问题场景验证

---

## 🎯 下阶段目标（2025年11月）- 已调整

### 目标1：BCP/BulkCopy 归档方案开发（**最高优先级** 🔥）
**目标**：实现跨实例数据归档能力，支持不同权限级别和场景需求。

**核心需求**：
1. **BCP 方案**：面向高权限管理员，基于文件导出/导入
2. **BulkCopy 方案**：面向普通权限用户，基于流式传输
3. **目标数据库配置**：用户可配置不同的目标数据库连接
4. **定时任务支持**：BulkCopy 支持后台长期定时任务
5. **扩展性**：为后续普通表归档预留架构

**交付物**：
1. 目标数据库配置管理功能
2. BCP 归档实现（高权限模式）
3. BulkCopy 归档实现（普通权限模式）
4. 后台定时任务调度框架
5. 用户操作手册与最佳实践

### 目标2：完善分区切换文档（中优先级）
**目标**：为已完成的分区切换功能提供完整文档支持。

**交付物**：
1. 用户操作手册（分区切换部分）
2. 预检查功能详解
3. FAQ 与常见故障处理指南
4. 最佳实践建议

### 目标3：性能优化与监控（后续规划）
**目标**：优化大数据量归档性能，完善监控与告警机制。

**交付物**：
1. 性能基准测试报告
2. 性能优化方案
3. 监控与告警增强

---

## 📋 任务清单（已调整）

### 阶段1：BCP/BulkCopy 技术设计与原型（优先级：P0 🔥）
**预计工期**：10-12个工作日  
**目标完成日期**：2025-11-20

#### 任务1.1：BCP/BulkCopy 技术设计（3天）
- [ ] **需求分析**（1天）
  - [ ] 明确 BCP vs BulkCopy 使用场景
  - [ ] 定义权限级别要求（管理员 vs 普通用户）
  - [ ] 分析定时任务需求
  - [ ] 评估扩展性要求（为普通表归档预留）

- [ ] **架构设计**（1天）
  - [ ] 设计目标数据库配置管理模块
  - [ ] 设计归档方案选择逻辑
  - [ ] 设计后台任务调度框架
  - [ ] 设计进度跟踪与日志记录
  - [ ] 设计错误处理与重试机制

- [ ] **数据模型设计**（1天）
  - [ ] 目标数据库连接配置表
  - [ ] 归档任务配置表（含方案类型）
  - [ ] 定时任务调度表
  - [ ] 扩展 BackgroundTask 支持新方案

#### 任务1.2：目标数据库配置管理（2天）
- [ ] **后端开发**（1天）
  - [ ] 数据库连接配置 CRUD API
  - [ ] 连接测试功能
  - [ ] 权限验证（BCP需要高权限，BulkCopy普通权限）
  - [ ] 加密存储连接字符串

- [ ] **前端开发**（1天）
  - [ ] 目标数据库配置页面
  - [ ] 连接测试界面
  - [ ] 归档向导中的目标库选择

#### 任务1.3：BCP 方案实现（3天）
- [ ] **核心功能开发**（2天）
  - [ ] BCP 导出逻辑（数据 → 文件）
  - [ ] BCP 导入逻辑（文件 → 目标库）
  - [ ] 格式文件生成（保持列映射）
  - [ ] 文件清理与管理
  - [ ] 事务控制与回滚

- [ ] **集成与测试**（1天）
  - [ ] 集成到归档向导
  - [ ] 权限检查（需要高权限）
  - [ ] 错误处理测试
  - [ ] 大数据量测试

#### 任务1.4：BulkCopy 方案实现（3天）✨ **技术决策已确认**
> **技术选型**：使用 **Dapper** 实现，保持与项目 `ISqlExecutor`、`SqlExecutor` 的技术栈一致性

- [ ] **核心功能开发**（2天）
  - [ ] 基于 Dapper 的批量读取（OFFSET-FETCH 分页）
  - [ ] 基于 Dapper 的批量插入（参数化 INSERT）
  - [ ] 列映射自动识别（INFORMATION_SCHEMA）
  - [ ] 批次控制（BatchSize, 默认 10000）
  - [ ] 进度回调（已传输行数与百分比）
  - [ ] 事务控制（批次级回滚保护）
  - [ ] 错误处理与日志记录

- [ ] **集成与测试**（1天）
  - [ ] 集成到归档向导
  - [ ] 权限检查（普通 INSERT 权限即可）
  - [ ] 网络超时处理（CommandTimeout=0）
  - [ ] 大数据量测试（100万+ 行）
  - [ ] 性能对比（与 SqlBulkCopy 对比验证）

#### 任务1.5：定时任务调度框架（2天）✨ **框架已选定：Hangfire**
> **框架选型**：选择 **Hangfire**，原因：内置 Dashboard、易用性高、集成简单  
> 详见：[技术选型-Hangfire vs Quartz.md](./技术选型-Hangfire%20vs%20Quartz.md)

- [ ] **后端开发**（1.5天）
  - [ ] 安装 NuGet 包（Hangfire.Core, Hangfire.SqlServer, Hangfire.AspNetCore）
  - [ ] 配置 Hangfire 服务（Program.cs, SQL Server 存储）
  - [ ] 启用 Hangfire Dashboard（/hangfire 路由）
  - [ ] 实现 `IJobScheduler` 接口
  - [ ] 实现 `HangfireJobScheduler`（RecurringJob 管理）
  - [ ] 定时任务配置（Cron 表达式）
  - [ ] 任务执行方法（`[AutomaticRetry]` 特性）
  - [ ] 并发控制（`[DisableConcurrentExecution]`）
  - [ ] 失败重试策略（3次，延迟 1/5/15 分钟）

- [ ] **前端开发**（0.5天）
  - [ ] 定时任务配置页面（嵌入到归档配置）
  - [ ] Hangfire Dashboard 集成（iframe 或链接跳转）
  - [ ] 权限控制（HangfireAuthorizationFilter, 仅管理员访问）
  - [ ] 手动触发任务

**负责人**：架构师 + 后端开发 + 前端开发  
**验收标准**：
- BCP 和 BulkCopy 两种方案均可运行
- 目标数据库配置管理功能完整
- 定时任务调度正常运行
- 支持至少 100 万行数据归档测试
- 权限验证正确（BCP高权限，BulkCopy普通权限）

---

## ✅ 阶段1最小颗粒度 TODO 清单（按执行顺序）

### 1. 基础设施与数据库准备
- [x] `ArchiveMethod` 枚举扩展：在 Domain 层新增 `ArchiveMethodType.Bcp`/`BulkCopy`
- [x] `BackgroundTaskOperationType` 扩展：补充 `ArchiveBcp`、`ArchiveBulkCopy` 常量（原有枚举已满足）
- [ ] 新增迁移脚本初始化（Infrastructure.Migrations）：创建 `PartitionArchive_TargetDatabaseConfig`、`PartitionArchive_ScheduledTask` 表及字段扩展

### 2. 目标数据库配置管理
- [ ] Domain：新增 `TargetDatabaseConfig` 聚合、`TargetDatabasePermissionLevel` 枚举，补充工厂与验证（中文 `///` 注释）
- [ ] Domain：定义 `ITargetDatabaseConfigRepository` 与 `ITargetDatabaseConnectionTester` 接口
- [ ] Infrastructure(EF)：新增实体映射 `TargetDatabaseConfigEntity`、`TargetDatabaseConfigConfiguration`
- [ ] Infrastructure(EF)：实现 `TargetDatabaseConfigRepository`（含加密字段持久化）
- [ ] Infrastructure：实现 `DataProtectionConnectionStringEncryptor`（IDataProtectionProvider）
- [ ] Infrastructure：实现 `SqlPermissionInspector`（判断 bulkadmin/sysadmin / INSERT 权限）
- [ ] Application：新增 DTO（列表项/详情/创建/更新/测试），实现 `TargetDatabaseConfigCommandService` 与 `QueryService`
- [ ] API：新增 `TargetDatabaseConfigsController`（CRUD + 测试连接 + 权限检测）
- [ ] Web：新增 Razor 页面组件（列表 + 新建/编辑对话框 + 权限提醒）
- [ ] Tests：为 Application/Infrastructure 编写单元测试（加密器、权限检测、服务流程）

### 3. BCP 归档方案实现
- [ ] Domain：在归档策略工厂中注册 `BcpArchiveMethod`
- [ ] Infrastructure：实现 `BcpCommandBuilder`（导出/导入命令、参数转义）
- [ ] Infrastructure：实现 `BcpFileManager`（临时目录、清理策略、并发文件锁）
- [ ] Infrastructure：实现 `BcpArchiveExecutor`（调用 bcp.exe、解析返回码、错误处理）
- [ ] Application：在归档编排服务中接入 BCP 流程（含权限校验、日志记录）
- [ ] API/Web：更新归档向导可选择 BCP，展示高权限提醒与参数输入
- [ ] Tests：编写命令生成单元测试、模拟执行器集成测试（可使用 Fake bcp.exe）

### 4. BulkCopy（Dapper）归档方案实现
- [ ] Infrastructure：实现 `DapperBulkCopyExecutor`（分批读取、批量插入、进度回调）
- [ ] Infrastructure：实现 `BulkCopyColumnMappingProvider`（信息架构查询 + 映射缓存）
- [ ] Infrastructure：补充批次事务与错误处理策略（含超时设置）
- [ ] Application：扩展归档编排服务，接入 BulkCopy 分支、进度上报
- [ ] API/Web：归档向导新增 BulkCopy 选项，配置批次大小、超时、断点续传开关
- [ ] Tests：性能基准基线脚本（10万/100万数据），编写单元 + 集成测试

### 5. 定时任务调度（Hangfire）
- [ ] 安装并配置 Hangfire 服务（Program.cs 注入、Worker 队列、Dashboard 授权）
- [ ] 实现 `HangfireJobScheduler`（新增/更新/暂停/恢复/触发/删除 API）
- [ ] 实现 `ArchiveJobExecutor`（调用归档编排服务，使用 `[AutomaticRetry]`、`[DisableConcurrentExecution]`）
- [ ] Application：新增 `ScheduledTaskCommandService`、`ScheduledTaskQueryService`
- [ ] API：新增 `ScheduledTasksController`（CRUD + 手动执行）
- [ ] Web：新增定时任务管理界面（列表、创建、Cron 帮助、执行历史）
- [ ] Tests：编写 Scheduler 单元测试（使用 Hangfire MemoryStorage）

### 6. 跨领域收尾
- [ ] 更新 `BCP-BulkCopy技术设计.md` 进度标记与关键截图
- [ ] 更新数据模型图/ER 图，确保 Docs 对应章节同步
- [ ] 编写端到端手动验证脚本（BCP 与 BulkCopy 各一套）
- [ ] 在 `项目状态报告` 中记录里程碑与风险应对

---

### 阶段2：分区切换文档完善（优先级：P1）
**预计工期**：5个工作日  
**目标完成日期**：2025-11-27

#### 任务2.1：用户操作手册
- [ ] **分区切换完整流程**（2天）
  - [ ] 创建分区配置（含截图）
  - [ ] 添加/拆分/合并边界值
  - [ ] 数据归档4步向导详解
  - [ ] 批量归档操作说明
  - [ ] 任务监控与日志查看

- [ ] **预检查功能详解**（1天）
  - [ ] 12项检查内容说明
  - [ ] Blocker/AutoFix/Warning 解读
  - [ ] 自动补齐功能使用指南
  - [ ] 手动修复步骤详解

- [ ] **最佳实践建议**（1天）
  - [ ] 分区设计建议
  - [ ] 归档策略建议
  - [ ] 性能优化建议
  - [ ] 安全注意事项

#### 任务2.2：FAQ 与故障处理指南
- [ ] **常见错误与解决方案**（1天）
  - [ ] 预检失败类问题（10+场景）
  - [ ] 自动补齐失败类问题
  - [ ] 后台任务执行失败类问题
  - [ ] 索引未对齐、约束不匹配处理

**负责人**：技术写作 + 开发团队协助  
**验收标准**：
- 文档完整覆盖分区切换功能
- 包含至少15个实际截图
- 至少包含20个常见问题及解决方案

---

### 阶段3：性能优化与监控（优先级：P2，后续规划）
**预计工期**：4-5个工作日  
**目标完成日期**：待定

此阶段暂缓，优先完成 BCP/BulkCopy 功能开发

---

## 📅 时间规划（已调整）

| 阶段 | 任务 | 预计工期 | 目标完成日期 | 优先级 | 状态 |
|------|------|----------|--------------|--------|------|
| 阶段1 | BCP/BulkCopy 技术设计 | 3天 | 2025-11-07 | P0 🔥 | ⏳ 待启动 |
| 阶段1 | 目标数据库配置管理 | 2天 | 2025-11-11 | P0 🔥 | ⏳ 待启动 |
| 阶段1 | BCP 方案实现 | 3天 | 2025-11-14 | P0 🔥 | ⏳ 待启动 |
| 阶段1 | BulkCopy 方案实现 | 3天 | 2025-11-18 | P0 🔥 | ⏳ 待启动 |
| 阶段1 | 定时任务调度框架 | 2天 | 2025-11-20 | P0 🔥 | ⏳ 待启动 |
| 阶段2 | 用户操作手册（分区切换） | 4天 | 2025-11-25 | P1 | ⏳ 待启动 |
| 阶段2 | FAQ 与故障指南 | 1天 | 2025-11-27 | P1 | ⏳ 待启动 |
| 阶段3 | 性能优化与监控 | 待定 | 待定 | P2 | 📋 后续规划 |

**关键里程碑**：
- 📅 **2025-11-20**：BCP/BulkCopy 功能开发完成（Milestone D）🔥
- 📅 **2025-11-27**：分区切换文档完成
- 📅 **2025-12月**：性能优化与普通表归档规划（Milestone E）

---

## 🎯 成功标准（已调整）

### BCP/BulkCopy 功能完成标准（P0 🔥）
- ✅ **目标数据库配置管理**：
  - 支持多个目标数据库配置
  - 连接测试功能正常
  - 连接字符串加密存储
  - 权限级别验证（BCP高权限 vs BulkCopy普通权限）

- ✅ **BCP 方案**：
  - 数据导出到文件成功
  - 文件导入到目标库成功
  - 格式文件自动生成
  - 支持至少 100 万行数据
  - 错误处理与回滚机制完善
  - 需要高权限（bulkadmin 或 sysadmin）

- ✅ **BulkCopy 方案**：
  - 流式传输正常运行
  - 列映射自动处理
  - 批次控制可配置
  - 进度回调实时更新
  - 支持至少 100 万行数据
  - 普通权限即可运行（INSERT 权限）
  - 断点续传机制（可选）

- ✅ **定时任务调度**：
  - 支持 Cron 表达式配置
  - 任务执行日志完整
  - 失败自动重试
  - 手动触发功能
  - 任务启用/禁用/删除

- ✅ **架构扩展性**：
  - 为后续普通表归档预留接口
  - 支持不同归档源类型扩展

### 文档完成标准（P1）
- ✅ 分区切换用户操作手册完整，包含 15+ 截图
- ✅ 预检查功能详解清晰
- ✅ FAQ 包含 20+ 常见问题及解决方案
- ✅ BCP/BulkCopy 使用说明完整

---

## 🚀 风险与依赖（已调整）

### 风险识别
1. **BCP 文件管理复杂度**
   - 风险：临时文件清理、磁盘空间管理、并发文件冲突
   - 缓解：设计完善的文件生命周期管理，定期清理策略

2. **BulkCopy 网络稳定性依赖**
   - 风险：跨实例大数据量传输可能超时或中断
   - 缓解：实现断点续传、批次控制、超时重试机制

3. **权限验证准确性**
   - 风险：权限检查不准确导致运行时失败
   - 缓解：在连接测试阶段提前验证权限，提供明确提示

4. **定时任务调度稳定性**
   - 风险：长期运行的定时任务可能出现内存泄漏或死锁
   - 缓解：选择成熟的调度框架（Hangfire/Quartz），完善监控

5. **跨实例兼容性**
   - 风险：不同 SQL Server 版本间的兼容性问题
   - 缓解：测试覆盖主流版本（2016/2017/2019/2022）

### 外部依赖
- 需要跨实例测试环境（不同网络/不同版本）
- BCP 需要高权限测试账号
- BulkCopy 需要普通权限测试账号
- 需要大数据量测试数据（> 100万行）
- 需要网络带宽测试（跨机房场景）

---

## 📝 备注

1. **优先级调整**：BCP/BulkCopy 功能为最高优先级，文档编写次之
2. **诊断工具取消**：当前预检查功能已足够完善，不再单独开发诊断工具
3. **扩展性设计**：架构设计需为普通表归档预留接口（后续独立规划）
4. **权限分级**：
   - **BCP 方案**：适合高权限管理员（bulkadmin/sysadmin），基于文件中转
   - **BulkCopy 方案**：适合普通权限用户（INSERT 权限），基于流式传输
   - 用户可在归档向导中根据权限情况选择合适方案
5. **定时任务场景**：BulkCopy 特别适合后台长期定时任务，无需文件管理

---

**制定人**：开发团队  
**审批人**：项目负责人  
**最后更新**：2025-11-04（已根据反馈调整）
