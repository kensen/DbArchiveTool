# 归档配置管理页面实现完成总结

## 实现时间
2025-01-XX

## 实现内容

### 1. 创建的文件

#### 1.1 Blazor 页面组件
- **文件**: `src/DbArchiveTool.Web/Pages/ArchiveConfigurations.razor`
- **路由**: `/archive-configurations`
- **功能**: 归档配置的完整 CRUD 管理界面

#### 1.2 API 客户端服务
- **文件**: `src/DbArchiveTool.Web/Services/ArchiveConfigurationApiClient.cs`
- **功能**: 封装与归档配置 API 的 HTTP 通信

### 2. 修改的文件

#### 2.1 服务注册
- **文件**: `src/DbArchiveTool.Web/Program.cs`
- **修改内容**: 添加 `ArchiveConfigurationApiClient` 的 HttpClient 注册

#### 2.2 导航菜单
- **文件**: `src/DbArchiveTool.Web/Shared/MainLayout.razor`
- **修改内容**: 添加"归档配置"菜单项，图标为 `setting`

### 3. 页面功能详情

#### 3.1 页面结构
- **标题**: 归档配置管理
- **布局**: PageContainer + Card + Table + Modal + Drawer

#### 3.2 数据筛选
- **数据源筛选**: 下拉选择框，支持"全部数据源"
- **状态筛选**: 下拉选择框，支持"全部状态"、"已启用"、"已禁用"
- **查询按钮**: 应用筛选条件刷新列表

#### 3.3 列表显示
表格列包括:
- **配置名称**: 归档配置的名称
- **源表**: 显示为 `SchemaName.TableName` 格式
- **分区表**: 蓝色Tag(是) 或 默认Tag(否)
- **归档方式**: 分区切换/BulkCopy/BCP
- **状态**: 成功Tag(已启用) 或 默认Tag(已禁用)
- **上次执行**: 本地时间格式显示
- **上次归档行数**: 千位分隔符格式
- **描述**: 支持省略号截断
- **操作列**: 详情、编辑、启用/禁用、删除

#### 3.4 详情抽屉
- **宽度**: 720px
- **内容**: 使用 Descriptions 组件展示完整配置信息
- **字段**:
  - 基础信息: 配置名称、描述
  - 表信息: 源表、分区表标记
  - 归档配置: 归档方式、批次大小、删除源数据标记
  - 过滤条件: 过滤列、过滤条件(如果有)
  - 执行信息: 上次执行时间、状态、归档行数
  - 审计信息: 创建时间、创建人、更新时间、更新人

#### 3.5 创建/编辑模态框
- **宽度**: 800px
- **字段**:
  - 配置名称 (必填)
  - 描述 (可选)
  - 数据源 (必填，下拉选择)
  - 源架构名 (默认: dbo)
  - 源表名 (必填)
  - 分区表 (Switch 开关)
  - 归档方式 (Radio 按钮组: 分区切换/BulkCopy/BCP)
  - 过滤列 (可选)
  - 过滤条件 (可选)
  - 批次大小 (InputNumber, 100-100000)
  - 删除源数据 (Switch 开关，默认开启)

#### 3.6 操作功能
- **详情**: 打开侧边抽屉显示完整配置信息
- **编辑**: 打开模态框，填充当前配置数据
- **启用/禁用**: 带确认的 Popconfirm，切换配置启用状态
- **删除**: 带确认的 Popconfirm，删除配置
- **新建**: 工具栏按钮，打开空白表单

### 4. API 客户端功能

#### 4.1 方法列表
- `GetAllAsync(dataSourceId?, isEnabled?)`: 获取配置列表(支持筛选)
- `GetByIdAsync(id)`: 获取单个配置详情
- `CreateAsync(model)`: 创建新配置
- `UpdateAsync(id, model)`: 更新配置
- `DeleteAsync(id)`: 删除配置
- `EnableAsync(id)`: 启用配置
- `DisableAsync(id)`: 禁用配置

#### 4.2 模型定义
- **ArchiveConfigurationListItemModel**: 列表项模型(16字段)
- **ArchiveConfigurationDetailModel**: 详情模型(20字段+审计字段)
- **CreateArchiveConfigurationModel**: 创建请求模型(13字段)
- **UpdateArchiveConfigurationModel**: 更新请求模型(13字段)

### 5. 关键技术点

#### 5.1 Ant Design Blazor 组件
- **PageContainer**: 页面容器，带标题和工具栏
- **Table**: 数据表格，支持自定义列模板
- **Modal**: 模态对话框，用于创建/编辑
- **Drawer**: 侧边抽屉，用于详情展示
- **Select**: 下拉选择框，支持清除和筛选
- **Tag**: 标签组件，用于状态显示
- **Popconfirm**: 确认弹窗，用于危险操作
- **Descriptions**: 描述列表，用于详情展示
- **Form/FormItem**: 表单组件
- **InputNumber**: 数字输入框
- **Switch**: 开关组件
- **RadioGroup/Radio**: 单选框组件

#### 5.2 数据绑定
- **@bind-Value**: 双向绑定
- **DataSource**: 表格数据源
- **Visible**: 控制模态框/抽屉显示
- **Loading**: 表格加载状态

#### 5.3 错误处理
- 所有 API 调用使用 try-catch
- 使用 MessageService 显示成功/失败提示
- Message 方法返回 void，直接调用不赋值

#### 5.4 数据转换
- 数据源 API 返回 `Result<IReadOnlyList<ArchiveDataSourceDto>>`
- 需要转换为 `List<DataSourceModel>` 用于 UI 显示
- 服务器名称格式: `{ServerAddress}:{ServerPort}/{DatabaseName}`

### 6. 编译修复记录

#### 6.1 Select 组件嵌套问题
- **错误**: `SelectOptions` 必须直接作为 `Select` 的子元素
- **修复**: 移除 `@if` 外层包裹，放到 `SelectOptions` 内部

#### 6.2 Tag Color 属性
- **错误**: 直接使用 `Color="blue"` 编译失败
- **修复**: 使用 `Color="@("blue")"` 强制字符串类型

#### 6.3 ArchiveMethod 枚举
- **错误**: 使用了不存在的 `SqlBulkCopy` 值
- **修复**: 正确的枚举值是 `BulkCopy`

#### 6.4 InputNumber 组件冲突
- **错误**: 多个组件使用 `InputNumber` 标签
- **修复**: 使用 `AntDesign.InputNumber` 完全限定名称

#### 6.5 Modal OkText/CancelText
- **错误**: 直接使用字符串 `OkText="保存"` 识别为变量
- **修复**: 使用 `OkText="@("保存")"` 显式字符串

#### 6.6 Message 服务调用
- **错误**: 尝试等待或赋值 void 返回值
- **修复**: 直接调用 `Message.Error(...)` 不赋值

### 7. 对应后端 API

#### 7.1 Controller
- **文件**: `src/DbArchiveTool.Api/Controllers/V1/ArchiveConfigurationsController.cs`
- **路由**: `/api/v1/archive-configurations`

#### 7.2 DTOs
- **文件**: `src/DbArchiveTool.Api/DTOs/Archives/ArchiveConfigurationDtos.cs`
- **包含**: 4个DTO类 (ListItem, Detail, Create, Update)

#### 7.3 Application 服务
- **文件**: `src/DbArchiveTool.Application/ArchiveConfigurations/IArchiveConfigurationCommandService.cs`
- **文件**: `src/DbArchiveTool.Application/ArchiveConfigurations/IArchiveConfigurationQueryService.cs`

### 8. 菜单位置
- **位置**: 主侧边栏
- **顺序**: 数据源管理 → 任务调度 → 日志审计 → 归档任务 → **归档配置** (新增)
- **图标**: `setting`
- **路由**: `/archive-configurations`

## 测试建议

### 9.1 功能测试
1. **页面加载**: 访问 `/archive-configurations`，验证页面正常显示
2. **数据筛选**: 测试数据源筛选和状态筛选功能
3. **新建配置**: 填写完整表单，验证创建成功
4. **编辑配置**: 修改现有配置，验证更新成功
5. **详情查看**: 点击详情按钮，验证信息展示完整
6. **启用/禁用**: 切换配置状态，验证操作成功
7. **删除配置**: 删除测试配置，验证删除成功

### 9.2 UI 测试
1. **响应式**: 测试不同屏幕尺寸下的布局
2. **加载状态**: 验证 Loading 指示器显示
3. **错误提示**: 触发错误场景，验证 Message 提示
4. **表单验证**: 测试必填字段验证

### 9.3 集成测试
1. **API 连接**: 验证与后端 API 通信正常
2. **数据源联动**: 验证数据源下拉框数据正确
3. **状态同步**: 验证启用/禁用状态正确反映

## 相关任务
- ✅ Task #17: 实现 Blazor 归档配置管理页面 (本次完成)
- 待办 Task #18: 实现 Blazor 归档执行监控页面
- 待办 Task #14-16: 单元测试和集成测试
- 待办 Task #19: 更新文档
- 待办 Task #20: 性能测试

## 技术栈
- .NET 8.0
- Blazor Server
- Ant Design Blazor 1.4.3
- HttpClient
- 依赖注入

## 注意事项
1. Message 服务的所有方法返回 void，不能等待或赋值
2. Select 组件的 SelectOptions 必须是直接子元素
3. Tag Color 等字符串属性需要用 `@("")` 包裹
4. ArchiveMethod 枚举正确值: `PartitionSwitch`, `BulkCopy`, `Bcp`
5. 数据源 API 返回 Result 包装类型，需要检查 IsSuccess
