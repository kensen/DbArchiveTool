# 分区管理功能 - 下阶段实施计划

> 更新日期：2025-10-27  
> 状态：分区边界管理核心功能（添加/拆分/合并）已全部完成并测试通过，进入数据归档阶段

## 1. 当前完成情况总结

### 1.1 已交付功能（✅ 2025-10-27）
- ✅ **添加分区值**（完整功能，已测试 - 2025-10-17）
  - 单值手动添加
  - 批量生成（日期范围/数值序列）
  - 前端校验（顺序/格式/重复）
  - 后端执行与任务入队
  - UI 反馈与列表刷新
  
- ✅ **分区拆分**（完整功能，已测试 - 2025-10-24）
  - 2步向导界面（设置边界 → 确认执行）
  - 边界值输入与文件组选择
  - SQL 脚本预览（Markdown 渲染）
  - 后台任务执行与监控
  - 日志美化（SQL 代码块高亮）
  - 关键修复：快照解析、文件组传递、执行流程、DDL 变量名
  
- ✅ **分区合并**（完整功能，已测试 - 2025-10-27）
  - 2步向导界面（选择边界 → 确认执行）
  - 智能合并预览（左/右边界、合并后范围）
  - 最小边界数验证
  - 后台任务执行与日志记录
  - 端到端测试通过

### 1.2 技术基础已就绪
- ✅ `BackgroundTask` 实体扩展（`OperationType` 字段）
- ✅ 后台任务执行框架（`PartitionExecutionProcessor`）
- ✅ 分区元数据查询服务（`IPartitionMetadataRepository`）
- ✅ SQL 执行器基础类（`SqlPartitionCommandExecutor`）
- ✅ 审计日志记录机制
- ✅ Markdown 日志渲染（`MarkdownViewer` 组件）
- ✅ 任务监控 UI（操作类型、执行状态、日志展示）

## 2. 剩余功能优先级排序

### 优先级说明(2025-10-27 更新)

**核心成就**：分区边界管理的三大核心功能（添加/拆分/合并）已全部完成并验证通过！

**下一阶段重点**：数据归档功能，这是旧工具的核心能力，需要完整的四步向导和严密的预检机制。

---

### P0 - 数据归档功能（当前最高优先级）

**业务价值**：这是旧归档工具的核心功能，支持生产环境历史数据清理与存档需求。

**技术现状**：
- ✅ 后端服务 80% 完成：
  - `PartitionSwitchInspectionService`（预检服务）
  - `IPartitionSwitchAppService`（执行服务）
  - API 路由已定义（`/archive/inspect`, `/archive/switch`）
  - `SwitchPartitionCommandExecutor`（执行器）
- ⏳ 前端 UI 0% 完成：需要完整的四步向导

**实施计划**：

#### 第 1-2 天：前端架构搭建
- [ ] 创建 `PartitionArchiveWizard.razor` 组件文件
- [ ] 实现 Steps 导航框架（AntDesign Steps 组件）
- [ ] 定义组件内部状态管理（`ArchiveWizardState` 类）
- [ ] 搭建 Drawer/Modal 容器与关闭逻辑
- [ ] 复用拆分/合并向导的 UI 模式

#### 第 3-4 天：Step 1-2 实现
- [ ] **Step 1 - 方案选择**：
  - 三种方案卡片展示（分区切换/BCP/BulkCopy）
  - BCP/BulkCopy 标记"规划中"并禁用
  - 选择分区切换后进入 Step 2
- [ ] **Step 2 - 参数配置**：
  - 源分区选择器（下拉列表 + 表格预览，显示分区号、边界值、行数）
  - 目标表输入框（支持自动补全已有表）
  - 目标数据库选择（同实例内的其他数据库下拉列表）
  - 备注说明输入（记录归档原因）
  - 表单验证（必填项、格式校验）

#### 第 5-7 天：Step 3-4 实现
- [ ] **Step 3 - 预检执行**：
  - 调用后端 `/archive/inspect` API
  - 展示预检结果（结构对比、索引对齐、约束检查）
  - 风险提示列表：
    - 红色警告（阻塞性错误，如结构不匹配）
    - 黄色提醒（建议项，如缺少索引）
  - 阻塞性错误显示与回退按钮
  - 检查通过后允许进入下一步
- [ ] **Step 4 - 执行确认**：
  - 展示将执行的 SQL 脚本（Markdown 代码块）
  - "导出脚本"按钮（下载 .sql 文件）
  - 执行确认对话框：
    - 二次确认提示
    - 备份提醒（勾选"已完成备份"）
  - 调用 `/archive/switch` API
  - 成功后展示任务 ID 并跳转到任务监控页面

#### 第 8-9 天：集成测试与修复
- [ ] 端到端测试场景：
  - ✅ 成功切换（结构一致、索引对齐）
  - ❌ 结构不匹配（列类型不同）
  - ❌ 索引未对齐（源表有聚集索引，目标表无）
  - ❌ 约束冲突（CHECK 约束不一致）
  - ❌ 文件组不可写
  - ❌ 目标表不存在
- [ ] Bug 修复与边界情况处理
- [ ] 错误消息优化（中文本地化）
- [ ] UI 交互流畅性优化

#### 第 10 天：任务监控 UI 适配
- [ ] 任务列表页新增"归档"操作类型筛选
- [ ] 任务详情页显示归档特定信息：
  - 源分区号与边界值
  - 目标数据库/表
  - 预检结果快照
  - 执行步骤（切换前、切换、验证后）
- [ ] 日志展示归档执行步骤
- [ ] 状态图标与进度条优化

**预计完成时间**：2025-11-10（2 周工期）

**关键里程碑**：
- Day 2：向导框架搭建完成，可打开向导界面
- Day 4：Step 1-2 完成，可配置归档参数
- Day 7：Step 3-4 完成，可执行预检和提交任务
- Day 9：集成测试通过，核心场景验证
- Day 10：任务监控 UI 适配，完整闭环

---

### P1 - 任务调度平台 UI 完善（归档功能完成后）

**业务价值**：提升任务监控的易用性和信息完整性。

**实施计划**：

#### 第 11-12 天：详情页增强
- [ ] 归档任务详情页布局设计
- [ ] 显示归档特定字段（目标库/表、方案类型）
- [ ] 预检结果快照展示（表格形式）
- [ ] 执行步骤时间线（Steps 组件）

#### 第 13 天：日志优化
- [ ] 日志分类渲染（按操作类型）
- [ ] 归档日志特殊格式（预检结果、切换步骤）
- [ ] 日志筛选器（操作类型、时间范围、状态）
- [ ] 导出日志功能（.txt 或 .log 文件）

**预计完成时间**：2025-11-13（3 天工期）

---

### P2 - 操作手册与培训材料（文档阶段）

**业务价值**：降低用户学习成本，减少错误操作。

**实施计划**：

#### 第 14-16 天：用户文档编写
- [ ] **用户操作指南**：
  - 添加分区值操作步骤（含截图）
  - 分区拆分操作步骤（含截图）
  - 分区合并操作步骤（含截图）
  - 数据归档操作步骤（四步详解，含截图）
- [ ] **最佳实践文档**：
  - 备份策略（执行前备份、验证备份可用性）
  - 执行时机（低峰期、维护窗口）
  - 风险控制（预检机制、回滚方案）
  - 性能优化（索引维护、统计更新）
- [ ] **故障排查手册**：
  - 常见错误及解决方案（20+ 条）
  - 日志分析技巧
  - 联系支持渠道

#### 第 17 天：README 更新
- [ ] 更新项目 README（新增分区管理功能介绍）
- [ ] 添加功能演示 GIF/视频链接
- [ ] 更新架构图（新增归档流程）

**预计完成时间**：2025-11-17（4 天工期）

---

### P3 - BCP/BulkCopy 归档方案（调研阶段，优先级后置）

**业务价值**：支持跨实例归档，扩展系统适用场景。

**技术现状**：
- ✅ 接口占位已完成
- ⏳ 技术方案未定型

**调研计划**：

#### 待定时间：技术预研
- [ ] **BCP 方案调研**：
  - [ ] 测试 `bcp out` 导出性能（不同数据量：1万/10万/100万行）
  - [ ] 评估文件存储策略（临时目录、清理机制、磁盘空间）
  - [ ] 研究加密传输方案（网络安全、SFTP/SCP）
  - [ ] 设计一致性校验机制（行数对比、CHECKSUM 校验）
  - [ ] 错误恢复机制（断点续传、重试逻辑）
- [ ] **BulkCopy 方案调研**：
  - [ ] 测试 `SqlBulkCopy` 跨实例写入性能
  - [ ] 评估内存占用与批次大小优化（1000/5000/10000 行/批次）
  - [ ] 研究长事务处理与超时重试
  - [ ] 设计并发控制（线程池、连接池限制）
  - [ ] 目标表索引管理策略（禁用→导入→重建）
- [ ] **方案对比文档**：
  - 性能对比表（速度、资源占用、网络消耗）
  - 适用场景分析（同机房/跨机房、同网段/跨网段）
  - 实施复杂度评估（开发工作量、运维成本）
  - 推荐方案建议（基于不同业务场景）

#### 待定时间：占位 UI 完善
- [ ] 在归档向导 Step 1 展示三种方案对比卡片
- [ ] BCP/BulkCopy 方案卡片标记"规划中"
- [ ] 提供需求收集表单：
  - 目标实例连接字符串
  - 预期数据量
  - 网络环境描述
  - 期望执行时间
- [ ] 后端记录用户选择日志（用于需求统计）

**预计完成时间**：待业务需求明确后安排（预估 1-2 周）

---

## 3. 资源需求与风险评估

### 3.1 开发资源
- **前端开发**：12-15 天（按顺序实施）
- **后端完善**：3-5 天（主要集成测试与 Bug 修复）
- **测试验证**：5-7 天（与开发并行）
- **文档编写**：2-3 天（最后统一整理）

### 3.2 技术风险
| 风险项 | 影响 | 缓解措施 |
|--------|------|----------|
| 归档向导复杂度高，开发超期 | P0 功能延期 | 提前搭建框架，拆分子任务并行开发 |
| 预检逻辑遗漏边界情况 | 生产环境执行失败 | 补充集成测试，参考旧工具校验逻辑 |
| BCP/BulkCopy 方案性能不达标 | 方案废弃，影响跨实例归档 | 提前性能测试，准备备选方案（混合模式） |
| 任务调度 UI 改动影响旧功能 | 现有分区转换功能异常 | 充分回归测试，保持向后兼容 |

### 3.3 依赖项
- ✅ 数据库架构支持（`BackgroundTask` 已扩展）
- ✅ 后台任务框架（`PartitionExecutionProcessor` 已支持新操作类型）
- ⏳ 测试环境准备（需要多实例 SQL Server 用于跨实例归档测试）
- ⏳ 文档模板（操作手册、API 文档）

---

## 4. 阶段性交付目标

### ✅ 阶段 1（已完成 - 2025-10-17）：添加分区值功能上线
- **交付物**：
  - ✅ 添加分区值向导前端组件（单值/批量生成）
  - ✅ 端到端测试通过
  - ✅ 任务执行与监控集成
- **验收标准**：
  - 边界合法性校验准确（范围内、不重复）
  - 能够成功提交添加任务
  - 任务状态实时更新
- **关键指标**：
  - ✅ 边界校验准确率 > 95%
  - ✅ 执行成功率 > 90%
  - ✅ UI 操作流畅（平均完成时间 < 2 分钟）

### ✅ 阶段 2（已完成 - 2025-10-24）：拆分分区功能上线
- **交付物**：
  - ✅ 拆分分区向导前端组件（2步完整流程）
  - ✅ 端到端测试通过
  - ✅ 任务执行与监控集成
  - ✅ Markdown 日志渲染（SQL 代码块美化）
- **验收标准**：
  - 边界合法性校验准确（范围内、不重复）
  - 执行后分区结构正确
  - 日志格式美观易读
- **关键指标**：
  - ✅ 拆分成功率 > 95%
  - ✅ 执行后无数据丢失（行数一致性校验）
  - ✅ UI 操作流畅（平均完成时间 < 2 分钟）

### ✅ 阶段 3（已完成 - 2025-10-27）：合并分区功能上线
- **交付物**：
  - ✅ 合并分区向导前端组件（2步完整流程）
  - ✅ 端到端测试通过
  - ✅ 任务执行与监控集成
- **验收标准**：
  - 边界选择合法性校验（存在性、不为最后边界）
  - 执行后分区结构正确
  - 数据量预估准确
- **关键指标**：
  - ✅ 合并成功率 > 95%
  - ✅ 执行后无数据丢失（行数一致性校验）
  - ✅ UI 操作流畅（平均完成时间 < 2 分钟）

### 📋 阶段 4（进行中 - 预计 2025-11-10）：数据归档功能上线
- **交付物**：
  - ⏳ 归档向导前端组件（四步完整流程）
  - ⏳ 端到端测试通过
  - ⏳ 任务监控 UI 适配
- **验收标准**：
  - 能够成功执行分区切换归档
  - 预检错误能正确阻塞执行
  - 任务状态实时更新
- **关键指标**：
  - 预检准确率 > 95%（无误判/漏判）
  - 执行成功率 > 90%（排除环境因素）
  - 平均执行时间 < 5 分钟（中小型分区）

### 📋 阶段 5（待定）：BCP/BulkCopy 调研完成
- **交付物**：
  - ⏳ 技术调研报告（性能对比、方案推荐）
  - ⏳ 占位 UI 完善（需求收集）
  - ⏳ PoC 原型（可选，基于测试环境）
- **验收标准**：
  - 明确推荐方案（BCP/BulkCopy/混合）
  - 性能测试数据完整（不同数据量级）
  - 实施计划清晰（工作量、时间表）

---

## 5. 下一步行动

### 🎉 当前成就（2025-10-27）
**Milestone B 圆满完成！** 分区边界管理的三大核心功能已全部交付：
- ✅ 添加分区值（单值/批量，2025-10-17）
- ✅ 分区拆分（2步向导，2025-10-24）
- ✅ 分区合并（2步向导，2025-10-27）

**技术亮点**：
- ✅ 统一的后台任务执行框架
- ✅ Markdown 日志渲染（SQL 代码块美化）
- ✅ 完善的错误处理与用户反馈
- ✅ 端到端测试覆盖

---

### 立即开始（2025-10-28，明天）
1. **启动数据归档向导前端开发**：
   - 创建 `PartitionArchiveWizard.razor` 组件文件
   - 参考拆分/合并组件的代码结构
   - 复用现有的 AntDesign 组件库和状态管理模式

2. **准备测试环境**：
   - 创建归档目标数据库与表
   - 准备各种测试场景数据（结构一致/不一致、索引对齐/不齐）
   - 配置本地 SQL Server 实例（多数据库）

3. **更新任务看板**：
   - 在 TODO.md 中标记归档功能任务进度
   - 创建子任务清单（Step 1-4 开发、测试、文档）

### 本周关键里程碑（10-28 至 11-1）
- **周一（10-28，明天）**：归档向导框架搭建 + Step 1 方案选择
- **周二（10-29）**：Step 2 参数配置完成
- **周三（10-30）**：Step 3 预检执行完成
- **周四（10-31）**：Step 4 执行确认完成
- **周五（11-1）**：初步集成测试 + Bug 修复

### 下周计划（11-4 至 11-8）
- **周一至周三（11-4 至 11-6）**：全面集成测试（6+ 场景）
- **周四（11-7）**：任务监控 UI 适配
- **周五（11-8）**：Bug 修复与优化

### 第三周计划（11-11 至 11-15）
- **周一至周三（11-11 至 11-13）**：任务调度平台 UI 完善
- **周四至周五（11-14 至 11-15）**：文档编写（操作手册、最佳实践）

---

## 6. 成功标准

本阶段实施完成后，应达到以下目标：

1. **功能完整性**：
   - ✅ 添加分区值（已完成）
   - ✅ 拆分分区（已完成）
   - ✅ 合并分区（已完成）
   - 🔄 数据归档（分区切换方案，进行中）
   - � BCP/BulkCopy 归档（调研完成，占位 UI）

2. **质量指标**：
   - 所有功能集成测试通过率 > 95%
   - 核心场景端到端测试覆盖率 100%
   - 无 P0/P1 级别 Bug 遗留

3. **用户体验**：
   - 向导式交互流畅，平均完成时间符合预期
   - 错误提示清晰，用户能够自主解决常见问题
   - 任务监控实时更新，执行进度透明

4. **文档完善**：
   - 操作手册覆盖所有功能
   - API 文档更新到位
   - 开发者文档（架构、扩展点）完整

---

**文档维护**：本计划每周更新一次，反映实际进度与调整。如有变更请同步更新 `分区边界值功能 TODO.md` 和 `分区边界值明细管理功能规划设计.md`。

**最后更新**：2025-10-27

