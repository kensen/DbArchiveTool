# 分区管理功能 - 下阶段实施计划

> 更新日期：2025-10-17  
> 状态：添加分区值功能已完成并测试通过，进入下一阶段开发

## 1. 当前完成情况总结

### 1.1 已交付功能
- ✅ **添加分区值**（完整功能，已测试）
  - 单值手动添加
  - 批量生成（日期范围/数值序列）
  - 前端校验（顺序/格式/重复）
  - 后端执行与任务入队
  - UI 反馈与列表刷新

### 1.2 技术基础已就绪
- ✅ `BackgroundTask` 实体扩展（`OperationType` 字段）
- ✅ 后台任务执行框架（`PartitionExecutionProcessor`）
- ✅ 分区元数据查询服务（`IPartitionMetadataRepository`）
- ✅ SQL 执行器基础类（`SqlPartitionCommandExecutor`）
- ✅ 审计日志记录机制

## 2. 剩余功能优先级排序

### 优先级调整说明(2025-10-17)

**决策**:优先完成分区拆分/合并功能,归档功能后置。

**理由**:
1. 拆分/合并后端已完成,风险低,可快速交付
2. 归档功能复杂度高,需要四步向导 + 跨库预检,适合后续集中攻坚
3. 循序渐进的节奏,先易后难,积累 UI 开发经验

---

### P0 - 分区拆分功能(调整为最高优先级)

**业务价值**:支持细化分区粒度,优化历史数据管理策略。

**技术现状**:
- ✅ 后端执行器已完成(`SplitPartitionCommand`)
- ✅ 任务执行框架已就绪
- ⏳ 前端向导 0% 完成

**实施计划**:

#### 第 1-2 天:前端向导实现
- [ ] 创建 `PartitionSplitWizard.razor` 组件
- [ ] **Step 1 - 选择待拆分分区**:
  - 表格展示现有分区(边界值、行数、文件组、数据量)
  - 从 `sys.partitions` 查询行数
  - 支持搜索与排序
- [ ] **Step 2 - 设置新边界**:
  - 输入新边界值(支持日期/数值格式)
  - 实时校验边界合法性(是否位于分区范围内)
  - 预览拆分后左右分区范围
  - 文件组选择(继承或指定新文件组)
- [ ] **Step 3 - 执行预览**:
  - 展示 SQL 脚本(`ALTER PARTITION FUNCTION ... SPLIT RANGE`)
  - 风险提示(锁定时间、资源占用)
  - 备份确认复选框
  - 调用后端 API 提交任务

#### 第 3 天:集成测试与修复
- [ ] 测试场景:
  - ✅ 成功拆分(边界位于分区内部)
  - ❌ 边界越界(新边界不在目标分区范围内)
  - ❌ 边界重复(与现有边界冲突)
  - ❌ 格式错误(日期格式不正确)
- [ ] Bug 修复与边界情况处理
- [ ] 错误消息优化(中文本地化)

**预计完成时间**:2025-10-20(本周日)

---

### P0 - 分区合并功能(紧随拆分功能)

**业务价值**:简化分区结构,减少小分区维护开销。

**技术现状**:
- ✅ 后端执行器已完成(`MergePartitionCommand`)
- ✅ 任务执行框架已就绪
- ⏳ 前端向导 0% 完成

**实施计划**:

#### 第 4-5 天:前端向导实现
- [ ] 创建 `PartitionMergeWizard.razor` 组件
- [ ] **Step 1 - 选择合并边界**:
  - 表格展示所有分区边界值
  - 选择要删除的边界(合并其左右分区)
  - 预览合并后范围(起始边界 → 结束边界)
  - 显示合并后数据量预估
- [ ] **Step 2 - 确认合并参数**:
  - 目标文件组(默认使用左侧分区的文件组)
  - 统计信息差异对比
  - 风险提示(数据量过大警告)
- [ ] **Step 3 - 执行预览**:
  - 展示 SQL 脚本(`ALTER PARTITION FUNCTION ... MERGE RANGE`)
  - 备份确认复选框
  - 调用后端 API 提交任务

#### 第 6 天:集成测试与修复
- [ ] 测试场景:
  - ✅ 成功合并(相邻分区)
  - ❌ 边界不存在
  - ❌ 最后一个边界拒绝合并(需保留至少一个分区)
  - ❌ 数据量过大警告
- [ ] Bug 修复与边界情况处理
- [ ] 错误消息优化(中文本地化)

**预计完成时间**:2025-10-23(下周三)

---

### P1 - 数据归档功能(后置,集中攻坚)

**业务价值**:这是旧工具的主要功能,支持生产环境归档需求。

**技术现状**:
- ✅ 后端服务 80% 完成:
  - `PartitionSwitchInspectionService`(预检服务)
  - `IPartitionSwitchAppService`(执行服务)
  - API 路由已定义
- ⏳ 前端 UI 0% 完成:需要完整的四步向导

**实施计划**:

#### 第 7-8 天:前端架构搭建
- [ ] 创建 `PartitionArchiveWizard.razor` 组件文件
- [ ] 实现 Steps 导航框架(AntDesign Steps 组件)
- [ ] 定义组件内部状态管理(`WizardState` 类)
- [ ] 搭建 Drawer/Modal 容器与关闭逻辑

#### 第 9-10 天:Step 1-2 实现
- [ ] **Step 1 - 方案选择**:
  - 三种方案卡片展示(分区切换/BCP/BulkCopy)
  - BCP/BulkCopy 标记"规划中"并禁用
  - 选择分区切换后进入 Step 2
- [ ] **Step 2 - 参数配置**:
  - 源分区选择器(下拉列表 + 表格预览)
  - 目标表输入框(支持自动补全已有表)
  - 目标数据库选择(同实例内的其他数据库)
  - 备注说明输入

#### 第 11-12 天:Step 3-4 实现
- [ ] **Step 3 - 预检执行**:
  - 调用后端 `/archive/inspect` API
  - 展示预检结果(结构对比、索引对齐、约束检查)
  - 风险提示列表(红色警告 + 黄色提醒)
  - 阻塞性错误显示与回退按钮
- [ ] **Step 4 - 执行确认**:
  - 展示将执行的 SQL 脚本
  - "导出脚本"按钮(下载 .sql 文件)
  - 执行确认对话框(二次确认 + 备份提醒)
  - 调用 `/archive/switch` API
  - 成功后展示任务 ID 并跳转到任务监控页面

#### 第 13 天:集成测试与修复
- [ ] 端到端测试场景:
  - ✅ 成功切换(结构一致、索引对齐)
  - ❌ 结构不匹配(列类型不同)
  - ❌ 索引未对齐(源表有聚集索引,目标表无)
  - ❌ 约束冲突(CHECK 约束不一致)
  - ❌ 文件组不可写
- [ ] Bug 修复与边界情况处理
- [ ] 错误消息优化(中文本地化)

#### 第 14 天:任务监控 UI 适配
- [ ] 任务列表页新增"归档"操作类型筛选
- [ ] 任务详情页显示归档特定信息:
  - 源分区号
  - 目标数据库/表
  - 预检结果快照
- [ ] 日志展示归档执行步骤(切换前、切换、验证后)

**预计完成时间**:2025-10-31(下月初,拆分/合并完成后)

---

### P2 - BCP/BulkCopy 归档方案（调研阶段）

**业务价值**：支持跨实例归档，扩展系统适用场景。

**技术现状**：
- ✅ 接口占位已完成
- ⏳ 技术方案未定型

**调研计划**：

#### 第 12-14 天：技术预研
- [ ] **BCP 方案调研**：
  - [ ] 测试 `bcp out` 导出性能（不同数据量）
  - [ ] 评估文件存储策略（临时目录、清理机制）
  - [ ] 研究加密传输方案（网络安全）
  - [ ] 设计一致性校验机制（行数/校验和）
- [ ] **BulkCopy 方案调研**：
  - [ ] 测试 `SqlBulkCopy` 跨实例写入性能
  - [ ] 评估内存占用与批次大小优化
  - [ ] 研究长事务处理与超时重试
  - [ ] 设计并发控制（避免资源耗尽）
- [ ] **方案对比文档**：
  - 性能对比表（速度、资源占用）
  - 适用场景分析（同机房 vs 跨机房）
  - 实施复杂度评估
  - 推荐方案建议

#### 第 15 天：占位 UI 完善
- [ ] 在归档向导 Step 1 展示三种方案对比
- [ ] BCP/BulkCopy 方案卡片标记"规划中"
- [ ] 提供需求收集表单（目标连接字符串、预期数据量）
- [ ] 后端记录用户选择日志（用于需求统计）

**预计完成时间**：2025-10-31（下月初）

---

## 3. 资源需求与风险评估

### 3.1 开发资源
- **前端开发**：12-15 天（按顺序实施）
- **后端完善**：3-5 天（主要集成测试与 Bug 修复）
- **测试验证**：5-7 天（与开发并行）
- **文档编写**：2-3 天（最后统一整理）

### 3.2 技术风险
| 风险项 | 影响 | 缓解措施 |
|--------|------|----------|
| 归档向导复杂度高，开发超期 | P0 功能延期 | 提前搭建框架，拆分子任务并行开发 |
| 预检逻辑遗漏边界情况 | 生产环境执行失败 | 补充集成测试，参考旧工具校验逻辑 |
| BCP/BulkCopy 方案性能不达标 | 方案废弃，影响跨实例归档 | 提前性能测试，准备备选方案（混合模式） |
| 任务调度 UI 改动影响旧功能 | 现有分区转换功能异常 | 充分回归测试，保持向后兼容 |

### 3.3 依赖项
- ✅ 数据库架构支持（`BackgroundTask` 已扩展）
- ✅ 后台任务框架（`PartitionExecutionProcessor` 已支持新操作类型）
- ⏳ 测试环境准备（需要多实例 SQL Server 用于跨实例归档测试）
- ⏳ 文档模板（操作手册、API 文档）

---

## 4. 阶段性交付目标

### 阶段 1(本周 10-17 至 10-20):拆分功能上线
- **交付物**:
  - ✅ 拆分分区向导前端组件(三步完整流程)
  - ✅ 端到端测试通过
  - ✅ 任务执行与监控集成
- **验收标准**:
  - 边界合法性校验准确(范围内、不重复)
  - 能够成功提交拆分任务
  - 任务状态实时更新
- **关键指标**:
  - 边界校验准确率 > 95%(无误判/漏判)
  - 执行成功率 > 90%(排除环境因素)
  - UI 操作流畅(平均完成时间 < 2 分钟)

### 阶段 2(下周 10-21 至 10-23):合并功能上线
- **交付物**:
  - ✅ 合并分区向导前端组件(三步完整流程)
  - ✅ 端到端测试通过
  - ✅ 任务执行与监控集成
- **验收标准**:
  - 边界选择合法性校验(存在性、不为最后边界)
  - 执行后分区结构正确
  - 数据量预估准确
- **关键指标**:
  - 合并成功率 > 95%
  - 执行后无数据丢失(行数一致性校验)
  - UI 操作流畅(平均完成时间 < 2 分钟)

### 阶段 3(下下周 10-24 至 10-31):数据归档功能上线
- **交付物**:
  - ✅ 归档向导前端组件(四步完整流程)
  - ✅ 端到端测试通过
  - ✅ 任务监控 UI 适配
- **验收标准**:
  - 能够成功执行分区切换归档
  - 预检错误能正确阻塞执行
  - 任务状态实时更新
- **关键指标**:
  - 预检准确率 > 95%(无误判/漏判)
  - 执行成功率 > 90%(排除环境因素)
  - 平均执行时间 < 5 分钟(中小型分区)

### 阶段 4(下月初):BCP/BulkCopy 调研完成
- **交付物**：
  - ✅ 技术调研报告（性能对比、方案推荐）
  - ✅ 占位 UI 完善（需求收集）
  - ✅ PoC 原型（可选，基于测试环境）
- **验收标准**：
  - 明确推荐方案（BCP/BulkCopy/混合）
  - 性能测试数据完整（不同数据量级）
  - 实施计划清晰（工作量、时间表）

---

## 5. 下一步行动

### 立即开始(2025-10-17,今天)
1. **启动分区拆分向导前端开发**:
   - 创建 `PartitionSplitWizard.razor` 组件文件
   - 参考添加分区值组件的代码结构
   - 复用现有的 AntDesign 组件库

2. **准备测试环境**:
   - 创建测试数据库与分区表
   - 准备各种测试场景数据(不同边界值、数据量)
   - 配置本地 SQL Server 实例

3. **更新任务看板**:
   - 在 TODO.md 中标记当前任务进度
   - 创建 GitHub Issues 跟踪子任务

### 本周关键里程碑(10-17 至 10-20)
- **周四(10-17,今天)**:拆分向导 Step 1-2 完成
- **周五(10-18)**:拆分向导 Step 3 完成 + 初步测试
- **周六(10-19)**:集成测试 + Bug 修复
- **周日(10-20)**:代码审查 + 文档更新

### 下周计划(10-21 至 10-23)
- **周一至周二(10-21 至 10-22)**:合并功能开发
- **周三(10-23)**:集成测试 + 文档整理

### 下下周计划(10-24 至 10-31)
- **周四至周日(10-24 至 10-27)**:归档功能开发(四步向导)
- **下周一至周四(10-28 至 10-31)**:集成测试 + 任务监控 UI 适配

---

## 6. 成功标准

本阶段实施完成后，应达到以下目标：

1. **功能完整性**：
   - ✅ 添加分区值（已完成）
   - ✅ 数据归档（分区切换方案）
   - ✅ 拆分分区
   - ✅ 合并分区
   - 🔄 BCP/BulkCopy 归档（调研完成，占位 UI）

2. **质量指标**：
   - 所有功能集成测试通过率 > 95%
   - 核心场景端到端测试覆盖率 100%
   - 无 P0/P1 级别 Bug 遗留

3. **用户体验**：
   - 向导式交互流畅，平均完成时间符合预期
   - 错误提示清晰，用户能够自主解决常见问题
   - 任务监控实时更新，执行进度透明

4. **文档完善**：
   - 操作手册覆盖所有功能
   - API 文档更新到位
   - 开发者文档（架构、扩展点）完整

---

**文档维护**：本计划应每周更新一次，反映实际进度与调整。如有变更请同步更新 `分区边界值功能 TODO.md` 和 `分区边界值明细管理功能规划设计.md`。

