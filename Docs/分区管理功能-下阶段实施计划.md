# 分区管理功能 - 下阶段实施计划

> 更新日期：2025-10-17  
> 状态：添加分区值功能已完成并测试通过，进入下一阶段开发

## 1. 当前完成情况总结

### 1.1 已交付功能
- ✅ **添加分区值**（完整功能，已测试）
  - 单值手动添加
  - 批量生成（日期范围/数值序列）
  - 前端校验（顺序/格式/重复）
  - 后端执行与任务入队
  - UI 反馈与列表刷新

### 1.2 技术基础已就绪
- ✅ `PartitionExecutionTask` 实体扩展（`OperationType` 字段）
- ✅ 后台任务执行框架（`PartitionExecutionProcessor`）
- ✅ 分区元数据查询服务（`IPartitionMetadataRepository`）
- ✅ SQL 执行器基础类（`SqlPartitionCommandExecutor`）
- ✅ 审计日志记录机制

## 2. 剩余功能优先级排序

### P0 - 数据归档功能（关键路径，对齐旧工具核心能力）

**业务价值**：这是旧工具的主要功能，必须尽快上线以支持生产环境归档需求。

**技术现状**：
- ✅ 后端服务 80% 完成：
  - `PartitionSwitchInspectionService`（预检服务）
  - `IPartitionSwitchAppService`（执行服务）
  - API 路由已定义
- ⏳ 前端 UI 0% 完成：需要完整的四步向导

**实施计划**：

#### 第 1 天：前端架构搭建
- [ ] 创建 `PartitionArchiveWizard.razor` 组件文件
- [ ] 实现 Steps 导航框架（AntDesign Steps 组件）
- [ ] 定义组件内部状态管理（`WizardState` 类）
- [ ] 搭建 Drawer/Modal 容器与关闭逻辑

#### 第 2 天：Step 1-2 实现
- [ ] **Step 1 - 方案选择**：
  - 三种方案卡片展示（分区切换/BCP/BulkCopy）
  - BCP/BulkCopy 标记"规划中"并禁用
  - 选择分区切换后进入 Step 2
- [ ] **Step 2 - 参数配置**：
  - 源分区选择器（下拉列表 + 表格预览）
  - 目标表输入框（支持自动补全已有表）
  - 目标数据库选择（同实例内的其他数据库）
  - 备注说明输入

#### 第 3 天：Step 3-4 实现
- [ ] **Step 3 - 预检执行**：
  - 调用后端 `/archive/inspect` API
  - 展示预检结果（结构对比、索引对齐、约束检查）
  - 风险提示列表（红色警告 + 黄色提醒）
  - 阻塞性错误显示与回退按钮
- [ ] **Step 4 - 执行确认**：
  - 展示将执行的 SQL 脚本
  - "导出脚本"按钮（下载 .sql 文件）
  - 执行确认对话框（二次确认 + 备份提醒）
  - 调用 `/archive/switch` API
  - 成功后展示任务 ID 并跳转到任务监控页面

#### 第 4 天：集成测试与修复
- [ ] 端到端测试场景：
  - ✅ 成功切换（结构一致、索引对齐）
  - ❌ 结构不匹配（列类型不同）
  - ❌ 索引未对齐（源表有聚集索引，目标表无）
  - ❌ 约束冲突（CHECK 约束不一致）
  - ❌ 文件组不可写
- [ ] Bug 修复与边界情况处理
- [ ] 错误消息优化（中文本地化）

#### 第 5 天：任务监控 UI 适配
- [ ] 任务列表页新增"归档"操作类型筛选
- [ ] 任务详情页显示归档特定信息：
  - 源分区号
  - 目标数据库/表
  - 预检结果快照
- [ ] 日志展示归档执行步骤（切换前、切换、验证后）

**预计完成时间**：2025-10-20（本周五）

---

### P1 - 拆分分区功能

**业务价值**：支持细化分区粒度，优化历史数据管理策略。

**技术现状**：
- ✅ 后端执行器已完成（`SplitPartitionCommand`）
- ⏳ 前端向导 0% 完成

**实施计划**：

#### 第 6-7 天：前端向导实现
- [ ] 创建 `PartitionSplitWizard.razor`
- [ ] **Step 1 - 选择待拆分分区**：
  - 表格展示现有分区（边界值、行数、文件组、数据量）
  - 从 `sys.partitions` 查询行数
  - 支持搜索与排序
- [ ] **Step 2 - 设置新边界**：
  - 输入新边界值
  - 实时计算拆分后左右分区范围
  - 预计行数分布预览（基于数据分布估算）
  - 文件组选择（继承或指定）
- [ ] **Step 3 - 执行预览**：
  - 展示 SQL 脚本（`ALTER PARTITION FUNCTION ... SPLIT RANGE`）
  - 索引重建计划
  - 风险提示（锁定时间、资源占用）
  - 备份确认复选框

#### 第 8 天：集成测试
- [ ] 测试场景：
  - ✅ 成功拆分（边界位于分区内部）
  - ❌ 边界越界（新边界不在目标分区范围内）
  - ❌ 锁冲突（表有活跃事务）
  - ❌ 文件组空间不足
- [ ] 性能测试（大数据量拆分）

**预计完成时间**：2025-10-24（下周四）

---

### P1 - 合并分区功能

**业务价值**：简化分区结构，减少小分区维护开销。

**技术现状**：
- ✅ 后端执行器已完成（`MergePartitionCommand`）
- ⏳ 前端向导 0% 完成

**实施计划**：

#### 第 9-10 天：前端向导实现
- [ ] 创建 `PartitionMergeWizard.razor`
- [ ] **Step 1 - 选择起始分区**：
  - 表格展示分区（仅显示有相邻下一分区的）
  - 高亮相邻分区对
  - 支持选择多个连续分区（批量合并）
- [ ] **Step 2 - 确认合并结果**：
  - 合并后范围展示（起始边界 → 结束边界）
  - 目标文件组（默认使用第一个分区的文件组）
  - 合并后数据量预估
  - 统计信息差异对比
- [ ] **Step 3 - 执行预览**：
  - 展示 SQL 脚本（`ALTER PARTITION FUNCTION ... MERGE RANGE`）
  - 索引重建计划
  - 数据量警告（超过阈值时建议离峰执行）

#### 第 11 天：集成测试
- [ ] 测试场景：
  - ✅ 成功合并（相邻分区）
  - ❌ 非相邻分区拒绝
  - ❌ 数据量过大警告
  - ❌ 待执行任务冲突（同表有其他任务）

**预计完成时间**：2025-10-26（下周六）

---

### P2 - BCP/BulkCopy 归档方案（调研阶段）

**业务价值**：支持跨实例归档，扩展系统适用场景。

**技术现状**：
- ✅ 接口占位已完成
- ⏳ 技术方案未定型

**调研计划**：

#### 第 12-14 天：技术预研
- [ ] **BCP 方案调研**：
  - [ ] 测试 `bcp out` 导出性能（不同数据量）
  - [ ] 评估文件存储策略（临时目录、清理机制）
  - [ ] 研究加密传输方案（网络安全）
  - [ ] 设计一致性校验机制（行数/校验和）
- [ ] **BulkCopy 方案调研**：
  - [ ] 测试 `SqlBulkCopy` 跨实例写入性能
  - [ ] 评估内存占用与批次大小优化
  - [ ] 研究长事务处理与超时重试
  - [ ] 设计并发控制（避免资源耗尽）
- [ ] **方案对比文档**：
  - 性能对比表（速度、资源占用）
  - 适用场景分析（同机房 vs 跨机房）
  - 实施复杂度评估
  - 推荐方案建议

#### 第 15 天：占位 UI 完善
- [ ] 在归档向导 Step 1 展示三种方案对比
- [ ] BCP/BulkCopy 方案卡片标记"规划中"
- [ ] 提供需求收集表单（目标连接字符串、预期数据量）
- [ ] 后端记录用户选择日志（用于需求统计）

**预计完成时间**：2025-10-31（下月初）

---

## 3. 资源需求与风险评估

### 3.1 开发资源
- **前端开发**：12-15 天（按顺序实施）
- **后端完善**：3-5 天（主要集成测试与 Bug 修复）
- **测试验证**：5-7 天（与开发并行）
- **文档编写**：2-3 天（最后统一整理）

### 3.2 技术风险
| 风险项 | 影响 | 缓解措施 |
|--------|------|----------|
| 归档向导复杂度高，开发超期 | P0 功能延期 | 提前搭建框架，拆分子任务并行开发 |
| 预检逻辑遗漏边界情况 | 生产环境执行失败 | 补充集成测试，参考旧工具校验逻辑 |
| BCP/BulkCopy 方案性能不达标 | 方案废弃，影响跨实例归档 | 提前性能测试，准备备选方案（混合模式） |
| 任务调度 UI 改动影响旧功能 | 现有分区转换功能异常 | 充分回归测试，保持向后兼容 |

### 3.3 依赖项
- ✅ 数据库架构支持（`PartitionExecutionTask` 已扩展）
- ✅ 后台任务框架（`PartitionExecutionProcessor` 已支持新操作类型）
- ⏳ 测试环境准备（需要多实例 SQL Server 用于跨实例归档测试）
- ⏳ 文档模板（操作手册、API 文档）

---

## 4. 阶段性交付目标

### 阶段 1（本周）：数据归档功能上线
- **交付物**：
  - ✅ 归档向导前端组件（四步完整流程）
  - ✅ 端到端测试通过
  - ✅ 任务监控 UI 适配
- **验收标准**：
  - 能够成功执行分区切换归档
  - 预检错误能正确阻塞执行
  - 任务状态实时更新
- **关键指标**：
  - 预检准确率 > 95%（无误判/漏判）
  - 执行成功率 > 90%（排除环境因素）
  - 平均执行时间 < 5 分钟（中小型分区）

### 阶段 2（下周）：拆分/合并功能上线
- **交付物**：
  - ✅ 拆分分区向导
  - ✅ 合并分区向导
  - ✅ 集成测试覆盖
- **验收标准**：
  - 边界合法性校验准确
  - 执行后分区结构正确
  - 索引/统计信息自动维护
- **关键指标**：
  - 拆分/合并成功率 > 95%
  - 执行后无数据丢失（行数一致性校验）
  - UI 操作流畅（平均完成时间 < 2 分钟）

### 阶段 3（下月初）：BCP/BulkCopy 调研完成
- **交付物**：
  - ✅ 技术调研报告（性能对比、方案推荐）
  - ✅ 占位 UI 完善（需求收集）
  - ✅ PoC 原型（可选，基于测试环境）
- **验收标准**：
  - 明确推荐方案（BCP/BulkCopy/混合）
  - 性能测试数据完整（不同数据量级）
  - 实施计划清晰（工作量、时间表）

---

## 5. 下一步行动

### 立即开始（本周一）
1. **启动归档向导前端开发**：
   - 创建组件文件并搭建框架
   - 参考添加分区值组件的代码结构
   - 复用现有的 AntDesign 组件库

2. **准备测试环境**：
   - 创建测试数据库与分区表
   - 准备各种测试场景数据（结构一致、不一致等）
   - 配置本地 SQL Server 实例

3. **更新任务看板**：
   - 在 TODO.md 中标记当前任务进度
   - 创建 GitHub Issues 跟踪子任务
   - 设置每日站会同步进展

### 本周关键里程碑
- **周三（10-19）**：归档向导 Step 1-2 完成
- **周四（10-20）**：归档向导 Step 3-4 完成 + 初步测试
- **周五（10-21）**：集成测试 + 任务监控 UI + Bug 修复

### 下周计划
- **周一至周三（10-24 至 10-26）**：拆分/合并功能开发
- **周四至周五（10-27 至 10-28）**：集成测试 + 文档整理

---

## 6. 成功标准

本阶段实施完成后，应达到以下目标：

1. **功能完整性**：
   - ✅ 添加分区值（已完成）
   - ✅ 数据归档（分区切换方案）
   - ✅ 拆分分区
   - ✅ 合并分区
   - 🔄 BCP/BulkCopy 归档（调研完成，占位 UI）

2. **质量指标**：
   - 所有功能集成测试通过率 > 95%
   - 核心场景端到端测试覆盖率 100%
   - 无 P0/P1 级别 Bug 遗留

3. **用户体验**：
   - 向导式交互流畅，平均完成时间符合预期
   - 错误提示清晰，用户能够自主解决常见问题
   - 任务监控实时更新，执行进度透明

4. **文档完善**：
   - 操作手册覆盖所有功能
   - API 文档更新到位
   - 开发者文档（架构、扩展点）完整

---

**文档维护**：本计划应每周更新一次，反映实际进度与调整。如有变更请同步更新 `分区边界值功能 TODO.md` 和 `分区边界值明细管理功能规划设计.md`。
