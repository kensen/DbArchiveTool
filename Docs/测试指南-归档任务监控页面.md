# 快速测试指南 - 归档任务监控页面

## 前提条件

1. ✅ 数据库已创建: `DbArchiveTool`
2. ✅ API 项目已运行 EF 迁移(包含 Hangfire 表)
3. ✅ 连接字符串正确配置

## 测试步骤

### 1. 启动 API 项目

```bash
cd src/DbArchiveTool.Api
dotnet run
```

**预期输出**:
```
info: Microsoft.Hosting.Lifetime[14]
      Now listening on: https://localhost:5001
info: Microsoft.Hosting.Lifetime[0]
      Application started.
```

**验证**: 访问 `https://localhost:5001/hangfire` 应该能看到 Hangfire Dashboard

### 2. 启动 Web 项目(新终端)

```bash
cd src/DbArchiveTool.Web
dotnet run
```

**预期输出**:
```
info: Microsoft.Hosting.Lifetime[14]
      Now listening on: http://localhost:5000
info: Microsoft.Hosting.Lifetime[0]
      Application started.
```

**关键**: 不应该有任何 `JobStorage` 相关的错误!

### 3. 访问归档任务监控页面

1. 打开浏览器: `http://localhost:5000`
2. 点击左侧菜单: **归档任务**
3. 路由应该跳转到: `/archive-jobs`

### 4. 验证功能

#### 4.1 统计卡片
检查顶部是否显示 6 个统计卡片:
- ✅ 已入队: X 个
- ✅ 已调度: X 个  
- ✅ 执行中: X 个
- ✅ 已成功: X 个
- ✅ 已失败: X 个
- ✅ 定时任务: X 个

#### 4.2 任务列表标签页
- ✅ 状态筛选下拉框(已入队/已调度/执行中/已成功/已失败)
- ✅ 查询按钮
- ✅ 任务列表表格(显示任务ID、状态、方法名、队列、时间等)
- ✅ 操作按钮(详情/重试/删除)

#### 4.3 定时任务标签页
- ✅ 定时任务列表
- ✅ Cron 表达式显示
- ✅ 下次执行时间
- ✅ 操作按钮(立即执行/移除)

#### 4.4 自动刷新
- ✅ 右上角有"自动刷新"开关
- ✅ 切换开关后,数据每 5 秒自动刷新

### 5. 测试定时任务

如果 API 项目已配置定时任务(如 `daily-archive-all`):

1. 在"定时任务"标签页找到该任务
2. 点击"立即执行"按钮
3. 确认操作
4. 切换到"任务列表"标签页
5. 应该能看到新创建的任务(状态为"已入队"或"执行中")

### 6. 测试任务详情

1. 在任务列表中,点击任意任务的"详情"按钮
2. 右侧应该弹出详情抽屉
3. 验证显示内容:
   - ✅ 任务 ID
   - ✅ 状态标签(带颜色)
   - ✅ 方法名称
   - ✅ 队列名称
   - ✅ 时间信息(创建/开始/结束)
   - ✅ 任务参数
   - ✅ 状态历史时间线

## 常见问题排查

### 问题1: JobStorage 错误

**症状**:
```
System.InvalidOperationException: Current JobStorage instance has not been initialized yet.
```

**检查**:
1. `appsettings.json` 中是否有 `ConnectionStrings:HangfireDatabase`
2. `Program.cs` 中是否调用了 `GlobalConfiguration.Configuration.UseSqlServerStorage`

**解决**: 确保按照文档添加了 JobStorage 初始化代码

### 问题2: 统计卡片显示 0

**原因**: API 项目中没有任何 Hangfire 任务

**解决**: 
1. 通过 API 创建一个归档任务
2. 或等待定时任务触发

### 问题3: 连接被拒绝

**症状**: 
```
Connection disconnected.
```

**检查**:
1. API 项目是否正在运行
2. 数据库是否可访问
3. 连接字符串是否正确

### 问题4: 数据库连接失败

**症状**:
```
SqlException: Cannot open database "DbArchiveTool"
```

**解决**:
1. 确保数据库已创建
2. 运行 EF 迁移: `dotnet ef database update --project src/DbArchiveTool.Infrastructure --startup-project src/DbArchiveTool.Api`

## 预期结果

### 全部成功的情况

✅ API 项目正常启动  
✅ Web 项目正常启动  
✅ 归档任务页面正常加载  
✅ 统计卡片显示数据  
✅ 任务列表正常显示  
✅ 定时任务列表正常显示  
✅ 自动刷新功能正常  
✅ 任务详情抽屉正常  
✅ 无任何控制台错误  

### 如果没有任务数据

如果系统刚部署,可能还没有任何任务,这是正常的:

- 统计卡片会显示 0
- 任务列表为空
- 定时任务列表可能有 `daily-archive-all` (如果已配置)

可以通过以下方式创建测试任务:

1. **通过 API**: 调用 `/api/v1/archive-jobs/execute/{configId}`
2. **通过 Dashboard**: 访问 `https://localhost:5001/hangfire` 手动入队任务
3. **触发定时任务**: 在自定义页面点击"立即执行"

## 性能验证

### 响应时间

- 页面首次加载: < 2秒
- 自动刷新: < 500ms
- 任务详情查询: < 200ms

### 内存占用

Web 项目不启动 Hangfire Server,内存占用应该较低:
- 空闲时: ~100-150MB
- 活动时: ~200-300MB

## 总结

如果以上所有步骤都通过,说明归档任务监控页面已成功集成并可以正常使用!

🎉 恭喜!自定义 Hangfire 监控页面已完全就绪!
