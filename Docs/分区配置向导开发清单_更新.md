# 分区配置向导开发剩余清单

> 最后更新：2025-10-12  
> 说明：以下任务基于当前已完成的工作（元数据查询 API、连接工厂扩展等）整理。列表按模块拆分，便于迭代跟踪。

---


## 新增进展（2025-10-12）
- 完成分区执行权限检查链路：新增 `PartitionPermissionRequirement`、`IPermissionInspectionRepository`、`SqlServerPermissionInspectionRepository`，`PartitionExecutionAppService` 在任务创建前阻断缺失权限情形并写入日志。
- 更新文档与 TODO 列表，Task 8（权限与环境校验）全部完成，开始推进备份检查与 Processor 主线。
- 将 `PartitionExecutionProcessor` 的后台权限校验改为复用 `SqlServerPermissionInspectionRepository`，前后台统一针对源数据库执行 `fn_my_permissions` 检查，并清理历史 `PermissionCheck.sql` 模板的依赖（保留空文件注明已弃用），同时在日志中输出服务器/数据库/对象上下文，便于排查。

## 历史进展（2025-10-10）
- 完成分区执行任务/日志领域模型及 EF 映射，并新增 `20251010085828_AddPartitionExecutionTables` 迁移。
- 实现执行任务仓储、内存队列、派发器与 `PartitionExecutionHostedService` 占位逻辑，新增 `PartitionExecutionProcessor`。
- 新增 `PartitionExecutionAppService`、`PartitionExecutionsController` 与前端 `PartitionExecutionApiClient`，支持任务创建/查询/日志基础能力。
- 恢复 `Partitions.razor` 原始结构，为后续执行监控 UI 改造保留基线。

## 📊 当前进度总览

### ✅ 已完成（Phase 1 - 分区配置向导）
- **后端**：领域模型、应用服务、API 控制器、数据持久化
- **前端**：配置向导 UI（三步骤：基础信息、分区值、完成）、### 1.1 PartitionC### 1.3 应用服务
   - [x] 实现 `Pa### 1.4 API 控制器
   - [x] 创### 2.1 数据持久化
   - [x] 更新 EF 实体与 DbContext 映射(PartitionConfigurations、PartitionValues)### 3.3 API 客户端
   - [x] 创建 Par### 4.1 单元测试
   - [x] PartitionConfiguration 领域逻辑测试
   - [x] PartitionConfigurationAppService 校验逻辑测试
   - [x] **新增 UpdateAsync 完整测试用例**(2025-10-10)
     - [x] UpdateAsync_ShouldFail_WhenConfigurationMissing
     - [x] UpdateAsync_ShouldFail_WhenConfigurationCommitted
     - [x] UpdateAsync_ShouldFail_WhenTableAlreadyPartitioned
     - [x] UpdateAsync_ShouldSucceed_WhenValid
   - [x] **新增 GetAsync 测试用例**(2025-10-10)
     - [x] GetAsync_ShouldFail_WhenConfigurationMissing
     - [x] GetAsync_ShouldReturnDetail_WhenFound
   - [ ] **PartitionCommand 领域逻辑测试**(状态机、工厂方法)
   - [ ] **PartitionCommandAppService 测试**(预览、执行、审批)
   - [ ] **SqlTemplateProvider 测试**(模板渲染、参数替换)ConfigurationApiClient
   - [x] 修复 JSON 序列化配置
   - [x] **实现 GetAsync 获取配置详情**(2025-10-10)
   - [x] **实现 UpdateAsync 更新配置**(2025-10-10)
   - [x] **新增 PartitionConfigurationDetailModel**(2025-10-10)
   - [x] **新增 UpdatePartitionConfigurationRequestModel**(2025-10-10)
   - [ ] **扩展 PartitionCommandApiClient**:
     - [ ] PreviewSplit/ExecuteSplit 方法
     - [ ] PreviewMerge/ExecuteMerge 方法
     - [ ] PreviewSwitch/ExecuteSwitch 方法
     - [ ] GetCommandStatus 方法
     - [ ] Approve/Reject 方法 编写数据库迁移脚本
   - [x] 修复 SQL 列名错误(`range_type` → `boundary_value_on_right`)
   - [x] **创建 AddPartitionConfigurationCommitted 迁移**(2025-10-10)
   - [x] **PartitionConfigurationEntity 新增 IsCommitted 字段**(2025-10-10)
   - [x] **PartitionConfigurationRepository 映射 IsCommitted**(2025-10-10)
   - [ ] **执行数据库迁移(dotnet ef database update)**
   - [ ] **创建 PartitionCommand 实体映射与迁移**
   - [ ] **创建 PartitionCommandRepository 实现**titionConfigurationsController`(创建配置/更新分区值)
   - [x] 创建 `PartitionCommandsController` 基础结构
   - [x] **新增 GET /api/v1/partition-configurations/{id} 获取配置详情**(2025-10-10)
   - [x] **新增 PUT /api/v1/partition-configurations/{id} 更新配置**(2025-10-10)
   - [x] **新增 UpdatePartitionConfigurationDto**(2025-10-10)
   - [ ] **实现 PartitionCommandsController 完整端点**:
     - [ ] POST `.../split/preview` 和 `.../split/execute`
     - [ ] POST `.../merge/preview` 和 `.../merge/execute`
     - [ ] POST `.../switch/preview` 和 `.../switch/execute`
     - [ ] GET `/api/v1/partition-commands/{commandId}` 状态查询
     - [ ] POST `/api/v1/partition-commands/{commandId}/approve|reject`
   - [ ] **补充 XML 注释与 ProducesResponseType 声明**figurationAppService`(创建配置、添加分区值)
   - [x] 输出 `CreatePartitionConfigurationRequest` / `ReplacePartitionValuesRequest` DTO
   - [x] **实现 GetAsync 获取配置详情**(2025-10-10)
   - [x] **实现 UpdateAsync 更新配置基础信息**(2025-10-10)
   - [x] **新增 UpdatePartitionConfigurationRequest DTO**(2025-10-10)
   - [x] **新增 PartitionConfigurationDetailDto**(2025-10-10)
   - [x] **ReplaceValuesAsync/DeleteAsync 增加 IsCommitted 校验**(2025-10-10)
   - [ ] **实现 `PartitionCommandAppService` 完整功能**:
     - [ ] PreviewSplitAsync / ExecuteSplitAsync
     - [ ] PreviewMergeAsync / ExecuteMergeAsync
     - [ ] PreviewSwitchAsync / ExecuteSwitchAsync
     - [ ] GetStatusAsync(命令状态查询)
     - [ ] ApproveAsync / RejectAsync(审批流程)
   - [ ] **定义 Split/Merge/Switch 请求 DTO**
   - [ ] **定义 PartitionCommandPreviewDto(含脚本、风险、Hash)**
   - [ ] **定义 PartitionCommandStatusDto** 领域扩展
   - [x] 支持存放模式、文件目录、文件大小、目标表名、备注等属性
   - [x] 增加必要的业务规则:目标表命名校验、单文件组参数验证、分区列 NOT NULL 要求等
   - [x] 实现分区值批量替换逻辑与边界验证
   - [x] **新增 IsCommitted 执行状态标记**(2025-10-10)
   - [x] **新增 MarkCommitted/MarkDraft 状态管理方法**(2025-10-10)/年生成
- **修复**：SQL 列名错误、JSON 枚举序列化、Context 冲突、日期选择优化

### 3.1 分区配置向导(Phase 1 - ✅ 已完成 98%)
   - [x] 实现抽屉 + Steps(基础信息 / 分区值 / 完成)
   - [x] 处理表选择、列信息加载、列统计展示、目标库下拉
   - [x] 实现多步骤校验(必选项、格式、文件大小、分区值排序)
   - [x] 调用新建配置 / 保存分区值 API
   - [x] 优化日期选择器(按月/按年选择)
   - [x] 修复 Context 参数冲突与 JSON 序列化问题
   - [x] **修复分区列下拉框状态清理问题**(2025-10-10)
   - [x] **实现数据目录自动获取与缓存**(2025-10-10)
   - [x] **实现文件名跟随文件组名称自动更新**(2025-10-10)
   - [x] **实现列统计日期时间格式化显示**(2025-10-10)
   - [x] **实现分区配置草稿编辑功能**(2025-10-10)
     - [x] 向导支持编辑模式(加载现有配置、禁用不可变字段)
     - [x] 已执行配置锁定保护(IsCommitted 校验)
     - [x] 已分区表方案修改限制(元数据校验)
     - [x] 配置列表编辑入口与状态管理
   - [ ] 执行数据库迁移(AddPartitionConfigurationCommitted)
   - [ ] 手动测试编辑功能完整流程
   - [ ] 补充集成测试(API 端到端测试)
   - [ ] 更新用户操作手册(新增编辑流程说明)ase 2 - 分区操作命令）
- *### 📝 修改的文件(2025-10-10)
1. `PartitionInfoController.cs` - 添加 3 个新的通用 API 端点(`~/api/v1/data-sources/{id}/tables`)
2. `SqlPartitionQueryService.cs` - 添加 `GetDatabaseTablesAsync` 方法和 `DatabaseTableDto`
3. `PartitionInfoApiClient.cs` - 添加 `GetDatabaseTablesAsync` 方法,修正 API 路径
4. `Partitions.razor` - 主要优化:
   - 修改事件处理器为 `HandleSourceTableChanged/HandlePartitionColumnChanged`
   - 添加 `CachedDefaultFileDirectory` 缓存字段
   - 添加 `HandleFilegroupNameChanged` 和 `RegenerateDataFileName` 方法
   - 添加 `FormatColumnStatValue` 方法
   - 优化 `ApplyStorageModeDefaults` 逻辑(检测文件组名称变化)

### 2025-10-10 第二次更新 - 分区配置草稿编辑功能 ✨
**功能概述**: 支持在草稿阶段修改分区配置的基础信息(存储模式、目标表等),已执行配置自动锁定防止误修改

#### 后端实现

**1. 领域层 (Domain)**
- `PartitionConfiguration.cs`:
  - 新增 `IsCommitted` 属性 - 标记配置是否已执行
  - 新增 `MarkCommitted(user)` 方法 - 标记为已执行状态
  - 新增 `MarkDraft(user)` 方法 - 恢复为草稿状态(用于撤销场景)
  - 构造函数新增 `isCommitted` 参数

**2. 基础设施层 (Infrastructure)**
- **数据库迁移**: `20251010043019_AddPartitionConfigurationCommitted.cs`
  - 在 `PartitionConfiguration` 表添加 `IsCommitted` 列(bit, 默认 false)
- `PartitionConfigurationEntity.cs`: 新增 `IsCommitted` 属性
- `ArchiveDbContext.cs`: 配置 `IsCommitted` 字段默认值
- `PartitionConfigurationRepository.cs`:
  - `MapToEntity()` 映射 `IsCommitted` 字段
  - `MapToDomain()` 还原 `isCommitted` 参数
  - 保持 `AsNoTracking` + `ChangeTracker.Clear` 模式防止跟踪冲突

**3. 应用层 (Application)**
- `IPartitionConfigurationAppService.cs`:
  - 新增 `GetAsync(configurationId)` - 获取配置详情
  - 新增 `UpdateAsync(configurationId, request)` - 更新配置基础信息
- 新增 DTOs:
  - `UpdatePartitionConfigurationRequest` - 更新请求(存储模式、目标表等)
  - `PartitionConfigurationDetailDto` - 详情返回(含分区值列表、元数据状态)
- `PartitionConfigurationSummaryDto`: 新增 `IsCommitted` 字段
- `PartitionConfigurationAppService.cs`:
  - 实现 `GetAsync()` - 查询配置详情,包含元数据判断
  - 实现 `UpdateAsync()` - 完整更新逻辑:
    - 已执行配置不可修改校验
    - 已分区表不可修改方案校验(通过元数据查询)
    - 存储设置更新(`UpdateStorageSettings`)
    - 目标表更新(`UpdateTargetTable`)
  - `ReplaceValuesAsync()` 新增已执行校验
  - `DeleteAsync()` 新增已执行校验
  - 重构 `BuildStorageSettings()` 为静态方法以支持创建/更新复用

**4. API 层**
- `PartitionConfigurationsController.cs`:
  - `GET /api/v1/partition-configurations/{id}` - 获取配置详情
  - `PUT /api/v1/partition-configurations/{id}` - 更新配置基础信息
- `PartitionConfigurationDtos.cs`:
  - 新增 `UpdatePartitionConfigurationDto` - API请求模型

#### 前端实现

**5. Web 层 (Blazor UI)**
- `PartitionConfigurationApiClient.cs`:
  - 新增 `GetAsync(configurationId)` 方法
  - 新增 `UpdateAsync(configurationId, request)` 方法
- `PartitionConfigurationRequests.cs`:
  - 新增 `UpdatePartitionConfigurationRequestModel`
  - 新增 `PartitionConfigurationDetailModel`
  - `PartitionConfigurationSummaryModel` 新增 `IsCommitted` 字段

**6. 分区配置向导组件 (PartitionConfigWizard)**
- `PartitionConfigWizard.razor`:
  - Drawer 新增 `Closable=true` 和 `MaskClosable=false`
  - 新增 `HandleDrawerClose()` 事件处理
  - 源表和分区列下拉框在编辑模式下禁用(`Disabled=@IsEditing`)
  - 完成步骤标题根据模式动态显示("创建成功"/"更新成功")
- `PartitionConfigWizard.razor.cs`:
  - 新增参数:
    - `IsEditMode` - 是否为编辑模式
    - `EditingConfigurationId` - 编辑的配置ID
    - `EditingConfiguration` - 编辑的配置详情
  - 新增 `InitializeWizardForEditAsync()` 方法:
    - 加载现有配置的所有字段
    - 恢复分区边界值列表
    - 恢复存储设置和目标表信息
  - `SubmitAsync()` 重构:
    - 区分创建/更新两种模式
    - 创建模式: 先 CreateAsync 再 ReplaceValuesAsync
    - 更新模式: 先 UpdateAsync 再 ReplaceValuesAsync
    - 使用已有的 `ConfigurationId` (编辑模式)

**7. 分区管理页面 (Partitions.razor)**
- **配置草稿表格增强**:
  - 新增 `IsCommitted` 和 `IsPartitioned` 字段计算
  - 新增行选择支持(`@bind-SelectedRows`, `_selectedDraft`, `_selectedDraftRows`)
  - 新增"编辑"按钮列(只对未执行且未分区的草稿启用)
  - 删除按钮同步禁用规则
- **编辑功能入口**:
  - 新增 `EditConfigurationDraftAsync(draft)` 方法:
    - 调用 `GetAsync()` 获取详细信息
    - 二次校验 `IsCommitted` 和 `SourceTableIsPartitioned`
    - 设置编辑模式参数并打开向导
  - 新增 `EditSelectedDraftAsync()` 方法(支持修改按钮调用)
  - 新增 `CanEditDraft` 计算属性
- **状态管理**:
  - 新增字段: `_editingConfigurationId`, `_editingConfigurationDetail`, `_partitionConfigWizardIsEdit`
  - `LoadConfigurationDraftsAsync()` 增强:
    - 计算 `IsPartitioned` (通过 `_partitionTables` 查找)
    - 刷新后保持选中状态
  - `OnTabChanged()` 切换时清空选中草稿
  - `DeleteConfigurationDraftAsync()` 删除后清空选中
  - `OnPartitionConfigCompletedAsync()` 完成后清空编辑状态
- **UI 交互优化**:
  - `OnDraftRowClick()` - 行点击选中
  - `GetDraftRowClass()` - 选中行高亮样式
  - `HandlePartitionWizardVisibleChanged()` - 关闭时清空编辑状态

**8. 配置草稿表数据模型**
- `ConfigurationDraftInfo`:
  - 新增 `IsCommitted` - 是否已执行
  - 新增 `IsPartitioned` - 源表是否已分区(通过元数据判断)

#### 测试完善

**9. 单元测试 (UnitTests)**
- `PartitionConfigurationAppServiceTests.cs`:
  - 新增 `UpdateAsync_ShouldFail_WhenConfigurationMissing` ✅
  - 新增 `UpdateAsync_ShouldFail_WhenConfigurationCommitted` ✅
  - 新增 `UpdateAsync_ShouldFail_WhenTableAlreadyPartitioned` ✅
  - 新增 `UpdateAsync_ShouldSucceed_WhenValid` ✅
  - 新增 `GetAsync_ShouldFail_WhenConfigurationMissing` ✅
  - 新增 `GetAsync_ShouldReturnDetail_WhenFound` ✅
  - 修复 `CreateAsync_ShouldSucceed_WhenMetadataUnavailable` (移除元数据必需校验)
  - 修复 `CreateAsync_ShouldFail_WhenColumnNullableAndNotForced` (调整错误消息)

#### 功能特性总结

**核心能力**:
1. ✅ 支持编辑未执行配置的基础信息(存储模式、文件组、目标表、备注等)
2. ✅ 执行状态锁定 - `IsCommitted=true` 的配置禁止修改/删除
3. ✅ 分区表保护 - 已分区表只能通过分区操作调整边界,禁止修改配置方案
4. ✅ UI 交互优化 - 编辑/创建模式共享向导组件,源表/分区列字段禁用
5. ✅ 数据完整性 - 更新前验证、元数据检查、边界值保留

**安全防护**:
- ✅ 已执行配置不可编辑(Application层 `UpdateAsync` 校验)
- ✅ 已执行配置不可删除(Application层 `DeleteAsync` 校验)
- ✅ 已执行配置不可修改分区值(Application层 `ReplaceValuesAsync` 校验)
- ✅ 已分区表不可修改方案(通过 `IPartitionMetadataRepository.GetConfigurationAsync` 判断)
- ✅ 源表、分区列字段禁止修改(UI层 `Disabled=@IsEditing`)

**修改的文件(11个核心文件)**:
1. Domain: `PartitionConfiguration.cs`
2. Infrastructure: `PartitionConfigurationEntity.cs`, `PartitionConfigurationRepository.cs`, `ArchiveDbContext.cs`, `20251010043019_AddPartitionConfigurationCommitted.cs`
3. Application: `IPartitionConfigurationAppService.cs`, `PartitionConfigurationAppService.cs`
4. API: `PartitionConfigurationsController.cs`, `PartitionConfigurationDtos.cs`
5. Web: `PartitionConfigurationApiClient.cs`, `PartitionConfigurationRequests.cs`, `PartitionConfigWizard.razor.cs`, `Partitions.razor`
6. Tests: `PartitionConfigurationAppServiceTests.cs`

**待完成工作**:
- [ ] 执行数据库迁移: `dotnet ef database update`
- [ ] 编译验证: `dotnet build DbArchiveTool.sln`
- [ ] 手动测试: 创建草稿 → 编辑 → 保存 → 验证

---

**最后更新**: 2025-10-10  
**当前阶段**: Phase 1 完成 **98%** (新增配置编辑功能),Phase 2 进行中  
**Phase 1 剩余工作**: 数据库迁移执行、手动测试验证、用户手册更新  
**下一里程碑**: 完成 Split/Merge/Switch 操作预览与执行(预计 2-3 周)  
**建议下一步**: 
1. 立即执行数据库迁移并验证编辑功能
2. 优先完成 PartitionCommand 应用服务与 SQL 模板执行器mand 领域模型、基础仓储、SQL 模板（已创建 Split/Merge/Switch 模板）
- **前端**：Split/Merge/Switch 模态框占位（待实现）

### 📋 待开发（Phase 3-5）
- 分区操作完整流程（预览、执行、状态查询）
- 后台任务执行与队列
- 审批流程与安全规则
- 用户手册与集成测试

---

## 一、后端（Domain / Application / API）

### 1.1 PartitionConfiguration 领域扩展
   - [x] 支持存放模式、文件目录、文件大小、目标表名、备注等属性
   - [x] 增加必要的业务规则：目标表命名校验、单文件组参数验证、分区列 NOT NULL 要求等
   - [x] 实现分区值批量替换逻辑与边界验证

### 1.2 PartitionCommand 领域模型（Phase 2）
   - [x] 创建 PartitionCommand 聚合根（Split/Merge/Switch）
   - [x] 定义 PartitionSafetyRule 值对象
   - [x] 定义 PartitionFilegroupMapping 值对象
   - [ ] **实现 PartitionCommand 状态机**（PendingApproval → Approved → Queued → Executing → Succeeded/Failed）
   - [ ] **添加风险提示与脚本 Hash 生成逻辑**
   - [ ] **实现 CreateSplit/CreateMerge/CreateSwitch 工厂方法**

### 1.3 应用服务
   - [x] 实现 `PartitionConfigurationAppService`（创建配置、添加分区值）
   - [x] 输出 `CreatePartitionConfigurationRequest` / `ReplacePartitionValuesRequest` DTO
   - [ ] **实现 `PartitionCommandAppService` 完整功能**：
     - [ ] PreviewSplitAsync / ExecuteSplitAsync
     - [ ] PreviewMergeAsync / ExecuteMergeAsync
     - [ ] PreviewSwitchAsync / ExecuteSwitchAsync
     - [ ] GetStatusAsync（命令状态查询）
     - [ ] ApproveAsync / RejectAsync（审批流程）
   - [ ] **定义 Split/Merge/Switch 请求 DTO**
   - [ ] **定义 PartitionCommandPreviewDto（含脚本、风险、Hash）**
   - [ ] **定义 PartitionCommandStatusDto**

### 1.4 API 控制器
   - [x] 创建 `PartitionConfigurationsController`（创建配置/更新分区值）
   - [x] 创建 `PartitionCommandsController` 基础结构
   - [ ] **实现 PartitionCommandsController 完整端点**：
     - [ ] POST `.../split/preview` 和 `.../split/execute`
     - [ ] POST `.../merge/preview` 和 `.../merge/execute`
     - [ ] POST `.../switch/preview` 和 `.../switch/execute`
     - [ ] GET `/api/v1/partition-commands/{commandId}` 状态查询
     - [ ] POST `/api/v1/partition-commands/{commandId}/approve|reject`
   - [ ] **补充 XML 注释与 ProducesResponseType 声明**

---

## 二、基础设施（Infrastructure）

### 2.1 数据持久化
   - [x] 更新 EF 实体与 DbContext 映射（PartitionConfigurations、PartitionValues）
   - [x] 编写数据库迁移脚本
   - [x] 修复 SQL 列名错误（`range_type` → `boundary_value_on_right`）
   - [ ] **创建 PartitionCommand 实体映射与迁移**
   - [ ] **创建 PartitionCommandRepository 实现**

### 2.2 SQL 模板与执行器
   - [x] 创建 SQL 模板目录结构（`SqlTemplates/Partitioning/Commands/`）
   - [x] 创建基础模板：SplitRange.sql、MergeRange.sql、SwitchOut.sql、PermissionCheck.sql
   - [ ] **实现 ISqlTemplateProvider 接口**
   - [ ] **实现 SqlPartitionCommandExecutor**（模板渲染、事务执行、日志记录）
   - [ ] **补充模板**：
     - [ ] SwitchIn.sql（恢复分区）
     - [ ] SwitchPrepareStaging.sql（创建临时表）
     - [ ] CreateFilegroup.sql（文件组创建模板）
   - [ ] **实现权限检查逻辑**（ALTER、CONTROL、VIEW DEFINITION）

### 2.3 后台任务与队列（Phase 3）
   - [x] 创建 PartitionCommandQueue 基础结构
   - [x] 创建 PartitionCommandHostedService 基础结构
   - [ ] **实现 PartitionCommandQueue（Channel<Guid> + FIFO）**
   - [ ] **实现 PartitionCommandHostedService 完整逻辑**：
     - [ ] 命令出队与状态更新
     - [ ] 调用 SqlPartitionCommandExecutor 执行
     - [ ] 异常处理与重试策略
     - [ ] 执行日志记录
   - [ ] **注册 HostedService 到 DI 容器**

### 2.4 安全与审计
   - [ ] **实现安全规则检查器**（分区是否为空、推荐执行时段）
   - [ ] **实现审计日志写入**（操作人、脚本 Hash、风险确认）
   - [ ] **实现备份确认验证逻辑**

---

## 三、前端（Blazor Web）

### 3.1 分区配置向导（Phase 1 - ✅ 已完成 95%）
   - [x] 实现抽屉 + Steps（基础信息 / 分区值 / 完成）
   - [x] 处理表选择、列信息加载、列统计展示、目标库下拉
   - [x] 实现多步骤校验（必选项、格式、文件大小、分区值排序）
   - [x] 调用新建配置 / 保存分区值 API
   - [x] 优化日期选择器（按月/按年选择）
   - [x] 修复 Context 参数冲突与 JSON 序列化问题
   - [x] **修复分区列下拉框状态清理问题**（2025-10-10）
   - [x] **实现数据目录自动获取与缓存**（2025-10-10）
   - [x] **实现文件名跟随文件组名称自动更新**（2025-10-10）
   - [x] **实现列统计日期时间格式化显示**（2025-10-10）
   - [ ] 补充集成测试（API 端到端测试）
   - [ ] 编写用户操作手册

### 3.2 分区操作界面（Phase 2 - 待开发）
   - [x] 创建 Split/Merge/Switch 模态框占位
   - [ ] **实现 Split（拆分）向导**：
     - [ ] 选择分区表与新增边界值
     - [ ] 文件组策略选择
     - [ ] 勾选备份确认与风险提示
     - [ ] 调用预览接口展示脚本
     - [ ] 提交执行并跳转任务日志
   - [ ] **实现 Merge（合并）向导**：
     - [ ] 展示当前分区列表与行数
     - [ ] 选择要合并的分区范围
     - [ ] 风险提示与备份确认
     - [ ] 预览脚本并执行
   - [ ] **实现 Switch（切换）向导**：
     - [ ] 选择源分区与目标表
     - [ ] 自动创建临时表选项
     - [ ] 预览脚本并执行
   - [ ] **实现任务日志页面（Tab4）**：
     - [ ] 展示命令列表（状态、时间、操作人）
     - [ ] 脚本下载功能
     - [ ] 审批按钮（Approve/Reject）
     - [ ] 状态轮询与实时更新
   - [ ] **实现脚本预览对话框**：
     - [ ] 语法高亮显示
     - [ ] 复制/下载功能
     - [ ] 风险提示列表展示

### 3.3 API 客户端
   - [x] 创建 PartitionConfigurationApiClient
   - [x] 修复 JSON 序列化配置
   - [ ] **扩展 PartitionCommandApiClient**：
     - [ ] PreviewSplit/ExecuteSplit 方法
     - [ ] PreviewMerge/ExecuteMerge 方法
     - [ ] PreviewSwitch/ExecuteSwitch 方法
     - [ ] GetCommandStatus 方法
     - [ ] Approve/Reject 方法

### 3.4 UI 优化
   - [x] 为向导新增 CSS（布局、list、按钮区域）
   - [ ] **添加加载状态与进度指示**
   - [ ] **优化错误提示展示**
   - [ ] **实现脚本高亮显示**

---

## 四、测试

### 4.1 单元测试
   - [x] PartitionConfiguration 领域逻辑测试
   - [x] PartitionConfigurationAppService 校验逻辑测试
   - [ ] **PartitionCommand 领域逻辑测试**（状态机、工厂方法）
   - [ ] **PartitionCommandAppService 测试**（预览、执行、审批）
   - [ ] **SqlTemplateProvider 测试**（模板渲染、参数替换）

### 4.2 集成测试
   - [x] 基础 API 测试框架搭建
   - [ ] **分区配置 API 集成测试**（创建配置、添加分区值成功/失败路径）
   - [ ] **分区命令 API 集成测试**（预览/执行 Split/Merge/Switch）
   - [ ] **后台任务集成测试**（Queue + HostedService + Executor）
   - [ ] **权限检查集成测试**

### 4.3 前端测试（可选）
   - [ ] bUnit 组件测试（分区向导关键交互）
   - [ ] Playwright E2E 测试（完整分区配置流程）

---

## 五、文档与交付

### 5.1 技术文档
   - [x] 在《分区管理功能设计》补充向导实际实现细节
   - [x] 更新开发清单（本文档）
   - [ ] **编写 SQL 模板使用说明**（参数、命名规则、风险提示）
   - [ ] **编写后台任务配置说明**（重试策略、并发控制）
   - [ ] **编写权限配置指南**（所需权限列表、检查方法）

### 5.2 用户文档
   - [ ] **生成分区配置向导使用手册**（截图 + 步骤说明）
   - [ ] **生成分区操作指南**（Split/Merge/Switch 操作流程）
   - [ ] **生成安全最佳实践文档**（备份、风险提示、审批流程）

### 5.3 项目管理
   - [ ] 在 README 的"功能规划" / "当前进度"更新分区配置里程碑
   - [ ] 创建 CHANGELOG 记录功能变更
   - [ ] 更新部署清单（迁移脚本、配置项、权限要求）

---

## 六、实施优先级（Sprint 规划）

### 🔥 Sprint 1（当前 - ✅ 已完成 98%）
**目标**：分区配置向导基础功能上线
- [x] 后端：领域模型、应用服务、API
- [x] 前端：配置向导 UI
- [x] 修复：SQL 错误、序列化问题
- [x] **UI 增强**：下拉框状态清理、数据目录缓存、文件名自动更新、日期格式化（2025-10-10）
- [x] **配置编辑功能**：草稿编辑、执行状态锁定、已分区表保护（2025-10-10）
- [ ] **数据库迁移执行**：AddPartitionConfigurationCommitted
- [ ] **手动测试**：验证编辑功能完整流程
- [ ] 集成测试：API 测试补充
- [ ] 用户文档：操作手册编写（含编辑流程）

### 🎯 Sprint 2（下一步 - Phase 2）
**目标**：分区操作命令预览与执行
- [ ] 实现 PartitionCommand 完整领域模型与状态机
- [ ] 实现 PartitionCommandAppService 预览/执行逻辑
- [ ] 实现 SqlTemplateProvider 与 SqlPartitionCommandExecutor
- [ ] 前端：Split/Merge/Switch 向导 UI
- [ ] 单元测试：命令逻辑与模板渲染

### 🚀 Sprint 3（Phase 3）
**目标**：后台任务与异步执行
- [ ] 实现 PartitionCommandQueue 与 HostedService
- [ ] 实现任务状态查询与日志记录
- [ ] 前端：任务日志页面与状态轮询
- [ ] 集成测试：后台任务流程

### 🔒 Sprint 4（Phase 4）
**目标**：审批流程与安全增强
- [ ] 实现审批 API 与权限检查
- [ ] 实现安全规则与风险提示
- [ ] 前端：审批界面与风险展示
- [ ] 用户文档：操作手册与最佳实践

### 📚 Sprint 5（Phase 5）
**目标**：文档完善与发布准备
- [ ] 完善技术文档与用户手册
- [ ] 补充集成测试与 E2E 测试
- [ ] 性能优化与代码审查
- [ ] 部署清单与发布说明

---

## 七、风险与依赖

### 风险项
1. **SQL Server 权限不足**：执行账户可能缺少必要权限（ALTER、CONTROL 等）
2. **生产环境执行风险**：分区操作可能影响业务，需要审批与备份确认
3. **后台任务失败处理**：需要完善重试策略与异常通知

### 外部依赖
- SQL Server 2016+ 支持分区函数与方案
- .NET 8 运行环境
- AntDesign Blazor 组件库

### 内部依赖
- ArchiveDbContext 数据库迁移
- AdminSessionState 用户身份识别
- IDbConnectionFactory 数据源连接管理

---

## 八、近期修复总结

### 2025-10-09 修复
1. **SQL 列名错误**：`pf.range_type` → `pf.boundary_value_on_right`（SqlServerPartitionMetadataRepository.cs）
2. **JSON 枚举序列化不一致**：统一前后端使用 `JsonStringEnumConverter()`（PascalCase）
3. **Context 参数冲突**：移除 ActionColumn 的显式 `Context="context"` 声明
4. **日期选择器优化**：简化为按月/按年选择，移除时间选择

### 2025-10-10 新增功能 ✨
**分区配置向导 UI 增强（Partitions.razor）**

1. **✅ 修复分区列下拉框状态问题**
   - 问题：切换源表时，分区列下拉框显示上一个表的列名
   - 解决：在 `ApplyTableSelectionAsync` 中清空 `PartitionColumn`、`Columns`、`Boundaries`
   - 使用 `@bind-Value` + `OnSelectedItemChanged` 替代 `Value/ValueChanged` 避免双重绑定

2. **✅ 数据目录自动获取与缓存**
   - 问题：切换到"单独文件组+单一数据文件"模式时，数据目录字段为空
   - 解决：向导初始化时获取服务器默认目录并缓存到 `CachedDefaultFileDirectory`
   - 在 `ApplyStorageModeDefaults` 中从缓存恢复

3. **✅ 文件名跟随文件组名称自动更新**
   - 问题：用户手动修改文件组名称后，文件名不自动更新
   - 解决：为文件组名称输入框添加 `OnBlur="HandleFilegroupNameChanged"` 事件
   - 提取 `RegenerateDataFileName()` 方法生成格式化文件名
   - **优化**：切换源表时也自动触发文件名更新（通过 `ApplyStorageModeDefaults` 检测 `filegroupChanged` 标记）

4. **✅ 列统计日期时间格式化**
   - 问题：datetime 列的统计值（最小值/最大值）显示原始 SQL Server 格式
   - 解决：创建 `FormatColumnStatValue(string? value)` 方法
   - `Date` 类型格式化为 `yyyy-MM-dd`
   - `DateTime/DateTime2` 类型格式化为 `yyyy-MM-dd HH:mm:ss`

**后端 API 扩展**

5. **✅ 新增通用表/列查询端点**
   - `GET /api/v1/data-sources/{id}/tables` - 查询所有用户表（非分区表也可选择）
   - `GET /api/v1/data-sources/{id}/tables/{schema}/{table}/columns` - 通用列查询
   - `GET /api/v1/data-sources/{id}/tables/{schema}/{table}/columns/{column}/statistics` - 通用列统计
   - 新增 `SqlPartitionQueryService.GetDatabaseTablesAsync` 方法
   - 新增 `DatabaseTableDto` 类

### 📝 修改的文件（2025-10-10）
1. `PartitionInfoController.cs` - 添加 3 个新的通用 API 端点（`~/api/v1/data-sources/{id}/tables`）
2. `SqlPartitionQueryService.cs` - 添加 `GetDatabaseTablesAsync` 方法和 `DatabaseTableDto`
3. `PartitionInfoApiClient.cs` - 添加 `GetDatabaseTablesAsync` 方法，修正 API 路径
4. `Partitions.razor` - 主要优化：
   - 修改事件处理器为 `HandleSourceTableChanged/HandlePartitionColumnChanged`
   - 添加 `CachedDefaultFileDirectory` 缓存字段
   - 添加 `HandleFilegroupNameChanged` 和 `RegenerateDataFileName` 方法
   - 添加 `FormatColumnStatValue` 方法
   - 优化 `ApplyStorageModeDefaults` 逻辑（检测文件组名称变化）

---

**最后更新**：2025-10-10  
**当前阶段**：Phase 1 完成 95%，Phase 2 进行中  
**Phase 1 剩余工作**：集成测试补充、用户手册编写  
**下一里程碑**：完成 Split/Merge/Switch 操作预览与执行（预计 2-3 周）  
**建议下一步**：优先完成 PartitionCommand 应用服务与 SQL 模板执行器
