# 新数据库归档工具 - 核心功能需求清单

> **版本**: 1.0  
> **日期**: 2025年9月29日  
> **基于**: 旧版数据归档工具逆向分析  
> **目标**: 构建高可靠、高性能的企业级数据库归档解决方案

---

## 📋 项目概述

### 设计原则
- **数据安全至上**: 确保归档过程中零数据丢失
- **严谨性校验**: 多层次验证机制保障操作可靠性
- **向后兼容**: 支持已使用旧工具的数据库平滑迁移
- **高效性能**: 优化归档速度和资源占用
- **可扩展性**: 支持多数据源和分布式部署

---

## 🎯 核心功能模块

### 1. 数据源管理模块

#### 1.1 多数据源配置
**功能描述**: 支持用户自定义添加和管理多个归档目标数据源

**详细需求**:
- **数据源类型支持**:
  - SQL Server (主要)
  - MySQL / PostgreSQL (扩展)
  - Oracle (扩展)
- **连接配置管理**:
  - 来源数据库连接 (IP、端口、认证信息、数据库名)
  - 目标数据库连接 (支持跨服务器归档)
  - 连接池配置和超时设置
  - SSL/TLS 加密连接支持
- **权限验证**:
  - 自动检测 `xp_cmdshell` 权限
  - 验证 `sysadmin` 角色权限
  - BCP 工具可用性检测
  - 目标目录读写权限验证
- **连接测试与监控**:
  - 实时连接状态检测
  - 连接延迟和性能监控
  - 断线重连机制

#### 1.2 归档配置管理
**功能描述**: 管理表级别的归档策略配置

**详细需求**:
- **表配置信息**:
  - 来源表名、目标表名映射
  - 分区列选择和数据类型验证
  - 文件组模式配置 (单文件组单文件、单文件组多文件、多文件组单文件、主文件组)
  - 文件大小和增长策略配置
- **归档策略配置**:
  - 归档数据类型 (指定分区、相对时间)
  - 自动归档时间策略 (按时间间隔、按天数)
  - 归档分区值列表管理
  - 相对天数设置
- **兼容性处理**:
  - 读取旧工具的 `PartitionArchive_SourceConfiguration` 配置
  - 配置数据迁移和格式转换
  - 配置版本管理和升级

### 2. 分区建模模块

#### 2.1 分区规划与设计
**功能描述**: 智能化分区方案设计和执行

**详细需求**:
- **分区方案生成**:
  - 根据数据分布自动推荐分区值
  - 支持日期、数值、字符串等多种分区类型
  - 分区边界值智能计算 (LEFT/RIGHT 边界)
  - 分区数量优化建议
- **文件组规划**:
  - 文件组命名规范 (DAFG_模式_表名_随机ID)
  - 数据文件命名规范 (DADF_模式_表名_ID_随机ID)
  - 存储路径规划和磁盘空间评估
  - 文件增长策略优化
- **索引兼容性分析**:
  - 现有索引结构分析
  - 分区键兼容性检查
  - 索引重建方案生成
  - 列存储索引特殊处理

#### 2.2 分区执行引擎
**功能描述**: 安全可靠的分区操作执行

**详细需求**:
- **前置检查**:
  - 表结构完整性验证
  - 分区列非空约束检查
  - 并发操作冲突检测
  - 数据库备份状态验证
- **分区创建流程**:
  - 文件组和数据文件创建
  - 分区函数创建 (`CREATE PARTITION FUNCTION`)
  - 分区方案创建 (`CREATE PARTITION SCHEME`)
  - 索引删除和重建 (按优先级排序)
  - 遗留对象清理
- **错误处理机制**:
  - 操作回滚机制
  - 详细错误日志记录
  - 失败恢复策略
  - 用户友好的错误提示

### 3. 分区维护模块

#### 3.1 分区扩展功能
**功能描述**: 动态添加和管理分区

**详细需求**:
- **分区添加**:
  - 新分区值验证和去重
  - `ALTER PARTITION FUNCTION ... SPLIT RANGE` 执行
  - `ALTER PARTITION SCHEME ... NEXT USED` 配置
  - 文件组动态创建 (多文件组模式)
- **分区删除**:
  - 分区数据安全性检查
  - `ALTER PARTITION FUNCTION ... MERGE RANGE` 执行
  - 空分区清理
  - 关联文件组清理
- **分区信息查询**:
  - 分区边界值显示
  - 分区数据量统计
  - 分区性能分析
  - 分区空间使用报告

#### 3.2 分区优化建议
**功能描述**: 智能分区性能优化

**详细需求**:
- **性能监控**:
  - 分区查询性能分析
  - 分区消除效率统计
  - 索引使用情况监控
- **优化建议**:
  - 分区边界调整建议
  - 索引优化建议
  - 文件组分布优化
  - 维护窗口建议

### 4. 数据归档模块

#### 4.1 归档执行引擎
**功能描述**: 高性能、高可靠的数据归档处理

**详细需求**:
- **归档前校验**:
  - 来源表与目标表结构一致性检查 (字段名、类型、长度、可空性、排列顺序)
  - 索引分区状态验证
  - 目标数据库和表存在性验证
  - 磁盘空间充足性检查
- **归档执行流程**:
  - 临时中间表创建 (`SELECT * INTO ... WHERE 1=0`)
  - 分区数据切换 (`ALTER TABLE ... SWITCH PARTITION`)
  - BCP 数据导出 (支持批量导出优化)
  - BCP 数据导入目标库 (支持错误文件记录)
  - 归档状态和统计信息更新
- **列存储索引处理**:
  - 导出前禁用列存储索引
  - 导入后重建列存储索引
  - 版本兼容性处理 (SQL Server 2012/2019差异)
- **事务安全机制**:
  - 每个分区独立事务处理
  - 失败自动回滚机制
  - 断点续传支持

#### 4.2 归档性能优化
**功能描述**: 提升归档效率和稳定性

**详细需求**:
- **并行处理**:
  - 多分区并行归档 (可配置并发数)
  - BCP 批处理优化
  - 网络带宽利用率优化
- **资源管理**:
  - 内存使用监控和控制
  - 临时文件空间管理
  - CPU 使用率限制
- **进度监控**:
  - 实时归档进度显示
  - 预估剩余时间
  - 速度和吞吐量统计

### 5. 自动化调度模块

#### 5.1 调度策略管理
**功能描述**: 灵活的自动归档调度配置

**详细需求**:
- **调度策略类型**:
  - 按时间间隔调度 (时、分、秒级别)
  - 按固定时间点调度 (每日、每周、每月)
  - 基于数据量阈值触发
  - 基于分区年龄触发
- **调度条件配置**:
  - 业务时间窗口设置
  - 系统资源使用率阈值
  - 数据库连接数限制
  - 自定义前置条件脚本
- **分区选择逻辑**:
  - 指定分区列表模式
  - 相对时间自动筛选模式
  - 数据量阈值筛选模式
  - 自定义 SQL 条件筛选

#### 5.2 调度执行管理
**功能描述**: 可靠的自动化任务执行

**详细需求**:
- **任务队列管理**:
  - 任务优先级排序
  - 并发任务数量控制
  - 任务依赖关系处理
- **执行监控**:
  - 实时任务状态监控
  - 任务执行历史记录
  - 失败重试机制配置
  - 异常告警通知
- **资源协调**:
  - 避免同表并发操作
  - 系统资源使用优化
  - 业务影响最小化

### 6. 安全与校验模块

#### 6.1 数据一致性校验
**功能描述**: 确保归档过程中数据完整性

**详细需求**:
- **归档前校验**:
  - 来源数据行数统计
  - 关键字段 HASH 值计算
  - 约束和索引完整性检查
- **归档后校验**:
  - 目标数据行数验证
  - 关键字段 HASH 值对比
  - 数据抽样对比验证
  - 业务规则一致性检查
- **差异处理**:
  - 数据差异报告生成
  - 自动修复机制
  - 手工干预流程
  - 回滚操作支持

#### 6.2 操作审计与权限
**功能描述**: 全面的操作审计和权限管控

**详细需求**:
- **权限管理**:
  - 基于角色的访问控制 (RBAC)
  - 操作权限细粒度控制
  - 数据源访问权限隔离
- **审计日志**:
  - 所有操作完整记录
  - 操作时间、用户、内容记录
  - 敏感操作特殊标记
  - 日志防篡改机制
- **合规支持**:
  - 数据保留政策支持
  - 法规遵从性检查
  - 审计报告自动生成

### 7. 执行日志与监控模块

#### 7.1 详细执行日志
**功能描述**: 全面的操作过程记录和追踪

**详细需求**:
- **日志记录范围**:
  - 操作执行记录 (`PartitionArchive_ArchiveOperationRecord`)
  - 分区明细记录 (`PartitionArchive_ArchivePartitionDetail`)
  - 其他操作记录 (`PartitionArchive_OtherOperationRecord`)
  - 系统运行日志和错误日志
- **日志内容详细化**:
  - 操作开始和结束时间
  - 数据量统计 (源、目标、差异)
  - 执行耗时分解 (切换、导出、导入时间)
  - 错误详情和堆栈信息
  - 操作用户和机器信息
- **日志存储和管理**:
  - 日志分级存储 (实时、历史、归档)
  - 日志查询和过滤功能
  - 日志导出和备份机制
  - 日志清理和归档策略

#### 7.2 实时监控与告警
**功能描述**: 主动的系统状态监控和问题预警

**详细需求**:
- **实时监控指标**:
  - 系统资源使用率 (CPU、内存、磁盘、网络)
  - 数据库连接状态和性能
  - 归档任务执行状态和进度
  - 错误频率和类型统计
- **告警机制**:
  - 多级告警阈值配置
  - 多渠道通知支持 (邮件、短信、钉钉)
  - 告警抑制和去重机制
  - 告警处理流程跟踪
- **性能分析**:
  - 归档性能趋势分析
  - 瓶颈识别和优化建议
  - 容量规划和预测
  - SLA 达成情况监控

### 8. 兼容性与迁移模块

#### 8.1 旧工具兼容
**功能描述**: 无缝兼容已使用旧工具的数据库环境

**详细需求**:
- **配置表兼容**:
  - 读取现有 `PartitionArchive_*` 系列配置表
  - 配置数据格式转换和验证
  - 增量配置同步机制
- **分区对象兼容**:
  - 识别现有分区函数和方案 (`DAPS_*`, `DAPF_*`)
  - 文件组和数据文件模式识别 (`DAFG_*`, `DADF_*`)
  - 现有分区状态评估和优化
- **历史数据处理**:
  - 现有归档记录导入
  - 历史执行日志迁移
  - 数据一致性验证
- **平滑升级路径**:
  - 工具并行运行期间的冲突避免
  - 分批迁移策略
  - 回滚和应急方案

#### 8.2 版本兼容性
**功能描述**: 支持不同版本数据库和工具的兼容性

**详细需求**:
- **SQL Server 版本支持**:
  - SQL Server 2008R2 - 2022 兼容
  - 版本特性差异处理 (如列存储索引)
  - 版本检测和自适应调整
- **工具版本管理**:
  - 配置表结构版本控制
  - 自动升级和降级支持
  - 版本兼容性检查
- **跨平台支持**:
  - Windows / Linux 部署支持
  - .NET Core / .NET Framework 兼容
  - Docker 容器化部署支持

---

## 🏗️ 技术架构需求

### 架构设计原则
- **微服务架构**: 模块化设计，便于扩展和维护
- **事件驱动**: 基于消息队列的异步处理
- **高可用性**: 支持集群部署和故障转移
- **可扩展性**: 水平扩展能力和负载均衡

### 技术栈建议
- **后端**: .NET 6/8 + Entity Framework Core
- **数据库**: SQL Server (主) + Redis (缓存)
- **消息队列**: RabbitMQ 或 Apache Kafka
- **监控**: Prometheus + Grafana
- **日志**: ELK Stack (Elasticsearch + Logstash + Kibana)
- **前端**: React/Vue.js + TypeScript
- **容器化**: Docker + Kubernetes

---

## 📊 性能与扩展性需求

### 性能指标
- **归档吞吐量**: 单表 ≥ 10GB/小时
- **并发能力**: 同时处理 ≥ 50 个归档任务
- **响应时间**: 界面操作响应 ≤ 2 秒
- **可用性**: 99.9% 系统可用率

### 扩展性需求
- **水平扩展**: 支持多节点分布式部署
- **数据源扩展**: 支持新数据库类型插件化扩展
- **功能扩展**: 支持自定义脚本和钩子函数
- **集成扩展**: 提供 REST API 和 SDK

---

## 🔧 运维管理需求

### 部署和配置
- **一键部署**: 支持自动化部署脚本
- **配置管理**: 中心化配置管理和热更新
- **环境隔离**: 开发、测试、生产环境隔离
- **版本管理**: 灰度发布和版本回滚能力

### 维护和诊断
- **健康检查**: 系统健康状态自动检测
- **性能诊断**: 性能瓶颈分析和优化建议
- **故障恢复**: 自动故障检测和恢复机制
- **维护模式**: 支持维护期间的服务降级

---

## 📋 开发里程碑

### 第一阶段 (核心功能)
- [ ] 数据源管理和连接功能
- [ ] 基础分区建模和执行
- [ ] 基本数据归档功能
- [ ] 执行日志和错误处理
- [ ] 旧工具配置兼容

### 第二阶段 (增强功能)
- [ ] 自动化调度系统
- [ ] 高级监控和告警
- [ ] 性能优化和并行处理
- [ ] Web 管理界面
- [ ] REST API 接口

### 第三阶段 (企业级特性)
- [ ] 集群部署和高可用
- [ ] 安全审计和合规
- [ ] 多租户支持
- [ ] 第三方系统集成
- [ ] 高级分析和报告

---

## ⚠️ 风险评估与应对

### 技术风险
- **数据安全风险**: 建立多层校验机制和回滚能力
- **性能风险**: 充分的性能测试和优化策略
- **兼容性风险**: 全面的兼容性测试覆盖

### 业务风险
- **服务中断风险**: 支持热升级和灰度发布
- **数据丢失风险**: 完善的备份和恢复机制
- **合规风险**: 内置合规检查和审计功能

### 应对策略
- 建立完善的测试体系和自动化测试
- 提供详细的操作手册和培训
- 建立应急响应机制和技术支持体系
- 采用渐进式迁移和回滚策略
- 采用渐进式迁移和回滚策略

---

*本需求清单基于旧版数据归档工具的深度分析制定，确保新工具在功能完整性、安全可靠性和扩展性方面全面超越旧版，同时保持良好的向后兼容性。*