# å®šæ—¶å½’æ¡£ä»»åŠ¡æ¨¡å—è¯„å®¡æŠ¥å‘Š

**è¯„å®¡æ—¥æœŸ**: 2025-12-25
**è¯„å®¡èŒƒå›´**: `src/DbArchiveTool.Web/Pages/ScheduledJobs/`
**è¯„å®¡æ–‡ä»¶**: Index.razor, Create.razor, Edit.razor

---

## ğŸ“‹ ç›®å½•

- [æ¨¡å—äº®ç‚¹](#æ¨¡å—äº®ç‚¹)
- [å…³é”®é—®é¢˜ï¼ˆP0ï¼‰](#å…³é”®é—®é¢˜p0éœ€ä¼˜å…ˆä¿®å¤)
- [é‡è¦ä¼˜åŒ–ï¼ˆP1ï¼‰](#é‡è¦ä¼˜åŒ–p1å½±å“ç”¨æˆ·ä½“éªŒ)
- [ä»£ç è´¨é‡æ”¹è¿›ï¼ˆP2ï¼‰](#ä»£ç è´¨é‡æ”¹è¿›p2)
- [åŠŸèƒ½å¢å¼ºå»ºè®®ï¼ˆP2ï¼‰](#åŠŸèƒ½å¢å¼ºå»ºè®®p2)
- [å®‰å…¨æ€§å»ºè®®ï¼ˆP2ï¼‰](#å®‰å…¨æ€§å»ºè®®p2)
- [ç”¨æˆ·ä½“éªŒä¼˜åŒ–ï¼ˆP3ï¼‰](#ç”¨æˆ·ä½“éªŒä¼˜åŒ–p3)
- [æµ‹è¯•å’Œæ–‡æ¡£ï¼ˆP3ï¼‰](#æµ‹è¯•å’Œæ–‡æ¡£p3)
- [ä¼˜å…ˆçº§æ€»ç»“](#ä¼˜å…ˆçº§æ€»ç»“)

---

## âœ… æ¨¡å—äº®ç‚¹

1. **å®Œå–„çš„åŠŸèƒ½è¦†ç›–**ï¼šåˆ—è¡¨ã€åˆ›å»ºã€ç¼–è¾‘åŠŸèƒ½é½å…¨ï¼Œæ“ä½œæµç¨‹æ¸…æ™°
2. **è‰¯å¥½çš„çŠ¶æ€ç®¡ç†**ï¼šä½¿ç”¨ `ScheduledArchiveJobState` æœåŠ¡ç®¡ç†ç¼“å­˜ï¼Œå‡å°‘ä¸å¿…è¦çš„ API è°ƒç”¨
3. **å®æ—¶é¢„è§ˆ**ï¼šåˆ›å»ºå’Œç¼–è¾‘é¡µé¢æä¾›å³ä¾§å®æ—¶é¢„è§ˆé¢æ¿ï¼Œç”¨æˆ·ä½“éªŒè‰¯å¥½
4. **ç›®æ ‡è¡¨éªŒè¯**ï¼šæä¾›ç›®æ ‡è¡¨æ£€æŸ¥å’Œè‡ªåŠ¨åˆ›å»ºåŠŸèƒ½ï¼Œé™ä½é…ç½®é”™è¯¯é£é™©
5. **ç­›é€‰æ¡ä»¶å¯è§†åŒ–**ï¼šé›†æˆ FilterBuilder ç»„ä»¶ï¼Œæä¾›å‹å¥½çš„æ¡ä»¶æ„å»ºç•Œé¢
6. **å‹å¥½çš„é”™è¯¯æç¤º**ï¼šè¡¨å•éªŒè¯å’Œæ“ä½œåé¦ˆæ¸…æ™°
7. **ç»„ä»¶åŒ–è®¾è®¡**ï¼šåˆç†ä½¿ç”¨ TableSelectorã€FilterBuilderã€CronBuilder ç­‰å¯å¤ç”¨ç»„ä»¶

---

## ğŸ”´ å…³é”®é—®é¢˜ï¼ˆP0ï¼šéœ€ä¼˜å…ˆä¿®å¤ï¼‰

### é—®é¢˜ #1ï¼šå¼‚æ­¥è°ƒç”¨ä¸­çš„æ­»é”é£é™©

**ä½ç½®**: `Index.razor:392-400`

**ä»£ç **:
```csharp
private void OnStateChanged()
{
    if (_disposed) return;

    // ä»…åˆ·æ–°UIï¼Œä¸é‡æ–°åŠ è½½æ•°æ®ï¼ˆæ•°æ®å·²ç”± JobState æ›´æ–°ç¼“å­˜ï¼‰
    InvokeAsync(() =>
    {
        if (_disposed) return;

        // ä»ç¼“å­˜ä¸­è·å–æœ€æ–°æ•°æ®
        var cachedJobs = JobState.GetJobsAsync(DataSourceId, forceRefresh: false).Result;  // âŒ æ­»é”é£é™©
        if (cachedJobs.IsSuccess && cachedJobs.Value != null)
        {
            _jobs = cachedJobs.Value;
            ApplyFilters();
        }

        StateHasChanged();
    });
}
```

**é—®é¢˜æè¿°**:
- åœ¨å¼‚æ­¥ä¸Šä¸‹æ–‡ `InvokeAsync` ä¸­ä½¿ç”¨ `.Result` é˜»å¡ç­‰å¾…å¼‚æ­¥æ–¹æ³•ï¼Œå¯èƒ½å¯¼è‡´æ­»é”
- Blazor æ¸²æŸ“ç®¡é“ä¸­çš„æ­»é”ä¼šå¯¼è‡´é¡µé¢æ— å“åº”

**ä¿®å¤æ–¹æ¡ˆ**:
```csharp
private void OnStateChanged()
{
    if (_disposed) return;

    InvokeAsync(async () =>  // æ”¹ä¸º async lambda
    {
        if (_disposed) return;

        var cachedJobs = await JobState.GetJobsAsync(DataSourceId, forceRefresh: false);  // ä½¿ç”¨ await
        if (cachedJobs.IsSuccess && cachedJobs.Value != null)
        {
            _jobs = cachedJobs.Value;
            ApplyFilters();
        }

        StateHasChanged();
    });
}
```

**å½±å“**: é«˜ - å¯èƒ½å¯¼è‡´é¡µé¢æ­»é”
**ä¿®å¤éš¾åº¦**: ä½

---

### é—®é¢˜ #2ï¼šç”Ÿäº§ä»£ç ä¸­çš„è°ƒè¯•è¾“å‡º

**ä½ç½®**:
- `Create.razor:453, 455, 460, 468, 473, 480`
- `Edit.razor:293, 300, 303, 307, 312, 378, 382, 633, 635, 640, 648, 653, 660`

**ä»£ç ç¤ºä¾‹**:
```csharp
Console.WriteLine("å¼€å§‹è°ƒç”¨ CreateAsync...");
var result = await JobApi.CreateAsync(request);
Console.WriteLine($"CreateAsync å®Œæˆ: IsSuccess={result.IsSuccess}");
```

**é—®é¢˜æè¿°**:
- å¤§é‡ `Console.WriteLine` è¾“å‡ºç”¨äºè°ƒè¯•ï¼Œä¸åº”å‡ºç°åœ¨ç”Ÿäº§ä»£ç ä¸­
- æ— æ³•æ§åˆ¶æ—¥å¿—çº§åˆ«ï¼Œæ— æ³•åœ¨ç”Ÿäº§ç¯å¢ƒå…³é—­
- ç¼ºå°‘ç»“æ„åŒ–æ—¥å¿—ä¿¡æ¯ï¼ˆæ—¶é—´æˆ³ã€ç”¨æˆ·ä¿¡æ¯ã€ä¸Šä¸‹æ–‡ï¼‰

**ä¿®å¤æ–¹æ¡ˆ**:

**æ–¹æ¡ˆ 1ï¼ˆæ¨èï¼‰**: å®Œå…¨ç§»é™¤ï¼Œä¾èµ–æµè§ˆå™¨å¼€å‘è€…å·¥å…·
```csharp
// ç›´æ¥åˆ é™¤æ‰€æœ‰ Console.WriteLine
```

**æ–¹æ¡ˆ 2**: æ›¿æ¢ä¸ºæ—¥å¿—æ¡†æ¶
```csharp
[Inject] private ILogger<Create> Logger { get; set; } = default!;

Logger.LogDebug("å¼€å§‹è°ƒç”¨ CreateAsync, JobName={JobName}", _formModel.Name);
var result = await JobApi.CreateAsync(request);
Logger.LogInformation("CreateAsync å®Œæˆ: IsSuccess={IsSuccess}, JobId={JobId}",
    result.IsSuccess, result.Value?.Id);
```

**å½±å“**: ä¸­ - å½±å“ä»£ç è´¨é‡å’Œæ—¥å¿—ç®¡ç†
**ä¿®å¤éš¾åº¦**: ä½

---

### é—®é¢˜ #3ï¼šä¸å¯é çš„ç»„ä»¶åˆå§‹åŒ–

**ä½ç½®**: `Edit.razor:289-314`

**ä»£ç **:
```csharp
protected override async Task OnAfterRenderAsync(bool firstRender)
{
    await base.OnAfterRenderAsync(firstRender);

    if (!_filterDefinitionLoaded && _filterBuilder != null && !string.IsNullOrWhiteSpace(_pendingFilterDefinition))
    {
        try
        {
            Console.WriteLine("å‡†å¤‡åŠ è½½ç­›é€‰æ¡ä»¶å®šä¹‰...");
            // ç­‰å¾…ç¡®ä¿ FilterBuilder å®Œå…¨åˆå§‹åŒ–ï¼ˆåŒ…æ‹¬åˆ—æ•°æ®åŠ è½½ï¼‰
            await Task.Delay(500);  // âŒ å›ºå®šå»¶è¿Ÿä¸å¯é 
            Console.WriteLine("å¼€å§‹è°ƒç”¨ LoadFromDefinition...");
            await _filterBuilder.LoadFromDefinition(_pendingFilterDefinition);
            _filterDefinitionLoaded = true;
            _pendingFilterDefinition = null;
            Console.WriteLine("ç­›é€‰æ¡ä»¶åŠ è½½å®Œæˆï¼Œè§¦å‘é‡æ–°æ¸²æŸ“");
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"âŒ åŠ è½½ç­›é€‰æ¡ä»¶å®šä¹‰å¤±è´¥: {ex.Message}\n{ex.StackTrace}");
        }
    }
}
```

**é—®é¢˜æè¿°**:
- ä½¿ç”¨ `Task.Delay(500)` ç­‰å¾…ç»„ä»¶åˆå§‹åŒ–ï¼Œä¸å¯é 
- ç½‘ç»œæ…¢æˆ–æ•°æ®é‡å¤§æ—¶ 500ms å¯èƒ½ä¸å¤Ÿ
- ç”¨æˆ·ä½“éªŒå·®ï¼ˆå¯èƒ½çœ‹åˆ°ç­›é€‰æ¡ä»¶å»¶è¿ŸåŠ è½½ï¼‰

**ä¿®å¤æ–¹æ¡ˆ**:

åœ¨ `FilterBuilder` ç»„ä»¶ä¸­æš´éœ²åˆå§‹åŒ–å®Œæˆäº‹ä»¶ï¼š

```csharp
// FilterBuilder.razor
[Parameter] public EventCallback OnInitializationCompleted { get; set; }

protected override async Task OnAfterRenderAsync(bool firstRender)
{
    if (firstRender && _columns.Any())
    {
        await OnInitializationCompleted.InvokeAsync();
    }
}
```

åœ¨ `Edit.razor` ä¸­ä½¿ç”¨ï¼š

```csharp
<FilterBuilder @ref="_filterBuilder"
               OnInitializationCompleted="OnFilterBuilderInitialized"
               ... />

private async Task OnFilterBuilderInitialized()
{
    if (!string.IsNullOrWhiteSpace(_pendingFilterDefinition) && _filterBuilder != null)
    {
        try
        {
            await _filterBuilder.LoadFromDefinition(_pendingFilterDefinition);
            _filterDefinitionLoaded = true;
            _pendingFilterDefinition = null;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "åŠ è½½ç­›é€‰æ¡ä»¶å®šä¹‰å¤±è´¥");
            Message.Error("åŠ è½½ç­›é€‰æ¡ä»¶å¤±è´¥");
        }
    }
}
```

**å½±å“**: é«˜ - å½±å“ç¼–è¾‘é¡µåŠ è½½å¯é æ€§
**ä¿®å¤éš¾åº¦**: ä¸­

---

## ğŸŸ  é‡è¦ä¼˜åŒ–ï¼ˆP1ï¼šå½±å“ç”¨æˆ·ä½“éªŒï¼‰

### é—®é¢˜ #4ï¼šå‰ç«¯è¿‡æ»¤æ€§èƒ½é—®é¢˜

**ä½ç½®**: `Index.razor:276-297`

**ä»£ç **:
```csharp
private void ApplyFilters()
{
    _filteredJobs = _jobs.Where(job =>
    {
        // å¯ç”¨çŠ¶æ€è¿‡æ»¤
        if (_filterEnabled.HasValue && job.IsEnabled != _filterEnabled.Value)
        {
            return false;
        }

        // å…³é”®å­—æœç´¢
        if (!string.IsNullOrWhiteSpace(_searchKeyword))
        {
            var keyword = _searchKeyword.Trim().ToLowerInvariant();
            return job.Name.ToLowerInvariant().Contains(keyword) ||
                   job.FullSourceTable.ToLowerInvariant().Contains(keyword) ||
                   job.FullTargetTable.ToLowerInvariant().Contains(keyword);
        }

        return true;
    }).ToList();
}
```

**é—®é¢˜æè¿°**:
- æ‰€æœ‰è¿‡æ»¤å’Œæœç´¢åœ¨å‰ç«¯è¿›è¡Œ
- åŠ è½½æ‰€æœ‰ä»»åŠ¡åˆ°å†…å­˜ï¼Œæ•°æ®é‡å¤§æ—¶æ€§èƒ½å·®
- åˆ†é¡µæ˜¯å‰ç«¯åˆ†é¡µï¼Œæ— æ³•å‡å°‘æ•°æ®ä¼ è¾“é‡

**ä¿®å¤æ–¹æ¡ˆ**:

1. **åç«¯å®ç°åˆ†é¡µå’Œè¿‡æ»¤ API**:
```csharp
// ScheduledArchiveJobsController.cs
[HttpGet]
public async Task<ActionResult<Result<PagedResult<ScheduledArchiveJobDto>>>> GetJobs(
    [FromQuery] Guid dataSourceId,
    [FromQuery] bool? isEnabled = null,
    [FromQuery] string? searchKeyword = null,
    [FromQuery] int pageIndex = 1,
    [FromQuery] int pageSize = 20)
{
    var result = await _jobService.GetPagedJobsAsync(
        dataSourceId,
        isEnabled,
        searchKeyword,
        pageIndex,
        pageSize);
    return Ok(result);
}
```

2. **å‰ç«¯è°ƒç”¨åç«¯åˆ†é¡µ API**:
```csharp
private async Task LoadJobsAsync()
{
    _loading = true;
    try
    {
        var result = await JobState.GetPagedJobsAsync(
            DataSourceId,
            _filterEnabled,
            _searchKeyword,
            _pageIndex,
            _pageSize);

        if (result.IsSuccess && result.Value != null)
        {
            _jobs = result.Value.Items;
            _totalCount = result.Value.TotalCount;
        }
    }
    finally
    {
        _loading = false;
        StateHasChanged();
    }
}

private async Task OnPageIndexChanged(int pageIndex)
{
    _pageIndex = pageIndex;
    await LoadJobsAsync();
}
```

**å½±å“**: ä¸­ - æ•°æ®é‡å¤§æ—¶å½±å“æ€§èƒ½
**ä¿®å¤éš¾åº¦**: ä¸­

---

### é—®é¢˜ #5ï¼šæ“ä½œåçš„ç¡¬ç¼–ç å»¶è¿Ÿ

**ä½ç½®**: `Index.razor:329-342`

**ä»£ç **:
```csharp
private async Task ExecuteJobAsync(Guid jobId)
{
    var result = await JobApi.ExecuteAsync(jobId);
    if (result.IsSuccess)
    {
        Message.Success("ä»»åŠ¡å·²è§¦å‘æ‰§è¡Œï¼Œè¯·ç¨åæŸ¥çœ‹æ‰§è¡Œç»“æœ");
        await Task.Delay(2000); // âŒ å›ºå®šå»¶è¿Ÿ 2 ç§’
        await RefreshAsync();
    }
    else
    {
        Message.Error(result.Error ?? "è§¦å‘æ‰§è¡Œå¤±è´¥");
    }
}
```

**é—®é¢˜æè¿°**:
- ä½¿ç”¨å›ºå®šå»¶è¿Ÿç­‰å¾…åå°ä»»åŠ¡å®Œæˆï¼Œä¸å¯é 
- ä»»åŠ¡å¯èƒ½åœ¨ 2 ç§’å†…æœªå®Œæˆï¼Œåˆ·æ–°çœ‹ä¸åˆ°å˜åŒ–
- ç”¨æˆ·ä½“éªŒä¸ä½³ï¼ˆç­‰å¾…æ—¶é—´å›ºå®šï¼‰

**ä¿®å¤æ–¹æ¡ˆ**:

**æ–¹æ¡ˆ 1ï¼ˆæ¨èï¼‰**: ä½¿ç”¨ SignalR å®æ—¶æ¨é€
```csharp
// åç«¯å‘é€ä»»åŠ¡çŠ¶æ€å˜æ›´é€šçŸ¥
await Clients.Group($"datasource-{dataSourceId}").SendAsync("JobStatusChanged", jobId, status);

// å‰ç«¯ç›‘å¬
protected override async Task OnInitializedAsync()
{
    await HubConnection.StartAsync();
    HubConnection.On<Guid, string>("JobStatusChanged", OnJobStatusChanged);
}

private async Task OnJobStatusChanged(Guid jobId, string status)
{
    await RefreshAsync();
}
```

**æ–¹æ¡ˆ 2**: è½®è¯¢æ£€æŸ¥ä»»åŠ¡çŠ¶æ€
```csharp
private async Task ExecuteJobAsync(Guid jobId)
{
    var result = await JobApi.ExecuteAsync(jobId);
    if (result.IsSuccess)
    {
        Message.Success("ä»»åŠ¡å·²è§¦å‘æ‰§è¡Œï¼Œæ­£åœ¨ç›‘æ§æ‰§è¡ŒçŠ¶æ€...");
        await PollJobStatusAsync(jobId, maxAttempts: 10, intervalMs: 1000);
    }
}

private async Task PollJobStatusAsync(Guid jobId, int maxAttempts, int intervalMs)
{
    for (int i = 0; i < maxAttempts; i++)
    {
        await Task.Delay(intervalMs);
        var statusResult = await JobApi.GetExecutionStatusAsync(jobId);
        if (statusResult.IsSuccess && statusResult.Value?.IsCompleted == true)
        {
            await RefreshAsync();
            Message.Success("ä»»åŠ¡æ‰§è¡Œå®Œæˆ");
            return;
        }
    }
    await RefreshAsync();
    Message.Info("ä»»åŠ¡æ­£åœ¨æ‰§è¡Œï¼Œè¯·ç¨ååˆ·æ–°æŸ¥çœ‹ç»“æœ");
}
```

**æ–¹æ¡ˆ 3ï¼ˆæœ€ç®€å•ï¼‰**: ç«‹å³æ›´æ–° UIï¼Œåå°å¼‚æ­¥åˆ·æ–°
```csharp
private async Task ExecuteJobAsync(Guid jobId)
{
    var result = await JobApi.ExecuteAsync(jobId);
    if (result.IsSuccess)
    {
        // ç«‹å³æ›´æ–° UI çŠ¶æ€
        var job = _jobs.FirstOrDefault(j => j.Id == jobId);
        if (job != null)
        {
            job.LastExecutionStatus = JobExecutionStatus.Running;
            job.LastExecutionStatusDisplay = "æ‰§è¡Œä¸­";
            StateHasChanged();
        }

        Message.Success("ä»»åŠ¡å·²è§¦å‘æ‰§è¡Œ");

        // åå°å¼‚æ­¥åˆ·æ–°ï¼ˆä¸é˜»å¡ UIï¼‰
        _ = Task.Run(async () =>
        {
            await Task.Delay(3000);
            await InvokeAsync(async () => await RefreshAsync());
        });
    }
}
```

**å½±å“**: ä¸­ - å½±å“ç”¨æˆ·ä½“éªŒ
**ä¿®å¤éš¾åº¦**: ä½ï¼ˆæ–¹æ¡ˆ 3ï¼‰/ é«˜ï¼ˆæ–¹æ¡ˆ 1ï¼‰

---

### é—®é¢˜ #6ï¼šè¡¨å•é‡ç½®ä¸å®Œæ•´

**ä½ç½®**: `Create.razor:486-493`

**ä»£ç **:
```csharp
private void HandleReset()
{
    _formModel.Reset();
    InitializeFormDefaults();
    _scheduleMode = "interval";
    _validationMessage = null;
    _selectedTableStats = null;
    // âŒ å­ç»„ä»¶çŠ¶æ€æœªé‡ç½®
}
```

**é—®é¢˜æè¿°**:
- é‡ç½®è¡¨å•æ•°æ®ä½†æœªé‡ç½®å­ç»„ä»¶çŠ¶æ€
- `TableSelector`ã€`FilterBuilder`ã€`CronBuilder` ä»æ˜¾ç¤ºæ—§æ•°æ®
- ç”¨æˆ·çœ‹åˆ°è¡¨å•æ•°æ®ä¸ä¸€è‡´

**ä¿®å¤æ–¹æ¡ˆ**:

1. **åœ¨å­ç»„ä»¶ä¸­æš´éœ² Reset æ–¹æ³•**:
```csharp
// TableSelector.razor
public void Reset()
{
    _selectedSchema = "dbo";
    _selectedTable = null;
    _selectedTableStats = null;
    StateHasChanged();
}

// FilterBuilder.razor
public void Reset()
{
    _conditions.Clear();
    _conditions.Add(new FilterCondition { Field = string.Empty, Operator = "=", Value = string.Empty });
    StateHasChanged();
}

// CronBuilder.razor
public void Reset()
{
    _cronExpression = null;
    _presetValue = "daily";
    StateHasChanged();
}
```

2. **åœ¨çˆ¶ç»„ä»¶ä¸­è°ƒç”¨**:
```csharp
private void HandleReset()
{
    _formModel.Reset();
    InitializeFormDefaults();
    _scheduleMode = "interval";
    _validationMessage = null;
    _selectedTableStats = null;

    // é‡ç½®å­ç»„ä»¶
    _tableSelector?.Reset();
    _filterBuilder?.Reset();
    // CronBuilder ä¼šå› ä¸º _formModel.CronExpression å˜åŒ–è‡ªåŠ¨é‡ç½®

    StateHasChanged();
}
```

**å½±å“**: ä¸­ - å½±å“ç”¨æˆ·ä½“éªŒ
**ä¿®å¤éš¾åº¦**: ä½

---

### é—®é¢˜ #7ï¼šç›®æ ‡è¡¨åè‡ªåŠ¨è¦†ç›–ç”¨æˆ·è¾“å…¥

**ä½ç½®**: `Create.razor:290-304`, `Edit.razor:458-486`

**ä»£ç **:
```csharp
private async Task OnSourceTableChanged(string? tableName)
{
    _formModel.SourceTableName = tableName;

    // è‡ªåŠ¨æ›´æ–°ç›®æ ‡è¡¨åï¼ˆè·Ÿéšæºè¡¨å˜æ›´ï¼‰
    if (!string.IsNullOrWhiteSpace(_formModel.SourceTableName))
    {
        _formModel.TargetTableName = $"{_formModel.SourceTableName}_Archive";  // âŒ æ€»æ˜¯è¦†ç›–

        // æ¸…é™¤ä¹‹å‰çš„æ£€æŸ¥ç»“æœ
        _targetTableExists = null;
        _targetTableCheckMessage = null;
    }

    await InvokeAsync(StateHasChanged);
}
```

**é—®é¢˜æè¿°**:
- æ¯æ¬¡æºè¡¨å˜åŒ–éƒ½è¦†ç›–ç›®æ ‡è¡¨å
- ç”¨æˆ·æ‰‹åŠ¨è¾“å…¥çš„ç›®æ ‡è¡¨åè¢«è¦†ç›–
- æ— æ³•è®¾ç½®è‡ªå®šä¹‰ç›®æ ‡è¡¨å

**ä¿®å¤æ–¹æ¡ˆ**:
```csharp
private bool _targetTableManuallyModified = false;

private async Task OnSourceTableChanged(string? tableName)
{
    _formModel.SourceTableName = tableName;

    // åªåœ¨ç”¨æˆ·æœªæ‰‹åŠ¨ä¿®æ”¹ç›®æ ‡è¡¨åæ—¶è‡ªåŠ¨ç”Ÿæˆ
    if (!string.IsNullOrWhiteSpace(_formModel.SourceTableName) && !_targetTableManuallyModified)
    {
        _formModel.TargetTableName = $"{_formModel.SourceTableName}_Archive";
        _targetTableExists = null;
        _targetTableCheckMessage = null;
    }

    await InvokeAsync(StateHasChanged);
}

private async Task OnTargetTableNameChanged()
{
    // æ ‡è®°ç”¨æˆ·å·²æ‰‹åŠ¨ä¿®æ”¹
    _targetTableManuallyModified = true;
    _targetTableExists = null;
    _targetTableCheckMessage = null;
    await Task.CompletedTask;
}
```

**å½±å“**: ä¸­ - å½±å“ç”¨æˆ·ä½“éªŒ
**ä¿®å¤éš¾åº¦**: ä½

---

### é—®é¢˜ #8ï¼šæ‰¹æ¬¡å¤§å°è‡ªåŠ¨è°ƒæ•´æ— æç¤º

**ä½ç½®**: `Create.razor:307-325`

**ä»£ç **:
```csharp
private async Task OnTableStatisticsChanged(TableWithStatisticsDto? stats)
{
    _selectedTableStats = stats;

    // å¦‚æœè¡¨è¶…è¿‡100ä¸‡è¡Œ,å»ºè®®è°ƒæ•´æ‰¹æ¬¡å¤§å°
    if (stats != null && stats.RowCount > 1000000)
    {
        if (_formModel.BatchSize > 5000)
        {
            _formModel.BatchSize = 5000;  // âŒ é™é»˜ä¿®æ”¹
        }
        if (_formModel.MaxRowsPerExecution > 50000)
        {
            _formModel.MaxRowsPerExecution = 50000;  // âŒ é™é»˜ä¿®æ”¹
        }
    }

    await InvokeAsync(StateHasChanged);
}
```

**é—®é¢˜æè¿°**:
- è‡ªåŠ¨è°ƒæ•´æ‰¹æ¬¡å¤§å°ä½†æœªé€šçŸ¥ç”¨æˆ·
- ç”¨æˆ·å¯èƒ½ä¸çŸ¥é“å‚æ•°å·²è¢«ä¿®æ”¹
- å¯èƒ½è¦†ç›–ç”¨æˆ·æœ‰æ„è®¾ç½®çš„å€¼

**ä¿®å¤æ–¹æ¡ˆ**:
```csharp
private async Task OnTableStatisticsChanged(TableWithStatisticsDto? stats)
{
    _selectedTableStats = stats;

    // å¦‚æœè¡¨è¶…è¿‡100ä¸‡è¡Œ,å»ºè®®è°ƒæ•´æ‰¹æ¬¡å¤§å°
    if (stats != null && stats.RowCount > 1000000)
    {
        bool adjusted = false;

        if (_formModel.BatchSize > 5000)
        {
            _formModel.BatchSize = 5000;
            adjusted = true;
        }
        if (_formModel.MaxRowsPerExecution > 50000)
        {
            _formModel.MaxRowsPerExecution = 50000;
            adjusted = true;
        }

        if (adjusted)
        {
            Message.Info($"æ£€æµ‹åˆ°è¡¨æ•°æ®é‡è¾ƒå¤§ï¼ˆ{stats.RowCount:N0} è¡Œï¼‰ï¼Œå·²è‡ªåŠ¨ä¼˜åŒ–æ‰¹æ¬¡å‚æ•°ä»¥æå‡æ€§èƒ½");
        }
    }

    await InvokeAsync(StateHasChanged);
}
```

**å½±å“**: ä½ - å½±å“ç”¨æˆ·ä½“éªŒ
**ä¿®å¤éš¾åº¦**: ä½

---

### é—®é¢˜ #9ï¼šç¼–è¾‘é¡µå…è®¸ä¿®æ”¹å…³é”®å­—æ®µ

**ä½ç½®**: `Edit.razor:56-62`

**ä»£ç **:
```razor
<TableSelector @ref="_tableSelector"
               DataSourceId="@DataSourceId"
               SourceSchema="@_formModel.SourceSchemaName"
               SourceTable="@_formModel.SourceTableName"
               SourceSchemaChanged="OnSourceSchemaChanged"
               SourceTableChanged="OnSourceTableChanged"
               OnTableStatisticsChanged="OnTableStatisticsChanged" />
```

**é—®é¢˜æè¿°**:
- ç¼–è¾‘é¡µå…è®¸ä¿®æ”¹æºè¡¨å’Œç›®æ ‡è¡¨
- å·²æœ‰æ‰§è¡Œå†å²çš„ä»»åŠ¡ä¿®æ”¹è¡¨åä¼šå¯¼è‡´æ•°æ®ä¸ä¸€è‡´
- å¯èƒ½å¯¼è‡´å½’æ¡£æ•°æ®æ··ä¹±

**ä¿®å¤æ–¹æ¡ˆ**:

**æ–¹æ¡ˆ 1ï¼ˆæ¨èï¼‰**: ç¦ç”¨å…³é”®å­—æ®µ
```razor
<Form Model="_formModel" LabelCol="new ColLayoutParam { Span = 6 }" WrapperCol="new ColLayoutParam { Span = 18 }">
    <FormItem Label="æºè¡¨æ¶æ„">
        <div class="readonly-field">
            <span><strong>@_formModel.SourceSchemaName</strong></span>
        </div>
    </FormItem>
    <FormItem Label="æºè¡¨åç§°">
        <div class="readonly-field">
            <span><strong>@_formModel.SourceTableName</strong></span>
        </div>
    </FormItem>
    <FormItem Label="ç›®æ ‡è¡¨æ¶æ„">
        <div class="readonly-field">
            <span><strong>@_formModel.TargetSchemaName</strong></span>
        </div>
    </FormItem>
    <FormItem Label="ç›®æ ‡è¡¨åç§°">
        <div class="readonly-field">
            <span><strong>@_formModel.TargetTableName</strong></span>
        </div>
    </FormItem>
</Form>

<Alert Type="@AlertType.Info"
       Message="è¡¨é…ç½®ä¸å¯ä¿®æ”¹ï¼Œå¦‚éœ€ä½¿ç”¨å…¶ä»–è¡¨è¯·åˆ›å»ºæ–°ä»»åŠ¡"
       ShowIcon="true"
       Style="margin-top: 16px;" />
```

**æ–¹æ¡ˆ 2**: æ˜¾ç¤ºè­¦å‘Šå¯¹è¯æ¡†
```csharp
private async Task OnSourceTableChanged(string? tableName)
{
    if (_formModel.SourceTableName != tableName && !string.IsNullOrEmpty(_formModel.SourceTableName))
    {
        var confirmed = await Modal.ConfirmAsync(new ConfirmOptions
        {
            Title = "ç¡®è®¤ä¿®æ”¹æºè¡¨ï¼Ÿ",
            Content = "ä¿®æ”¹æºè¡¨å°†å½±å“ä»»åŠ¡çš„æ‰§è¡Œå†å²å’Œç»Ÿè®¡æ•°æ®ï¼Œå»ºè®®åˆ›å»ºæ–°ä»»åŠ¡ã€‚ç¡®å®šè¦ä¿®æ”¹å—ï¼Ÿ",
            OkText = "ç¡®å®šä¿®æ”¹",
            CancelText = "å–æ¶ˆ"
        });

        if (!confirmed)
        {
            return;
        }
    }

    _formModel.SourceTableName = tableName;
    CheckChanges();
    await InvokeAsync(StateHasChanged);
}
```

**å½±å“**: é«˜ - å½±å“æ•°æ®ä¸€è‡´æ€§
**ä¿®å¤éš¾åº¦**: ä½ï¼ˆæ–¹æ¡ˆ 1ï¼‰/ ä¸­ï¼ˆæ–¹æ¡ˆ 2ï¼‰

---

### é—®é¢˜ #14ï¼šè¯¦æƒ…é¡µé¢æœªå®ç°

**ä½ç½®**: `Index.razor:371-375`

**ä»£ç **:
```csharp
private void NavigateToDetails(Guid jobId)
{
    // TODO: å¯¼èˆªåˆ°è¯¦æƒ…é¡µé¢ï¼ˆStage 5 å®ç°ï¼‰
    Navigation.NavigateTo($"/archive-data-sources/{DataSourceId}/scheduled-jobs/{jobId}");
}
```

**é—®é¢˜æè¿°**:
- åˆ—è¡¨é¡µä»»åŠ¡åç§°å¯ç‚¹å‡»ä½†è¯¦æƒ…é¡µæœªå®ç°
- ç”¨æˆ·æ— æ³•æŸ¥çœ‹ä»»åŠ¡é…ç½®è¯¦æƒ…å’Œæ‰§è¡Œå†å²

**ä¿®å¤æ–¹æ¡ˆ**:

åˆ›å»ºè¯¦æƒ…é¡µ `Details.razor`:

```razor
@page "/archive-data-sources/{DataSourceId:guid}/scheduled-jobs/{JobId:guid}"
@attribute [ReuseTabsPage(Title = "ä»»åŠ¡è¯¦æƒ…", Closable = true)]

<PageHeader Title="@_job?.Name" SubTitle="å®šæ—¶å½’æ¡£ä»»åŠ¡è¯¦æƒ…" OnBack="NavigateBack">
    <PageHeaderExtra>
        <Space>
            @if (_job?.IsEnabled == true)
            {
                <SpaceItem><Button OnClick="DisableJob">ç¦ç”¨</Button></SpaceItem>
            }
            else
            {
                <SpaceItem><Button OnClick="EnableJob">å¯ç”¨</Button></SpaceItem>
            }
            <SpaceItem><Button Type="@ButtonType.Primary" OnClick="ExecuteJob">ç«‹å³æ‰§è¡Œ</Button></SpaceItem>
            <SpaceItem><Button OnClick="NavigateToEdit">ç¼–è¾‘</Button></SpaceItem>
        </Space>
    </PageHeaderExtra>
</PageHeader>

<Row Gutter="16">
    <Col Span="16">
        <!-- ä»»åŠ¡é…ç½®å¡ç‰‡ -->
        <Card Title="ä»»åŠ¡é…ç½®" Class="section-card">
            <Descriptions Bordered Column="2">
                <DescriptionsItem Title="ä»»åŠ¡åç§°" Span="2">@_job?.Name</DescriptionsItem>
                <DescriptionsItem Title="ä»»åŠ¡æè¿°" Span="2">@(_job?.Description ?? "-")</DescriptionsItem>
                <DescriptionsItem Title="æºè¡¨">@_job?.FullSourceTable</DescriptionsItem>
                <DescriptionsItem Title="ç›®æ ‡è¡¨">@_job?.FullTargetTable</DescriptionsItem>
                <DescriptionsItem Title="æ‰¹æ¬¡å¤§å°">@_job?.BatchSize.ToString("N0") è¡Œ</DescriptionsItem>
                <DescriptionsItem Title="å•æ¬¡æœ€å¤§">@_job?.MaxRowsPerExecution.ToString("N0") è¡Œ</DescriptionsItem>
                <DescriptionsItem Title="è°ƒåº¦æ–¹å¼">@GetScheduleDescription()</DescriptionsItem>
                <DescriptionsItem Title="çŠ¶æ€">
                    @if (_job?.IsEnabled == true)
                    {
                        <Badge Status="@BadgeStatus.Success" Text="å¯ç”¨" />
                    }
                    else
                    {
                        <Badge Status="@BadgeStatus.Default" Text="ç¦ç”¨" />
                    }
                </DescriptionsItem>
            </Descriptions>
        </Card>

        <!-- ç­›é€‰æ¡ä»¶å¡ç‰‡ -->
        <Card Title="ç­›é€‰æ¡ä»¶" Class="section-card">
            <pre class="filter-display">@_job?.ArchiveFilterCondition</pre>
        </Card>

        <!-- æ‰§è¡Œå†å²å¡ç‰‡ -->
        <Card Title="æ‰§è¡Œå†å²" Class="section-card">
            <Table TItem="JobExecutionHistoryDto"
                   DataSource="_executionHistory"
                   Loading="_loadingHistory"
                   Size="TableSize.Small"
                   Bordered>
                <PropertyColumn Property="h => h.StartTime" Title="å¼€å§‹æ—¶é—´" />
                <PropertyColumn Property="h => h.Status" Title="çŠ¶æ€" />
                <PropertyColumn Property="h => h.ArchivedRowCount" Title="å½’æ¡£è¡Œæ•°" />
                <PropertyColumn Property="h => h.DurationSeconds" Title="è€—æ—¶ï¼ˆç§’ï¼‰" />
                <PropertyColumn Property="h => h.ErrorMessage" Title="é”™è¯¯ä¿¡æ¯" />
            </Table>
        </Card>
    </Col>

    <Col Span="8">
        <!-- ç»Ÿè®¡å¡ç‰‡ -->
        <Card Title="æ‰§è¡Œç»Ÿè®¡" Class="section-card">
            <Statistic Title="æ€»æ‰§è¡Œæ¬¡æ•°" Value="@_statistics?.TotalExecutions" />
            <Statistic Title="æˆåŠŸæ¬¡æ•°" Value="@_statistics?.SuccessCount" />
            <Statistic Title="å¤±è´¥æ¬¡æ•°" Value="@_statistics?.FailureCount" />
            <Statistic Title="æ€»å½’æ¡£è¡Œæ•°" Value="@_statistics?.TotalArchivedRows?.ToString("N0")" />
        </Card>
    </Col>
</Row>
```

**å½±å“**: ä¸­ - åŠŸèƒ½å®Œæ•´æ€§
**ä¿®å¤éš¾åº¦**: ä¸­

---

## ğŸŸ¡ ä»£ç è´¨é‡æ”¹è¿›ï¼ˆP2ï¼‰

### é—®é¢˜ #10ï¼šå˜æ›´æ£€æµ‹æ€§èƒ½ä¼˜åŒ–

**ä½ç½®**: `Edit.razor:424-441`

**é—®é¢˜æè¿°**:
- æ¯æ¬¡è¾“å…¥éƒ½è§¦å‘å®Œæ•´çš„å˜æ›´æ£€æµ‹
- é¢‘ç¹çš„å­—ç¬¦ä¸²æ¯”è¾ƒå½±å“æ€§èƒ½

**ä¿®å¤æ–¹æ¡ˆ**:

ä½¿ç”¨é˜²æŠ–ï¼ˆdebounceï¼‰å»¶è¿Ÿæ‰§è¡Œï¼š

```csharp
private System.Threading.Timer? _debounceTimer;

private void CheckChanges()
{
    // å–æ¶ˆä¹‹å‰çš„è®¡æ—¶å™¨
    _debounceTimer?.Dispose();

    // åˆ›å»ºæ–°çš„å»¶è¿Ÿæ£€æµ‹
    _debounceTimer = new System.Threading.Timer(_ =>
    {
        InvokeAsync(() =>
        {
            _hasChanges =
                _formModel.Name != _originalModel.Name ||
                _formModel.Description != _originalModel.Description ||
                // ... å…¶ä»–æ¯”è¾ƒ
            StateHasChanged();
        });
    }, null, 300, Timeout.Infinite);  // 300ms å»¶è¿Ÿ
}

public void Dispose()
{
    _debounceTimer?.Dispose();
    _cts.Cancel();
    _cts.Dispose();
}
```

**å½±å“**: ä½ - æ€§èƒ½ä¼˜åŒ–
**ä¿®å¤éš¾åº¦**: ä½

---

### é—®é¢˜ #11ï¼šå–æ¶ˆä»¤ç‰Œæœªä½¿ç”¨

**ä½ç½®**: `Edit.razor:281`

**é—®é¢˜æè¿°**:
- åˆ›å»ºäº†å–æ¶ˆä»¤ç‰Œä½†æœªåœ¨å¼‚æ­¥æ“ä½œä¸­ä½¿ç”¨
- é¡µé¢å¯¼èˆªåå¼‚æ­¥æ“ä½œä»åœ¨æ‰§è¡Œ

**ä¿®å¤æ–¹æ¡ˆ**:
```csharp
private async Task LoadDataSourceInfoAsync()
{
    try
    {
        var result = await DataSourceApi.GetAsync(_cts.Token);  // ä¼ é€’å–æ¶ˆä»¤ç‰Œ
        // ...
    }
    catch (OperationCanceledException)
    {
        // å¿½ç•¥å–æ¶ˆå¼‚å¸¸
    }
}

private async Task LoadJobAsync()
{
    _loading = true;
    try
    {
        var result = await JobApi.GetByIdAsync(JobId, _cts.Token);  // ä¼ é€’å–æ¶ˆä»¤ç‰Œ
        // ...
    }
    catch (OperationCanceledException)
    {
        // å¿½ç•¥å–æ¶ˆå¼‚å¸¸
    }
    finally
    {
        _loading = false;
    }
}
```

**å½±å“**: ä½ - èµ„æºæ³„æ¼
**ä¿®å¤éš¾åº¦**: ä½

---

### é—®é¢˜ #12ï¼šå¯ç”¨/ç¦ç”¨çŠ¶æ€åˆ†ç¦»å¤„ç†

**ä½ç½®**: `Edit.razor:615-631`

**é—®é¢˜æè¿°**:
- æ›´æ–°ä»»åŠ¡é…ç½®æ—¶ä¸åŒ…å« `IsEnabled` å­—æ®µ
- éœ€è¦å•ç‹¬è°ƒç”¨å¯ç”¨/ç¦ç”¨ API
- ç”¨æˆ·ä½“éªŒä¸ä¸€è‡´

**ä¿®å¤æ–¹æ¡ˆ**:

åœ¨æ›´æ–°è¯·æ±‚ä¸­åŒ…å« `IsEnabled`:

```csharp
var request = new UpdateScheduledArchiveJobRequest
{
    // ... å…¶ä»–å­—æ®µ
    IsEnabled = _formModel.IsEnabled,  // æ·»åŠ æ­¤å­—æ®µ
    MaxConsecutiveFailures = _formModel.MaxConsecutiveFailures
};

var result = await JobApi.UpdateAsync(JobId, request);
```

åŒæ—¶åœ¨åç«¯å¤„ç†ï¼š

```csharp
public async Task<Result> UpdateJobAsync(Guid jobId, UpdateScheduledArchiveJobRequest request)
{
    var job = await _repository.GetByIdAsync(jobId);
    if (job == null)
        return Result.Failure("ä»»åŠ¡ä¸å­˜åœ¨");

    // æ›´æ–°é…ç½®
    job.UpdateConfiguration(/* ... */);

    // å¤„ç†å¯ç”¨çŠ¶æ€å˜åŒ–
    if (request.IsEnabled && !job.IsEnabled)
    {
        job.Enable();
        await _schedulerService.ScheduleJobAsync(job);
    }
    else if (!request.IsEnabled && job.IsEnabled)
    {
        job.Disable();
        await _schedulerService.UnscheduleJobAsync(job.Id);
    }

    await _repository.UpdateAsync(job);
    return Result.Success();
}
```

**å½±å“**: ä½ - ç”¨æˆ·ä½“éªŒ
**ä¿®å¤éš¾åº¦**: ä¸­

---

### é—®é¢˜ #13ï¼šé”™è¯¯ä¿¡æ¯ä¸å¤Ÿè¯¦ç»†

**ä½ç½®**: å¤šå¤„

**ä»£ç ç¤ºä¾‹**:
```csharp
Message.Error(result.Error ?? "åˆ›å»ºä»»åŠ¡å¤±è´¥");
```

**é—®é¢˜æè¿°**:
- é”™è¯¯æç¤ºæ³›åŒ–ï¼Œä¸åˆ©äºç”¨æˆ·æ’æŸ¥é—®é¢˜
- æ²¡æœ‰åŒºåˆ†é”™è¯¯ç±»å‹ï¼ˆç½‘ç»œã€éªŒè¯ã€ä¸šåŠ¡é€»è¾‘ï¼‰

**ä¿®å¤æ–¹æ¡ˆ**:

1. **åç«¯è¿”å›ç»“æ„åŒ–é”™è¯¯**:
```csharp
public class Result<T>
{
    public bool IsSuccess { get; set; }
    public T? Value { get; set; }
    public string? Error { get; set; }
    public ErrorType ErrorType { get; set; }  // æ–°å¢
    public Dictionary<string, string[]>? ValidationErrors { get; set; }  // æ–°å¢
}

public enum ErrorType
{
    Validation,
    NotFound,
    BusinessRule,
    Database,
    Network,
    Unknown
}
```

2. **å‰ç«¯æ ¹æ®é”™è¯¯ç±»å‹å±•ç¤ºä¸åŒæç¤º**:
```csharp
private async Task HandleSubmit()
{
    var result = await JobApi.CreateAsync(request);

    if (!result.IsSuccess)
    {
        switch (result.ErrorType)
        {
            case ErrorType.Validation:
                Message.Warning($"è¡¨å•éªŒè¯å¤±è´¥ï¼š{result.Error}");
                if (result.ValidationErrors != null)
                {
                    foreach (var error in result.ValidationErrors)
                    {
                        Message.Warning($"{error.Key}: {string.Join(", ", error.Value)}");
                    }
                }
                break;

            case ErrorType.BusinessRule:
                Message.Error($"ä¸šåŠ¡è§„åˆ™é”™è¯¯ï¼š{result.Error}");
                break;

            case ErrorType.Database:
                Message.Error($"æ•°æ®åº“é”™è¯¯ï¼š{result.Error}ã€‚è¯·è”ç³»ç®¡ç†å‘˜ã€‚");
                break;

            case ErrorType.Network:
                Message.Error("ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œåé‡è¯•");
                break;

            default:
                Message.Error($"æ“ä½œå¤±è´¥ï¼š{result.Error ?? "æœªçŸ¥é”™è¯¯"}");
                break;
        }
        return;
    }

    Message.Success("ä»»åŠ¡åˆ›å»ºæˆåŠŸ");
    Navigation.NavigateTo($"/archive-data-sources/{DataSourceId}/scheduled-jobs");
}
```

**å½±å“**: ä½ - ç”¨æˆ·ä½“éªŒ
**ä¿®å¤éš¾åº¦**: ä¸­

---

## ğŸ”µ åŠŸèƒ½å¢å¼ºå»ºè®®ï¼ˆP2ï¼‰

### é—®é¢˜ #15ï¼šæ‰¹é‡æ“ä½œæ”¯æŒ

**å»ºè®®**:
åœ¨åˆ—è¡¨é¡µæ·»åŠ æ‰¹é‡å¯ç”¨/ç¦ç”¨/åˆ é™¤åŠŸèƒ½

**å®ç°æ–¹æ¡ˆ**:
```razor
<Table TItem="ScheduledArchiveJobDto"
       DataSource="_filteredJobs"
       @bind-SelectedRows="_selectedRows"
       RowSelection="true">
    <!-- è¡¨æ ¼åˆ—å®šä¹‰ -->
</Table>

<Space Style="margin-top: 16px;">
    <SpaceItem>
        <Button Disabled="@(!_selectedRows.Any())" OnClick="EnableSelectedJobs">
            æ‰¹é‡å¯ç”¨ï¼ˆ@_selectedRows.Countï¼‰
        </Button>
    </SpaceItem>
    <SpaceItem>
        <Button Disabled="@(!_selectedRows.Any())" OnClick="DisableSelectedJobs">
            æ‰¹é‡ç¦ç”¨ï¼ˆ@_selectedRows.Countï¼‰
        </Button>
    </SpaceItem>
    <SpaceItem>
        <Popconfirm Title="@($"ç¡®å®šåˆ é™¤é€‰ä¸­çš„ {_selectedRows.Count} ä¸ªä»»åŠ¡å—ï¼Ÿ")"
                    OnConfirm="DeleteSelectedJobs"
                    Disabled="@(!_selectedRows.Any())">
            <Button Danger Disabled="@(!_selectedRows.Any())">
                æ‰¹é‡åˆ é™¤ï¼ˆ@_selectedRows.Countï¼‰
            </Button>
        </Popconfirm>
    </SpaceItem>
</Space>

@code {
    private List<ScheduledArchiveJobDto> _selectedRows = new();

    private async Task EnableSelectedJobs()
    {
        var tasks = _selectedRows.Select(job => JobApi.EnableAsync(job.Id));
        await Task.WhenAll(tasks);
        Message.Success($"å·²å¯ç”¨ {_selectedRows.Count} ä¸ªä»»åŠ¡");
        await RefreshAsync();
        _selectedRows.Clear();
    }
}
```

**å½±å“**: ä½ - åŠŸèƒ½å¢å¼º
**ä¿®å¤éš¾åº¦**: ä½

---

### é—®é¢˜ #16ï¼šä»»åŠ¡å…‹éš†åŠŸèƒ½

**å»ºè®®**:
æ·»åŠ "å…‹éš†ä»»åŠ¡"æŒ‰é’®ï¼Œå¿«é€Ÿåˆ›å»ºç›¸ä¼¼é…ç½®çš„ä»»åŠ¡

**å®ç°æ–¹æ¡ˆ**:
```razor
<!-- Index.razor -->
<ActionColumn Title="æ“ä½œ" Width="260">
    <Space Size="@("small")">
        <!-- ç°æœ‰æ“ä½œæŒ‰é’® -->
        <SpaceItem>
            <Button Type="ButtonType.Link" Size="@ButtonSize.Small" OnClick="() => CloneJob(context)">
                å…‹éš†
            </Button>
        </SpaceItem>
    </Space>
</ActionColumn>

@code {
    private void CloneJob(ScheduledArchiveJobDto job)
    {
        // å¯¼èˆªåˆ°åˆ›å»ºé¡µé¢ï¼Œä¼ é€’å…‹éš†æºä»»åŠ¡ ID
        Navigation.NavigateTo($"/archive-data-sources/{DataSourceId}/scheduled-jobs/create?cloneFrom={job.Id}");
    }
}
```

```razor
<!-- Create.razor -->
@code {
    [Parameter]
    [SupplyParameterFromQuery(Name = "cloneFrom")]
    public Guid? CloneFromJobId { get; set; }

    protected override async Task OnInitializedAsync()
    {
        await LoadDataSourceInfoAsync();

        if (CloneFromJobId.HasValue)
        {
            await LoadJobForClone(CloneFromJobId.Value);
        }
        else
        {
            InitializeFormDefaults();
        }
    }

    private async Task LoadJobForClone(Guid jobId)
    {
        var result = await JobApi.GetByIdAsync(jobId);
        if (result.IsSuccess && result.Value != null)
        {
            var sourceJob = result.Value;

            // å¤åˆ¶é…ç½®ï¼Œä½†ä¿®æ”¹åç§°
            _formModel.Name = $"{sourceJob.Name} - å‰¯æœ¬";
            _formModel.Description = sourceJob.Description;
            _formModel.SourceSchemaName = sourceJob.SourceSchemaName;
            _formModel.SourceTableName = sourceJob.SourceTableName;
            _formModel.TargetSchemaName = sourceJob.TargetSchemaName;
            _formModel.TargetTableName = $"{sourceJob.TargetTableName}_Copy";
            _formModel.ArchiveFilterCondition = sourceJob.ArchiveFilterCondition;
            _formModel.BatchSize = sourceJob.BatchSize;
            _formModel.MaxRowsPerExecution = sourceJob.MaxRowsPerExecution;
            _formModel.IntervalMinutes = sourceJob.IntervalMinutes;
            _formModel.CronExpression = sourceJob.CronExpression;
            _formModel.IsEnabled = false;  // å…‹éš†çš„ä»»åŠ¡é»˜è®¤ç¦ç”¨
            _formModel.MaxConsecutiveFailures = sourceJob.MaxConsecutiveFailures;

            _scheduleMode = !string.IsNullOrWhiteSpace(sourceJob.CronExpression) ? "cron" : "interval";

            Message.Info($"å·²ä»ä»»åŠ¡ \"{sourceJob.Name}\" å…‹éš†é…ç½®ï¼Œè¯·ä¿®æ”¹åä¿å­˜");
        }
    }
}
```

**å½±å“**: ä½ - ç”¨æˆ·ä½“éªŒ
**ä¿®å¤éš¾åº¦**: ä½

---

### é—®é¢˜ #17ï¼šæ‰§è¡Œå†å²æŸ¥çœ‹

**å»ºè®®**:
åœ¨åˆ—è¡¨é¡µæ·»åŠ "æŸ¥çœ‹å†å²"é“¾æ¥ï¼Œå±•ç¤ºä»»åŠ¡æ‰§è¡Œè®°å½•

**å®ç°æ–¹æ¡ˆ**:
```razor
<!-- Index.razor -->
<ActionColumn Title="æ“ä½œ" Width="280">
    <Space Size="@("small")">
        <!-- ç°æœ‰æ“ä½œæŒ‰é’® -->
        <SpaceItem>
            <Button Type="ButtonType.Link" Size="@ButtonSize.Small" OnClick="() => ShowExecutionHistory(context)">
                å†å²
            </Button>
        </SpaceItem>
    </Space>
</ActionColumn>

<Modal Title="@($"{_selectedJob?.Name} - æ‰§è¡Œå†å²")"
       Visible="_historyModalVisible"
       Width="1000"
       OnCancel="() => _historyModalVisible = false"
       Footer="null">
    <Table TItem="JobExecutionHistoryDto"
           DataSource="_executionHistory"
           Loading="_loadingHistory"
           Size="TableSize.Small">
        <PropertyColumn Property="h => h.StartTime" Title="å¼€å§‹æ—¶é—´" Format="yyyy-MM-dd HH:mm:ss" />
        <PropertyColumn Property="h => h.Status" Title="çŠ¶æ€">
            @switch (context.Status)
            {
                case JobExecutionStatus.Success:
                    <Tag Color="green">æˆåŠŸ</Tag>
                    break;
                case JobExecutionStatus.Failed:
                    <Tag Color="red">å¤±è´¥</Tag>
                    break;
                case JobExecutionStatus.Running:
                    <Tag Color="blue">æ‰§è¡Œä¸­</Tag>
                    break;
            }
        </PropertyColumn>
        <PropertyColumn Property="h => h.ArchivedRowCount" Title="å½’æ¡£è¡Œæ•°" Format="N0" />
        <PropertyColumn Property="h => h.DurationSeconds" Title="è€—æ—¶ï¼ˆç§’ï¼‰" />
        <PropertyColumn Property="h => h.ErrorMessage" Title="é”™è¯¯ä¿¡æ¯" />
        <ActionColumn Title="æ“ä½œ">
            @if (!string.IsNullOrEmpty(context.ErrorMessage))
            {
                <Button Size="@ButtonSize.Small" OnClick="() => ShowErrorDetails(context)">
                    æŸ¥çœ‹è¯¦æƒ…
                </Button>
            }
        </ActionColumn>
    </Table>
</Modal>

@code {
    private bool _historyModalVisible;
    private ScheduledArchiveJobDto? _selectedJob;
    private List<JobExecutionHistoryDto> _executionHistory = new();
    private bool _loadingHistory;

    private async Task ShowExecutionHistory(ScheduledArchiveJobDto job)
    {
        _selectedJob = job;
        _historyModalVisible = true;
        _loadingHistory = true;

        try
        {
            var result = await JobApi.GetExecutionHistoryAsync(job.Id, pageIndex: 1, pageSize: 50);
            if (result.IsSuccess && result.Value != null)
            {
                _executionHistory = result.Value.Items;
            }
        }
        finally
        {
            _loadingHistory = false;
            StateHasChanged();
        }
    }
}
```

**å½±å“**: ä¸­ - åŠŸèƒ½å®Œæ•´æ€§
**ä¿®å¤éš¾åº¦**: ä¸­

---

### é—®é¢˜ #18ï¼šCron è¡¨è¾¾å¼ä¸‹æ¬¡æ‰§è¡Œæ—¶é—´é¢„è§ˆ

**å»ºè®®**:
åœ¨ CronBuilder ä¸­å±•ç¤ºæœªæ¥ 5 æ¬¡æ‰§è¡Œæ—¶é—´

**å®ç°æ–¹æ¡ˆ**:
```razor
<!-- CronBuilder.razor -->
@if (!string.IsNullOrWhiteSpace(_cronExpression) && _isValidCron)
{
    <div class="next-executions">
        <Text Strong>é¢„è®¡æ‰§è¡Œæ—¶é—´ï¼š</Text>
        <Timeline>
            @foreach (var nextTime in _nextExecutionTimes)
            {
                <TimelineItem>@nextTime.ToString("yyyy-MM-dd HH:mm:ss")</TimelineItem>
            }
        </Timeline>
    </div>
}

@code {
    private List<DateTime> _nextExecutionTimes = new();

    private void OnCronExpressionChanged(string? expression)
    {
        _cronExpression = expression;
        UpdateNextExecutionTimes();
        // ...
    }

    private void UpdateNextExecutionTimes()
    {
        _nextExecutionTimes.Clear();

        if (string.IsNullOrWhiteSpace(_cronExpression))
            return;

        try
        {
            var schedule = CronExpression.Parse(_cronExpression);
            var now = DateTime.UtcNow;

            for (int i = 0; i < 5; i++)
            {
                var next = schedule.GetNextOccurrence(now, TimeZoneInfo.Local);
                if (next.HasValue)
                {
                    _nextExecutionTimes.Add(next.Value.LocalDateTime);
                    now = next.Value.UtcDateTime;
                }
                else
                {
                    break;
                }
            }
        }
        catch
        {
            // Cron è¡¨è¾¾å¼æ— æ•ˆ
        }
    }
}
```

**å½±å“**: ä½ - ç”¨æˆ·ä½“éªŒ
**ä¿®å¤éš¾åº¦**: ä½

---

## ğŸ”’ å®‰å…¨æ€§å»ºè®®ï¼ˆP2ï¼‰

### é—®é¢˜ #19ï¼šæ— æƒé™éªŒè¯

**å»ºè®®**:
æ·»åŠ åŸºäºè§’è‰²çš„æƒé™æ§åˆ¶

**å®ç°æ–¹æ¡ˆ**:
```csharp
// å®šä¹‰æƒé™ç­–ç•¥
public static class Permissions
{
    public const string ViewJobs = "ScheduledJobs.View";
    public const string CreateJobs = "ScheduledJobs.Create";
    public const string EditJobs = "ScheduledJobs.Edit";
    public const string DeleteJobs = "ScheduledJobs.Delete";
    public const string ExecuteJobs = "ScheduledJobs.Execute";
}

// Program.cs æ³¨å†Œç­–ç•¥
builder.Services.AddAuthorization(options =>
{
    options.AddPolicy(Permissions.ViewJobs, policy =>
        policy.RequireRole("Admin", "Operator", "Viewer"));
    options.AddPolicy(Permissions.CreateJobs, policy =>
        policy.RequireRole("Admin", "Operator"));
    options.AddPolicy(Permissions.EditJobs, policy =>
        policy.RequireRole("Admin", "Operator"));
    options.AddPolicy(Permissions.DeleteJobs, policy =>
        policy.RequireRole("Admin"));
    options.AddPolicy(Permissions.ExecuteJobs, policy =>
        policy.RequireRole("Admin", "Operator"));
});
```

```razor
<!-- Index.razor -->
@attribute [Authorize(Policy = Permissions.ViewJobs)]

<AuthorizeView Policy="@Permissions.CreateJobs">
    <Authorized>
        <Button Type="ButtonType.Primary" Icon="plus" OnClick="ShowCreateModal">æ–°å»ºä»»åŠ¡</Button>
    </Authorized>
</AuthorizeView>

<ActionColumn Title="æ“ä½œ">
    <Space Size="@("small")">
        <AuthorizeView Policy="@Permissions.ExecuteJobs">
            <Authorized>
                <SpaceItem>
                    <Button Type="ButtonType.Link" Size="@ButtonSize.Small" OnClick="() => ExecuteJobAsync(context.Id)">
                        ç«‹å³æ‰§è¡Œ
                    </Button>
                </SpaceItem>
            </Authorized>
        </AuthorizeView>

        <AuthorizeView Policy="@Permissions.EditJobs">
            <Authorized>
                <SpaceItem>
                    <Button Type="ButtonType.Link" Size="@ButtonSize.Small" OnClick="() => ShowEditModal(context)">
                        ç¼–è¾‘
                    </Button>
                </SpaceItem>
            </Authorized>
        </AuthorizeView>

        <AuthorizeView Policy="@Permissions.DeleteJobs">
            <Authorized>
                <SpaceItem>
                    <Popconfirm Title="ç¡®å®šåˆ é™¤æ­¤ä»»åŠ¡å—ï¼Ÿ" OnConfirm="() => DeleteJobAsync(context.Id)">
                        <Button Type="ButtonType.Link" Size="@ButtonSize.Small" Danger>åˆ é™¤</Button>
                    </Popconfirm>
                </SpaceItem>
            </Authorized>
        </AuthorizeView>
    </Space>
</ActionColumn>
```

**å½±å“**: é«˜ - å®‰å…¨æ€§
**ä¿®å¤éš¾åº¦**: ä¸­

---

### é—®é¢˜ #20ï¼šå±é™©æ“ä½œç¡®è®¤ä¸è¶³

**å»ºè®®**:
ä¸ºå±é™©æ“ä½œæ·»åŠ äºŒæ¬¡ç¡®è®¤

**å®ç°æ–¹æ¡ˆ**:
```csharp
// ç«‹å³æ‰§è¡Œç¡®è®¤
private async Task ExecuteJobAsync(Guid jobId)
{
    var job = _jobs.FirstOrDefault(j => j.Id == jobId);
    if (job == null) return;

    var confirmed = await Modal.ConfirmAsync(new ConfirmOptions
    {
        Title = "ç¡®è®¤ç«‹å³æ‰§è¡Œï¼Ÿ",
        Content = new RenderFragment(builder =>
        {
            builder.OpenElement(0, "div");
            builder.AddContent(1, $"å°†ç«‹å³æ‰§è¡Œå½’æ¡£ä»»åŠ¡ï¼š{job.Name}");
            builder.OpenElement(2, "div");
            builder.AddAttribute(3, "style", "margin-top: 8px; color: #faad14;");
            builder.AddContent(4, "âš ï¸ æ­¤æ“ä½œå¯èƒ½å½±å“ç”Ÿäº§ç¯å¢ƒï¼Œè¯·ç¡®ä¿åœ¨ä½å³°æœŸæ‰§è¡Œ");
            builder.CloseElement();
            builder.CloseElement();
        }),
        OkText = "ç¡®è®¤æ‰§è¡Œ",
        OkType = "primary",
        OkButtonProps = new ButtonProps { Danger = true },
        CancelText = "å–æ¶ˆ"
    });

    if (!confirmed) return;

    var result = await JobApi.ExecuteAsync(jobId);
    // ...
}

// ç¦ç”¨ä»»åŠ¡ç¡®è®¤
private async Task DisableJobAsync(Guid jobId)
{
    var job = _jobs.FirstOrDefault(j => j.Id == jobId);
    if (job == null) return;

    var confirmed = await Modal.ConfirmAsync(new ConfirmOptions
    {
        Title = "ç¡®è®¤ç¦ç”¨ä»»åŠ¡ï¼Ÿ",
        Content = $"ç¦ç”¨ä»»åŠ¡ \"{job.Name}\" åå°†ä¸å†è‡ªåŠ¨æ‰§è¡Œå½’æ¡£æ“ä½œï¼Œå¯èƒ½å¯¼è‡´æ•°æ®ç§¯å‹ã€‚",
        OkText = "ç¡®è®¤ç¦ç”¨",
        CancelText = "å–æ¶ˆ"
    });

    if (!confirmed) return;

    var result = await JobApi.DisableAsync(jobId);
    // ...
}

// ä¿®æ”¹å…³é”®é…ç½®è­¦å‘Š
private async Task HandleSubmit()
{
    if (!ValidateForm())
    {
        Message.Warning(_validationMessage ?? "è¯·å®Œå–„è¡¨å•ä¿¡æ¯");
        return;
    }

    // æ£€æŸ¥æ˜¯å¦ä¿®æ”¹äº†å…³é”®å‚æ•°
    bool hasRiskyChanges =
        _formModel.SourceTableName != _originalModel.SourceTableName ||
        _formModel.TargetTableName != _originalModel.TargetTableName ||
        _formModel.ArchiveFilterCondition != _originalModel.ArchiveFilterCondition;

    if (hasRiskyChanges)
    {
        var confirmed = await Modal.ConfirmAsync(new ConfirmOptions
        {
            Title = "æ£€æµ‹åˆ°å…³é”®é…ç½®å˜æ›´",
            Content = new RenderFragment(builder =>
            {
                builder.OpenElement(0, "div");
                builder.AddContent(1, "æ‚¨ä¿®æ”¹äº†ä»¥ä¸‹å…³é”®é…ç½®ï¼š");
                builder.OpenElement(2, "ul");

                if (_formModel.SourceTableName != _originalModel.SourceTableName)
                    builder.AddMarkupContent(3, "<li>æºè¡¨åç§°</li>");
                if (_formModel.TargetTableName != _originalModel.TargetTableName)
                    builder.AddMarkupContent(4, "<li>ç›®æ ‡è¡¨åç§°</li>");
                if (_formModel.ArchiveFilterCondition != _originalModel.ArchiveFilterCondition)
                    builder.AddMarkupContent(5, "<li>ç­›é€‰æ¡ä»¶</li>");

                builder.CloseElement();
                builder.AddMarkupContent(6, "<div style='margin-top: 8px; color: #ff4d4f;'><strong>âš ï¸ ä¿®æ”¹è¿™äº›é…ç½®å¯èƒ½å¯¼è‡´å½’æ¡£æ•°æ®ä¸ä¸€è‡´æˆ–ä¸¢å¤±ï¼Œè¯·è°¨æ…æ“ä½œï¼</strong></div>");
                builder.CloseElement();
            }),
            OkText = "æˆ‘å·²ç¡®è®¤ï¼Œç»§ç»­ä¿å­˜",
            OkType = "primary",
            OkButtonProps = new ButtonProps { Danger = true },
            CancelText = "å–æ¶ˆ"
        });

        if (!confirmed) return;
    }

    // ç»§ç»­ä¿å­˜é€»è¾‘
    // ...
}
```

**å½±å“**: é«˜ - å®‰å…¨æ€§
**ä¿®å¤éš¾åº¦**: ä½

---

## ğŸ“± ç”¨æˆ·ä½“éªŒä¼˜åŒ–ï¼ˆP3ï¼‰

### é—®é¢˜ #21ï¼šå“åº”å¼è®¾è®¡ä¸è¶³

**é—®é¢˜æè¿°**:
- 16:8 çš„åˆ—å¸ƒå±€åœ¨å°å±å¹•ä¸Šä½“éªŒå·®
- ç§»åŠ¨ç«¯å³ä¾§é¢„è§ˆé¢æ¿è¢«æŒ¤å‹

**ä¿®å¤æ–¹æ¡ˆ**:
```razor
<Row Gutter="16">
    <AntDesign.Col Xs="24" Sm="24" Md="24" Lg="16" Xl="16">
        <!-- å·¦ä¾§è¡¨å• -->
    </AntDesign.Col>

    <AntDesign.Col Xs="24" Sm="24" Md="24" Lg="8" Xl="8">
        <!-- å³ä¾§é¢„è§ˆ -->
    </AntDesign.Col>
</Row>

<style>
@media (max-width: 992px) {
    .preview-panel {
        position: static;
        margin-top: 16px;
    }
}
</style>
```

**å½±å“**: ä½ - ç§»åŠ¨ç«¯ä½“éªŒ
**ä¿®å¤éš¾åº¦**: ä½

---

### é—®é¢˜ #22ï¼šæ— åŠ è½½éª¨æ¶å±

**ä¿®å¤æ–¹æ¡ˆ**:
```razor
@if (_loading)
{
    <Card>
        <Skeleton Active Paragraph="@(new SkeletonParagraphProps { Rows = 8 })" />
    </Card>
}
else
{
    <!-- å®é™…å†…å®¹ -->
}
```

**å½±å“**: ä½ - åŠ è½½ä½“éªŒ
**ä¿®å¤éš¾åº¦**: ä½

---

### é—®é¢˜ #23ï¼šæ— å¸®åŠ©æ–‡æ¡£

**ä¿®å¤æ–¹æ¡ˆ**:
```razor
<FormItem Label="æ‰¹æ¬¡å¤§å°" Required>
    <Space>
        <SpaceItem>
            <RadioGroup @bind-Value="_formModel.BatchSize">
                <Radio Value="1000">1,000 è¡Œ</Radio>
                <Radio Value="5000">5,000 è¡Œï¼ˆæ¨èï¼‰</Radio>
                <Radio Value="10000">10,000 è¡Œ</Radio>
            </RadioGroup>
        </SpaceItem>
        <SpaceItem>
            <Tooltip Title="æ‰¹æ¬¡å¤§å°å†³å®šæ¯æ¬¡ä»æºè¡¨è¯»å–å’Œå†™å…¥ç›®æ ‡è¡¨çš„è¡Œæ•°ã€‚è¾ƒå°çš„æ‰¹æ¬¡å¯ä»¥å‡å°‘é”å®šæ—¶é—´ï¼Œä½†ä¼šå¢åŠ å¾€è¿”æ¬¡æ•°ã€‚å»ºè®®æ ¹æ®è¡¨å¤§å°å’ŒæœåŠ¡å™¨æ€§èƒ½é€‰æ‹©åˆé€‚çš„å€¼ã€‚">
                <Icon Type="question-circle" Theme="outline" Style="color: rgba(0,0,0,.45);" />
            </Tooltip>
        </SpaceItem>
    </Space>
</FormItem>
```

**å½±å“**: ä½ - ç”¨æˆ·ä½“éªŒ
**ä¿®å¤éš¾åº¦**: ä½

---

### é—®é¢˜ #24ï¼šæ— å›½é™…åŒ–æ”¯æŒ

**ä¿®å¤æ–¹æ¡ˆ**:
```csharp
// ä½¿ç”¨èµ„æºæ–‡ä»¶
@inject IStringLocalizer<ScheduledJobs> L

<Button>@L["CreateTask"]</Button>
<Message>@L["TaskCreatedSuccess"]</Message>

// Resources/ScheduledJobs.zh-CN.resx
CreateTask = æ–°å»ºä»»åŠ¡
TaskCreatedSuccess = ä»»åŠ¡åˆ›å»ºæˆåŠŸ

// Resources/ScheduledJobs.en-US.resx
CreateTask = Create Task
TaskCreatedSuccess = Task created successfully
```

**å½±å“**: ä½ - å›½é™…åŒ–éœ€æ±‚
**ä¿®å¤éš¾åº¦**: ä¸­

---

### é—®é¢˜ #25ï¼šæ— é”®ç›˜å¯¼èˆªæ”¯æŒ

**ä¿®å¤æ–¹æ¡ˆ**:
```razor
@inject IJSRuntime JS

<PageHeader Title="æ–°å»ºå®šæ—¶å½’æ¡£ä»»åŠ¡" OnBack="NavigateBack">
    <PageHeaderExtra>
        <Space>
            <SpaceItem><Button OnClick="HandleReset" Title="Alt+R">é‡ç½®</Button></SpaceItem>
            <SpaceItem><Button OnClick="NavigateBack" Title="Esc">å–æ¶ˆ</Button></SpaceItem>
            <SpaceItem><Button Type="@ButtonType.Primary" Loading="_submitting" OnClick="HandleSubmit" Title="Ctrl+S">ä¿å­˜</Button></SpaceItem>
        </Space>
    </PageHeaderExtra>
</PageHeader>

@code {
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await JS.InvokeVoidAsync("registerKeyboardShortcuts",
                DotNetObjectReference.Create(this));
        }
    }

    [JSInvokable]
    public async Task OnKeyboardShortcut(string key)
    {
        switch (key)
        {
            case "ctrl+s":
            case "cmd+s":
                await HandleSubmit();
                break;
            case "escape":
                NavigateBack();
                break;
            case "alt+r":
                HandleReset();
                break;
        }
    }
}
```

```javascript
// wwwroot/js/keyboard-shortcuts.js
window.registerKeyboardShortcuts = (dotNetHelper) => {
    document.addEventListener('keydown', (e) => {
        if ((e.ctrlKey || e.metaKey) && e.key === 's') {
            e.preventDefault();
            dotNetHelper.invokeMethodAsync('OnKeyboardShortcut', 'ctrl+s');
        } else if (e.key === 'Escape') {
            dotNetHelper.invokeMethodAsync('OnKeyboardShortcut', 'escape');
        } else if (e.altKey && e.key === 'r') {
            e.preventDefault();
            dotNetHelper.invokeMethodAsync('OnKeyboardShortcut', 'alt+r');
        }
    });
};
```

**å½±å“**: ä½ - é«˜çº§ç”¨æˆ·ä½“éªŒ
**ä¿®å¤éš¾åº¦**: ä¸­

---

## ğŸ§ª æµ‹è¯•å’Œæ–‡æ¡£ï¼ˆP3ï¼‰

### é—®é¢˜ #26ï¼šç¼ºå°‘è‡ªåŠ¨åŒ–æµ‹è¯•

**å»ºè®®**:
æ·»åŠ å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•

**å®ç°æ–¹æ¡ˆ**:
```csharp
// tests/DbArchiveTool.Web.Tests/Pages/ScheduledJobs/CreateTests.cs
public class CreatePageTests : TestContext
{
    [Fact]
    public void ValidateForm_EmptyName_ReturnsError()
    {
        // Arrange
        var cut = RenderComponent<Create>(parameters => parameters
            .Add(p => p.DataSourceId, Guid.NewGuid()));

        var form = cut.FindComponent<CreateJobFormModel>();
        form.Instance.Name = "";

        // Act
        var isValid = cut.InvokeAsync(() => cut.Instance.ValidateForm()).Result;

        // Assert
        Assert.False(isValid);
        Assert.Contains("è¯·å¡«å†™ä»»åŠ¡åç§°", cut.Instance._validationMessage);
    }

    [Fact]
    public async Task HandleSubmit_ValidForm_CallsApiAndNavigates()
    {
        // Arrange
        var mockApi = new Mock<IScheduledArchiveJobApiClient>();
        mockApi.Setup(x => x.CreateAsync(It.IsAny<CreateScheduledArchiveJobRequest>()))
               .ReturnsAsync(Result<Guid>.Success(Guid.NewGuid()));

        Services.AddSingleton(mockApi.Object);

        var cut = RenderComponent<Create>(parameters => parameters
            .Add(p => p.DataSourceId, Guid.NewGuid()));

        // å¡«å……è¡¨å•
        var nameInput = cut.Find("input[placeholder='ä¾‹å¦‚: è®¢å•å½’æ¡£ä»»åŠ¡']");
        await nameInput.ChangeAsync("æµ‹è¯•ä»»åŠ¡");

        // Act
        var submitButton = cut.Find("button[type='submit']");
        await submitButton.ClickAsync(new Microsoft.AspNetCore.Components.Web.MouseEventArgs());

        // Assert
        mockApi.Verify(x => x.CreateAsync(It.Is<CreateScheduledArchiveJobRequest>(
            r => r.Name == "æµ‹è¯•ä»»åŠ¡")), Times.Once);
    }
}
```

**å½±å“**: ä¸­ - ä»£ç è´¨é‡
**ä¿®å¤éš¾åº¦**: é«˜

---

### é—®é¢˜ #27ï¼šç¼ºå°‘ä»£ç æ–‡æ¡£

**å»ºè®®**:
ä¸ºå¤æ‚æ–¹æ³•æ·»åŠ  XML æ³¨é‡Š

**å®ç°æ–¹æ¡ˆ**:
```csharp
/// <summary>
/// å¤„ç†è¡¨ç»Ÿè®¡ä¿¡æ¯å˜æ›´äº‹ä»¶
/// </summary>
/// <param name="stats">è¡¨ç»Ÿè®¡ä¿¡æ¯ï¼ŒåŒ…å«è¡Œæ•°ã€å¤§å°ç­‰</param>
/// <remarks>
/// å½“è¡¨æ•°æ®é‡è¶…è¿‡ 100 ä¸‡è¡Œæ—¶ï¼Œä¼šè‡ªåŠ¨è°ƒæ•´æ‰¹æ¬¡å¤§å°å’Œå•æ¬¡æœ€å¤§è¡Œæ•°ï¼Œ
/// ä»¥ä¼˜åŒ–å½’æ¡£æ€§èƒ½å¹¶å‡å°‘å¯¹æºè¡¨çš„é”å®šæ—¶é—´ã€‚
/// </remarks>
private async Task OnTableStatisticsChanged(TableWithStatisticsDto? stats)
{
    _selectedTableStats = stats;

    // å¦‚æœè¡¨è¶…è¿‡100ä¸‡è¡Œ,å»ºè®®è°ƒæ•´æ‰¹æ¬¡å¤§å°
    if (stats != null && stats.RowCount > 1000000)
    {
        bool adjusted = false;

        if (_formModel.BatchSize > 5000)
        {
            _formModel.BatchSize = 5000;
            adjusted = true;
        }
        if (_formModel.MaxRowsPerExecution > 50000)
        {
            _formModel.MaxRowsPerExecution = 50000;
            adjusted = true;
        }

        if (adjusted)
        {
            Message.Info($"æ£€æµ‹åˆ°è¡¨æ•°æ®é‡è¾ƒå¤§ï¼ˆ{stats.RowCount:N0} è¡Œï¼‰ï¼Œå·²è‡ªåŠ¨ä¼˜åŒ–æ‰¹æ¬¡å‚æ•°");
        }
    }

    await InvokeAsync(StateHasChanged);
}
```

**å½±å“**: ä½ - ä»£ç å¯ç»´æŠ¤æ€§
**ä¿®å¤éš¾åº¦**: ä½

---

## ğŸ“Š ä¼˜å…ˆçº§æ€»ç»“

### ç«‹å³ä¿®å¤ï¼ˆP0ï¼‰

| é—®é¢˜ç¼–å· | é—®é¢˜æè¿° | å½±å“ | ä¿®å¤éš¾åº¦ |
|---------|---------|------|---------|
| #1 | å¼‚æ­¥è°ƒç”¨æ­»é”é£é™© | é«˜ | ä½ |
| #2 | ç”Ÿäº§ä»£ç ä¸­çš„è°ƒè¯•è¾“å‡º | ä¸­ | ä½ |
| #3 | ç»„ä»¶åˆå§‹åŒ–ä¸å¯é  | é«˜ | ä¸­ |

**é¢„è®¡å·¥ä½œé‡**: 1-2 å¤©

---

### çŸ­æœŸä¼˜åŒ–ï¼ˆP1ï¼‰

| é—®é¢˜ç¼–å· | é—®é¢˜æè¿° | å½±å“ | ä¿®å¤éš¾åº¦ |
|---------|---------|------|---------|
| #4 | å‰ç«¯è¿‡æ»¤æ€§èƒ½é—®é¢˜ | ä¸­ | ä¸­ |
| #5 | æ“ä½œåç¡¬ç¼–ç å»¶è¿Ÿ | ä¸­ | ä½-é«˜ |
| #6 | è¡¨å•é‡ç½®ä¸å®Œæ•´ | ä¸­ | ä½ |
| #7 | ç›®æ ‡è¡¨åè‡ªåŠ¨è¦†ç›– | ä¸­ | ä½ |
| #8 | æ‰¹æ¬¡å¤§å°è°ƒæ•´æ— æç¤º | ä½ | ä½ |
| #9 | ç¼–è¾‘é¡µå…è®¸ä¿®æ”¹å…³é”®å­—æ®µ | é«˜ | ä½ |
| #14 | è¯¦æƒ…é¡µé¢æœªå®ç° | ä¸­ | ä¸­ |

**é¢„è®¡å·¥ä½œé‡**: 3-5 å¤©

---

### ä¸­æœŸæ”¹è¿›ï¼ˆP2ï¼‰

| é—®é¢˜ç¼–å· | é—®é¢˜æè¿° | å½±å“ | ä¿®å¤éš¾åº¦ |
|---------|---------|------|---------|
| #10 | å˜æ›´æ£€æµ‹æ€§èƒ½ä¼˜åŒ– | ä½ | ä½ |
| #11 | å–æ¶ˆä»¤ç‰Œæœªä½¿ç”¨ | ä½ | ä½ |
| #12 | å¯ç”¨/ç¦ç”¨çŠ¶æ€åˆ†ç¦» | ä½ | ä¸­ |
| #13 | é”™è¯¯ä¿¡æ¯ä¸å¤Ÿè¯¦ç»† | ä½ | ä¸­ |
| #15 | æ‰¹é‡æ“ä½œæ”¯æŒ | ä½ | ä½ |
| #16 | ä»»åŠ¡å…‹éš†åŠŸèƒ½ | ä½ | ä½ |
| #17 | æ‰§è¡Œå†å²æŸ¥çœ‹ | ä¸­ | ä¸­ |
| #18 | Cron ä¸‹æ¬¡æ‰§è¡Œæ—¶é—´é¢„è§ˆ | ä½ | ä½ |
| #19 | æ— æƒé™éªŒè¯ | é«˜ | ä¸­ |
| #20 | å±é™©æ“ä½œç¡®è®¤ä¸è¶³ | é«˜ | ä½ |

**é¢„è®¡å·¥ä½œé‡**: 5-7 å¤©

---

### é•¿æœŸè§„åˆ’ï¼ˆP3ï¼‰

| é—®é¢˜ç¼–å· | é—®é¢˜æè¿° | å½±å“ | ä¿®å¤éš¾åº¦ |
|---------|---------|------|---------|
| #21 | å“åº”å¼è®¾è®¡ä¸è¶³ | ä½ | ä½ |
| #22 | æ— åŠ è½½éª¨æ¶å± | ä½ | ä½ |
| #23 | æ— å¸®åŠ©æ–‡æ¡£ | ä½ | ä½ |
| #24 | æ— å›½é™…åŒ–æ”¯æŒ | ä½ | ä¸­ |
| #25 | æ— é”®ç›˜å¯¼èˆªæ”¯æŒ | ä½ | ä¸­ |
| #26 | ç¼ºå°‘è‡ªåŠ¨åŒ–æµ‹è¯• | ä¸­ | é«˜ |
| #27 | ç¼ºå°‘ä»£ç æ–‡æ¡£ | ä½ | ä½ |

**é¢„è®¡å·¥ä½œé‡**: 5-10 å¤©ï¼ˆå¯é€‰ï¼‰

---

## å»ºè®®çš„ä¿®å¤é¡ºåº

1. **ç¬¬ä¸€é˜¶æ®µï¼ˆç´§æ€¥ï¼‰**: ä¿®å¤ P0 é—®é¢˜ (#1, #2, #3)
2. **ç¬¬äºŒé˜¶æ®µï¼ˆé‡è¦ï¼‰**: ä¿®å¤ P1 ä¸­çš„é«˜å½±å“é—®é¢˜ (#9, #14)
3. **ç¬¬ä¸‰é˜¶æ®µï¼ˆä¼˜åŒ–ï¼‰**: ä¿®å¤ P1 ä¸­çš„å…¶ä»–é—®é¢˜ (#4, #5, #6, #7, #8)
4. **ç¬¬å››é˜¶æ®µï¼ˆå¢å¼ºï¼‰**: å®ç° P2 å®‰å…¨æ€§åŠŸèƒ½ (#19, #20)
5. **ç¬¬äº”é˜¶æ®µï¼ˆå®Œå–„ï¼‰**: å®ç° P2 åŠŸèƒ½å¢å¼º (#15-#18) å’Œä»£ç è´¨é‡æ”¹è¿› (#10-#13)
6. **ç¬¬å…­é˜¶æ®µï¼ˆå¯é€‰ï¼‰**: æ ¹æ®éœ€æ±‚å®ç° P3 ä¼˜åŒ–

---

## é™„å½•

### ç›¸å…³æ–‡ä»¶æ¸…å•

- `src/DbArchiveTool.Web/Pages/ScheduledJobs/Index.razor` - åˆ—è¡¨é¡µ
- `src/DbArchiveTool.Web/Pages/ScheduledJobs/Create.razor` - åˆ›å»ºé¡µ
- `src/DbArchiveTool.Web/Pages/ScheduledJobs/Edit.razor` - ç¼–è¾‘é¡µ
- `src/DbArchiveTool.Web/Components/TableSelector.razor` - è¡¨é€‰æ‹©å™¨ç»„ä»¶
- `src/DbArchiveTool.Web/Components/FilterBuilder.razor` - ç­›é€‰æ¡ä»¶æ„å»ºå™¨
- `src/DbArchiveTool.Web/Components/CronBuilder.razor` - Cron è¡¨è¾¾å¼æ„å»ºå™¨
- `src/DbArchiveTool.Web/Services/ScheduledArchiveJobApiClient.cs` - API å®¢æˆ·ç«¯
- `src/DbArchiveTool.Web/Services/ScheduledArchiveJobState.cs` - çŠ¶æ€ç®¡ç†æœåŠ¡

### è¯„å®¡äººå‘˜

- è¯„å®¡è€…: Claude Code
- è¯„å®¡æ—¥æœŸ: 2025-12-25

---

**æ³¨æ„**: æœ¬è¯„å®¡æŠ¥å‘ŠåŸºäºå½“å‰ä»£ç å¿«ç…§ï¼Œå®é™…ä¿®å¤æ—¶è¯·ç»“åˆæœ€æ–°ä»£ç å’Œä¸šåŠ¡éœ€æ±‚è¿›è¡Œè°ƒæ•´ã€‚
