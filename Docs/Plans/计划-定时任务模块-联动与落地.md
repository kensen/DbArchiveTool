
# 计划-定时任务模块-联动与落地

日期：2025-12-30

> 更新：本计划已根据当前代码落地情况标注完成状态（✅已完成 / ⏳未完成）。

## 1. 背景与目标

当前“定时任务模块”在配置侧（Cron 生成/校验/预览/编辑回显）已测试通过，但从整体体验看，仍存在“配置与真实调度执行/监控联动不明显”的情况。

本计划的目标是把“定时任务=可配置 + 可执行 + 可观测 + 可控”闭环打通：

- 让 Web UI 的操作（创建/编辑/启用/禁用/立即执行）与 Hangfire 的真实任务状态一致、可见
- 统一 Cron 的时区语义（以本地时间语义为主），避免预览正确但实际触发偏移
- 让任务状态（NextExecutionAtUtc / LastExecutionAtUtc / 结果）能解释、能追踪
- 增强运行安全性（并发互斥、失败策略、回归验证）

## 2. 现状核对（已确认）

### 2.1 已具备的能力

- API 端已启动 Hangfire Server，并在启动时会尝试注册“已启用”的定时归档任务。
- Infrastructure 已实现 `ScheduledArchiveJobScheduler`（基于 Hangfire RecurringJob / BackgroundJob）。
- API 已提供定时任务相关接口：CRUD、启用/禁用、立即执行、统计查询、目标表校验/创建等。
- Web 端已完成 CronBuilder 的配置能力（你已验证通过）。

### 2.2 当前体验断裂的主要原因

1) Hangfire Storage 连接串可能不一致

- API：Hangfire 存储当前使用 `ConnectionStrings:ArchiveDatabase`（并写到 Schema=Hangfire）
- Web：监控使用 `ConnectionStrings:HangfireDatabase`（只读监控）

如果两者不是同一个库/同一个 Schema，则 Web 看不到 API 真正注册/运行的任务，造成“没联动”的错觉。

2) 更新任务（PUT Update）后不会自动更新 Hangfire RecurringJob

当前只有 enable/disable 会同步调度；更新 Cron/Interval 后，Hangfire 里可能仍是旧计划，导致“改了没生效”。

3) Cron 时区语义在 Scheduler 侧仍需要统一

UI 生成 Cron 以本地时间语义为主；Scheduler 目前使用 `RecurringJobOptions.TimeZone = Utc`，存在触发偏移风险。

## 3. 范围与非范围

### 3.1 范围

- ScheduledArchiveJob（定时归档任务）的调度联动、运行触发、状态可见、时区语义、NextExecutionAtUtc/统计/历史。

### 3.2 非范围

- 分区维护相关 BackgroundTask 的重构/扩展（本计划不改其业务行为）。
- 其他与定时归档无关的 UI/模块优化（除非与“联动闭环”直接相关）。

## 4. 交付里程碑

- M1（联动可见）：Web 能看到并操作真实 Hangfire 任务
- M2（调度正确）：Cron/Interval 的触发时间与预期一致，NextExecutionAtUtc 可解释
- M3（可观测）：执行历史与统计可用，能定位失败原因
- M4（可运营）：并发互斥/失败策略明确，完成端到端回归

## 5. 详细 Todo（含验收标准）

### 5.1 联动可见（P0）

#### 1) 确认 Hangfire 存储一致（P0）✅已完成

工作内容：

- 核对 API 与 Web 目前分别使用的 Hangfire 连接串与 Schema
- 制定统一策略：
	- 推荐：API 与 Web 监控都指向同一个 Hangfire Storage（同库同 Schema）
	- 若要分离：则 Web 监控必须改为读取 API 使用的那份存储；或在 UI 上明确“监控连接目标”
- 更新配置示例与运行说明（仅在既有文档里补充，不新增无关文档）

验收标准：

- Web 监控页能看到 API 注册的 RecurringJobs
- Hangfire Dashboard（API 暴露的 /hangfire）与 Web 监控展示一致

完成情况：

- 已对齐 API/Web 的 Hangfire 存储读取策略，并修复“监控看不到任务”的主要误判来源（监控聚合 default + archive 队列）。

#### 2) 核对 UI 是否已启用（P0）✅已完成

工作内容：

- 确认定时任务列表/详情页是否有：启用、禁用、立即执行
- 确认按钮调用 API：`POST /api/v1/scheduled-archive-jobs/{id}/enable|disable|execute`
- 操作后刷新缓存/状态（例如刷新列表、详情、统计）

验收标准：

- 点击“启用”后 Hangfire 出现对应 RecurringJob
- 点击“禁用”后 Hangfire 删除对应 RecurringJob
- 点击“立即执行”后 Hangfire 队列出现一次性任务

完成情况：

- Web 端已具备启用/禁用/立即执行入口，并在列表与监控页增强了“业务任务识别/失败原因可见”。

#### 3) 更新时同步调度配置（P0）✅已完成

工作内容：

- 在 API `PUT /scheduled-archive-jobs/{id}` 更新成功后：
	- 若任务当前为启用状态，则调用 `IScheduledArchiveJobScheduler.UpdateJobScheduleAsync(id)`
	- 若任务为禁用状态，则仅更新配置，不注册

验收标准：

- 修改 Cron/Interval 后无需重启、无需禁用/启用，Hangfire 里 Cron 立即更新

完成情况：

- Update 成功后（任务启用时）会同步更新 Hangfire 的 RecurringJob 调度。

#### 4) 创建后启用策略定稿（P0）✅已完成

工作内容：

- 明确“创建任务”的默认启用策略（建议默认禁用，用户显式启用更安全）
- 若要支持默认启用：需要在 Create API/DTO 与 UI 上体现，并在创建后立即注册到 Hangfire

验收标准：

- 创建后的初始状态与 UI 提示一致，不会出现“创建了但其实没跑”的误解

完成情况：

- 当前实现选择：创建后默认启用，并在创建成功后立即注册到 Hangfire，避免“启用但未调度/需要手工点一次启动”。

### 5.2 调度正确（P0/P1）

#### 5) 修正 Cron 时区语义（P0）✅已完成

工作内容：

- Scheduler 注册 RecurringJob 时统一 `RecurringJobOptions.TimeZone`：
	- 推荐改为 `TimeZoneInfo.Local`（与 UI 本地语义一致）
	- 或提供可配置的 TimeZoneId（后续扩展项）

验收标准：

- 东八区下“每天 02:30”实际触发时间为本地 02:30
- 与 UI 预览一致

完成情况：

- Scheduler 注册 RecurringJob 已统一采用本地时区语义（Local）以匹配 UI 生成/预览逻辑。

#### 6) 完善 NextExecutionAtUtc 计算（P1）✅已完成

工作内容：

- 替换 Scheduler 中粗略估算 `CalculateNextExecutionTime`：
	- Cron 模式：用 Cronos 结合 TimeZone 计算下次执行，并以 UTC 写入 `NextExecutionAtUtc`
	- Interval 模式：用 interval 规则计算，写入 UTC
- 修正 Executor 成功后“总是用 IntervalMinutes 推算下一次”的逻辑：
	- Cron 模式不能用 interval 盲算
	- 建议由 Scheduler 统一计算并更新（或抽一个计算服务复用）

验收标准：

- `NextExecutionAtUtc` 与 Hangfire 实际计划一致（允许很小偏差，但需要可解释）

完成情况：

- 后端已引入 Cronos：Cron/Interval 两种模式均由 Cronos 精确计算 NextExecutionAtUtc（以 Local 语义计算、以 UTC 落库）。

### 5.3 可观测（P1）

#### 7) 补齐执行历史与统计（P1）⏳未完成

工作内容：

- 目前 API statistics 存在简化推算与 TODO（SkippedCount）
- 选择一条路径实现历史：
	- A) 落库执行历史表（推荐，可控、可迁移、与业务字段契合）
	- B) 从 Hangfire Storage 读取并映射（实现快，但字段受限）
- 提供 API：history 查询、统计聚合
- Web 展示历史与统计

验收标准：

- UI 能看到每次执行记录：时间、结果、错误、归档行数、耗时
- 统计的成功/失败/跳过计数真实准确

当前状态：

- 已增强列表/监控页的错误可见性（LastExecutionError 等），但“可查询的完整执行历史/统计聚合”仍需单独落地。

### 5.4 可运营（P1/P2）

#### 8) 执行幂等与并发控制（P1）⏳未完成

工作内容：

- 防止同一 ScheduledArchiveJob 重叠执行：
	- 使用 Hangfire 并发限制（例如 DisableConcurrentExecution）或分布式锁
	- 或在应用层/仓储层引入“运行中互斥”
- 定义失败策略：
	- `MaxConsecutiveFailures` 达到阈值后暂停/告警/降级（明确行为即可）

验收标准：

- 同一任务不会因调度重叠而并发执行导致数据问题
- 失败策略行为明确且可观测（日志/状态可见）

#### 9) 归档执行链路核验（P1）⏳未完成

工作内容：

- 核对 ScheduledArchiveJobExecutor → 归档编排服务：
	- 数据源与连接信息
	- 过滤条件
	- 目标表校验/创建
	- delete source data 策略
	- 批次/最大行数

验收标准：

- 定时执行与手动执行在同配置下效果一致（差异必须有文档/提示）

当前状态：

- 已补齐“普通表归档”基础执行能力（用于定时归档任务不再固定失败），但仍需做更系统的链路核验与限制条件梳理（例如目标表索引/约束一致性策略）。

#### 10) 端到端验证与回归（P0/P1）⏳未完成

工作内容：

- 准备一条小表 + 测试数据，覆盖：
	- Interval：每分钟、每小时
	- Cron：每天固定时间、每周、每月
	- 启用/禁用/立即执行
- 验证状态字段与 Hangfire 一致

验收标准：

- 创建→启用→Hangfire 可见→触发→状态更新→禁用后不再触发

## 6. 风险与注意事项

- Hangfire 存储不一致会导致“监控不可见”，属于体验断裂的高频根因，应优先处理。
- Cron 时区语义必须统一，否则会出现“UI 预览正确但实际触发偏移”的生产风险。
- 建议先完成 P0（联动闭环），再推进历史/统计/并发等增强项。

