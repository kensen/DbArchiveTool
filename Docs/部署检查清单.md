# 部署检查清单

> **版本**: 1.0  
> **日期**: 2025年10月8日  
> **适用环境**: 生产环境、测试环境

---

## 📋 部署前检查

### 1. 数据库迁移验证

#### 1.1 迁移列表
确保以下迁移按顺序存在：
```
20250930085014_AddAdminUser
20251001124957_AddArchiveDataSource
20251007053916_AddPartitionCommandExtendedFields
20251008023227_AddTargetServerConfiguration
```

#### 1.2 验证命令
```bash
cd src/DbArchiveTool.Infrastructure
dotnet ef migrations list --project . --startup-project ../DbArchiveTool.Api
```

### 2. 数据库连接配置

#### 2.1 检查连接字符串
文件位置：`src/DbArchiveTool.Api/appsettings.json`

```json
{
  "ConnectionStrings": {
    "ArchiveDatabase": "Server=<YOUR_SERVER>;Database=DbArchiveTool;Trusted_Connection=True;TrustServerCertificate=True"
  }
}
```

> **注意**：
> - 生产环境请使用独立的 `appsettings.Production.json`
> - 密码等敏感信息应使用环境变量或 Azure Key Vault

#### 2.2 数据库名称
- **开发环境**: `DbArchiveTool`
- **生产环境**: 建议使用 `DbArchiveTool_Prod`
- ⚠️ **注意**: 确保不使用 `DbArchiveToolDb`（这是测试时误创建的数据库）

---

## 🚀 部署步骤

### 方式一：自动迁移（推荐用于开发/测试）

API 项目启动时会自动应用待处理的迁移：

```bash
cd src/DbArchiveTool.Api
dotnet run
```

日志中会显示：
```
info: Microsoft.EntityFrameworkCore.Migrations[20405]
      No migrations were applied. The database is already up to date.
```

### 方式二：使用 EF Core 工具手动迁移（推荐用于生产）

```bash
cd src/DbArchiveTool.Infrastructure
dotnet ef database update --project . --startup-project ../DbArchiveTool.Api
```

### 方式三：使用 SQL 脚本部署（最安全）

1. 生成幂等迁移脚本：
```bash
cd src/DbArchiveTool.Infrastructure
dotnet ef migrations script --project . --startup-project ../DbArchiveTool.Api --idempotent --output ../../Sql/Migration_Full_Idempotent.sql
```

2. 在目标数据库执行脚本：
```bash
sqlcmd -S <SERVER> -d <DATABASE> -E -i Sql/Migration_Full_Idempotent.sql
```

---

## ✅ 部署后验证

### 1. 检查迁移历史

```sql
SELECT MigrationId, ProductVersion 
FROM __EFMigrationsHistory 
ORDER BY MigrationId;
```

应返回 4 条记录。

### 2. 验证 ArchiveDataSource 表结构

```sql
SELECT COLUMN_NAME, DATA_TYPE, IS_NULLABLE, COLUMN_DEFAULT
FROM INFORMATION_SCHEMA.COLUMNS
WHERE TABLE_NAME = 'ArchiveDataSource'
ORDER BY ORDINAL_POSITION;
```

**关键字段验证**：
| 字段名 | 类型 | 可空 | 默认值 |
|--------|------|------|--------|
| `UseSourceAsTarget` | bit | NO | 1 |
| `TargetServerPort` | int | NO | 0 |
| `TargetUseIntegratedSecurity` | bit | NO | 0 |
| `TargetServerAddress` | nvarchar(128) | YES | NULL |
| `TargetDatabaseName` | nvarchar(128) | YES | NULL |
| `TargetUserName` | nvarchar(64) | YES | NULL |
| `TargetPassword` | nvarchar(256) | YES | NULL |

### 3. 验证数据完整性

```sql
-- 检查是否有空值问题
SELECT COUNT(*) AS TotalRows,
       SUM(CASE WHEN TargetServerPort IS NULL THEN 1 ELSE 0 END) AS NullPortCount
FROM ArchiveDataSource;
```

`NullPortCount` 应为 0。

### 4. API 健康检查

访问 API 端点：
```
GET http://<API_HOST>:5083/swagger
```

应能正常访问 Swagger UI。

### 5. Web 应用功能测试

1. 登录系统
2. 访问数据源列表页面
3. 尝试创建新数据源
4. 配置目标服务器（点击"目标服务器配置"按钮）

---

## 🔧 常见问题排查

### 问题1：迁移时报错 "列名重复"

**原因**：数据库中已存在列，但迁移历史表中没有记录。

**解决方案**：
```sql
-- 手动标记迁移为已应用
INSERT INTO __EFMigrationsHistory (MigrationId, ProductVersion)
VALUES ('20251008023227_AddTargetServerConfiguration', '8.0.11');
```

### 问题2：读取数据时报 "Data is Null" 异常

**原因**：`TargetServerPort` 字段为 NULL。

**解决方案**：
```sql
-- 更新 NULL 值并添加约束
UPDATE ArchiveDataSource SET TargetServerPort = 1433 WHERE TargetServerPort IS NULL;
ALTER TABLE ArchiveDataSource ALTER COLUMN TargetServerPort INT NOT NULL;
```

### 问题3：默认值不正确

**症状**：`UseSourceAsTarget` 默认值为 0，应为 1。

**解决方案**：
```sql
-- 删除旧约束
DECLARE @sql NVARCHAR(MAX);
SELECT @sql = 'ALTER TABLE ArchiveDataSource DROP CONSTRAINT ' + dc.name 
FROM sys.default_constraints dc 
JOIN sys.columns c ON c.default_object_id = dc.object_id
WHERE c.object_id = OBJECT_ID('ArchiveDataSource') AND c.name = 'UseSourceAsTarget';
IF @sql IS NOT NULL EXEC sp_executesql @sql;

-- 添加正确约束
ALTER TABLE ArchiveDataSource ADD CONSTRAINT DF_ArchiveDataSource_UseSourceAsTarget DEFAULT 1 FOR UseSourceAsTarget;
ALTER TABLE ArchiveDataSource ADD CONSTRAINT DF_ArchiveDataSource_TargetServerPort DEFAULT 0 FOR TargetServerPort;
ALTER TABLE ArchiveDataSource ADD CONSTRAINT DF_ArchiveDataSource_TargetUseIntegratedSecurity DEFAULT 0 FOR TargetUseIntegratedSecurity;
```

---

## 📝 回滚计划

如需回滚到上一个迁移：

```bash
cd src/DbArchiveTool.Infrastructure
dotnet ef database update 20251007053916_AddPartitionCommandExtendedFields --project . --startup-project ../DbArchiveTool.Api
```

或使用 SQL 脚本：
```sql
-- 执行 Down 迁移
ALTER TABLE ArchiveDataSource DROP COLUMN TargetDatabaseName;
ALTER TABLE ArchiveDataSource DROP COLUMN TargetPassword;
ALTER TABLE ArchiveDataSource DROP COLUMN TargetServerAddress;
ALTER TABLE ArchiveDataSource DROP COLUMN TargetServerPort;
ALTER TABLE ArchiveDataSource DROP COLUMN TargetUseIntegratedSecurity;
ALTER TABLE ArchiveDataSource DROP COLUMN TargetUserName;
ALTER TABLE ArchiveDataSource DROP COLUMN UseSourceAsTarget;
DROP TABLE PartitionCommand;

-- 删除迁移记录
DELETE FROM __EFMigrationsHistory WHERE MigrationId = '20251008023227_AddTargetServerConfiguration';
```

---

## 📞 支持

如遇到部署问题，请联系开发团队或查看：
- 项目文档：`Docs/`
- 错误日志：API 启动日志
- 数据库日志：SQL Server Profiler

