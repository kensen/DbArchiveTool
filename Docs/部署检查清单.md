# éƒ¨ç½²æ£€æŸ¥æ¸…å•

> **ç‰ˆæœ¬**: 1.0  
> **æ—¥æœŸ**: 2025å¹´10æœˆ8æ—¥  
> **é€‚ç”¨ç¯å¢ƒ**: ç”Ÿäº§ç¯å¢ƒã€æµ‹è¯•ç¯å¢ƒ

---

## ğŸ“‹ éƒ¨ç½²å‰æ£€æŸ¥

### 1. æ•°æ®åº“è¿ç§»éªŒè¯

#### 1.1 è¿ç§»åˆ—è¡¨
ç¡®ä¿ä»¥ä¸‹è¿ç§»æŒ‰é¡ºåºå­˜åœ¨ï¼š
```
20250930085014_AddAdminUser
20251001124957_AddArchiveDataSource
20251007053916_AddPartitionCommandExtendedFields
20251008023227_AddTargetServerConfiguration
```

#### 1.2 éªŒè¯å‘½ä»¤
```bash
cd src/DbArchiveTool.Infrastructure
dotnet ef migrations list --project . --startup-project ../DbArchiveTool.Api
```

### 2. æ•°æ®åº“è¿æ¥é…ç½®

#### 2.1 æ£€æŸ¥è¿æ¥å­—ç¬¦ä¸²
æ–‡ä»¶ä½ç½®ï¼š`src/DbArchiveTool.Api/appsettings.json`

```json
{
  "ConnectionStrings": {
    "ArchiveDatabase": "Server=<YOUR_SERVER>;Database=DbArchiveTool;Trusted_Connection=True;TrustServerCertificate=True"
  }
}
```

> **æ³¨æ„**ï¼š
> - ç”Ÿäº§ç¯å¢ƒè¯·ä½¿ç”¨ç‹¬ç«‹çš„ `appsettings.Production.json`
> - å¯†ç ç­‰æ•æ„Ÿä¿¡æ¯åº”ä½¿ç”¨ç¯å¢ƒå˜é‡æˆ– Azure Key Vault

#### 2.2 æ•°æ®åº“åç§°
- **å¼€å‘ç¯å¢ƒ**: `DbArchiveTool`
- **ç”Ÿäº§ç¯å¢ƒ**: å»ºè®®ä½¿ç”¨ `DbArchiveTool_Prod`
- âš ï¸ **æ³¨æ„**: ç¡®ä¿ä¸ä½¿ç”¨ `DbArchiveToolDb`ï¼ˆè¿™æ˜¯æµ‹è¯•æ—¶è¯¯åˆ›å»ºçš„æ•°æ®åº“ï¼‰

---

## ğŸš€ éƒ¨ç½²æ­¥éª¤

### æ–¹å¼ä¸€ï¼šè‡ªåŠ¨è¿ç§»ï¼ˆæ¨èç”¨äºå¼€å‘/æµ‹è¯•ï¼‰

API é¡¹ç›®å¯åŠ¨æ—¶ä¼šè‡ªåŠ¨åº”ç”¨å¾…å¤„ç†çš„è¿ç§»ï¼š

```bash
cd src/DbArchiveTool.Api
dotnet run
```

æ—¥å¿—ä¸­ä¼šæ˜¾ç¤ºï¼š
```
info: Microsoft.EntityFrameworkCore.Migrations[20405]
      No migrations were applied. The database is already up to date.
```

### æ–¹å¼äºŒï¼šä½¿ç”¨ EF Core å·¥å…·æ‰‹åŠ¨è¿ç§»ï¼ˆæ¨èç”¨äºç”Ÿäº§ï¼‰

```bash
cd src/DbArchiveTool.Infrastructure
dotnet ef database update --project . --startup-project ../DbArchiveTool.Api
```

### æ–¹å¼ä¸‰ï¼šä½¿ç”¨ SQL è„šæœ¬éƒ¨ç½²ï¼ˆæœ€å®‰å…¨ï¼‰

1. ç”Ÿæˆå¹‚ç­‰è¿ç§»è„šæœ¬ï¼š
```bash
cd src/DbArchiveTool.Infrastructure
dotnet ef migrations script --project . --startup-project ../DbArchiveTool.Api --idempotent --output ../../Sql/Migration_Full_Idempotent.sql
```

2. åœ¨ç›®æ ‡æ•°æ®åº“æ‰§è¡Œè„šæœ¬ï¼š
```bash
sqlcmd -S <SERVER> -d <DATABASE> -E -i Sql/Migration_Full_Idempotent.sql
```

---

## âœ… éƒ¨ç½²åéªŒè¯

### 1. æ£€æŸ¥è¿ç§»å†å²

```sql
SELECT MigrationId, ProductVersion 
FROM __EFMigrationsHistory 
ORDER BY MigrationId;
```

åº”è¿”å› 4 æ¡è®°å½•ã€‚

### 2. éªŒè¯ ArchiveDataSource è¡¨ç»“æ„

```sql
SELECT COLUMN_NAME, DATA_TYPE, IS_NULLABLE, COLUMN_DEFAULT
FROM INFORMATION_SCHEMA.COLUMNS
WHERE TABLE_NAME = 'ArchiveDataSource'
ORDER BY ORDINAL_POSITION;
```

**å…³é”®å­—æ®µéªŒè¯**ï¼š
| å­—æ®µå | ç±»å‹ | å¯ç©º | é»˜è®¤å€¼ |
|--------|------|------|--------|
| `UseSourceAsTarget` | bit | NO | 1 |
| `TargetServerPort` | int | NO | 0 |
| `TargetUseIntegratedSecurity` | bit | NO | 0 |
| `TargetServerAddress` | nvarchar(128) | YES | NULL |
| `TargetDatabaseName` | nvarchar(128) | YES | NULL |
| `TargetUserName` | nvarchar(64) | YES | NULL |
| `TargetPassword` | nvarchar(256) | YES | NULL |

### 3. éªŒè¯æ•°æ®å®Œæ•´æ€§

```sql
-- æ£€æŸ¥æ˜¯å¦æœ‰ç©ºå€¼é—®é¢˜
SELECT COUNT(*) AS TotalRows,
       SUM(CASE WHEN TargetServerPort IS NULL THEN 1 ELSE 0 END) AS NullPortCount
FROM ArchiveDataSource;
```

`NullPortCount` åº”ä¸º 0ã€‚

### 4. API å¥åº·æ£€æŸ¥

è®¿é—® API ç«¯ç‚¹ï¼š
```
GET http://<API_HOST>:5083/swagger
```

åº”èƒ½æ­£å¸¸è®¿é—® Swagger UIã€‚

### 5. Web åº”ç”¨åŠŸèƒ½æµ‹è¯•

1. ç™»å½•ç³»ç»Ÿ
2. è®¿é—®æ•°æ®æºåˆ—è¡¨é¡µé¢
3. å°è¯•åˆ›å»ºæ–°æ•°æ®æº
4. é…ç½®ç›®æ ‡æœåŠ¡å™¨ï¼ˆç‚¹å‡»"ç›®æ ‡æœåŠ¡å™¨é…ç½®"æŒ‰é’®ï¼‰

---

## ğŸ”§ å¸¸è§é—®é¢˜æ’æŸ¥

### é—®é¢˜1ï¼šè¿ç§»æ—¶æŠ¥é”™ "åˆ—åé‡å¤"

**åŸå› **ï¼šæ•°æ®åº“ä¸­å·²å­˜åœ¨åˆ—ï¼Œä½†è¿ç§»å†å²è¡¨ä¸­æ²¡æœ‰è®°å½•ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼š
```sql
-- æ‰‹åŠ¨æ ‡è®°è¿ç§»ä¸ºå·²åº”ç”¨
INSERT INTO __EFMigrationsHistory (MigrationId, ProductVersion)
VALUES ('20251008023227_AddTargetServerConfiguration', '8.0.11');
```

### é—®é¢˜2ï¼šè¯»å–æ•°æ®æ—¶æŠ¥ "Data is Null" å¼‚å¸¸

**åŸå› **ï¼š`TargetServerPort` å­—æ®µä¸º NULLã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼š
```sql
-- æ›´æ–° NULL å€¼å¹¶æ·»åŠ çº¦æŸ
UPDATE ArchiveDataSource SET TargetServerPort = 1433 WHERE TargetServerPort IS NULL;
ALTER TABLE ArchiveDataSource ALTER COLUMN TargetServerPort INT NOT NULL;
```

### é—®é¢˜3ï¼šé»˜è®¤å€¼ä¸æ­£ç¡®

**ç—‡çŠ¶**ï¼š`UseSourceAsTarget` é»˜è®¤å€¼ä¸º 0ï¼Œåº”ä¸º 1ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼š
```sql
-- åˆ é™¤æ—§çº¦æŸ
DECLARE @sql NVARCHAR(MAX);
SELECT @sql = 'ALTER TABLE ArchiveDataSource DROP CONSTRAINT ' + dc.name 
FROM sys.default_constraints dc 
JOIN sys.columns c ON c.default_object_id = dc.object_id
WHERE c.object_id = OBJECT_ID('ArchiveDataSource') AND c.name = 'UseSourceAsTarget';
IF @sql IS NOT NULL EXEC sp_executesql @sql;

-- æ·»åŠ æ­£ç¡®çº¦æŸ
ALTER TABLE ArchiveDataSource ADD CONSTRAINT DF_ArchiveDataSource_UseSourceAsTarget DEFAULT 1 FOR UseSourceAsTarget;
ALTER TABLE ArchiveDataSource ADD CONSTRAINT DF_ArchiveDataSource_TargetServerPort DEFAULT 0 FOR TargetServerPort;
ALTER TABLE ArchiveDataSource ADD CONSTRAINT DF_ArchiveDataSource_TargetUseIntegratedSecurity DEFAULT 0 FOR TargetUseIntegratedSecurity;
```

---

## ğŸ“ å›æ»šè®¡åˆ’

å¦‚éœ€å›æ»šåˆ°ä¸Šä¸€ä¸ªè¿ç§»ï¼š

```bash
cd src/DbArchiveTool.Infrastructure
dotnet ef database update 20251007053916_AddPartitionCommandExtendedFields --project . --startup-project ../DbArchiveTool.Api
```

æˆ–ä½¿ç”¨ SQL è„šæœ¬ï¼š
```sql
-- æ‰§è¡Œ Down è¿ç§»
ALTER TABLE ArchiveDataSource DROP COLUMN TargetDatabaseName;
ALTER TABLE ArchiveDataSource DROP COLUMN TargetPassword;
ALTER TABLE ArchiveDataSource DROP COLUMN TargetServerAddress;
ALTER TABLE ArchiveDataSource DROP COLUMN TargetServerPort;
ALTER TABLE ArchiveDataSource DROP COLUMN TargetUseIntegratedSecurity;
ALTER TABLE ArchiveDataSource DROP COLUMN TargetUserName;
ALTER TABLE ArchiveDataSource DROP COLUMN UseSourceAsTarget;
DROP TABLE PartitionCommand;

-- åˆ é™¤è¿ç§»è®°å½•
DELETE FROM __EFMigrationsHistory WHERE MigrationId = '20251008023227_AddTargetServerConfiguration';
```

---

## ğŸ“ æ”¯æŒ

å¦‚é‡åˆ°éƒ¨ç½²é—®é¢˜ï¼Œè¯·è”ç³»å¼€å‘å›¢é˜Ÿæˆ–æŸ¥çœ‹ï¼š
- é¡¹ç›®æ–‡æ¡£ï¼š`Docs/`
- é”™è¯¯æ—¥å¿—ï¼šAPI å¯åŠ¨æ—¥å¿—
- æ•°æ®åº“æ—¥å¿—ï¼šSQL Server Profiler

