# 数据归档功能开发 Todos

## 顶层阶段
- [x] 完成 P0 后端能力闭环
- [x] 搭建归档向导前端流程（完成 Markdown 预览与任务跳转）
- [ ] 扩充测试与运维支撑

## 近期目标：P0 后端能力闭环
- [x] 扩展 `PartitionSwitchInspectionService` Blocker 校验（索引/约束/权限/锁）
  - [x] 借助 `SqlExecutor` 查询分区对象，输出结构差异明细
  - [x] 接入权限检测脚本（ALTER/TABLE CONTROL）
  - [x] 增加锁冲突检查（查 `sys.dm_tran_locks`）
  - [x] 拦截目标表触发器与外键依赖并输出阻塞提示
  - [x] 验证源/目标表 ALTER 权限并检测源表锁占用
  - [x] 比对 CHECK/DEFAULT 约束定义并输出阻塞提示
- [x] 设计 `PartitionSwitchPlan` 结构
  - [x] 明确 Blocker/AutoFix/Warning 模型与字段
  - [x] 定义 AutoFix 任务步骤（创建表/同步分区/索引/约束/统计）
- [x] 实现 AutoFix 执行链路
  - [x] 在应用层提供 `AutoFixAsync`，接受用户勾选的步骤
  - [x] 基础设施落地自动补齐执行器，执行 SQL 并记录日志
  - [x] 失败场景回滚策略与错误上报
- [x] 强化 `SqlPartitionCommandExecutor.ExecuteSwitchWithTransactionAsync`
  - [x] 拆分执行阶段日志（检查、补齐、切换）
  - [x] 异常分类输出 & 写入后台任务日志

## 中期目标：归档向导前端流程 ✅ **已完成**
- [x] `PartitionArchiveWizard.razor` 框架搭建
  - [x] Step 切换组件与向导状态管理
  - [x] Step 1 方案选择（禁用 BCP/BulkCopy）
  - [x] Step 2 参数配置表单与实时校验
  - [x] Step 3 预检结果展示（Blocker/AutoFix/Warning）
  - [x] Step 4 执行确认与 API 调用（补齐 Markdown 预览 & 成功跳转）
- [x] 与后端对接
  - [x] 预检接口调用 & AutoFix 勾选逻辑
  - [x] 任务提交成功后的跳转与提示
  - [x] 批量分区归档支持（多分区选择与依次执行）
  - [x] 配置关联（可选择已保存的分区配置）

## 后续目标：测试与运维支撑（2025-11-04 更新）
- [x] 集成测试覆盖
  - [x] 正常切换（单分区/批量分区）✅ 工具创建的分区测试通过
  - [x] 结构不匹配检测 ✅
  - [x] 目标表非空检测 ✅ **已增强为阻断模式**
  - [x] 跨实例阻断检测 ✅
  - [x] 索引对齐检查与自动修复 ✅
  - [x] 分区配置验证 ✅
  - [ ] 已有分区归档场景测试（待补充，需覆盖对齐问题处理流程）
- [x] 任务监控增强
  - [x] 展示预检/补齐/执行日志（Markdown 格式）✅
  - [x] 批量执行进度展示（成功/失败计数）✅
  - [ ] 失败重试与人工干预入口（计划中）
- [ ] 文档与运维稿（**高优先级**）
  - [x] 技术设计文档更新 ✅
  - [ ] **用户操作手册**（待编写，包含）：
    - [ ] 工具创建分区并归档完整流程（含截图）
    - [ ] 已有分区对齐检查与处理指南
    - [ ] 批量归档操作说明
    - [ ] 自动补齐功能使用说明与注意事项
  - [ ] **FAQ 与常见故障处理**（待整理，包含）：
    - [ ] 索引未对齐问题处理
    - [ ] 约束不匹配问题处理
    - [ ] 分区方案名称不一致问题处理
    - [ ] 目标表残留数据处理流程
    - [ ] 预检失败常见原因与解决方案
  - [ ] **已有分区诊断脚本**（待开发）：
    - [ ] 分区方案对齐检查脚本
    - [ ] 索引对齐状态检查脚本
    - [ ] 约束一致性检查脚本
- [x] 无分区配置草稿场景回归（归档接口支持直连元数据，向导可直接触发）✅
  - [x] 拓展应用服务/仓储以支持默认配置加载 ✅
  - [x] 更新前端归档向导交互（提示、字段收集）✅
  - [x] 增补集成测试覆盖此场景 ✅

## 安全增强记录（2025-11-04）
- ✅ **CleanupResidualData 步骤重构**：
  - 原逻辑：自动执行 TRUNCATE 清空目标分区数据
  - 新逻辑：**仅检测+阻断**，不自动清空
  - 检测到残留数据时：
    - 返回 `Succeeded=false`
    - 提供手动清空脚本（包含事务控制）
    - 中断自动补齐流程
  - 提高归档安全性，防止误删除业务数据
- ✅ 测试验证：工具创建的分区能正常通过检测（目标分区为空）
- ⚠️ 影响：已有分区如目标表非空需手动处理后才能归档
