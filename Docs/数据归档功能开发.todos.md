# 数据归档功能开发 Todos

> **最后更新**: 2025-11-05  
> **当前阶段**: Blazor UI 管理页面开发与后端增强

## 顶层阶段
- [x] 完成 P0 后端能力闭环
- [x] 搭建归档向导前端流程（完成 Markdown 预览与任务跳转）
- [x] **Blazor UI 管理页面基础功能开发（2025-11-05 完成）**
  - ✅ Hangfire 任务监控页面
  - ✅ 归档配置管理页面
- [x] **BCP/BulkCopy 跨库归档核心功能（2025-11-13 完成）** ✨
  - ✅ BCP 执行器实现与测试
  - ✅ BulkCopy 执行器实现与测试
  - ✅ 分区表 SWITCH 优化策略
  - ✅ 跨服务器连接架构
  - ✅ DbContext 并发问题全面修复
- [ ] 扩充测试与运维支撑（进行中）

## 近期目标：P0 后端能力闭环
- [x] 扩展 `PartitionSwitchInspectionService` Blocker 校验（索引/约束/权限/锁）
  - [x] 借助 `SqlExecutor` 查询分区对象，输出结构差异明细
  - [x] 接入权限检测脚本（ALTER/TABLE CONTROL）
  - [x] 增加锁冲突检查（查 `sys.dm_tran_locks`）
  - [x] 拦截目标表触发器与外键依赖并输出阻塞提示
  - [x] 验证源/目标表 ALTER 权限并检测源表锁占用
  - [x] 比对 CHECK/DEFAULT 约束定义并输出阻塞提示
- [x] 设计 `PartitionSwitchPlan` 结构
  - [x] 明确 Blocker/AutoFix/Warning 模型与字段
  - [x] 定义 AutoFix 任务步骤（创建表/同步分区/索引/约束/统计）
- [x] 实现 AutoFix 执行链路
  - [x] 在应用层提供 `AutoFixAsync`，接受用户勾选的步骤
  - [x] 基础设施落地自动补齐执行器，执行 SQL 并记录日志
  - [x] 失败场景回滚策略与错误上报
- [x] 强化 `SqlPartitionCommandExecutor.ExecuteSwitchWithTransactionAsync`
  - [x] 拆分执行阶段日志（检查、补齐、切换）
  - [x] 异常分类输出 & 写入后台任务日志

## 中期目标：归档向导前端流程 ✅ **已完成**
- [x] `PartitionArchiveWizard.razor` 框架搭建
  - [x] Step 切换组件与向导状态管理
  - [x] Step 1 方案选择（禁用 BCP/BulkCopy）
  - [x] Step 2 参数配置表单与实时校验
  - [x] Step 3 预检结果展示（Blocker/AutoFix/Warning）
  - [x] Step 4 执行确认与 API 调用（补齐 Markdown 预览 & 成功跳转）
- [x] 与后端对接
  - [x] 预检接口调用 & AutoFix 勾选逻辑
  - [x] 任务提交成功后的跳转与提示
  - [x] 批量分区归档支持（多分区选择与依次执行）
  - [x] 配置关联（可选择已保存的分区配置）

## Blazor UI 管理页面开发（2025-11-05 完成）✅
### 1. Hangfire 后台任务监控页面（`/archive-jobs`）✅
- [x] **后端基础架构**
  - [x] Hangfire.SqlServer 存储配置（连接字符串: `HangfireConnection`）
  - [x] 自定义监控服务接口 `IHangfireMonitorService`（9个方法）
  - [x] HangfireMonitorService 实现（基于 `JobStorage.Current`）
  - [x] 任务模型：`HangfireJobModel`, `HangfireJobDetailModel`, `HangfireRecurringJobModel`, `HangfireStatisticsModel`
  - [x] 分页结果模型 `PagedResult<T>`
- [x] **前端页面功能**
  - [x] 任务统计卡片（已入队、已调度、执行中、已成功、已失败、定时任务）
  - [x] 任务列表展示（分页、状态筛选、创建时间、耗时等）
  - [x] 定时任务列表（Cron 表达式、下次执行时间、最后执行时间）
  - [x] 任务详情抽屉（状态历史、参数详情、失败原因）
  - [x] 任务操作：详情、重试、删除
  - [x] 定时任务操作：立即执行、移除
  - [x] 自动刷新功能（5秒间隔，可开关）
  - [x] 状态颜色标识（成功/失败/进行中等）

### 2. 归档配置管理页面（`/archive-configurations`）✅
- [x] **后端领域模型与 API**
  - [x] Domain 实体：`ArchiveConfiguration` 聚合根（15个属性）
  - [x] 仓储接口：`IArchiveConfigurationRepository`（8个方法）
  - [x] 仓储实现：`ArchiveConfigurationRepository`（EF Core）
  - [x] 数据库迁移：`20251104085629_AddArchiveConfiguration`
  - [x] DTOs：`ArchiveConfigurationListItemDto`, `ArchiveConfigurationDetailDto`, `CreateArchiveConfigurationRequest`, `UpdateArchiveConfigurationRequest`
  - [x] API 控制器：`ArchiveConfigurationsController`（7个端点）
    - GET /api/v1/archive-configurations（列表+筛选）
    - GET /api/v1/archive-configurations/{id}（详情）
    - POST /api/v1/archive-configurations（创建）
    - PUT /api/v1/archive-configurations/{id}（更新）
    - DELETE /api/v1/archive-configurations/{id}（删除）
    - POST /api/v1/archive-configurations/{id}/enable（启用）
    - POST /api/v1/archive-configurations/{id}/disable（禁用）
  - [x] 唯一索引：DataSourceId + SourceSchemaName + SourceTableName（防止重复配置）
- [x] **Shared 层归档枚举与模型**
  - [x] `ArchiveMethod` 枚举（Bcp, BulkCopy, PartitionSwitch）
  - [x] BCP 相关：`BcpOptions`, `BcpResult`, `BcpExecutor` 执行器
  - [x] BulkCopy 相关：`BulkCopyOptions`, `BulkCopyResult`, `BulkCopyProgress`, `SqlBulkCopyExecutor` 执行器
  - [x] 优化的分区归档执行器：`OptimizedPartitionArchiveExecutor`（支持 PARTITION SWITCH 策略）
  - [x] 归档结果与进度模型：`ArchiveResult`, `ArchiveProgress`
- [x] **前端服务与页面**
  - [x] API 客户端：`ArchiveConfigurationApiClient`（7个方法）
  - [x] 页面组件：`ArchiveConfigurations.razor`
  - [x] 功能特性：
    - [x] 表格列表（配置名称、源表、分区表标识、归档方式、状态、上次执行时间/行数）
    - [x] 数据源和状态筛选
    - [x] 创建/编辑模态框（完整表单验证）
    - [x] 详情抽屉（配置详情 + 审计字段）
    - [x] 启用/禁用切换（Popconfirm 确认）
    - [x] 删除操作（Popconfirm 确认）
  - [x] 菜单导航集成

## 后续目标：测试与运维支撑（2025-11-05 更新）

### 代码质量与测试覆盖
- [x] **集成测试覆盖**（已验证场景）
  - [x] 正常切换（单分区/批量分区）✅ 工具创建的分区测试通过
  - [x] 结构不匹配检测 ✅
  - [x] 目标表非空检测 ✅ **已增强为阻断模式**
  - [x] 跨实例阻断检测 ✅
  - [x] 索引对齐检查与自动修复 ✅
  - [x] 分区配置验证 ✅
  - [ ] **已有分区归档场景测试**（待补充）：
    - [ ] 生产环境已有分区表对齐检查流程
    - [ ] 索引/约束不一致场景修复流程
    - [ ] 目标表残留数据处理流程
    - [ ] 分区方案名称差异处理流程
- [x] **任务监控增强**
  - [x] 展示预检/补齐/执行日志（Markdown 格式）✅
  - [x] 批量执行进度展示（成功/失败计数）✅
  - [x] Hangfire 集成与自定义监控页面 ✅
  - [ ] **失败重试与人工干预入口**（待开发）：
    - [ ] 失败任务一键重试
    - [ ] 批量重试选择
    - [ ] 人工审批流程（高危操作）

### Blazor UI 后续增强（高优先级）
- [ ] **归档执行监控页面**（`/archive-executions`）**【下一步开发重点】**
  - [ ] 执行历史列表（基于 `ArchiveTask` 实体）
    - [ ] 时间范围筛选（开始时间、完成时间）
    - [ ] 状态筛选（Pending, Running, Completed, Failed, Cancelled）
    - [ ] 数据源筛选
    - [ ] 分页展示（20条/页）
  - [ ] 执行详情查看
    - [ ] 输入参数（配置ID、数据源、表名、分区号等）
    - [ ] 执行日志（Markdown 格式，高亮关键步骤）
    - [ ] 结果统计（源行数、目标行数、耗时、吞吐量）
    - [ ] 状态时间线（队列时间、开始时间、完成时间）
  - [ ] 批量执行进度监控
    - [ ] 实时进度条（已完成/总数）
    - [ ] 成功/失败计数统计
    - [ ] 当前执行任务展示
  - [ ] 失败任务重试入口
    - [ ] 单个任务重试按钮
    - [ ] 批量重试选择
    - [ ] 重试确认对话框
- [ ] **数据源管理页面增强**（`/data-sources` 改进）
  - [ ] 测试连接功能
    - [ ] 源数据库连接测试
    - [ ] 目标数据库连接测试（若配置）
    - [ ] 连接耗时统计
    - [ ] 权限检测（ALTER TABLE 权限）
  - [ ] 目标服务器配置管理
    - [ ] 独立目标服务器配置（可选）
    - [ ] 目标连接字符串管理
    - [ ] 源=目标模式切换
  - [ ] 连接状态实时检测
    - [ ] 连接池状态监控
    - [ ] 连接失败告警
    - [ ] 自动重连策略
- [ ] **分区配置管理页面改进**
  - [ ] 分区方案CRUD增强
    - [ ] 分区方案向导（简化创建流程）
    - [ ] 分区方案模板库
    - [ ] 分区方案复制功能
  - [ ] 分区边界值管理优化
    - [ ] 批量生成边界值（按月/按年/自定义）
    - [ ] 边界值可视化时间轴
    - [ ] 过期分区自动检测
  - [ ] 分区状态可视化
    - [ ] 分区空间占用统计
    - [ ] 分区行数分布图表
    - [ ] 分区健康度评分

### 文档与运维支撑（高优先级）
- [x] **技术设计文档更新** ✅
  - [x] `BCP-BulkCopy技术设计.md` - BCP/BulkCopy 执行器设计
  - [x] `BackgroundTask架构设计.md` - 后台任务架构
  - [x] `Hangfire集成说明.md` - Hangfire 集成指南
  - [x] `自定义Hangfire监控页面.md` - 监控页面实现文档
- [ ] **用户操作手册**（待编写）
  - [ ] **归档配置管理手册**：
    - [ ] 新建归档配置流程（含截图）
    - [ ] 归档方式选择指南（BCP vs BulkCopy vs PartitionSwitch）
    - [ ] 批次大小调优建议
    - [ ] 过滤条件配置示例
  - [ ] **分区归档操作手册**：
    - [ ] 工具创建分区并归档完整流程
    - [ ] 已有分区对齐检查与处理指南
    - [ ] 批量归档操作说明
    - [ ] 自动补齐功能使用说明与注意事项
  - [ ] **任务监控与故障处理**：
    - [ ] Hangfire 任务监控页面使用说明
    - [ ] 任务失败重试操作指南
    - [ ] 定时任务配置与管理
- [ ] **FAQ 与常见故障处理**（待整理）
  - [ ] **分区归档常见问题**：
    - [ ] 索引未对齐问题诊断与处理
    - [ ] 约束不匹配问题处理
    - [ ] 分区方案名称不一致问题处理
    - [ ] 目标表残留数据处理流程
    - [ ] 预检失败常见原因与解决方案
  - [ ] **性能优化建议**：
    - [ ] BCP vs BulkCopy 性能对比与选择
    - [ ] 批次大小调优策略
    - [ ] 归档执行时间窗口建议
    - [ ] 大表归档最佳实践
  - [ ] **错误代码参考**：
    - [ ] 常见异常错误码及含义
    - [ ] 错误排查步骤
    - [ ] 联系支持的场景
- [ ] **诊断脚本与工具**（待开发）
  - [ ] **分区健康检查脚本集**：
    - [ ] `CheckPartitionAlignment.sql` - 分区方案对齐检查
    - [ ] `CheckIndexAlignment.sql` - 索引对齐状态检查
    - [ ] `CheckConstraintConsistency.sql` - 约束一致性检查
    - [ ] `CheckPartitionDataSkew.sql` - 分区数据倾斜检测
  - [ ] **性能分析脚本**：
    - [ ] 归档任务性能统计查询
    - [ ] 分区空间占用分析
    - [ ] 归档吞吐量趋势分析
- [x] **无分区配置草稿场景回归** ✅
  - [x] 拓展应用服务/仓储以支持默认配置加载 ✅
  - [x] 更新前端归档向导交互（提示、字段收集）✅
  - [x] 增补集成测试覆盖此场景 ✅

---

## 本次开发完成总结（2025-11-05）

### 新增代码统计
| 模块 | 文件数 | 代码行数 | 说明 |
|-----|-------|---------|------|
| Domain | 2 | ~300 | `ArchiveConfiguration` 聚合根 + 仓储接口 |
| Infrastructure | 4 | ~47,000 | 仓储实现 + BCP/BulkCopy 执行器 + 迁移 |
| Application | 1 | ~200 | 归档编排服务集成 |
| API | 2 | ~600 | API 控制器 + DTOs |
| Web | 4 | ~45,000 | 监控页面 + 配置页面 + API 客户端 + 模型 |
| Shared | 5 | ~3,500 | 归档枚举 + 选项模型 + 结果模型 |
| **总计** | **18** | **~96,600** | **完整的归档配置管理与任务监控体系** |

### 主要功能亮点
1. **Hangfire 任务监控集成**
   - 自定义监控服务，无需依赖 Hangfire Dashboard
   - 支持任务筛选、详情查看、失败重试、定时任务管理
   - 实时统计卡片与自动刷新（5秒间隔）
   
2. **归档配置管理**
   - 完整的 CRUD 功能，支持数据源和状态筛选
   - 三种归档方式支持：BCP、BulkCopy、PartitionSwitch
   - 启用/禁用配置快速切换，防止误操作
   - 唯一索引约束，防止重复配置
   
3. **BCP/BulkCopy 执行器**
   - `BcpExecutor`: 基于 BCP 命令行工具的导出/导入执行器
   - `SqlBulkCopyExecutor`: 基于 SqlBulkCopy API 的流式传输执行器
   - `OptimizedPartitionArchiveExecutor`: 优化的分区切换执行器（< 1秒锁定）
   - 支持进度回调、批次大小配置、错误处理与日志记录
   
4. **UI/UX 增强**
   - Ant Design Blazor 组件库统一风格
   - 响应式布局，支持移动端访问
   - 详情抽屉、确认对话框等交互优化
   - 状态标签颜色区分（成功/失败/进行中）

### 技术债务与改进点
- [ ] **性能优化**：大表归档场景的 BulkCopy 内存占用优化
- [ ] **错误处理**：统一的异常处理中间件与友好的错误提示
- [ ] **日志增强**：结构化日志输出（Serilog）与日志级别配置
- [ ] **权限控制**：归档配置的创建/编辑/删除权限管理
- [ ] **审计日志**：归档操作审计日志记录与查询

---

## 安全增强记录（2025-11-04）
- ✅ **CleanupResidualData 步骤重构**
  - 原逻辑：自动执行 TRUNCATE 清空目标分区数据
  - 新逻辑：**仅检测+阻断**，不自动清空
  - 检测到残留数据时：
    - 返回 `Succeeded=false`
    - 提供手动清空脚本（包含事务控制）
    - 中断自动补齐流程
  - 提高归档安全性，防止误删除业务数据
- ✅ 测试验证：工具创建的分区能正常通过检测（目标分区为空）
- ⚠️ 影响：已有分区如目标表非空需手动处理后才能归档

---

## 版本历史
- **v0.6.0** (2025-11-13): ✨ BCP/BulkCopy 跨库归档测试验证 + DbContext 并发修复 + 性能优化
  - ✅ BCP 跨服务器归档执行成功
  - ✅ 分区表 SWITCH + BCP 优化策略（生产表影响 < 1秒）
  - ✅ Repository 层统一 AsNoTracking()
  - ✅ 移除 Progress 回调中的 DbContext 访问
  - ✅ 跨服务器场景重复检查优化
  - ✅ 临时表创建文件组修复（SELECT INTO → CREATE TABLE ON）
- **v0.5.0** (2025-11-05): Hangfire 监控 + 归档配置管理 + BCP/BulkCopy 执行器
- **v0.4.0** (2025-11-04): 分区切换安全增强 + 目标表残留数据阻断
- **v0.3.0** (2025-11-03): 归档向导前端流程 + BackgroundTask 重构
- **v0.2.0** (2025-10-30): P0 后端能力闭环 + 自动补齐功能
- **v0.1.0** (2025-10-15): 初始版本，基础分区管理功能
