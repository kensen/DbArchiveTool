# 数据归档功能开发 Todos

## 顶层阶段
- [x] 完成 P0 后端能力闭环
- [ ] 搭建归档向导前端流程
- [ ] 扩充测试与运维支撑

## 近期目标：P0 后端能力闭环
- [x] 扩展 `PartitionSwitchInspectionService` Blocker 校验（索引/约束/权限/锁）
  - [x] 借助 `SqlExecutor` 查询分区对象，输出结构差异明细
  - [x] 接入权限检测脚本（ALTER/TABLE CONTROL）
  - [x] 增加锁冲突检查（查 `sys.dm_tran_locks`）
  - [x] 拦截目标表触发器与外键依赖并输出阻塞提示
  - [x] 验证源/目标表 ALTER 权限并检测源表锁占用
  - [x] 比对 CHECK/DEFAULT 约束定义并输出阻塞提示
- [x] 设计 `PartitionSwitchPlan` 结构
  - [x] 明确 Blocker/AutoFix/Warning 模型与字段
  - [x] 定义 AutoFix 任务步骤（创建表/同步分区/索引/约束/统计）
- [x] 实现 AutoFix 执行链路
  - [x] 在应用层提供 `AutoFixAsync`，接受用户勾选的步骤
  - [x] 基础设施落地自动补齐执行器，执行 SQL 并记录日志
  - [x] 失败场景回滚策略与错误上报
- [x] 强化 `SqlPartitionCommandExecutor.ExecuteSwitchWithTransactionAsync`
  - [x] 拆分执行阶段日志（检查、补齐、切换）
  - [x] 异常分类输出 & 写入后台任务日志

## 中期目标：归档向导前端流程
- [ ] `PartitionArchiveWizard.razor` 框架搭建
  - [ ] Step 切换组件与向导状态管理
  - [ ] Step 1 方案选择（禁用 BCP/BulkCopy）
  - [ ] Step 2 参数配置表单与实时校验
  - [ ] Step 3 预检结果展示（Blocker/AutoFix/Warning）
  - [ ] Step 4 执行确认与 API 调用
- [ ] 与后端对接
  - [ ] 预检接口调用 & AutoFix 勾选逻辑
  - [ ] 任务提交成功后的跳转与提示

## 后续目标：测试与运维支撑
- [ ] 集成测试覆盖
  - [ ] 正常切换
  - [ ] 结构不匹配
  - [ ] 目标表非空
  - [ ] 跨实例阻断
- [ ] 任务监控增强
  - [ ] 展示预检/补齐/执行日志
  - [ ] 失败重试与人工干预入口
- [ ] 文档与运维稿
  - [ ] 用户操作手册
  - [ ] FAQ 与常见故障处理
