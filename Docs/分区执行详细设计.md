# 分区执行详细设计

> 版本：0.1（2025-10-10）  
> 作者：  
> 适用范围：面向“分区配置草稿”落地执行的端到端方案（后端、前端、运维）

---

## 1. 背景与目标
- 当前“分区配置草稿”功能已能收集并保存分区方案，但缺少真正将配置应用到业务数据库的执行闭环。
- 历史工具提供了较丰富的执行日志（校验、索引操作、耗时统计等），是设计参考，但与现有 Blazor UI 风格不一致，需要梳理出更现代、可追踪的执行体验。
- 目标：为每个配置草稿提供“校验-排队-执行-结果回溯”全链路能力，保障长时操作的稳定性、可观测性与安全性。

成功标准：
1. 用户在草稿详情中可以发起执行请求，并在任何时刻查询执行进度、查看完整日志。
2. 同一数据源同一时刻仅存在一个正在运行的分区执行任务，不同数据源可并行。
3. 执行过程中的关键校验失败能够在前置阶段阻止执行；运行中失败要清晰感知并支持后续恢复。
4. 执行结束后草稿自动标记为已提交 (`IsCommitted = true`)，且日志永久留存，以便审计。

---

## 2. 相关名词
- **配置草稿**：`PartitionConfiguration` 记录，尚未执行到目标数据库的分区方案。
- **分区执行任务**：针对单一配置草稿的一次后台执行，会产生日志、状态、最终结果。
- **任务步骤**：执行任务内部的细粒度动作，例如“校验索引”“拆分分区”“重建索引”等。
- **执行日志**：任务运行时产生的结构化记录，包含时间、级别、耗时、摘要、详情。

---

## 3. 总体方案
### 3.1 执行流程概览
```
用户触发执行 → 应用层校验 → 写入任务记录 & 入队 → 后台工作进程按数据源顺序取出 → 
再次锁定与校验 → 按步骤执行 T-SQL → 更新任务状态 & 分区配置 → 推送/查询进度
```

### 3.2 关键组件
- **PartitionExecutionAppService**（新）：协调配置读取、校验、任务落库、排队、状态查询。
- **PartitionExecutionTask**（新领域对象）：持久化任务状态、步骤摘要、与配置草稿的关联。
- **PartitionExecutionLogEntry**（新领域对象）：存储每条执行日志。
- **PartitionExecutionQueue**（扩展现有 `PartitionCommandQueue` 或新建）：负责后台任务排队。
- **PartitionExecutionHostedService**（对 `PartitionCommandHostedService` 大幅增强）：串行消费任务，控制并发、写日志。
- **SqlPartitionExecutor**（扩展现有 `SqlPartitionCommandExecutor`）：负责渲染执行脚本、调用数据库并捕获结果。
- **前端 PartitionExecutionCenter / ExecutionPanel**：展示任务列表、详情与日志。

### 3.3 与现有能力的衔接
- `PartitionCommand` 目前聚焦单次 Split/Merge/Switch 操作。分区执行任务会在内部拆解成若干 `PartitionCommand`（或直接重用其脚本生成能力），并在任务表中关联。
- `PartitionConfiguration` 的 `MarkCommitted/MarkDraft` 将在任务成功/失败后调用，确保草稿状态与执行结果一致。
- 已存在的 `PartitionCommandQueue`、`SqlPartitionCommandExecutor` 将复用并扩展，避免重复造轮子。

---

## 4. 前置校验设计
### 4.1 校验触发时机
1. **发起执行前（同步校验）**：直接向用户返回错误，阻断执行。
2. **任务进入后台后（串行校验）**：再次确认环境，以防排队期间状态变更。

### 4.2 校验内容
- 配置草稿状态：
  - `IsCommitted` 必须为 `false`。
  - 草稿必须存在已保存的边界值、目标库信息与文件策略。
  - `RequirePartitionColumnNotNull` 为 `true` 时确认已在草稿中记录需要的转换步骤。
- 数据源与目标表状态：
  - 检查待执行数据源当前是否已有运行中的任务（数据库级互斥）。
  - 通过 `IPartitionMetadataRepository` 再次拉取真实的表信息，验证未提前分区、列类型未变化。
  - 对 `PartitionSafetyRule` 中的 `RequiresEmptyPartition` 做针对性检查（行数/空间等）。
  - 必要时读取目标数据库磁盘空间、文件路径可用性。
- 人工确认项：
  - 用户需勾选“最近 12 小时内已备份”或输入备份编号，写入任务 `Payload`，供日志展示。
  - 若检测到临界风险（例如表数据量超过阈值、业务高峰时段），提示用户选择“仍然执行”才可继续。

校验失败处理：
- 前置校验失败 → HTTP 400，前端提示。
- 后台校验失败 → 任务标记为 `Failed`，日志记录失败原因，前端展示为“前置校验失败（队列阶段）”。

---

## 5. 后台队列与并发控制
- **队列实现**：复用现有 `PartitionCommandQueue`，但需要在负载消息中包含 `DataSourceId`、`ExecutionTaskId` 等信息；若现有通道不易扩展，可以并行维护新的 `PartitionExecutionQueue`（`Channel<ExecutionDispatch>`）。
- **并发约束**：
  - 内部维护 `ConcurrentDictionary<Guid, SemaphoreSlim>`，确保同一数据源任务串行执行。
  - 持久化约束：在 `PartitionExecutionTask` 表上对 `(DataSourceId, Status in [Running, Validating])` 建立部分唯一索引，阻止业务层漏检。
- **任务恢复**：HostedService 启动时扫描数据库中状态为 `Running/Validating` 但 `Heartbeat` 超时的任务，重新入队并记录“上次执行异常退出”日志，避免僵尸任务。

---

## 6. 执行步骤与日志
### 6.1 步骤拆分（建议参考旧工具日志）
1. 记录基础信息（表名、数据量、目标时间范围、备份确认）。
2. 校验阶段：索引、约束、触发器、锁等待、目标文件组空间。
3. 必要的预处理（可选）：`ALTER TABLE ... SET (LOCK_ESCALATION = DISABLE)`、关闭触发器等。
4. 分区执行：
   - 添加文件组/数据文件（如果草稿选择独立文件组）。
   - `ALTER PARTITION SCHEME` + `ALTER PARTITION FUNCTION` 按边界逐一拆分。
5. 索引及统计信息处理：
   - 删除受影响的非聚集索引。
   - 执行分区后重建索引、更新统计信息。
6. 收尾与核验：
   - 查询 `sys.partitions`、`sys.indexes` 写入最终摘要。
   - 标记 `PartitionConfiguration.MarkCommitted`.
   - 写入成功日志与耗时汇总。

### 6.2 日志结构
- `PartitionExecutionLogEntry` 字段建议：
  - `Id`、`ExecutionTaskId`
  - `TimestampUtc`
  - `Category`（Info/Warning/Error/Step）
  - `Title`（例如“删除非聚集索引 IX_xxx”）
  - `Message`（详细描述，统一使用 Markdown 或纯文本）
  - `DurationMs`（可空）
  - `Extra`（JSON，记录行数、文件路径、生成脚本片段等）
- **总结日志**：任务完成时生成一条总览记录，包含总耗时、影响分区数、涉及索引数量等，供前端展示在顶部。

---

## 7. 数据模型与存储
拟新增表（EF Migration）：

| 表名 | 作用 | 主要字段 |
| ---- | ---- | -------- |
| `PartitionExecutionTask` | 任务主表 | `Id`, `PartitionConfigurationId`, `DataSourceId`, `Status`, `Phase`, `Progress`, `QueuedAt`, `StartedAt`, `CompletedAt`, `CreatedBy`, `LastHeartbeatUtc`, `FailureReason`, `SummaryJson`, `BackupReference`, `Priority` |
| `PartitionExecutionLog` | 日志表 | `Id`, `ExecutionTaskId`, `TimestampUtc`, `Category`, `Title`, `Message`, `DurationMs`, `ExtraJson` |
| `PartitionExecutionStep`（可选） | 存储结构化步骤 | `Id`, `ExecutionTaskId`, `StepKey`, `DisplayName`, `Status`, `StartedAt`, `CompletedAt`, `Order` |

索引建议：
- `PartitionExecutionTask`: 索引 `(DataSourceId, Status)`，并对 `Status IN ('Running','Validating')` 建唯一索引。
- `PartitionExecutionLog`: 索引 `(ExecutionTaskId, TimestampUtc ASC)` 用于按时间排序拉取。

与既有表的关系：
- `PartitionExecutionTask.PartitionConfigurationId` 外键到 `PartitionConfigurationEntity.Id`。
- 执行成功后 `PartitionConfigurationEntity.IsCommitted = true`，并记录 `UpdatedAtUtc`、`UpdatedBy`。

---

## 8. 接口设计（草案）
| 接口 | 方法 | 描述 |
| ---- | ---- | ---- |
| `/api/v1/partition-configurations/{id}/execute` | POST | 发起执行，返回 `executionTaskId`。需要请求体包含 `RequestedBy`、`BackupConfirmed`、`BackupReference`、`ForceWhenWarnings` 等。 |
| `/api/v1/partition-executions/{taskId}` | GET | 查询任务详情（状态、阶段、当前进度、摘要）。 |
| `/api/v1/partition-executions/{taskId}/logs` | GET | 分页拉取日志（支持 `since` 参数做长轮询）。 |
| `/api/v1/partition-executions` | GET | 按数据源或配置草稿列出近期任务。 |
| `/api/v1/partition-executions/{taskId}/cancel`（可选） | POST | 允许管理员在任务进入执行前取消。 |

请求/响应 DTO 需在 `DbArchiveTool.Api/Models/PartitionExecutionDtos.cs` 新增定义，并在 `DbArchiveTool.Web/Services` 配套 API Client。

权限控制：
- 仅具备分区管理权限的管理员可发起执行。
- 任务日志接口需校验请求人对数据源的访问权，避免越权查看敏感信息。

---

## 9. 前端设计
- **入口整合**：
  - 在“分区配置草稿”详情页增加“执行分区”按钮和任务状态概览卡片。
  - 若存在最近任务，展示其状态及查看详情入口。
- **执行确认弹窗**：
  - 展示关键校验结果与风险提示（表数据量、待拆分数量、索引受影响列表等）。
  - 用户勾选“已完成备份”并填写执行备注后才允许提交。
- **任务进度 UI**：
  - 新建可复用组件 `PartitionExecutionProgress`，展示状态流转（待校验 → 排队 → 执行中 → 成功/失败）。
  - 日志采用时间轴或分组表格，支持按类别过滤。
  - 提供“复制日志”与“下载日志”为 TXT/JSON 的功能。
- **页面模块拆分**：
  - 将分区管理主页面拆成：草稿列表组件、执行任务列表组件、草稿详情面板、执行详情弹窗。
  - 计划使用 `Tabs` 或 `Drawer` 承载执行详情，保持主页面整洁。

UX 要点：
- 长任务期间需自动轮询任务状态（建议 5s~10s）。
- 失败场景给出可执行的下一步提示，如“请重新生成脚本后重试”“请手工清理残留索引”。

---

## 10. 安全、审计与容灾
- 所有执行必须记录触发人 (`RequestedBy`) 与后台实际执行账号（可能为连接串登录用户）。
- 日志中不得出现敏感数据（如真实业务数据值），必要时进行脱敏。
- 若任务失败或中断，需提供“回滚建议”提示，并在日志中写明数据库可能处于的状态。
- 关键操作（建文件组、ALTER TABLE）需启用 `SET XACT_ABORT ON`，确保异常自动回滚。
- 对于执行中的 SQL 异常，记录 SQL 执行时间、错误号、错误消息，方便 DBA 排查。

---

## 11. 测试与验收
### 11.1 自动化测试
- Application 层：新增 `PartitionExecutionAppServiceTests`，覆盖校验失败、成功建任务、重复任务阻止等。
- Infrastructure 层：对 `PartitionExecutionHostedService` 引入集成测试，使用 InMemory Channel + 假 SQL 执行器模拟成功/失败。
- Web 层：API Controller 单元测试 & Swagger 注释补齐。

### 11.2 手工验证
- 小表、百万行大表分别验证执行耗时与日志完整性。
- 并发场景：同库多次点击执行，确认仅生成 1 个任务。
- 异常场景：模拟 SQL 报错、网络中断，检查任务恢复能力与提示。

---

## 12. 迭代计划（建议两阶段推进）
### Phase 1：执行框架搭建（预估 1.5~2 周）
1. 建模与迁移：`PartitionExecutionTask/Log` 表、EF 配置。
2. Application 层服务、API DTO、Controller 基础实现。
3. 后台队列、HostedService、执行器骨架（先写入模拟日志，不真正连库）。
4. 前端执行入口 + 任务列表基础 UI。
5. 自动化测试框架搭好。

### Phase 2：SQL 执行与体验完善（预估 2 周）
1. 整合 `SqlPartitionCommandExecutor`，实现真实 SQL 执行与日志采集。
2. 完整的前置校验逻辑与风险提示。
3. 前端日志展示、轮询、导出功能。
4. 失败恢复、超时重试、任务重入处理。
5. 性能 & 安全验证，补齐文档、操作手册。

Milestone 关闭条件：
- Demo：演示从草稿 → 发起执行 → 查看任务 → 查看日志的全流程。
- 文档：更新《分区管理功能设计.md》《运维手册》。
- 值班手册：列出常见错误及处理方式。

---

## 13. 后续待定议题
- 是否支持任务取消 / 暂停（涉及 SQL KILL 风险，需 DBA 评估）。
- 执行策略差异化：按时间段、按历史数据量动态拆分等。
- 与归档任务调度的整合：未来是否统一到一个任务中心。
- 跨环境部署（测试 / 生产）对连接字符串、权限的影响如何隔离。

---

## 14. 附录
- 旧工具日志截图要点：详尽记录每一步的耗时、成功/失败状态，作为 UI 呈现时的分组依据。
- 与现状差异：旧工具为 WinForm 弹窗，日志呈现为彩色文本；本系统将采用结构化日志 + Web 组件表现。

---

### 版本记录
- **0.1（2025-10-10）**：初版方案，覆盖域模型、后台流程、UI 规划与实施计划。
- **0.2（2025-10-10）**：补充执行任务/日志实体、迁移与 API 骨架实现记录，新增前端 PartitionExecution API Client 说明。
